// pages/authorize/authorize.js
Page({

  /**
   * 页面的初始数据
   */
  data: {
  
  },
  onLoad: function (options) {
  
  },

  onReady: function () {
  
  },
  onShow: function () {
  
  },

  onReachBottom: function () {
  
  },
  bindGetUserInfo:function(e){
    let detail=e.detail
    if (detail.iv){
      wx.redirectTo({
        url: '/pages/login/login',
      })
    }else{
      wx.showToast({
        title: '请接受授权',
      })
    }
  }
}),{},<view class="container">
 <button type="blue" open-type="getUserInfo" bindgetuserinfo="bindGetUserInfo">授权小程序</button>
</view>
,.container{
  padding:40rpx 20rpx;
},let app = getApp();
// let qqmap = require('../../utils/qqmap-wx-jssdk.min.js')
// let qqmapsdk
const httpHelper = require('../../utils/httpHelper.js')
const api = require('../../api.js')
Page({
  data: {
    info: {},
    showInfo: true,
    province: '',
    city: '',
    latitude: '',
    longitude: '',
    imgPath:''
  },
  onLoad: function(options) {
    let info = app.globalData.userInfo;
    let that = this;
    // qqmapsdk = new qqmap({
    //   key: 'EFZBZ-VFC3X-REB4R-7HPCG-5EPIQ-GHFTG' //这里自己的key秘钥进行填充
    // });
    let chatInfo= app.globalData.chatInfo
    if (chatInfo){
      that.setData({
        imgPath: chatInfo.avatarUrl
      })
    }else{
      wx.getUserInfo({
        success: function (res) {
          app.globalData.chatInfo = res.userInfo
          that.setData({
            imgPath: res.userInfo.avatarUrl
          })
        }
      })
    }
    
  },
  onShow:function(){
    let that=this
    var userInfo = wx.getStorageSync('userInfo');
    let info=that.data.info
    if (userInfo){
      info = userInfo
      that.setData({
        info: info
      })
    }else{
      httpHelper.ajax({
        url: api.userInfo
      }).then((res) => {
        if (res.data.errorCode == 0) {
          info = res.data.data
          wx.setStorageSync('userInfo', res.data.data);
          that.setData({
            info: info
          })
        }
      }).catch((res, code, header) => {
        console.log(res)
      })
    }
  },
  loginOut: function() {
    httpHelper.ajax({
      url: api.loginOut
    }).then((res) => {
      if (res.data.errorCode == 0) {
        try {
          app.globalData.token = ''
          wx.clearStorageSync()
          wx.clearStorage() 
          wx.showToast({
            title: '退出成功',
          })
         setTimeout(()=>{
           wx.redirectTo({
             url: '/pages/weblogin/weblogin',
           })
         },500)
        } catch (e) {
          wx.showToast({
            title: '退出失败请重试',
          })
        }
      }
    }).catch((res, code, header) => {
      console.log(res)
    })
  },
  getUserLocation: function () {
    let vm = this;
    wx.getSetting({
      success: (res) => {
        console.log(JSON.stringify(res))
        // res.authSetting['scope.userLocation'] == undefined    表示 初始化进入该页面
        // res.authSetting['scope.userLocation'] == false    表示 非初始化进入该页面,且未授权
        // res.authSetting['scope.userLocation'] == true    表示 地理位置授权
        if (res.authSetting['scope.userLocation'] != undefined && res.authSetting['scope.userLocation'] != true) {
          wx.showModal({
            title: '请求授权当前位置',
            content: '需要获取您的地理位置，请确认授权',
            success: function (res) {
              if (res.cancel) {
                wx.showToast({
                  title: '拒绝授权',
                  icon: 'none',
                  duration: 1000
                })
              } else if (res.confirm) {
                wx.openSetting({
                  success: function (dataAu) {
                    if (dataAu.authSetting["scope.userLocation"] == true) {
                      wx.showToast({
                        title: '授权成功',
                        icon: 'success',
                        duration: 1000
                      })
                      //再次授权，调用wx.getLocation的API
                      vm.getLocation();
                    } else {
                      wx.showToast({
                        title: '授权失败',
                        icon: 'none',
                        duration: 1000
                      })
                    }
                  }
                })
              }
            }
          })
        } else if (res.authSetting['scope.userLocation'] == undefined) {
          //调用wx.getLocation的API
          vm.getLocation();
        }
        else {
          //调用wx.getLocation的API
          vm.getLocation();
        }
      }
    })
  },
  // 微信获得经纬度
  getLocation: function () {
    let vm = this;
    wx.getLocation({
      type: 'wgs84',
      success: function (res) {
        //console.log(JSON.stringify(res))
        var latitude = res.latitude
        var longitude = res.longitude
        var speed = res.speed
        var accuracy = res.accuracy;
        vm.getLocal(latitude, longitude)
      },
      fail: function (res) {
        console.log('fail' + JSON.stringify(res))
      }
    })
  },
  // 获取当前地理位置
  getLocal: function (latitude, longitude) {
    let vm = this;
    qqmapsdk.reverseGeocoder({
      location: {//120.741459,31.260328
        latitude: latitude,
        longitude: longitude
      },
      success: function (res) {
        //console.log(JSON.stringify(res));
        let address = res.result.address
        let province = res.result.ad_info.province
        let city = res.result.ad_info.city
        let district = res.result.ad_info.district ? res.result.ad_info.district:''
        let street = res.result.ad_info.street ? res.result.ad_info.street:''
        let street_number = res.result.ad_info.street_number ? res.result.ad_info.street_number:''
        vm.setData({
          province: province,
          city: city,
          district: district,
          street: street,
          address: address,
          street_number: street_number,
          latitude: latitude,
          longitude: longitude
        })

      },
      fail: function (res) {
        console.log(res);
      },
      complete: function (res) {
        // console.log(res);
      }
    });
  }
}),{"navigationBarTitleText": "我的"},<view class="container">
  <view class="userinfo">
    <!-- <block wx:if="{{info.imgUrl}}">
      <image src='{{info.imgUrl}}' mode='aspectFit'></image>
    </block>
    <block wx:else>
      <image src='/images/home_s.png' mode='aspectFit'></image>
    </block> -->
    <open-data type="userAvatarUrl"></open-data>
    <!-- <view>{{info.name}}</view> -->
  </view>
  <view class='infomod'>
    <icon class='iconfont icon-address'></icon>
    <text>{{info.name}}</text>
  </view>
  <view class='infomod' bindtap='loginOut'>
    <icon class='iconfont icon-exit'></icon>
    <text>退出登录</text>
  </view>
</view>,.userinfo{
  text-align: center;
  padding:60rpx 0;
}
.userinfo open-data{
  display: inline-block;
  width: 120rpx;
  height:120rpx;
  border-radius:50%;
  margin-bottom:20rpx;
}
.infomod{
  background: #fff;
  margin-bottom:20rpx;
  height:80rpx;
  line-height: 80rpx;
  padding:0 40rpx;
}
.infomod icon{
  color:#999;
}
.infomod text{
  display: inline-block;
  margin-left:40rpx;
},const httpHelper = require('../../utils/httpHelper.js');
const api = require('../../api.js')
const app = getApp()
let downanimation = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let sortanimation = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let lineanimation = wx.createAnimation({
  duration: 300,
  timingFunction: 'ease',
})
Page({
  data: {
    newsList: [],
    pageNum: 0,
    pageSize: 10,
    sortList: [{
      sortColumn: 'orderDate',
      sortOrder: 'desc'
    }],
    sortName: '排序',
    sortCount: 1,
    total: 0,
    showBottom: false,
    showNoImg: false,
    isLink: false,
    scrollTop: 0,
    sortShow: false,
    sortAnimate: {},
    downAnimate: {},
    lineAnimate: {},
    filterList: [{
      sorttype: 'maxPlanDelyDate',
      name: '预约发货时间'
    }, {
      sorttype: 'orderDate',
      name: '下单时间'
    }, {
      sorttype: 'clearSort',
      name: '清除排序'
    }],
    dispatchUser: true,
    orderBar: [],
    status: 'deal'
  },
  onLoad: function(options) {
    let orderId = options.id
    if (orderId) {
      app.globalData.orderId = orderId
      app.globalData.isLink = true
    }
    wx.removeStorageSync('orderBar')
    wx.removeStorageSync('status')
    wx.removeStorage({
      key: 'scroll',
      success: function(res) {},
    })
  },
  onReady: function() {

  },
  onShow: function() {
    this.getAccountInfo()
    let that = this
    let scrollData = wx.getStorage({
      key: 'scroll',
      success: function(res) {
        let _data = res.data
        that.setData({
          newsList: [],
          pageNum: 0,
          pageSize: _data.pageSize,
          scrollTop: _data.scrollTop
        }, () => {
          that.initList()
          setTimeout(() => {
            wx.pageScrollTo({
              scrollTop: _data.scrollTop,
            })
          }, 1000)
        })
      },
      fail: function() {
        that.setData({
          newsList: [],
          pageNum: 0,
          pageSize: 10,
          showBottom: false
        }, () => {
          that.initList()
        })
      }
    })


  },
  //事件处理函数
  onPullDownRefresh: function() {
    let that = this
    that.setData({
      newsList: [],
      sortName: '排序',
      sortList: [{
        sortColumn: 'orderDate',
        sortOrder: 'desc'
      }],
      sortCount: 1,
      pageNum: 0,
      pageSize: 10,
      showBottom: false
    }, () => {
      that.initList()
      that.clearScrollData();
      wx.stopPullDownRefresh()
    })

  },
  initList: function() {
    let that = this
    let useInfo = wx.getStorageSync('userInfo')
    let status = this.data.status
    let _data = {
      pageNum: this.data.pageNum,
      completionStatus: status,
      pageSize: this.data.pageSize,
      sortList: this.data.sortList
    }
    let orderId = app.globalData.orderId
    let islink = app.globalData.isLink
    //console.log(orderId)
    httpHelper.ajax({
      url: api.newsList,
      method: 'post',
      data: _data
    }).then((res) => {
      let resdata = res.data
      if (resdata.errorCode == 0) {
        console.log(resdata)
        let total = resdata.data.total
        let list = resdata.data.list
        if (list.length == 0) {
          wx.stopPullDownRefresh()
          that.setData({
            showNoImg: true
          })
          return
        } else {
          that.setData({
            showNoImg: false
          })
        }
        let goods = ''
        let _list = that.data.newsList
        for (var i = 0; i < list.length; i++) {
          let planDelyDate = list[i].planDelyDate ? list[i].planDelyDate : '' //预约发货
          let planArriveDate = list[i].planArriveDate ? list[i].planArriveDate : '' //预约到货
          let delyDate = list[i].delyDate ? list[i].delyDate : '' //发货
          let arriveDate = list[i].arriveDate ? list[i].arriveDate : '' //到货
          let timeRange = list[i].timeRange ? list[i].timeRange:''
          let maxPlanDelyDate = list[i].maxPlanDelyDate
          let _day = maxPlanDelyDate.substr(0,10)
          if (timeRange=='-1'){
            planDelyDate='2小时上门'
          }else{
            planDelyDate = _day + ' ' + timeRange
          }
          //planDelyDate = planDelyDate.substr(0, (planDelyDate.length - 3))
          planArriveDate = planArriveDate.substr(0, (planArriveDate.length - 3))
          delyDate = delyDate.substr(0, (delyDate.length - 3))
          arriveDate = arriveDate.substr(0, (arriveDate.length - 3))
          list[i].planDelyDate = planDelyDate
          list[i].planArriveDate = planArriveDate
          list[i].delyDate = delyDate
          list[i].arriveDate = arriveDate
          let goodsName = list[i].goodsName ? list[i].goodsName + '，' : ''
          let goodsType = list[i].goodsType ? list[i].goodsType == 'light' ? "抛货，" : '重货，' : 
          ''
          let goodsQty = list[i].goodsQty ? list[i].goodsQty + '箱，' : ''
          let goodsWeight = list[i].goodsWeight ? list[i].goodsWeight + '吨，' : ''
          let goodsVolume = list[i].goodsVolume ? list[i].goodsVolume + 'm³，' : ''
          goods = goodsName + goodsType + goodsQty + goodsWeight + goodsVolume
          goods = goods.substr(0, (goods.length - 1))
          list[i].goodsMsg = goods
          if (list[i].orderStatus == 'wait') {
            list[i].payDesc = '草稿'
          }
          if (list[i].paymentStatus == 'paid') {
            if (list[i].orderStatus == 'undelivery') {
              list[i].payDesc = '已支付未发货'
            } else if (list[i].orderStatus == 'delivering') {
              list[i].payDesc = '已支付运输中'
            } else if (list[i].orderStatus == 'reject') {
              list[i].payDesc = '已支付已拒收'
            } else if (list[i].orderStatus == 'cancel') {
              list[i].payDesc = '已支付已取消'
            } else if (list[i].orderStatus == 'normalSign') {
              list[i].payDesc = '已支付正常签收'
            } else if (list[i].orderStatus == 'abnormalSign') {
              list[i].payDesc = '已支付异常签收'
            } else if (list[i].orderStatus == 'undispatch') { //待派单
              list[i].payDesc = '已支付待派单'
            }
          } else if (list[i].paymentStatus == 'refund') {
            if (list[i].orderStatus == 'reject') {
              list[i].payDesc = '已退款已拒收'
            } else if (list[i].orderStatus == 'cancel') {
              list[i].payDesc = '已退款已取消'
            }
          } else {
            if (list[i].orderStatus == 'undelivery') {
              list[i].payDesc = '未发货'
            } else if (list[i].orderStatus == 'delivering') {
              list[i].payDesc = '运输中'
            } else if (list[i].orderStatus == 'reject') {
              list[i].payDesc = '已拒收'
            } else if (list[i].orderStatus == 'cancel') {
              list[i].payDesc = '已取消'
            } else if (list[i].orderStatus == 'normalSign') {
              list[i].payDesc = '正常签收'
            } else if (list[i].orderStatus == 'abnormalSign') {
              list[i].payDesc = '异常签收'
            } else if (list[i].orderStatus == 'undispatch') { //待派单
              list[i].payDesc = '待派单'
            }
          }
          _list.push(list[i]);

        }
        that.setData({
          newsList: _list,
          total: total
        })
        if (orderId && islink) {
          wx.navigateTo({
            url: '/pages/detail/detail?orderId=' + orderId,
            success: function() {
              app.globalData.isLink = false
            }
          })
        }
      }
    }).catch((res, code, header) => {
      console.log(res)
    })
  },
  onReachBottom: function() {
    let that = this
    let pageNum = this.data.pageNum
    let total = this.data.total
    let pageSize = this.data.pageSize
    let pages = Math.ceil(total / pageSize);
    if (pageNum < pages) {
      pageNum++;
      if (pageNum == (pages - 1)) {
        that.setData({
          showBottom: true
        })
      }
      that.setData({
        pageNum: pageNum
      }, () => {
        that.initList()
      })
    } else {
      wx.showToast({
        title: '亲，没有更多了'
      })

    }
  },
  onPageScroll: function(e) { // 获取滚动条当前位置
    this.data.scrollTop = e.scrollTop;
    this.clearScrollData();
  },
  clickOrder: function() {
    let pageNum = this.data.pageNum
    let pageSize = this.data.pageSize
    let scrollTop = this.data.scrollTop
    wx.setStorage({
      key: 'scroll',
      data: {
        pageNum: 0,
        pageSize: pageSize * (pageNum + 1),
        scrollTop: scrollTop
      },
    })
    app.globalData.orderId = null
  },
  clearScrollData: function() {
    wx.removeStorage({
      key: 'scroll',
      success: function(res) {},
    })
  },
  bindSort: function(e) {
    let sortShow = this.data.sortShow;
    if (sortShow) {
      this.endSort()
    } else {
      sortanimation.top('80rpx').step()
      downanimation.rotate('180').step()
      this.setData({
        sortAnimate: sortanimation.export(),
        downAnimate: downanimation.export(),
        sortShow: true
      })
    }

  },
  endSort: function() {
    sortanimation.top('-100%').step()
    downanimation.rotate('0').step()
    this.setData({
      sortAnimate: sortanimation.export(),
      downAnimate: downanimation.export(),
      sortShow: false
    })
  },
  clickBar: function(e) {
    let that = this
    let ind = e.currentTarget.dataset.index //{ order: true, logist: false }
    let status = e.currentTarget.dataset.status
    let filterList = this.data.filterList
    let left = 120 * ind
    let orderBar = this.data.orderBar
    for (let i in orderBar) {
      if (i == ind) {
        orderBar[i].isCur = true
      } else {
        orderBar[i].isCur = false
      }
    }
    if (ind == (orderBar.length - 1)) {
      filterList[0].name = '发货时间'
      filterList[0].sorttype = 'orderDate'
    } else {
      filterList[0].name = '预约发货时间'
      filterList[0].sorttype = 'maxPlanDelyDate'
    }
    wx.setStorageSync('orderBar', orderBar)
    wx.setStorageSync('status', status)
    this.setData({
      orderBar: orderBar,
      filterList: filterList,
      status: status,
      sortName:'排序',
      pageNum: 0,
      pageSize: 10,
      showBottom:false,
      scrollTop:0,
      newsList: [],
      sortList: [{
        sortColumn: 'orderDate',
        sortOrder: 'desc'
      }]
    }, () => {
      that.initList()
    })
  },
  BindSearch: function(e) {
    let that = this
    let _type = e.currentTarget.dataset.type
    let _name = e.currentTarget.dataset.name
    let sortList = this.data.sortList
    let sortCount = this.data.sortCount
    let s_type = 'asc'
    if (sortList[0].sortColumn == _type) {
      sortCount++
      if (sortCount % 2 === 1) {
        s_type = 'asc'
      } else {
        s_type = 'desc'
      }
      sortList[0].sortOrder = s_type
      sortList[0].sortColumn = _type
    } else {
      sortCount = 1
      sortList[0].sortOrder = 'asc'
      sortList[0].sortColumn = _type
    }
    if (s_type == 'desc') {
      _name += '倒序'
    } else {
      _name += '正序'
    }
    if (_type == 'clearSort') {
      _name = '排序'
      sortList[0].sortColumn = 'orderDate' //orderDate下单时间;maxPlanDelyDate 预约发货时间；
      sortList[0].sortOrder = 'desc'
    }

    this.setData({
      sortName: _name,
      sortList: sortList,
      sortCount: sortCount,
      newsList:[]
    }, function() {
      that.initList()
    })
    this.endSort()
  },
  getAccountInfo() {
    let that = this
    let userInfo = wx.getStorageSync('userInfo')
    let _orderBar = wx.getStorageSync('orderBar')
    let _status = wx.getStorageSync('status')
    let roleNameCN = userInfo.roleNameCN
    let orderBar = this.data.orderBar
    let status=''
    if (roleNameCN.indexOf('短驳') >= 0) {
      app.globalData.refutationUser = true
      app.globalData.dispatchUser = false
      status = 'deal'
      orderBar = [{
        name: '待处理',
        isCur: true,
        status: 'deal'
      }, {
          name: '已完成',
          isCur: false,
          status: 'complete'
        }]
    } else if (roleNameCN.indexOf('调度') >= 0) {
      app.globalData.dispatchUser = true
      app.globalData.refutationUser = false
      status = 'dispatch'
      orderBar = [{
        name: '待调度',
        isCur: true,
        status: 'dispatch'
      }, {
        name: '待处理',
        isCur: false,
        status: 'deal'
      }, {
        name: '已完成',
        isCur: false,
        status: 'complete'
      }]
    } else if (roleNameCN.indexOf('管理员') >= 0) {
      app.globalData.refutationUser = true
      app.globalData.dispatchUser = true
      status = 'dispatch'
      orderBar = [{
        name: '待调度',
        isCur: true,
        status: 'dispatch'
      }, {
        name: '待处理',
        isCur: false,
        status: 'deal'
      }, {
        name: '已完成',
        isCur: false,
        status: 'complete'
      }]
    }else{
      app.globalData.refutationUser = false
      app.globalData.dispatchUser = false
      status = 'deal'
      orderBar = [{
        name: '待处理',
        isCur: true,
        status: 'deal'
      }, {
        name: '已完成',
        isCur: false,
        status: 'complete'
      }]
    }
    if (_orderBar){
      orderBar = _orderBar
    }
    if (_status){
      status = _status
    }
    that.setData({
      orderBar: orderBar,
      status: status
    }, () => {
      
    })

  }
}),{"enablePullDownRefresh": true},<view class="container">
  <view class='headNav weui-flex'>
    <view class='weui-flex_item orderBar'>
      <text wx:for='{{orderBar}}' wx:key='' bindtap='clickBar' data-index='{{index}}' data-status='{{item.status}}' class='{{item.isCur?"blue":""}}'>{{item.name}}</text>
      <!-- <view class='line' animation="{{lineAnimate}}"></view> -->
    </view>
    <view class='oper weui-flex_cente' bindtap='bindSort'>
      <text>{{sortName}}</text>
      <image src='/images/Down.png' mode='widthFix' animation="{{downAnimate}}"></image>
    </view>
  </view>
  <block wx:if="{{newsList.length>0}}">
    <view class="news_mod" wx:for="{{newsList}}" wx:key="{{item.id}}">
      <view class="news_time">
        <text>{{item.orderDate}}</text>
      </view>
      <navigator url='/pages/detail/detail?orderId={{item.id}}' bindtap='clickOrder'>
        <view class='upper'>
          <view class='weui-flex title'>
            <view class='weui-flex_item'>物流单号:{{item.orderNo}}</view>
            <view class='right'> {{item.enterpriseName}} </view>
          </view>
          <view class='weui-flex weui-flex_center'>
            <view class='weui-flex_item'>
              <view class="{{item.orderStatus=='undelivery'?'red_c':''}}">
                <block wx:if="{{item.orderStatus=='undispatch'||item.orderStatus=='undelivery'||item.orderStatus=='reject'||item.orderStatus=='cancel'}}">预约发货时间:{{item.planDelyDate}}</block>
                <block wx:else>发货时间:{{item.delyDate}}</block>
              </view>
              <view>
                <block wx:if="{{item.orderStatus=='undispatch'||item.orderStatus=='undelivery'||item.orderStatus=='delivering'}}">预估到货时间:{{item.planArriveDate}}</block>
                <block wx:elif="{{item.orderStatus=='reject'||item.orderStatus=='cancel'}}">预估到货时间: - -</block>
                <block wx:else>到货时间:{{item.arriveDate}}</block>
              </view>
            </view>
            <view class='right'>
              <view class='state state_{{item.orderStatus}}'>
                <icon class="iconfont icon-{{item.orderStatus}}"></icon>
                <view class='text'>
                  <text wx:if='{{item.paymentStatus=="unpaid"&&item.orderStatus!="wait"}}' class='c666'>未支付</text>
                  <text>{{item.payDesc}}</text>
                </view>
                <view class='unpay' wx:if='{{item.balanceAmt>0&&item.paymentStatus=="paid"}}'>
                  <image src='/images/unpay.png' mode='widthFix'></image>
                </view>
              </view>
            </view>
          </view>
          <view class='weui-flex weui-flex_center' wx:if='{{item.orderStatus!="undispatch"&&item.consignor}}'>
            <view class='weui-flex_item'>
              发货人:{{item.consignor}}{{item.consignorContactNo?'('+item.consignorContactNo+')':''}}
            </view>
            <view class='right'>
            </view>
          </view>
          <view class='weui-flex weui-flex_center' wx:if='{{item.orderStatus=="reject"}}'>
            <view class='weui-flex_item red_c'>
              拒收理由:{{item.rejectReason}}
            </view>
            <view class='right'>

            </view>
          </view>
          <view class='weui-flex weui-flex_center' wx:if='{{item.orderStatus!="undispatch"&&item.orderStatus!="undelivery"&&item.orderStatus!="reject"&&item.orderStatus!="cancel"}}'>
            <view class='weui-flex_item'>
              运单号:{{item.deliveryNo}}
            </view>
            <view class='right'>
              ￥{{item.logisticAmt}}
            </view>
          </view>
        </view>
        <view class='lower'>
          <view class='weui-flex' wx:if='{{item.orderStatus!="undispatch"}}'>
            <view>
              <icon class="iconfont icon-zuobiao"></icon>
              收货地址:
            </view>
            <view class='weui-flex_item'>
              {{item.recvAddrDescr}}
            </view>
          </view>
          <view class='weui-flex'>
            <view>
              <icon class="iconfont icon-fa-truck"></icon>
              物流信息:
            </view>
            <view class='weui-flex_item'>
              {{item.speciallineFromName}}
              <icon class="iconfont icon-zhi"></icon> {{item.speciallineToName}}
            </view>
          </view>
          <view class='weui-flex'>
            <view>
              <icon class="iconfont icon-wupin"></icon>
              物品信息:
            </view>
            <view class='weui-flex_item'>
              {{item.goodsMsg}}
            </view>
          </view>
        </view>
      </navigator>
    </view>
  </block>
  <block wx:else>
    <view wx:if="{{showNoImg}}" class="noList">
      <image src='/images/noData.png' mode='aspectFit'></image>
    </view>
  </block>
  <view class="noMore" wx:if="{{showBottom}}"></view>
</view>
<view class="sortMod weui-flex weui-flex-col" animation="{{sortAnimate}}">
  <view class='sortList'>
    <view wx:for="{{filterList}}" hover-class='touch' wx:key="" bindtap='BindSearch' data-type='{{item.sorttype}}' data-name='{{item.name}}'>
      <text>{{item.name}}</text>
    </view>
  </view>
  <view bindtap='endSort' class='weui-flex_item'></view>
</view>,.container {
  padding-top: 50px;
}
.headNav{
  position: fixed;
  width: 100%;
  top:0;
  height:42px;
  line-height: 42px;
  background: #fff;
  border-bottom: 1px solid #EFEFF4;
  color:#00A6F5;
  padding-left:20rpx;
  z-index: 10
}
.headNav .orderBar{
  position: relative;
}
.headNav .orderBar text{
  display: inline-block;
  width: 120rpx;
  line-height: 36px;
  color:#666;
  text-align: center;
  border-bottom:2px solid #fff;
}
.headNav .orderBar text.blue{
  border-color:#00A6F5;
}
.headNav .orderBar .line{
  width: 120rpx;
  position: absolute;
  height:2px;
  background: #00A6F5;
  left:0;
  bottom:0;
}
.headNav .oper{
  margin-right:20rpx;
  font-size:24rpx;
}
.headNav .oper text{
  display: inline-block;
}
.headNav .oper image{
  display: inline-block;
  width: 24rpx;
  vertical-align: middle;
  margin:0 0 0 10rpx;
}

.news_mod navigator {
  display: block;
  margin: 0 20rpx 20rpx;
  background: #fff;
  border-radius: 0.2em;
  box-shadow: 0 0 10rpx rgba(0, 0, 0, 0.2);
  color: #666;
  font-size:24rpx;
}

.news_mod .news_time {
  text-align: center;
  padding: 20rpx 0;
}

.news_mod .news_time text {
  display: inline-block;
  padding: 0.6rpx 20rpx;
  background: #cfcfcf;
  color: #fff;
  font-size: 24rpx;
  border-radius: 0.2em;
}

.news_mod .upper {
  padding: 20rpx 20rpx 10rpx;
  border-bottom: 1px solid #e5e5e5;
}

.news_mod .upper .title {
  font-size: 28rpx;
  color: #444;
}

.news_mod .upper .right {
  padding-left: 20rpx;
  position: relative;
}

.news_mod .upper .weui-flex_item {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.news_mod .upper .right .state {
  display: inline-block;
  height: 48rpx;
  line-height: 48rpx;
  font-size: 22rpx;
  border-radius: 48rpx;
}

.news_mod .upper .right .state icon {
  position: relative;
  float:left;
  margin-left:6rpx;
  height: 40rpx;
  width: 40rpx;
  margin-top:4rpx;
  font-size: 22rpx;
  overflow: hidden;
  color: #fff;
  border-radius: 40rpx;
  background: #999;
  text-align: center;
}

.news_mod .upper .right .state icon::before {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  line-height: 40rpx;
}

.news_mod .upper .right .state > .text {
  padding: 0 20rpx;
  min-width: 100rpx;
  float:left;
}

.news_mod .upper .right .state_undelivery {
  border-color: #e5f6dd;
  background: #e5f6dd;
  color: #52c41a;
}

.news_mod .upper .right .state_undelivery icon {
  background: #52c41a;
}

.news_mod .upper .right .state_reject,.news_mod .upper .right .state_cancel {
  border-color: #fff2d9;
  background: #fff2d9;
  color: #fa0;
}

.news_mod .upper .right .state_reject icon,.news_mod .upper .right .state_cancel icon {
  background: #fa0;
}

.news_mod .upper .right .state_delivering {
  border-color: #ddefff;
  background: #ddefff;
  color: #00a6f5;
}

.news_mod .upper .right .state_delivering icon {
  background: #00a6f5;
}

.news_mod .upper .right .state_normalSign {
  border-color: #f6f6f6;
  background: #f6f6f6;
  color: #666;
}

.news_mod .upper .right .state_normalSign icon {
  background: #bfbfbf;
}

.news_mod .upper .right .state_abnormalSign {
  border-color: #fedee0;
  background: #fedee0;
  color: #f5222d;
}

.news_mod .upper .right .state_abnormalSign icon {
  background: #f5222d;
}
.news_mod .upper .right .state_undispatch{
  border-color: #DDEFFF;
  background: #DDEFFF;
  color:#2E77EE;
}
.news_mod .upper .right .state_undispatch icon{
  background: #4A83FF
}
.news_mod .upper .right .state_wait{
  border-color: rgba(171, 149, 29, 0.3);
  background: rgba(171, 149, 29, 0.3);
  color: #ab951d;
}
.news_mod .upper .right .state_wait icon{
    background: #ab951d;
  color: #fff;
}
.news_mod .lower {
  padding: 10rpx 20rpx 20rpx;
}
.news_mod .lower icon {
  font-size: 28rpx;
  position: relative;
  height: 36rpx;
  width: 36rpx;
  text-align: center;
  overflow: hidden;
}

.news_mod .lower .iconfont::before {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  line-height: 36rpx;
}
.noMore{
  text-align: center;
  padding:40rpx 0;
  color:#999;
}
.noList{
  text-align: center;
  padding-top:30%;
  color:#666;
}
.noList image{
  width: 30%;
  max-width: auto;
}
.sortMod{
  position: fixed;
  width: 100%;
  height:calc(100% - 80rpx);
  background: rgba(0,0,0,0.3);
  top:-100%;
  z-index: 5;
}
.sortList{
  background: #fff;
  font-size:24rpx;
}
.sortList view{
  padding:20rpx;
  color:#393939;
  border-bottom:1px solid #f2f2f2;
}
.sortList .touch{
  background: #f6f6f6;
}
.blue{
  color:#00A6F5 !important;
}
.right .unPay{
  position: absolute;
  right:0;
}
.right .unPay image{
  width: 120rpx;
},const app = getApp()
const httpHelper = require('../../utils/httpHelper.js');
const api = require('../../api.js')

Page({
  data: {
    newsDetail: {},
    orderId: 0,
    pageSize:10,
    pageNum:1,
    datapage:10,
    refutationUser:false,
    dispatchUser:false,
    sendtel:'',
    gettel:'',
    pickInd:0,
    addresList: [],
    shortUser: [],
    userList:[]
  },
  onLoad: function(options) {
    let refutationUser = app.globalData.refutationUser
    let dispatchUser = app.globalData.dispatchUser
    if (refutationUser) {
      refutationUser = true
    }
    if (dispatchUser){
      dispatchUser=true
    }
    this.setData({
      orderId: options.orderId ? options.orderId : 0,
      refutationUser: refutationUser,
      dispatchUser: dispatchUser
    })
  },
  onReady: function() {

  },
  onShow: function() {
    this.initData()
    
  },
  onUnload:function(){
    app.globalData.isLink =false
    app.globalData.orderId = null
  },
  onReachBottom:function(){
    let pageSize = this.data.pageSize
    let addresList = this.data.addresList
    let pageNum = this.data.pageNum
    let len = addresList.length
    let datapage=0
    let totalPage = Math.ceil(len / pageSize)
    if (pageNum < totalPage){
      pageNum++
      datapage = pageSize * pageNum
      this.setData({
        datapage: datapage,
        pageNum: pageNum
      })
    }else{
       wx.showToast({
         title: '没有更多地址了',
       })
    } 
  },
  getShortList:function(){
    let that=this
    let newsDetail = this.data.newsDetail
    let userList=[]
    let ind=0
    httpHelper.ajax({
      url: api.getShortList +'ShortRefutation',
      method:'POST'
    }).then((res) => {
      console.log(res)
      let _data = res.data.data
      if (_data.length>0){
        for (let i in _data){
          userList.push(_data[i].name)
          if (_data[i].userId == newsDetail.shortUserId){
            ind=i
          }else{

          }
        }
      }
      that.setData({
        shortUser: _data,
        userList: userList,
        pickInd:ind
      })
    }).catch((error)=>{

    })
  },
  updateShortUser:function(){
    let that=this    
    let newsDetail = this.data.newsDetail
    let shortUser = this.data.shortUser
    let pickInd = this.data.pickInd
    let pamars={
      shortUserId: shortUser[pickInd].userId,
      orderIdList: [newsDetail.id]
    }
    if (!newsDetail.shortUserId){
      wx.showToast({
        title: '请选择短驳人员',
        icon:'none'
      })
      return
    }
    httpHelper.ajax({
      url: api.shortUser,
      data:pamars,
      method: 'post',
    }).then((res) => {
      if (res.data.errorCode==0){
        wx.showToast({
          title: '调度成功',
        })
        setTimeout(()=>{
          wx.navigateBack({})
        },1500)
        //that.initData()
      }
    }).catch((error) => {
      
    })
  },
  editPrice: function(e) {
    let _data = e.currentTarget.dataset
    let price = _data.price
    let id = _data.id
    wx.navigateTo({
      url: 'editPrice/editPrice?price=' + price + '&id=' + id,
    })

  },
  rejection: function(e) {
    let _data = e.currentTarget.dataset
    let id = _data.id
    wx.navigateTo({
      url: 'rejection/rejection?id=' + id,
    })
  },
  deliverGoods: function(e) {
    let _data = e.currentTarget.dataset
    let id = _data.id
    wx.navigateTo({
      url: 'deliver/deliver?id=' + id,
    })
  },
  abnormal: function(e) {
    let _data = e.currentTarget.dataset
    let id = _data.id
    wx.showModal({
      title: '提示',
      content: '确认该物流单为异常签收',
      success: (res) => {
        if (res.confirm) {
          this.changeSatus(id, 'abnormalSign')
        }
      }
    })
  },
  normal: function(e) {
    let _data = e.currentTarget.dataset
    let id = _data.id
    wx.showModal({
      title: '提示',
      content: '确认该物流单为正常签收',
      success: (res) => {
        if (res.confirm) {
          this.changeSatus(id, 'normalSign')
        }
      }
    })
  },
  initData: function() {
    let that = this
    let orderId = that.data.orderId
    httpHelper.ajax({
      url: api.newsDetail + orderId + '/get',
    }).then((res) => {
      console.log(res)
      if (res.data.errorCode == 0) {
        let detail = res.data.data
        let goodMsg = ''
        let planDelyDate = detail.detailVO.planDelyDate ? detail.detailVO.planDelyDate : '' //预约发货
        let planArriveDate = detail.detailVO.planArriveDate ? detail.detailVO.planArriveDate : '' //预约到货
        let delyDate = detail.delyDate ? detail.delyDate : '' //发货
        let arriveDate = detail.arriveDate ? detail.arriveDate : '' //到货
        let timeRange = detail.detailVO.timeRange
        let maxPlanDelyDate = detail.detailVO.maxPlanDelyDate
        let _day = maxPlanDelyDate.substr(0, 10)
        if (timeRange == '-1') {
          planDelyDate = '2小时上门'
        } else {
          planDelyDate = _day + ' ' + timeRange
        }
        planArriveDate = planArriveDate.substr(0, (planArriveDate.length - 3))
        delyDate = delyDate.substr(0, (delyDate.length - 3))
        arriveDate = arriveDate.substr(0, (arriveDate.length - 3))
        detail.detailVO.planDelyDate = planDelyDate
        detail.detailVO.planArriveDate = planArriveDate
        detail.delyDate = delyDate
        detail.arriveDate = arriveDate
        let goods = detail.detailVO
        let goodsName = goods.goodsName ? goods.goodsName + '，' : ''
        let goodsType = goods.goodsType ? goods.goodsType == 'light' ? "抛货，" : '重货，' : ''
        let goodsQty = goods.goodsQty ? goods.goodsQty + '箱，' : ''
        let goodsWeight = goods.goodsWeight ? goods.goodsWeight + '吨，' : ''
        let goodsVolume = goods.goodsVolume ? goods.goodsVolume + 'm³，' : ''
        goodMsg = goodsName + goodsType + goodsQty + goodsWeight + goodsVolume
        goodMsg = goodMsg.substr(0, (goodMsg.length - 1))
        detail.goodsMsg = goodMsg
        if (detail.orderStatus == 'wait') {
          detail.payDesc = '草稿'
        }
        if (detail.paymentStatus == 'paid') {
          if (detail.orderStatus == 'undelivery') {
            detail.payDesc = '已支付未发货'
          } else if (detail.orderStatus == 'delivering') {
            detail.payDesc = '已支付运输中'
          } else if (detail.orderStatus == 'reject') {
            detail.payDesc = '已支付已拒收'
          } else if (detail.orderStatus == 'cancel') {
            detail.payDesc = '已支付已取消'
          } else if (detail.orderStatus == 'normalSign') {
            detail.payDesc = '已支付正常签收'
          } else if (detail.orderStatus == 'abnormalSign') {
            detail.payDesc = '已支付异常签收'
          } else if (detail.orderStatus == 'undispatch') {//待派单
            detail.payDesc = '已支付待派单'
          }
        } else if (detail.paymentStatus == 'refund') {
          if (detail.orderStatus == 'reject') {
            detail.payDesc = '已退款已拒收'
          } else if (detail.orderStatus == 'cancel') {
            detail.payDesc = '已退款已取消'
          }
        } else {
          if (detail.orderStatus == 'undelivery') {
            detail.payDesc = '未发货'
          } else if (detail.orderStatus == 'delivering') {
            detail.payDesc = '运输中'
          } else if (detail.orderStatus == 'reject') {
            detail.payDesc = '已拒收'
          } else if (detail.orderStatus == 'cancel') {
            detail.payDesc = '已取消'
          } else if (detail.orderStatus == 'normalSign') {
            detail.payDesc = '正常签收'
          } else if (detail.orderStatus == 'abnormalSign') {
            detail.payDesc = '异常签收'
          } else if (detail.orderStatus == 'undispatch') {//待派单
            detail.payDesc = '待派单'
          }
        }
        let sendtels = detail.detailVO.consignorContactNo
        let gettels = detail.detailVO.consigneeContactNo
        sendtels = sendtels.split(/[\s\,\，\;]+/);
        gettels = gettels.split(/[\s\,\，\;]+/);
        let addrList=[]
        let lineVOList = detail.enterpriseVO.enterpriseSpeciallineVOList[0].enterpriseSpeciallineLoadVOList
        if (lineVOList.length>0){
          for (let i = 0; i < lineVOList.length; i++) {
            lineVOList[i].addressVO.contactNo = lineVOList[i].contactNo
            addrList.push(lineVOList[i].addressVO)
          }
        }
        that.setData({
          newsDetail: detail,
          sendtel: sendtels[0],
          gettel: gettels[0],
          addresList: addrList
        },function(){
          that.getShortList()
        })
      } else {
        wx.showModal({
          title: '提示',
          content: res.data.errorMsg,
          success: (res) => {
            if (res.confirm) {
              wx.navigateBack({})
            }
          }
        })
      }
    }).catch((res, code, header) => {
      console.log(res)
    })
  },
  changeSatus: function(id, statu) {
    let that = this
    let name = ''
    let data = {
      id: id,
      orderStatus: statu
    }
    if (statu == 'normalSign') {
      name = "正常"
    } else {
      name = "异常"
    }

    httpHelper.ajax({
      url: api.updateNews,
      data: data,
      method: 'post'
    }).then((res) => {
      console.log(res)
      if (res.data.errorCode == 0) {
        wx.showToast({
          title: name + '签收成功',
          icon: 'none'
        })
        that.initData()
      }
    }).catch((res, code, header) => {
      
    })
  },
  sendNews: function() {
    let orderId = this.data.orderId
    httpHelper.ajax({
      url: api.testNews,
      data: {
        openid: 'oTS7ZwJd_pmqW7Sx8WdmZPbinrgY',
        pagepath: "pages/index/index?id=" + orderId,
        isPagePath:'0'
      },
      method: 'post'
    }).then((res) => {
      console.log(res)
      if (res.data.errorCode == 0) {
        wx.showToast({
          title: '发送成功',
        })
      }
    }).catch((res, code, header) => {
      console.log(res)
    })
  },
  dial:function(e){
    let phone = e.currentTarget.dataset.phone;
    phone = phone.replace(/\s+/g, "")
    wx.makePhoneCall({
      phoneNumber: phone,
    })
  },
  bindDispatchChange:function(e){
     let ind=e.detail.value
     let shortUser = this.data.shortUser
    let newsDetail = this.data.newsDetail
     let that=this
    newsDetail.shortUserId = shortUser[ind].userId
     //请求调拨接口
     this.setData({
       pickInd:ind,
       newsDetail:newsDetail
     })
  }
}),{},<view class="container">
  <view class='model upper'>
    <view class='weui-flex title'>
      <view class='weui-flex_item'>物流单号:{{newsDetail.orderNo}}</view>
      <view class='right'>{{newsDetail.enterpriseVO.name}}</view>
    </view>
    <view class='weui-flex weui-flex_center'>
      <view class='weui-flex_item'>
        <view class="{{newsDetail.orderStatus=='undelivery'?'red_c':''}}">
          <block wx:if="{{newsDetail.orderStatus=='undispatch'||newsDetail.orderStatus=='undelivery'||newsDetail.orderStatus=='reject'||newsDetail.orderStatus=='cancel'}}">预约发货时间:{{newsDetail.detailVO.planDelyDate}}</block>
          <block wx:else>发货时间:{{newsDetail.delyDate}}</block>
        </view>
        <view>
          <block wx:if="{{newsDetail.orderStatus=='undispatch'||newsDetail.orderStatus=='undelivery'||newsDetail.orderStatus=='delivering'}}">预估到货时间:{{newsDetail.detailVO.planArriveDate}}</block>
          <block wx:elif="{{newsDetail.orderStatus=='reject'||newsDetail.orderStatus=='cancel'}}">预估到货时间: - -</block>
          <block wx:else>到货时间:{{newsDetail.arriveDate}}</block>
        </view>
      </view>
      <view class='right'>
        <view class='state state_{{newsDetail.orderStatus}}'>
          <icon class="iconfont icon-{{newsDetail.orderStatus}}"></icon>
          <view class='text'>
            <text wx:if='{{newsDetail.paymentStatus=="unpaid"&&newsDetail.orderStatus!="wait"}}' class='c666'>未支付</text>
            <text>{{newsDetail.payDesc}}</text>
          </view>
        </view>
        <view class='unPay' wx:if='{{newsDetail.balanceAmt>0&&newsDetail.paymentStatus=="paid"}}'>
          <image mode='widthFix' src='/images/unpay.png'></image>
        </view>
      </view>
    </view>
    <view class='weui-flex red_c' wx:if='{{newsDetail.orderStatus=="reject"}}'>
      <view class=''>
        拒收理由:
      </view>
      <view class='weui-flex_item reason'>
        {{newsDetail.rejectReason}}
      </view>
    </view>
    <view class='weui-flex weui-flex_center' wx:if='{{newsDetail.orderStatus!="undispatch"&&newsDetail.orderStatus!="undelivery"&&newsDetail.orderStatus!="reject"&&newsDetail.orderStatus!="cancel"}}'>
      <view class='weui-flex_item'>
        运单号:{{newsDetail.deliveryNo}}
      </view>
      <block wx:if='{{newsDetail.orderStatus=="delivering"&&refutationUser}}'>
        <view class='right' bindtap='editPrice' data-id='{{newsDetail.id}}' data-price='{{newsDetail.logisticAmt}}'>
          ￥{{newsDetail.logisticAmt}}
          <icon class="iconfont icon-edit"></icon>
        </view>
      </block>
      <block wx:else>
        ￥{{newsDetail.logisticAmt}}
      </block>
    </view>
  </view>
  <view class='model'>
    <view class='weui-flex fs14'>
      <view>
        物品信息:
      </view>
      <view class='weui-flex_item'>
        {{newsDetail.goodsMsg}}
      </view>
    </view>
    <view class='c999'>{{newsDetail.detailVO.remark}}</view>
  </view>
  <view class='model route'>
    <view class="fs14">运输路线</view>
    <view class="weui-flex">
      <view class='text'>
        <!-- <text class='blue'>发</text> -->
        <image src='/images/send2x.png' mode='aspectFit'></image>
        <view class='line'></view>
      </view>
      <view class='weui-flex_item'>
        <view class='name fs13'>{{newsDetail.detailVO.consignor}}{{newsDetail.detailVO.consignorContactNo?'('+newsDetail.detailVO.consignorContactNo+')':''}}</view>
        <view class='address fs12'>地址:{{newsDetail.detailVO.delyAddressVO.province}}{{newsDetail.detailVO.delyAddressVO.city}}{{newsDetail.detailVO.delyAddressVO.district}}{{newsDetail.detailVO.delyAddressVO.addressDetail}}</view>
      </view>
      <view class='call weui-flex_center' bindtap='dial' data-phone='{{sendtel}}'>
        <image src='/images/call.png' mode='widthFix'></image>
      </view>
    </view>
    <view class="weui-flex">
      <view class='text'>
        <!-- <text class='yellow'>收</text> -->
        <image src='/images/get2x.png' mode='aspectFit'></image>
      </view>
      <view class='weui-flex_item'>
        <view class='name fs14'>{{newsDetail.detailVO.consignee}}（{{newsDetail.detailVO.consigneeContactNo}}）</view>
        <view class='address fs12'>地址:{{newsDetail.detailVO.recvAddressVO.province}}{{newsDetail.detailVO.recvAddressVO.city}}{{newsDetail.detailVO.recvAddressVO.district}}{{newsDetail.detailVO.recvAddressVO.addressDetail}}</view>
        <view class='distance c999'>距离送货地址
          <text class='yellow_c'>{{newsDetail.detailVO.distance?newsDetail.detailVO.distance:0}}km</text>
        </view>
      </view>
      <view class='call weui-flex_center' bindtap='dial' data-phone='{{gettel}}'>
        <image src='/images/call.png' mode='widthFix'></image>
      </view>
    </view>
  </view>
  <view class='model' wx:if='{{newsDetail.recvAddr}}'>
    目的地:{{newsDetail.recvAddr}}
  </view>
  <view class='addressList' wx:if='{{addresList.length>0}}'>
    <view class='title'>发货地址列表({{addresList.length}})</view>
    <view class='list' wx:for='{{addresList}}' wx:key='' wx:if='{{index<datapage}}'>
      地址{{index+1}}：{{item.fullAddress}}{{item.contactNo?'(电话:'+item.contactNo+')':''}}
    </view>
  </view>
  <view class='weui-flex chooseP' wx:if="{{dispatchUser&&newsDetail.orderStatus=='undelivery'||newsDetail.orderStatus=='undispatch'}}">
    <view class=''>短驳人员</view>
    <picker class='weui-flex_item weui-flex_center' bindchange="bindDispatchChange" value="{{pickInd}}" range="{{userList}}">
      <view class="picker fs12 right">
        <input wx:if='{{newsDetail.shortUserId}}' placeholder='请选择短驳人员' disabled='disabled' value='{{userList[pickInd]}}'></input>
        <input wx:else placeholder='请选择短驳人员' value='' disabled='disabled'></input>
      </view>
    </picker>
  </view>
  <view class='footBtn weui-flex' wx:if='{{refutationUser||dispatchUser}}'>
    <block wx:if="{{refutationUser}}">
      <block wx:if="{{newsDetail.orderStatus=='undelivery'}}">
        <button class="weui-flex_item" data-id="{{newsDetail.id}}" type="bluenull" bindtap='rejection'>拒收</button>
        <button class="weui-flex_item" data-id="{{newsDetail.id}}" type="blue" bindtap='deliverGoods'>发货</button>
      </block>
      <block wx:elif="{{newsDetail.orderStatus=='delivering'}}">
        <button class="weui-flex_item" data-id="{{newsDetail.id}}" type="bluenull" bindtap='abnormal'>异常签收</button>
        <button class="weui-flex_item" data-id="{{newsDetail.id}}" type="blue" bindtap='normal'>正常签收</button>
      </block>
    </block>
    <block wx:if='{{dispatchUser&&newsDetail.orderStatus=="undelivery"||newsDetail.orderStatus=="undispatch"}}'>
      <button class="weui-flex_item" bindtap='updateShortUser' data-id="{{newsDetail.id}}" type="blue">调度</button>
    </block>
  </view>
</view>,.container {
  padding: 20rpx 0 140rpx;
}

.model {
  background: #fff;
  border-bottom: 1px solid #e5e5e5;
  font-size:24rpx;
}

.model:last-child {
  border-bottom: 0;
}

.model {
  padding: 20rpx 24rpx;
}

.upper {
  color: #666;
}
.name{
  word-break: break-all;
}

.model .title {
  font-size: 28rpx;
  color: #444;
}

.model .right {
  padding-left: 20rpx;
  position: relative;
}

.model .ellipsis {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.model .reason{
  word-break: break-all;
}

.model .right .state {
  display: inline-block;
  height: 48rpx;
  line-height: 48rpx;
  font-size: 22rpx;
  border-radius: 48rpx;
}

.model .right .state icon {
  position: relative;
  float:left;
  margin:4rpx 0 0 6rpx;
  height: 40rpx;
  width: 40rpx;
  font-size: 20rpx;
  overflow: hidden;
  color: #fff;
  border-radius: 40rpx;
  background: #999;
  text-align: center;
}

.model .right .state icon::before {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  line-height: 40rpx;
}

.model .right .state > .text {
  float:left;
  padding: 0 20rpx;
}

.model .right .state_undelivery {
  border-color: #e5f6dd;
  background: #e5f6dd;
  color: #52c41a;
}

.model .right .state_undelivery icon {
  background: #52c41a;
}

.model .right .state_reject,.model .right .state_cancel {
  border-color: #fff2d9;
  background: #fff2d9;
  color: #fa0;
}

.model .right .state_reject icon,.model .right .state_cancel icon {
  background: #fa0;
}

.model .right .state_delivering {
  border-color: #ddefff;
  background: #ddefff;
  color: #00a6f5;
}

.model .right .state_delivering icon {
  background: #00a6f5;
}

.model .right .state_normalSign {
  border-color: #f6f6f6;
  background: #f6f6f6;
  color: #666;
}

.model .right .state_normalSign icon {
  background: #bfbfbf;
}

.model .right .state_abnormalSign {
  border-color: #fedee0;
  background: #fedee0;
  color: #f5222d;
}
.model .right .state_abnormalSign icon {
  background: #f5222d;
}
.model .right .state_undispatch{
  border-color: #DDEFFF;
  background: #DDEFFF;
  color:#2E77EE;
}
.model .right .state_undispatch icon{
  background: #4A83FF
}
.model .right .state_wait{
  border-color: rgba(171, 149, 29, 0.3);
  background: rgba(171, 149, 29, 0.3);
  color: #ab951d;
}
.model .right .state_wait icon{
  background: #ab951d;
  color: #fff;
}

.model .right .icon-edit {
  height: 40rpx;
  width: 40rpx;
  position: relative;
  overflow: hidden;
  font-size: 28rpx;
  color:#00a6f5;
}

.model .right .icon-edit::before {
  position: absolute;
  top: 50%;
  margin-top:-20rpx;
  left: 0;
}
.route .weui-flex{
    margin-top:20rpx;
}
.route .text{
  width: 100rpx;
  height:50rpx;
  background: #fff;
  position: relative;
}
.route .text image{
  width: 36rpx;
  height:44rpx;
  margin-left:20rpx;
}
/* .route text{
  display: inline-block;
   width: 30rpx;
   height:30rpx;
   border-radius: 30rpx;
   line-height: 30rpx;
   text-align: center;
   font-size:20rpx;
   color:#fff;
   margin-left:20rpx;
} */
.route .address{
  white-space:normal;
  word-break: break-all;
}
.route text.blue{
  background: #00a6f5;
}
.route text.yellow{
  background: #fa0;
}
.route .line{
   position: absolute;
   width: 1px;
   background: #e5e5e5;
   height:100%;
   left:36rpx;
   top:100%;
}
.call image{
  width: 40rpx;
  margin-left:20rpx;
  vertical-align: middle;
}
.addressList{
  margin-top:24rpx;
  background: #fff;
  padding-left:20rpx;
}
.addressList .title{
  padding:20rpx 0 0;
}
.addressList .list{
  border-bottom:1px solid #EFEFF4;
  font-size:24rpx;
  padding:20rpx 0;
}
.footBtn{
  background: #fff;
  box-shadow: -2px -2px 5px rgba(0,0,0,0.1);
}
.footBtn picker{
  position: absolute;
  height:100%;
  width: 100%;
  opacity: 0;
}
.footBtn .picker{
  height:100rpx;
}
.right .unPay{
  position: absolute;
  right:0;
  top:120rpx;
}
.right .unPay image{
  width: 120rpx;
}
.chooseP{
  background: #fff;
  margin-top:20rpx;
  padding:0 20rpx;
  line-height:80rpx;
}
.chooseP .right{
  text-align: right;
},const httpHelper = require('../../utils/httpHelper.js');
const api = require('../../api.js')
const app = getApp()
Page({
  data: {
     code:'',
     userAccount:'',
     userPass:''
  },
  onLoad: function (options) {
    let code = options.code
    let that = this
    if(code){
      this.setData({
         code:code
      })
      that.formsubmit();
    }else{
      wx.redirectTo({
        url: '/pages/weblogin/weblogin',
      })
    }
    // wx.getStorage({
    //   key: 'loginInfo',
    //   success: function(res) {
    //     console.log(res)
    //     let data=res.data;
    //     that.setData({
    //       userAccount: data.account,
    //       userPass: data.pass
    //       });
        
    //   },
    // })
    //判断当前是否有orderId存在
    let orderId = app.globalData.orderId
    console.log("login:" + orderId)
    if (orderId) {
      app.globalData.isLink = true
    }
    
  },
  onReady: function () {

  },
  onShow: function () {

  },
  onHide: function () {
    
  },
  onUnload:function(){
    
  },
  formsubmit: function (e) {
    let Account = this.data.userAccount
    let Password = this.data.userPass
    let loginType ='WEIXIN_OPENID'
    let showMsg=false;
    if(e){
      showMsg=true
      loginType = 'USERNAME_PASSWORD'
      Account = e.detail.value.account
      Password = e.detail.value.pass
    }
    let that=this
    httpHelper.ajax({
      url: api.login,
      method: 'post',
      addToken:false,
      showMsg: showMsg,
      data: {
        loginType: loginType,
        password: Password,
        username: Account,
        weixinCode: that.data.code
      }
    }).then((res) => {
      var _data = res.data
      if (_data.errorCode == 0) {
        console.log(res)
        wx.setStorageSync('token', _data.data)
        app.globalData.token = _data.data
        httpHelper.ajax({
          url: api.userInfo
        }).then((res) => {
          console.log(res)
          if (res.data.errorCode == 0) {
            let _data = res.data.data
            wx.setStorageSync('userInfo', _data);
            app.globalData.userInfo = _data
            wx.switchTab({
              url: '/pages/index/index',
            }, 300)
          }
        }).catch((res, code, header) => {

        })
        
      } else if (_data.errorCode == '500' && showMsg) {
        wx.showModal({
          title: '提示',
          content: _data.errorMsg,
          success:(res)=>{
            wx.redirectTo({
              url: '/pages/weblogin/weblogin',
            })
          }
        })
      }
    }).catch((res, code, header) => {
      console.log(res)
    })
  }
}),{"navigationBarTitleText": "登录"},<!--pages/login/login.wxml-->
<view class="container">
  <form bindsubmit='formsubmit'>
    <view class="login_mod">
      <view class="form">
        <view class="name">用户名</view>
        <view class="input">
          <input type='text' placeholder='请输入用户名' name='account' value='{{userAccount}}'></input>
        </view>
      </view>
      <view class="form">
        <view class="name">密码</view>
        <view class="input">
          <input type='text' password='true' placeholder='请输入登录密码' name='pass' value='{{userPass}}'></input>
        </view>
      </view>
    </view>
    <view class='getpass'>
    <!-- <navigator url='/pages/getPass/getPass'>忘记密码?</navigator> -->
    </view>
    <view class='btnBox'>
            <button type='blue' form-type='submit'>登录</button>
    </view>
  </form>

</view>,
form{
  display: block;
  padding-top:20rpx;
}
.login_mod{
  background: #fff;
  padding-left:24rpx;
}
.form{
  display: flex;
  justify-content: center;
  line-height: 80rpx;
  border-bottom:1px solid #e5e5e5;
}
.form:last-child{
  border-bottom:0;
}
.form .name{
  width: 120rpx;
}
.form .input{
  flex-grow: 1;
}
.form .input input{
  height:80rpx;
  line-height: 80rpx;
}
.getpass{
  font-size:24rpx;
  margin-top:20rpx;
  text-align: right;
  padding:0 40rpx;
  color:#00a6f5;
}
.getpass navigator{
  display: inline-block;
  background: none !important;
},const httpHelper = require('../../utils/httpHelper.js');
const api = require('../../api.js')
const app = getApp()
Page({
  data: {
    code: '',
    userAccount: '',
    userPass: ''
  },
  onLoad: function (options) {
    // let code = options.code
    //判断当前是否有orderId存在
    let that = this
    let orderId = app.globalData.orderId
    console.log("login:" + orderId)
    if (orderId) {
      app.globalData.isLink = true
    }
    //直接使用微信code登陆
    wx.login({
      success: function (res) {
        that.data.code = res.code;
        httpHelper.ajax({
          url: api.login,
          method: 'post',
          addToken: false,
          showMsg: false,
          data: {
            loginType: 'WEIXIN_OPENID',
            weixinCode: res.code
          }
        }).then(res => {
          that.getuserInfo(res);
        }).catch(e => {

        })
      }
    })
  },
  getuserInfo(data) {
    var _data = data.data
    if (_data.errorCode == 0) {
      console.log(data)
      wx.setStorageSync('token', _data.data)
      app.globalData.token = _data.data
      httpHelper.ajax({
        url: api.userInfo
      }).then((res) => {
        console.log(res)
        if (res.data.errorCode == 0) {
          let _data = res.data.data
          wx.setStorageSync('userInfo', _data);
          app.globalData.userInfo = _data
          wx.switchTab({
            url: '/pages/index/index',
          }, 300)
        }
      }).catch((res, code, header) => {

      })
    }

  },
  onReady: function () {

  },
  onShow: function () {

  },
  onHide: function () {

  },
  onUnload: function () {

  },
  formsubmit: function (e) {
    let Account = this.data.userAccount
    let Password = this.data.userPass
    if (e) {
      Account = e.detail.value.account
      Password = e.detail.value.pass
    }
    let that = this
    httpHelper.ajax({
      url: api.login,
      method: 'post',
      addToken: false,
      data: {
        loginType: 'USERNAME_PASSWORD',
        password: Password,
        username: Account,
        weixinCode: that.data.code
      }
    }).then((res) => {
      that.getuserInfo(res);
    }).catch((res, code, header) => {
      console.log(res)
    })
  }
}),//logs.js
const util = require('../../utils/util.js')

Page({
  data: {
    logs: []
  },
  onLoad: function () {
    this.setData({
      logs: (wx.getStorageSync('logs') || []).map(log => {
        return util.formatTime(new Date(log))
      })
    })
  }
})
,{
  "navigationBarTitleText": "查看启动日志"
},<!--logs.wxml-->
<view class="container log-list">
  <block wx:for="{{logs}}" wx:for-item="log">
    <text class="log-item">{{index + 1}}. {{log}}</text>
  </block>
</view>
,.log-list {
  display: flex;
  flex-direction: column;
  padding: 40rpx;
}
.log-item {
  margin: 10rpx;
}
,// pages/getPass/getPass.js
Page({

  /**
   * 页面的初始数据
   */
  data: {
  
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
  
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {
  
  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {
  
  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {
  
  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {
  
  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {
  
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {
  
  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {
  
  }
}),{"navigationBarTitleText": "找回密码"},<view class='container'>
<text>暂未开放</text>
</view>

,.container{
  text-align: center;
  padding-top:40rpx;
},// pages/weblogin/weblogin.js
//const app = getApp()
Page({
  data: {
  
  },
  onLoad: function (options) {
    // //判断当前是否有orderId存在
    // let orderId = app.globalData.orderId
    // console.log("weblogin:" + orderId)
    // if (orderId) {
    //   app.globalData.isLink = true
    // } 
  },
  onReady: function () {
  
  },
  onShow: function () {
  
  },
  onHide: function () {
  
  },
  onUnload: function () {
  
  },
}),{},<web-view src="https://open.weixin.qq.com/connect/oauth2/authorize?appid=wxc52ed58bf82ea628&redirect_uri=https://logtest.ydcfo.com/page/getChatCode.html&response_type=code&scope=snsapi_base&state=1&connect_redirect=1#wechat_redirect">
</web-view>,/* pages/weblogin/weblogin.wxss */,const httpHelper = require('../../../utils/httpHelper.js');
const api = require('../../../api.js')
Page({
  data: {
    price: '',
    place: '',
    enclosure: [],
    fileInfoIds: []
  },
  onLoad: function(options) {
    this.setData({
      id: options.id ? options.id : 0
    })
  },
  onReady: function() {

  },
  onShow: function() {

  },
  filterPrice: function(e) {
    let val = e.detail.value
    let reg = /^\d+(\.\d{0,2})?$/
    if (!reg.test(val)) {
      if (isNaN(val)) {
        wx.showToast({
          title: '金额不合法',
          icon: 'none'
        })
      } else {
        val = Math.round(val * 100) / 100
        val = val.toFixed(2)
      }
    }
    this.setData({
      price: val
    })
  },
  editPrice: function(e) {
    let val = e.detail.value.price,
      numbers = e.detail.value.numbers,
      recvAddr = e.detail.value.recvAddr,
      id = this.data.id,
      that = this
    let reg = /^\d+(\.\d{0,2})?$/
    if(val==''){
      val=0.00
    }else{
      if (!reg.test(val)) {
        if (isNaN(val)) {
          wx.showToast({
            title: '金额不合法',
            icon: 'none'
          })

          return
        } else {
          val = Math.round(val * 100) / 100
          val = val.toFixed(2)
        }
      }else{
        
      }
    }
    if (numbers == '') {
      wx.showToast({
        title: '请输入单号',
        icon: 'none'
      })
      return;
    }
    let data = {
      id: id,
      deliveryNo: numbers,
      logisticAmt: val,
      orderStatus: 'delivering',
      logisticFileInfoIds: this.data.fileInfoIds.join(','),
      recvAddr: recvAddr
    }
    httpHelper.ajax({
      url: api.updateNews,
      data: data,
      method: 'post'
    }).then((res) => {
      console.log(res)
      if (res.data.data) {
        wx.showToast({
          title: '发货成功',
          success: res => {
            setTimeout(() => {
              wx.navigateBack({})
            }, 1500)
          },
          fail: res => {

          }
        })

      }
    }).catch((res, code, header) => {
      console.log(res)
    })
  },
  uploadFile: function() {
    let enclosure = this.data.enclosure
    let that = this
    let fileInfoIds = this.data.fileInfoIds
    wx.chooseImage({
      count: 1,
      sizeType: ['original', 'compressed'],
      sourceType: ['album', 'camera'],
      success(res) {
        const tempFilePaths = res.tempFilePaths
        wx.showLoading({
          title: '上传中...',
          mask: true,
        })
        wx.uploadFile({
          url: api.uplodFile + '?access_token=' + wx.getStorageSync('token'),
          filePath: tempFilePaths[0],
          name: 'file',
          formData: {},
          success(res) {
            let data = res.data
            data = JSON.parse(data)
            enclosure.push(tempFilePaths[0])
            fileInfoIds.push(data.data)
            that.setData({
              enclosure: enclosure,
              fileInfoIds: fileInfoIds
            })
            wx.hideLoading()
          },
          fail(error) {
            wx.showToast({
              title: error,
              duration: 2000
            })
          }
        })

      }
    })
  },
  operPic: function(e) {
    let ind = e.currentTarget.dataset.index
    let enclosure = this.data.enclosure
    let fileInfoIds = this.data.fileInfoIds
    let that = this
    wx.showActionSheet({
      itemList: ['删除'],
      success(res) {
        let tapIndex = res.tapIndex
        if (tapIndex == 0) {
          enclosure.splice(ind, 1)
          fileInfoIds.splice(ind, 1)
          that.setData({
            enclosure: enclosure,
            fileInfoIds: fileInfoIds
          })
        }
      },
      fail(res) {
        console.log(res.errMsg)
      }
    })
  },
}),{"navigationBarTitleText": "发货"},<view class="container">
  <form bindsubmit='editPrice'>
    <view class='inputMod'>
      <view class="weui-flex">
        <view class='name'>运单号</view>
        <view class='input weui-flex_item'>
          <input type='text' placeholder='请输入运单号' name="numbers" placeholder-class='cd5'></input>
        </view>
      </view>
      <view class="weui-flex">
        <view class='name'>物流运费</view>
        <view class='input weui-flex_item'>
          <input type='digit' placeholder='请输入运费,最多两位小数' name="price" bindblur='filterPrice' placeholder-class='cd5' value="{{price}}"></input>
        </view>
      </view>
      <view class="weui-flex">
        <view class='name'>目的地</view>
        <view class='input weui-flex_item'>
          <input placeholder='请输入目的地' name="recvAddr" placeholder-class='cd5' value="{{place}}"></input>
        </view>
      </view>
      <view class='uploadImg'>
        <view class='imgList'>
          <view class='picBox' wx:for="{{enclosure}}" wx:key="" data-index="{{index}}" bindtap='operPic'>
            <image src='{{item}}'></image>
          </view>
        </view>
        <view class='uploadBtn' bindtap='uploadFile'>
          <image src='/images/camara.png' mode='widthFix'></image>
          <view>上传附件</view>
        </view>
      </view>
    </view>
    <view class='btnBox'>
      <button type='blue' form-type='submit'>确认</button>
    </view>
  </form>
</view>,.inputMod .name{
  width: 120rpx;
}
/*上传附件*/
.uploadImg {
  overflow: hidden;
}

.uploadImg .imgList {
  float: left;
}

.uploadImg .imgList .picBox {
  position: relative;
  display: inline-block;
  width: 120rpx;
  height: 120rpx;
  margin: 20rpx;
}

.uploadImg .imgList image {
  width: 120rpx;
  height: 120rpx;
  vertical-align: middle;
  margin-top:0;
}

.uploadImg .uploadBtn {
  float: left;
  margin:20rpx 0;
  height: 120rpx;
  width: 120rpx;
  line-height: 1.6;
  text-align: center;
  background: #f2f2f2;
  font-size:24rpx;
}

.uploadImg image {
  width: 50rpx;
  vertical-align: middle;
  margin-top:20rpx;
}
,const httpHelper = require('../../../utils/httpHelper.js');
const api = require('../../../api.js')
Page({
  data: {
    price: ''
  },
  onLoad: function (options) {
      this.setData({
        price: options.price ? options.price:0,
        id: options.id ? options.id : 0
      })
  },
  onReady: function () {

  },
  onShow: function () {

  },
  editPrice: function (e) {
    let val = e.detail.value.price,
      id = this.data.id,
      that=this,
      reg = /^\d+(\.\d{0,2})?$/;
    // if (val == '') {
    //   wx.showToast({
    //     title: '请输入运费',
    //     icon: 'loading'
    //   })
    // } else {
      val = Math.round(val * 100) / 100
      val = val.toFixed(2)
      if (!reg.test(val)) {
        wx.showToast({
          title: '输入的金额不合法',
          icon: 'none'
        })
      } else {
        that.setData({
          price: val
        })
        let data = {
          id: parseInt(id),
          logisticAmt: val,
        }
        
        httpHelper.ajax({
          url: api.updatePrice,
          data: data,
          method: 'post'
        }).then((res) => {
          if (res.data.errorCode == 0) {
            wx.navigateBack({})
          }
        }).catch((res, code, header) => {
          console.log(res)
        })
      }
    // }
  }
}),{"navigationBarTitleText": "修改运费"},<view class="container">
<form bindsubmit='editPrice'>
  <view class='inputMod'>
    <view class="weui-flex">
      <view class='name'>运费</view>
      <view class='input weui-flex_item'>
      <input type='digit' placeholder='请输入运费,最多两位小数' name="price" placeholder-class='cd5' value='{{price}}'></input>
      </view>
    </view>
  </view>
  <view class='btnBox'>
  <button type='blue' form-type='submit'>确认</button>
  </view>
</form>
</view>,,const app = getApp()
const httpHelper = require('../../../utils/httpHelper.js');
const api = require('../../../api.js')
Page({
  data: {
    id: '',
    textarea:''
  },
  onLoad: function (options) {
    this.setData({
      id: options.id ? options.id : 0
    })
    var phone = wx.getSystemInfoSync();  //调用方法获取机型
    var that = this;
    if (phone.platform == 'ios') {
      that.setData({
        isIOS: true
      });
    } else if (phone.platform == 'android') {
      that.setData({
        isIOS: false
      });

    }

  },
  onReady: function () {

  },
  onShow: function () {

  },
  editReason: function (e) {
    let val = e.detail.value.reason
    let id = this.data.id
    if (val == '') {
      wx.showToast({
        title: '请输入拒收理由',
        icon: 'loading'
      })
    } else {
      let res = httpHelper.inputReg(val)
      if (!res) {
        wx.showModal({
          title: '提示',
          content: '内容不能带表情或特殊符号，请修改！',
        })
        return
      }
      let data = {
        id: id,
        rejectReason: val,
        orderStatus: 'reject'
      }
      httpHelper.ajax({
        url: api.updateNews,
        data: data,
        method: 'post'
      }).then((res) => {
        if (res.data.errorCode == 0) {
          wx.navigateBack({})
        }
      }).catch((res, code, header) => {
        console.log(res)
      })
    }
  },
}),{"navigationBarTitleText": "拒收理由"},
<view class="container">
<form bindsubmit='editReason'>
  <view class='inputMod'>
    <view class="weui-flex">
      <view class='name'>拒收理由：</view>
      <view class='input weui-flex_item'>
      <textarea class="{{isIOS?'ios':''}}" name='reason' placeholder='请输入拒收理由' placeholder-class='cd5' value='{{textarea}}'></textarea>
      </view>
    </view>
  </view>
  <view class='btnBox'>
  <button type='blue' form-type='submit'>确认</button>
  </view>
</form>
</view>,.inputMod .input textarea.ios{
  padding:10rpx 20rpx 20rpx 0;
}