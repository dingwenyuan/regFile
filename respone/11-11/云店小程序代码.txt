//app.js
import WxValidate from './assets/plugins/wx-validate/WxValidate'
import WxService from './assets/plugins/wx-service/WxService'
import HttpResource from './helpers/HttpResource'
import HttpService from './helpers/HttpService'
import AcFunc from './helpers/acFunc'
import P from './helpers/permission.js'
import __config from './etc/config'
import rpn from './helpers/rpn'
import Action from './helpers/action.js'
import Pay from './helpers/pay.js'
let utils = require('utils/util.js')
App({
  onLaunch: function(options) {
    let that = this;
    wx.getSystemInfo({
      success: function(res) {
        that.globalData.SystemInfo = res;
      },
    })
    this.action = new Action({
      app: this
    })
    this.pay = (options) => new Pay(options)
    console.info(that, 'App is onLaunch', options, window)
  },
  onShow: function(options = {}) {
    console.log('app onShow:', options);
    if (options.query.bindOrder && options.query.action) {
      // this.isLaunch = true;
      // options.query.action=null
    } else {
      this.queryFunc(options.query);
    }
    this.globalData.scene = options.scene
  },
  //根据query对应不同的操作,再次绑定bindOrderAgain传true
  queryFunc(query = {}, bindOrderAgain = false) {
    if (query.q) {
      console.log('AcFunc.getUrlParams', AcFunc.getUrlParams(query.q))
      query = AcFunc.getUrlParams(query.q);
    }
    if (query.action != null) {
      this.canget = null;
    }
    switch (query.action) {
      case 'viewSaleOrder':
        console.log('queryFunc viewSaleOrder');
        this.isNotAction = false;
        this.isLaunch = true;
        this.action.viewSaleOrder(query, bindOrderAgain);
        break;
      case 'viewCloudShopOrder':
        console.log('queryFunc viewCloudShopOrder');
        this.isNotAction = false;
        this.isLaunch = true;
        this.action.viewCloudShopOrder(query, bindOrderAgain);
        break;
      case 'viewLogisticsOrder':
        console.log('queryFunc viewLogisticsOrder');
        this.isNotAction = false;
        this.isLaunch = true;
        this.action.viewLogisticsOrder(query, bindOrderAgain);
        break;
      case 'viewCloudShop':
        console.log('queryFunc viewCloudShop');
        this.isNotAction = false;
        this.isLaunch = true;
        this.action.viewCloudShop(query);
        break;
      case 'viewOwnCloudShopOrder':
        console.log('queryFunc viewOwnCloudShopOrder');
        this.isNotAction = false;
        this.isLaunch = true;
        this.action.viewOwnCloudShopOrder(query);
        break;
      case 'viewOwnLogisticsOrder':
        console.log('queryFunc viewOwnLogisticsOrder');
        this.isNotAction = false;
        this.isLaunch = true;
        this.action.viewOwnLogisticsOrder(query);
        break;
      default:
        this.isNotAction = true;
        if (!this.isLaunch) {
          this.isLaunch = true;
          this.reconnectToken({
            clearToken: true
          })
        }
    }
  },
  setCartCount: function() {
    this.HttpService.getCartCount().then((res) => {
      if (res) {
        utils.getCartGoods(res)
      } else {
        wx.removeTabBarBadge({
          index: 1,
        })
      }
    }).catch((error) => {
      console.log(error)
    })
  },
  setMsgCount: function() {
    this.HttpService.msgCount().then((res) => {
      if (res > 0) {
        utils.getnewsnum(3)
      } else {
        wx.removeTabBarBadge({
          index: 3,
        })
      }
    }).catch((error) => {
      wx.showToast({
        'title': error,
        icon: 'none'
      })
    })
  },
  globalData: {
    userInfo: null,
    loginInfo: null,
    code: '',
    canIUse: false,
    isShare: false,
    shareOrderDetail: null
  },
  //获取云店登陆人信息
  loginInfo: function() {
    let that = this
    let info = {}
    that.HttpService.userInfo().then((res) => {
      console.log(res)
      that.globalData.loginInfo = res
    }).catch((error) => {
      console.log(error)
    })
  },
  getUserInfo() {
    return this.WxService.getUserInfo()
      .then(data => {
        console.log(data)
        this.globalData.userInfo = data.userInfo
        return this.globalData.userInfo
      })
  },
  //获取code，如不是必要的不要调用这个方法
  _getCode() {
    return this.WxService.login().then((res) => {
      this.WxService.setStorageSync('code', res.code);
      return res.code;
    })
  },

  _closeShop(options) {
    let {
      errCode,
      shopName,
      shopCode,
      contactNo
    } = options
    if (errCode == '402.00000000001') {
      wx.navigateTo({
        url: '/pages/closeTips/index' + '?shopCode=' + shopCode ,
      })
    } else if (errCode == '402.00000000002' || errCode ==='402.00000000003') {
      wx.showModal({
        title: '提示',
        content: `抱歉，您没有访问${shopName}${errCode === '402.00000000003'?'下单':''}云店的权限,请联系卖家`,
        cancelText: '取消',
        confirmText: '联系卖家',
        success: function(res) {
          if (res.confirm) {
            let reg = /^[0-9]+-*[0-9]+-*[0-9]+/
            contactNo = contactNo.match(reg).toString();
            wx.makePhoneCall({
              phoneNumber: contactNo,
            })
          }
        }
      })
    }
  },

  _setUser(res) {
    let that = this;
    return new Promise((resolve, reject) => {
      if (!res.cloudShopVO.cloudShopFlag && !res.clientId) {
        that._closeShop({
          errCode: '402.00000000001',
          shopCode: res.cloudShopVO.code
        })
        // reject()
        return;
      } else if (!res.cloudShopVO.clientPermissionVO.allowVisitorsVisit && !res.clientId) {
        that._closeShop({
          errCode: '402.00000000002',
          shopName: res.cloudShopVO.name,
          contactNo: res.cloudShopVO.contactNo
        })
        return;
      }
      if (!res.hasBindPublicApp && this.isNotAction) {
        wx.redirectTo({
          url: '/pages/webview/index',
        })
      }
      this.WxService.setStorageSync('access_token', res.token);
      res.ownerVO.cloudShopVO = res.cloudShopVO
      this.WxService.setStorageSync('owner', res.ownerVO);
      resolve(res.token);
    })
  },
  //绑定微信公众号，推送消息用
  _bindwx(wxcode) {
    this.HttpService.bindWX(wxcode)
  },
  _getPageNow() {
    var pages = getCurrentPages();
    return pages[pages.length - 1]
  },
  /**
   * 获取getToken
   * 
   * @param {Object} options 配置项
   * @param {boolean} options.navigateTo 失败了跳转登陆页
   * 
   */
  getToken(options = {}) {
    let {
      navigateTo = true
    } = options;
    let that = this;
    if (wx.getStorageSync('access_token')) {
      console.info('获取token成功，直接返回token');
      return Promise.resolve(wx.getStorageSync('access_token'));
    } else {
      let promise = this._getCode().then((res) => {
        return this.HttpService.getToken(res).then((res) => {
          return this._setUser(res);
          // let bool=this._setUser(res);
          // if(bool){
          //   return res.token
          // }else{
          //   return Promise.reject();
          // }

        })
      });
      if (navigateTo && this.isNotAction) {
        console.info('获取token失败，navigateTo为true，promise如果失败了跳转登录界面');
        promise.catch((e) => {
          console.error('获取token失败，navigateTo为true，promise已失败,即将跳转登录界面', e)
          wx.showToast({
            'title': e,
            duration: 2000,
            icon: 'none'
          });
          setTimeout(() => {
            if (that._getPageNow().route.indexOf('login/index') == -1) {
              wx.navigateTo({
                url: '/pages/login/index',
              })
            }
          }, 1000)
        })
      } else {
        console.info('获取token失败，navigateTo为false，promise如果失败了不做处理');
      }
      return promise
    }
  },
  reconnectToken(options = {}) {
    let {
      clearToken = false, navigateTo = true
    } = options
    var that = this;
    if (that.canget) {
      return that.canget;
    } else {
      if (clearToken) {
        that.logout()
      }
      return that.canget = new Promise((resolve, reject) => {
        that.getToken({
          navigateTo: navigateTo
        }).then((res) => {
          resolve(res)
          console.info('reconnectToken 连接成功，注意查看')
          setTimeout(() => {
            that.canget = null;
            console.info('reconnectToken setTimeout 完成了，注意查看')
          }, 1000 * 10)
          return res;
        }).catch(e => {
          that.canget = null;
          reject(e);
        })
        setTimeout(() => {
          that.canget = null;
          console.info('reconnectToken 连接超时，注意查看')
          reject({data:{errorMsg:'登录超时'}});
        }, 1000 * 30)
      })
    }
  },
  //登出调用此功能
  logout() {
    this.WxService.setStorageSync('code', '');
    this.WxService.setStorageSync('access_token', '');
    this.WxService.setStorageSync('owner', '');
  },
  renderImage(path) {
    if (!path) return ''
    if (path.indexOf('http') !== -1) return path
    return `${this.__config.domain}${path}`
  },
  //校验方法
  WxValidate: (rules, messages) => new WxValidate(rules, messages),
  HttpResource: (url, paramDefaults, actions, options) => new HttpResource(url, paramDefaults, actions, options).init(),
  //接口方法
  HttpService: new HttpService({
    baseURL: __config.basePath,
    blackList: __config.blackList,
  }),
  //常用方法
  AcFunc: AcFunc,
  //生成权限字符串方法
  P: P,
  //封装了异步的wx方法，返回promise对象
  WxService: new WxService,
  __config,
  getUploadUrl() {
    let url = __config.basePath + '/sys/common/file/single/upload?access_token=' + wx.getStorageSync("access_token")
    return url
  },
  getxsimg(photoType, fileId, id) {
    let ownerId = wx.getStorageSync('owner').ownerId
    if (id){
      ownerId = id
    }
    return __config.basePath + '/sys/common/file/' + photoType + '/' + fileId + '/' + ownerId + '/xs/get?access_token=' + wx.getStorageSync("access_token");
  },
  getimg(photoType, fileId) {
    return __config.basePath + '/sys/common/file/' + photoType + '/' + fileId + '/get?access_token=' + wx.getStorageSync("access_token");
  },
  getlogistimg(fileId, photoType) {
    if (!photoType){
      photoType ='thumbnail'
    }
    return __config.basePath + '/sys/common/logisticsFile/' + photoType + '/' + fileId + '/get?access_token=' + wx.getStorageSync("access_token");
  },
  //页面刷新问题的值存储xlf
  clearSet() {
    wx.removeStorageSync('refresh');
    wx.removeStorageSync('baseinforefresh');
    wx.removeStorageSync('refreshorder');
  },
  /**
   * 公式计算方法，不支持复杂公式计算('(1-10)*((0-3)+(0-29))')
   * @param {String} expression 传入单据信息
   * getApp().eval('1*2-66')
   */
  eval: (expression = '0') => new rpn(expression).calculate(),
}),{
  "pages": [
    
    "pages/index/index",
    "pages/login/index",
    "pages/logs/logs",
    "pages/myhome/browseshop/browseshop",
    "pages/myhome/baseinfo/baseinfo",
    "pages/myhome/edittel/edittel",
    "pages/myhome/myhome",
    "pages/cart/cart",
    "pages/order/order",
    "pages/order/addressList/index",
    "pages/order/orderfilter/index",
    "pages/order/orderDetail/orderDetail",
    "pages/order/logistDetail/logistDetail",
    "pages/order/confirmOrder/index",
    "pages/order/logistEdit/index",
    "pages/order/orderSuccess/index",
    "pages/agreement/logist/index",
    "pages/address/address",
    "pages/news/news",
    "pages/productdetail/productdetail",
    "pages/authorization/authorization",
    "pages/closeTips/index",
    "pages/webview/index"
  ],
  "window": {
    "backgroundTextStyle": "light",
    "navigationBarBackgroundColor": "#00a6f5",
    "navigationBarTitleText": "秒账云店",
    "navigationBarTextStyle": "white",
    "backgroundColor": "#efeff4"
  },
  "tabBar": {
    "color": "#444",
    "backgroundColor": "#fafafa",
    "selectedColor": "#00a6f5",
    "borderStyle": "",
    "list": [
      {
        "pagePath": "pages/index/index",
        "text": "选购",
        "iconPath": "images/tabBar/goods.png",
        "selectedIconPath": "images/tabBar/goods_s.png"
      },
      {
        "pagePath": "pages/cart/cart",
        "text": "购物车",
        "iconPath": "images/tabBar/cart.png",
        "selectedIconPath": "images/tabBar/cart_s.png"
      },
      {
        "pagePath": "pages/order/order",
        "text": "订单",
        "iconPath": "images/tabBar/order.png",
        "selectedIconPath": "images/tabBar/order_s.png"
      },
      {
        "pagePath": "pages/news/news",
        "text": "消息",
        "iconPath": "images/tabBar/news.png",
        "selectedIconPath": "images/tabBar/news_s.png"
      },
      {
        "pagePath": "pages/myhome/myhome",
        "text": "我的",
        "iconPath": "images/tabBar/home.png",
        "selectedIconPath": "images/tabBar/home_s.png"
      }
    ]
  },
  "networkTimeout": {
    "request": 60000,
    "connectSocket": 20000,
    "uploadFile": 20000,
    "downloadFile": 20000
  },
  "debug": true
},/**app.wxss**/
@import 'style/weui.wxss';
@import 'style/style.wxss';
@import 'style/fonts/iconfont.wxss';

page {
  background-color: #efeff4;
  font-size: 28rpx;
  color: #333;
}
textarea{
  position: relative;
  z-index: 0;
}
/*加减*/

.operInput {
  border: 1px solid #c4c4c4;
  border-radius: 0.3em;
  height: 60rpx;
  overflow: hidden;
}

.operInput .iconfont {
  height: 100%;
  width: 60rpx;
  font-size: 24rpx;
  text-align: center;
  background: #f8f8f8;
  color: #a2a2a2;
  position: relative;
}

.operInput .iconfont:before {
  position: absolute;
  display: block;
  line-height: 60rpx;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
}

.operInput .iconfont.touch {
  background: #00a6f5;
  color: #fff;
}

.operInput input {
  display: inline-block;
  width: 140rpx;
  height: 60rpx;
  text-align: center;
  border-left: 1px solid #c4c4c4;
  border-right: 1px solid #c4c4c4;
}
.operInput input[disabled]{
  background: #f9f9f9;
  color:#999;
}

/*价格列表*/

.priceList .icon-sanjiao {
  width: 30rpx;
  height: 30rpx;
  text-align: center;
  color: #999;
  font-size: 20rpx;
  position: relative;
}

.priceList .icon-sanjiao:before {
  position: absolute;
  top: 0;
}

/*提示*/

.tips {
  display: inline-block;
  font-size: 20rpx;
  background: #fedee0;
  border-radius: 0.8em;
  height: 32rpx;
  line-height: 32rpx;
  padding: 0 16rpx;
  color: #fe3824;
}

/*订单状态*/

.orderState {
  position: relative;
}

.orderState .state {
  height: 24px;
  padding: 2px;
  font-size: 22rpx;
  border-radius: 24px;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  white-space: nowrap;
  overflow: hidden;
}
.orderState > image{
  height:50rpx !important;
  width:210rpx !important;
  margin-left:20rpx;
}
.orderState .state icon {
  float:left;
  position: relative;
  height: 20px;
  width: 20px;
  font-size: 22rpx;
  overflow: hidden;
  color: #fff;
  border-radius: 20px;
  background: #999;
  text-align: center;
  vertical-align: middle;
}

.orderState .state icon:before {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  line-height: 20px;
}

.orderState .state .text {
  display: inline-block;
  height:20px;
  line-height: 20px;
  padding: 0 20rpx;
  min-width: 100rpx;
  text-align: center;
}

.orderState .state_undelivery {
  border-color: #e5f6dd;
  background: #e5f6dd;
  color: #52c41a;
}

.orderState .state_undelivery icon {
  background: #52c41a;
}

.orderState .state_reject, .orderState .state_cancel {
  border-color: #fff2d9;
  background: #fff2d9;
  color: #fa0;
}

.orderState .state_reject icon, .orderState .state_cancel icon {
  background: #fa0;
}

.orderState .state_delivering {
  border-color: #ddefff;
  background: #ddefff;
  color: #00a6f5;
}

.orderState .state_delivering icon {
  background: #00a6f5;
}

.orderState .state_normalSign {
  border-color: #f6f6f6;
  background: #f6f6f6;
  color: #666;
}

.orderState .state_normalSign icon {
  background: #bfbfbf;
}

.orderState .state_abnormalSign {
  border-color: #fedee0;
  background: #fedee0;
  color: #f5222d;
}

.orderState .state_abnormalSign icon {
  background: #f5222d;
}

.orderState .state_wait {
  border-color: rgba(171, 149, 29, 0.3);
  background: rgba(171, 149, 29, 0.3);
  color: #ab951d;
}

.orderState .state_wait icon {
  background: #ab951d;
  color: #fff;
}

.orderState .state_undispatch {
  border-color: #ddefff;
  background: #ddefff;
  color: #4a83ff;
}

.orderState .state_undispatch icon {
  background: #4a83ff;
  color: #fff;
}

.orderState .unPay {
  position: absolute;
}

.orderState .unPay image {
  width: 120rpx;
  height:120rpx;
}

view.textArea{
  height:120rpx;
  padding:20rpx;
  background: #fff;
  font-size:26rpx;
}
input.textArea{
  font-size:26rpx;
  padding:20rpx;
}

button[type='success'] {
  background: #00a6f5;
  color: #fff !important;
  font-size: 30rpx;
}

button[type='blue'] {
  background: #fff;
  color: #00a6f5 !important;
  font-size: 30rpx;
  border: 1px solid #00a6f5;
}
button[type='blue']::after{
  border:0;
}

button[type='yello'] {
  background: #fa0;
  color: #fff !important;
  font-size: 30rpx;
}

.iconMore {
  color: #c4c4c4;
  font-size: 24rpx;
}

.red {
  color: #fe3824;
}

.error {
  color: #f5222d;
}

.c000 {
  color: 000;
}

.c999 {
  color: #999;
}

.c666 {
  color: #666;
}

.blue {
  color: #00a6f5 !important;
}

.darkblue {
  color: #576b95;
}

.yello {
  color: #fa0;
}

.bg_blue {
  background: #00a6f5;
}

.bg_navy {
  background: #36d4c8;
}

.fs10 {
  font-size: 20rpx;
}

.fs11 {
  font-size: 22rpx;
}

.fs12 {
  font-size: 24rpx;
}

.fs13 {
  font-size: 26rpx;
}

.fs14 {
  font-size: 28rpx;
}

.fs15 {
  font-size: 30rpx;
}

.fs16 {
  font-size: 32rpx;
}
,{
	"compilerOptions": {
		"target": "es2015",
		"module": "commonjs"
	}	
},{
	"description": "项目配置文件",
	"packOptions": {
		"ignore": []
	},
	"setting": {
		"urlCheck": false,
		"es6": true,
		"postcss": true,
		"minified": true,
		"newFeature": true
	},
	"compileType": "miniprogram",
	"libVersion": "2.3.2",
	"appid": "wxa7149a0d6614c472",
	"projectname": "cloudShop",
	"debugOptions": {
		"hidedInDevtools": []
	},
	"isGameTourist": false,
	"condition": {
		"search": {
			"current": -1,
			"list": []
		},
		"conversation": {
			"current": -1,
			"list": []
		},
		"plugin": {
			"current": -1,
			"list": []
		},
		"game": {
			"currentL": -1,
			"list": []
		},
		"miniprogram": {
			"current": 0,
			"list": [
				{
					"id": 0,
					"name": "haha",
					"pathName": "pages/index/index",
					"query": "action=bindshop"
				}
			]
		}
	}
},Date.getLocalTime = function(afteMonthNum = 0) {
  var date = new Date();
  var year = date.getFullYear();
  var month = date.getMonth() + 1;
  var day = date.getDate();
  if (month.toString().length == 1) {
    month = '0' + month;
  }
  if (day.toString().length == 1) {
    day = '0' + day;
  }
  var payOrder_startTime = year + '-' + month + '-' + day;
  var nextDay = day - 1;
  var nextMonth = (month - 0 + afteMonthNum) % 12 === 0 ? 12 : (month - 0 + afteMonthNum) % 12;
  var nextYear = year + ((month - 0 + afteMonthNum) % 12 > 0 ? parseInt((month - 0 + afteMonthNum) / 12) : parseInt((month - 0 + afteMonthNum) / 12) - 1);
  if (nextDay == 0) {
    nextMonth = month - 1;
    if (nextMonth == 0) {
      nextMonth = 12;
    }
    if (nextMonth == 2) {
      if (nextYear % 4 == 0 && nextYear % 100 != 0 || nextYear % 400 == 0) {
        nextDay = 29;
      } else {
        nextDay = 28;
      }
    } else if (nextMonth == 7 || nextMonth == 8 || nextMonth % 2 == 1) {
      nextDay = 31;
    } else if (nextMonth % 2 == 0) {
      nextDay = 30;
    }
  }
  if (nextMonth.toString().length == 1) {
    nextMonth = '0' + nextMonth;
  }
  if (nextDay.toString().length == 1) {
    nextDay = '0' + nextDay;
  }
  var payOrder_endTime = nextYear + '-' + nextMonth + '-' + nextDay;
  if (afteMonthNum == 0) return payOrder_startTime;
  if (afteMonthNum != 0) return payOrder_endTime;
};
/** 格式化日期 */
Date.prototype.format = function(format) {
  var o = {
    "M+": this.getMonth() + 1,
    "d+": this.getDate(),
    "h+": this.getHours(),
    "m+": this.getMinutes(),
    "s+": this.getSeconds(),
    "q+": Math.floor((this.getMonth() + 3) / 3),
    "S": this.getMilliseconds()
  };

  if (/(y+)/.test(format)) {
    format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
  }

  for (var k in o) {
    if (new RegExp("(" + k + ")").test(format)) {
      format = format.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
    }
  }
  return format;
  //For example:
  //var date = new Date();
  //alert(date.format("yyyy年MM月dd日"));
  //alert(date.format("MM月d日"));
};
const AcFunc = {
  /**
   *数字格式化带指定位小数
   * getApp().AcFunc.money('1')为'1.00'
   * @author Dingwenyuan
   * @param {any} num 传入数字
   * @param {Number} len 保留小数的位数
   * @param {*} noEndZero ,是否删除小数后面的0
   * @returns 
   * @memberof AcFunc
   */
  money(num, len, noEndZero = false) {
    if (num < 0) {
      var _num = this._money(Math.abs(num), len, noEndZero);
      return _num == 0 ? _num : '-' + _num;
    }
    return this._money(num, len, noEndZero)
  },

  /**
   *在数组里面筛选指定key的数据
   *
   * @author Dingwenyuan
   * @param {Array} sources 传入数组
   * @param {String} key 生成map对象的键名
   * @param {any} value 生成map对象的键值
   * @returns {Object}
   * @memberof AcFunc
   */
  getInfoMapByKey(sources, key, value) {
    if (key == null) {
      return sources;
    }
    var len = sources.length;
    var map = {};
    for (var i = 0; i < len; i++) {
      if (sources[i] != null) {
        map[sources[i][key]] = {};
        var _map = map[sources[i][key]];
        for (var j in sources[i]) {
          _map[j] = sources[i][j];
        }
      }
    }
    if (null != key && null != value) {
      return map[value] == null ? {} : map[value];
    } else {
      return map;
    }
  },

  /**
   * 数据分组排序
   * @param {String}
   *            source 资源名字，必须
   * @param {String}
   *            key 生成map对象的键名
   * @param {String}
   *            value 生成map对象的键值
   */
  getInfoMapOrderByKey(sources, key, value) {
    if (key == null) {
      return sources;
    }
    var len = sources.length;
    var map = {};
    for (var i = 0; i < len; i++) {
      if (sources[i] != null) {
        var sk = sources[i][key];
        sk = sk === '' ? '未分类' : sk;
        sk = sk == null ? '未分类' : sk;
        if (!map[sk]) {
          map[sk] = [];
        }
        map[sk].push(sources[i]);
      }
    }
    //console.log(map)
    if (null != key && null != value) {
      return map[value] == null ? [] : map[value];
    } else {
      return map;
    }
  },

  /**
   * 单位转换
   * @author dingwenyuan
   * @param {Number} sum 最小单位总数
   * @param {Array} unitGroup 单位比例数据
   * @returns {String}
   */
  unitConversion(sum, unitGroup, str, i, minus) {
    if (unitGroup == '' || unitGroup == null) {
      unitGroup = [];
    }
    str = str == null ? '' : str;
    i = i == null ? 0 : i;
    minus = minus == null ? '' : minus;
    if (sum < 0) {
      minus = '-';
      sum = -sum;
    }
    if (i == 0) {
      //小到大排序
      unitGroup.sort(function(v1, v2) {
        if (v1.rate > v2.rate) {
          return -1;
        }
        if (v1.rate < v2.rate) {
          return 1;
        }
        if (v1.rate == v2.rate) {
          return 0;
        }
      });
    }
    if (i < unitGroup.length - 1) {
      var v = unitGroup[i]
      var rate = v.rate;
      var name = '';
      if (Math.abs(sum / rate) >= 1) {
        var rateNum = parseInt(sum / rate);
        if (rateNum == sum / rate) {
          sum = 0;
        } else {
          sum = sum % rate;
        }
        name = v.name ? v.name : '';
        str += rateNum + name;
      }
      return ac_arr_func.unitConversion(sum, unitGroup, str, ++i, minus)
    } else {
      var v = unitGroup[i];
      var name = '';
      if (sum != 0) {
        if (v) {
          name = v.name ? v.name : '';
        }
        return str = minus + str + this.money(sum, 6, true) + name;
      } else {
        return minus + str;
      }
    }
  },

  _money(num, len, noEndZero) {
    if (num == undefined || num === '') {
      if (noEndZero) {
        return '0';
      }
      return '0.00';
    }
    if (num > 9999 * 10000 * 10000 * 10000) {
      num = 0;
    }
    var len = len == null ? 2 : len;
    num = num.toString();
    var complement = '0.';
    if (num.indexOf('.') > -1) {
      var indexdo = num.substr(num.indexOf('.')).length - 1;
      if (indexdo > 7) {
        complement = '0.00000001'
      } else {
        if (indexdo > len) {
          for (var zero = 0; zero < indexdo; zero++) {
            complement += '0';
          }
          complement += '1';
        }
      }
    }
    var i = parseFloat(num) + parseFloat(complement);
    var returnValue = i.toFixed(len);
    if (noEndZero) {
      if (returnValue == 0) {
        return '0';
      }
      //小数6个0会变成科学计数法
      if (returnValue < 0.000001) {
        var rv = returnValue.toString().replace(/(0*)$/, '').replace(/\.$/, '')
        return rv == '' ? 0 : rv;
      }
      var rv = parseFloat(returnValue);
      return isNaN(rv) == false ? rv : 0;
    }
    if (returnValue == 0 || isNaN(returnValue)) {
      return '0.00'
    }
    return returnValue;
  },
  myTotal(title, icon, t) {
    let times = 2000
    if (t) {
      times = t
    }
    wx.showToast({
      title: title,
      // icon: icon,
      icon: 'none',
      duration: times
    })
  },
  getProdDim(prodVO) {
    //获取需要的列数据 
    var getVisibleColumn = function(type) {
      var yes = {
        spec: '', //规格
        color: '', //颜色
        photo: '', //颜色图片
        initPieceQty: 0, //期初匹数add
        initQty: 0, //期初库存
        warnMinQty: 0, //库存预警
        // eachCarton: 0, //每箱数量         
        // volume: 0, //体积
        // extent: 0, //长  
        // width: 0, //宽
        // height: 0, //高
      }
      if (type == 'box') {
        yes = {
          eachCarton: 0,
          extent: 0,
          height: 0,
          volume: 0,
          width: 0,
        }
      }
      var obj = {}
      for (var i in yes) {
        obj[i] = yes[i]
      }
      return obj;
    }
    var _source = prodVO.prodDimList
    var gridRows = [];
    var yes = {
      id: null,
    };

    if (getApp().P().yardsFlag) {
      yes.invBatDtlList = [];
    }
    var zhudanwei = prodVO.unitList[0] && prodVO.unitList[0].name || '';
    yes = Object.assign(yes, getVisibleColumn());
    var box = Object.assign({}, getVisibleColumn('box'));
    _source.forEach((unitGroup, i) => {
      if (unitGroup.prodDimUnitList && unitGroup.prodDimUnitList.length != 0) {
        unitGroup.prodDimUnitList.forEach((v, i) => {
          var json = {};
          for (var y in yes) {
            if (unitGroup[y] == null || unitGroup[y] == '') {
              json[y] = yes[y]
            } else {
              json[y] = unitGroup[y]
            }

          }
          for (var k in box) {
            if (unitGroup.prodDimBox[k] == null || unitGroup.prodDimBox[k] == '') {
              json[k] = box[k];
            } else {
              json[k] = unitGroup.prodDimBox[k];
            }
          }
          json.prodDimUnitId = v.id;
          json.commonFlag = v.commonFlag;
          json.rate = parseFloat(v.rate);
          json['zhudanwei'] = zhudanwei;
          json.unitName = v.name ? v.name:'';
          json.unitId = v.unitId?v.unitId:0;
          json.prodSalePriceVOList = v.prodSalePriceVOList;
          //json.prodDimBox = unitGroup.prodDimBox
          v.prodSalePriceVOList.forEach((sv_v, sv_i) => {
            json['salePrice' + sv_v.seq] = sv_v.price;
          })
          json.amountFormula = prodVO.amountFormula
          json.prodId = unitGroup.prodId
          json.colorId = unitGroup.colorId
          json.specId = unitGroup.specId
          json.photo = unitGroup.photo ? unitGroup.photo : (prodVO.photo ? prodVO.photo : 0)
          json.stockQty = unitGroup.qty ? unitGroup.qty : 0;
          json.warnMinQty = unitGroup.warnMinQty;
          json.unitNameline = v.name ? '/' + v.name : '';
          json.available = unitGroup.available;
          if (v.dimUnitAvailable) {
            gridRows.push(json)
          }
        })
      }
    })
    return gridRows
  },
  /**
   * 根据指定key值获取map数组
   * ac_arr_func.getMapArrByObj([{a:1},{a:2}],{a:1})
   * @author dingwenyuan
   * @param {any} arr  传入数组
   * @param {Object}  mapkv 筛选数组里面符合的对象
   */
  getMapArrByObj(arr = [], mapkv = {}) {
    var retrun_arr = [];
    for (var i = 0; i < arr.length; i++) {
      var cell = arr[i];
      var bool = true;
      for (var key in mapkv) {
        if (mapkv.hasOwnProperty(key)) {
          var element = mapkv[key];
          if (cell[key] != element) {
            bool = false;
          }
        }
      }
      if (bool) {
        retrun_arr.push(cell)
      }
    }
    return retrun_arr;
  },
  /**
  * 取出数组对象里面指定键值
  * getApp().AcFunc.getArrByMetaFromArr([{a:1,b:2},{a:2,b:3}],'a','b',['1'])
  * @param {Array} source 传入数组
  * @param {String} keyName 键名
  * @param {String} refName 返回键名，默认返回keyName
  * @param {Array} keyValueArr 匹配键值数组
  * @returns 
  */
  getArrByMetaFromArr(sources, keyName, refName, keyValueArr) {
    refName = refName === undefined ? keyName : refName;
    keyValueArr = keyValueArr === undefined ? [] : keyValueArr;
    var map = [];
    sources.forEach(function (v, i) {
      if (keyValueArr.length != 0) {
        if (keyValueArr.includes(v[keyName])) {
          map.push(v[refName])
        }
      } else {
        map.push(v[refName])
      }
    })
    return map;
  },
  /**
   * 单位转换
   * @author dingwenyuan
   * @param {Number} sum 最小单位总数
   * @param {Array} unitGroup 单位比例数据
   * @returns {String}
   */
  unitConversion(sum, unitGroup, str, i, minus) {
    if (unitGroup == '' || unitGroup == null) {
      unitGroup = [];
    }
    str = str == null ? '' : str;
    i = i == null ? 0 : i;
    minus = minus == null ? '' : minus;
    if (sum < 0) {
      minus = '-';
      sum = -sum;
    }
    if (i == 0) {
      //小到大排序
      unitGroup.sort(function(v1, v2) {
        if (v1.rate > v2.rate) {
          return -1;
        }
        if (v1.rate < v2.rate) {
          return 1;
        }
        if (v1.rate == v2.rate) {
          return 0;
        }
      });
    }
    if (i < unitGroup.length - 1) {
      var v = unitGroup[i]
      var rate = v.rate;
      var name = '';
      if (Math.abs(sum / rate) >= 1) {
        var rateNum = parseInt(sum / rate);
        if (rateNum == sum / rate) {
          sum = 0;
        } else {
          sum = sum % rate;
        }
        name = v.name ? v.name : '';
        str += rateNum + name;
      }
      return this.unitConversion(sum, unitGroup, str, ++i, minus)
    } else {
      var v = unitGroup[i];
      var name = '';
      if (sum != 0) {
        if (v) {
          name = v.name ? v.name : '';
        }
        return str = minus + str + this.money(sum, 6, true) + name;
      } else {
        return minus + str;
      }
    }
  },
  /**
   * 
   * @param {string} formula 计算公式 
   * @param {obj} data 数据
   * @param {string} formtype 计算类别
   */
  countTotalPrice(formula, data, formtype) {
    
    let P = getApp().P()
    let hasAttr = true
    // let unitFlag = P.unitFlag
    // let unitRate = data.rate || data.unitRate
    let totalPrice = 0
    if (data.displayQty) {
      data.qty = data.displayQty
    }
    if (P.custFormulaFlag) {
      formula = formula.split(' ')
      for (let i in formula) {
        let val = data[formula[i]]
        let _nan = isNaN(parseInt(formula[i]))
        if (!_nan) {
          val = formula[i]
        }
        if (val && val != 0) {
          formula[i] = val
        }
      }
      let str = formula.join('')
      totalPrice = getApp().eval(str)

    } else {
      totalPrice = data.qty * data.unitPrice
    }
    return totalPrice
    

  },
  /**物流状态的渲染 */
  changeObjStatus(data) {
    let paymentStatus = data.paymentStatus,
      orderStatus = data.orderStatus,
      balanceAmt = data.balanceAmt
    let combination = paymentStatus + "|" + orderStatus
    let isDif = balanceAmt!= 0 ? true : false //是否为预估到货时间
    let obj = {
      'paid|undelivery': ['已支付未发货', 'state_undelivery', 'icon-undelivery', true, true, true, isDif],
      'paid|delivering': ['已支付运输中', 'state_delivering', 'icon-delivering', false, true, false, isDif],
      'paid|normalSign': ['已支付正常签收', 'state_normalSign', 'icon-signin', false, false, false, isDif],
      'paid|abnormalSign': ['已支付异常签收', 'state_abnormalSign', 'icon-signin', false, false, false, isDif],
      'paid|reject': ['已支付已拒收', 'state_reject', 'icon-reject', false, true, false, false],
      'paid|cancel': ['已支付已取消', 'state_cancel', 'icon-close', false, true, false, false],
      'paid|undispatch': ['已支付待派单', 'state_undispatch', 'icon-undispatch', true, true, true, true],

      'refund|reject': ['已退款已拒收', 'state_normalSign', 'icon-reject', false, true, false, false],
      'refund|cancel': ['已退款已取消', 'state_cancel', 'icon-close', false, true, false, false],

      'unpaid|undelivery': ['未发货', 'state_undelivery', 'icon-undelivery', true, true, true, true],
      'unpaid|delivering': ['运输中', 'state_delivering', 'icon-delivering', false, true, true, true],
      'unpaid|cancel': ['已取消', 'state_cancel', 'icon-close', false, true, false, false],
      'unpaid|reject': ['已拒收', 'state_reject', 'icon-reject', false, true, false, false],
      'unpaid|undispatch': ['待派单', 'state_undispatch', 'icon-undispatch', true, true, true, true],
      'unpaid|wait': ['草稿', 'state_wait', 'icon-wait', true, true, true, true],
    }
    let statusDesc = obj[combination][0],
      statusClass = obj[combination][1],
      iconClass = obj[combination][2],
      isEdit = obj[combination][3],
      idDeff = obj[combination][4],
      isCancel = obj[combination][5],
      hasPay = obj[combination][6];
    data.statusDesc = statusDesc
    data.statusClass = statusClass
    data.iconClass = iconClass
    data.isEdit = isEdit
    data.idDeff = idDeff
    data.isCancel = isCancel
    data.hasPay = hasPay
    return data;
  },
  /**货品属性的生成 */
  setGoodsMsg(goods) {
    let goodsName = goods.goodsName ? goods.goodsName + '，' : ''
    let goodsType = goods.goodsType ? goods.goodsType == 'light' ? "抛货，" : '重货，' : ''
    let goodsQty = goods.goodsQty ? goods.goodsQty + '箱，' : ''
    let goodsWeight = goods.goodsWeight ? goods.goodsWeight + '吨，' : ''
    let goodsVolume = goods.goodsVolume ? goods.goodsVolume + 'm³，' : ''
    let goodsMsg = goodsName + goodsQty + goodsWeight + goodsVolume
    goodsMsg = goodsMsg.substr(0, (goodsMsg.length - 1))
    goods.goodsMsg = goodsMsg
    return goods;
  },

  getUrlParams(url) {
    url = decodeURIComponent(url);
    let params = url.split('?')[1];
    let json = {};
    if (params) {
      params.split('&').forEach((v, i) => {
        let arr = v.split('=');
        json[arr[0]] = arr[1];
      })
    }
    return json;
  },
  objToUrl(obj = {}) {
    let url = '';
    for (let i in obj) {
      url += '&' + i + '=' + obj[i];
    }
    let sub = url.substr(1)
    return sub ? '?' + sub : sub;
  },
  get$(id) {
    return new Promise((resolve, reject) => {
      try {
        const query = wx.createSelectorQuery()
        query.select('#' + id).boundingClientRect()
        query.selectViewport().scrollOffset()
        query.exec(function(res) {
          resolve(res)
        })
      } catch (e) {
        reject(e)
      }
    })
  },
  filterNumber(number) {
    let _number = String(number)
    let _int = '',
      _float = ''
    if (_number.indexOf('.') >= 0) {
      _int = _number.substr(0, _number.indexOf('.'))
      _float = _number.substr(_number.indexOf('.'), _number.length)
    } else {
      _int = _number
    }
    if (_int.length > 10) {
      _int = _int.substr(0, 10);
    }

    return this.money(_int + _float, 6, true)
  },
  //图片点击事件
  imgBig: function(event) {
    var src = event.currentTarget.dataset.src;
    if (src.indexOf('http') == -1) {
      wx.showToast({
        title: '暂无图片',
        icon: 'none',
      })
      return;
    }
    if (src.indexOf('chatLogo') == -1){
      src = src.replace(/thumbnail/g, "original")
    }
    var imgList = [];
    imgList.push(src);
    wx.previewImage({
      current: src,
      urls: imgList
    })
  },
}
export default AcFunc,/**
 * 分享相关页面逻辑定义和对url的处理
 * query包括 action, code, id, q, ownerId,username等参数
 */
class Action {
  constructor(options) {
    this.app = options.app;
  }

  //查看分享的销售单
  //登陆不上直接查看销售单bindOrder=fail，进入云店登陆后尝试绑定单据；登陆成功且绑定单据成功修改id为返回的云单id，bindOrder=true，登陆成功绑定单据失败bindOrder=pedding,进入查看销售单
  viewSaleOrder(query, bindOrderAgain = false) {
    this.app.reconnectToken({
      clearToken: !bindOrderAgain,
      navigateTo: false
    }).then(() => {
      let pamars = {
        ownerId: query.ownerId,
        orderId: query.id,
        username: query.username
      }
      this.app.HttpService.orderShare(pamars).then((res) => {
        console.log(res)
        this.app.HttpService.orderBind(res).then((res = {}) => {          
          if (res.id) {
            console.error('viewSaleOrder绑定成功正常进入单据详情界面')
            query.id = res.id;
            query.bindOrder = 'success';
            wx.navigateTo({
              url: '/pages/order/orderDetail/orderDetail' + this.app.AcFunc.objToUrl(query),
            })
          } else {
            console.error('viewSaleOrder绑定失败正常进入秒账销售单界面')
            // query.id = res.id;
            query.bindOrder = 'pendding';
            wx.navigateTo({
              url: '/pages/order/orderDetail/orderDetail' + this.app.AcFunc.objToUrl(query),
            })
          }
        }).catch(e => {
          console.error('orderBind绑定失败', e)
          if (bindOrderAgain) {
            console.error('viewSaleOrder再次绑定失败，放弃绑定操作,弹出错误提示')
          } else {
            console.error('viewSaleOrder第一次绑定失败，进入未登录查看单据页面')
            query.bindOrder = 'fail';
            wx.navigateTo({
              url: `/pages/order/orderDetail/orderDetail` + this.app.AcFunc.objToUrl(query),
            })
          }
        })
      }).catch(e => {
        console.error('查看orderShare销售单失败', e)
        this.app.AcFunc.myTotal(e, 'none')
      })

    }).catch((e) => {
      if (bindOrderAgain) {
        console.error('viewSaleOrder再次绑定失败，放弃绑定操作,弹出错误提示')
      } else {
        console.error('viewSaleOrder第一次绑定失败，进入未登录查看单据页面')
        query.bindOrder = 'fail';
        wx.redirectTo({
          url: `/pages/order/orderDetail/orderDetail` + this.app.AcFunc.objToUrl(query),
        })
      }
    })
  }
  //查看分享的云单
  //未登录直接查看分享的单据，bindOrder = 'fail'，有进入云店按钮；已登录直接查看分享的云单，bindOrder = 'success'
  viewCloudShopOrder(query, bindOrderAgain = false) {    
    this.app.reconnectToken({
      clearToken: !bindOrderAgain,
      navigateTo: false
    })
    .then(res=>{
      if (bindOrderAgain){
        wx.switchTab({
          url: '/pages/index/index',
        })
      }else{
        query.bindOrder = 'success';
        wx.navigateTo({
          url: `/pages/order/orderDetail/orderDetail` + this.app.AcFunc.objToUrl(query),
        })
      }
    })
    .catch(e=>{
      query.bindOrder = 'fail';
      wx.navigateTo({
        url: `/pages/order/orderDetail/orderDetail` + this.app.AcFunc.objToUrl(query),
      })
        // if (this.app._getPageNow().route.indexOf('login/index') > -1) {
        //   let that = this
        //   wx.navigateBack({
        //     complete: function () {
        //       wx.navigateTo({
        //         url: `/pages/login/index` + that.app.AcFunc.objToUrl(query),
        //       })
        //     }
        //   })
        // } else {
        //   wx.navigateTo({
        //     url: `/pages/login/index` + this.app.AcFunc.objToUrl(query),
        //   })
        // }
    })
  }
  //查看分享的物流单
  //只传id物流单第一次尝试绑定，成功正常进入单据详情界面
  //失败url带上id=${id}&bindOrder=fail&action=viewLogisticsOrder，点击进入云店登录后再次viewLogisticsOrder传入bindOrderAgain=true，进入单据详情界面
  //分享进入的物流单，绑定物流单成功或失败，如果直接点击返回，调用wx.navigateBack成功回调viewSaleOrder，进入销售单绑定逻辑，物流单结束
  viewLogisticsOrder(query, bindOrderAgain = false) {
    this.app.reconnectToken({
      clearToken: !bindOrderAgain,
      navigateTo: false
    }).then(() => {
      let pamars = {
        ownerId: query.ownerId,
        orderId: query.id,
        username: query.username
      }
      this.app.HttpService.logistShare(pamars).then((res) => {
        console.log(res)
        //that.globalData.shareOrderDetail = res
        //that.setLogistDetail(res)
        let obj = {
          id: res.id,
          orderNo: res.orderNo
        }
        this.app.HttpService.logistBind([obj]).then(() => {
          console.error('viewLogisticsOrder绑定成功正常进入单据详情界面')
          query.id = res.id;
          query.bindOrder = 'success';
          wx.navigateTo({
            url: '/pages/order/logistDetail/logistDetail' + this.app.AcFunc.objToUrl(query),
          })
        }).catch((error) => {
          console.error(error)
          // query.id = res.id;
          query.bindOrder = 'pedding';
          wx.navigateTo({
            url: '/pages/order/logistDetail/logistDetail' + this.app.AcFunc.objToUrl(query),
          })
          this.app.AcFunc.myTotal(error, 'none')
        })
      }).catch((error) => {
        console.log(error)
        query.bindOrder = 'fail';
        wx.redirectTo({
          url: '/pages/order/logistDetail/logistDetail' + this.app.AcFunc.objToUrl(query),
        })
        this.app.AcFunc.myTotal(error, 'none')
      })
    }).catch((e) => {
      if (bindOrderAgain) {
        console.error('viewLogisticsOrder再次绑定失败，放弃绑定操作,弹出错误提示')
      } else {
        console.error('viewLogisticsOrder第一次绑定失败，进入未登录查看单据页面')
        query.bindOrder = 'fail';
        wx.redirectTo({
          url: '/pages/order/logistDetail/logistDetail' + this.app.AcFunc.objToUrl(query),
        })
      }
    })
  }
  //分享进入店铺
  viewCloudShop(query) {
    this.app.HttpService.changeshop({
      shopCode : query.code,
      shareUrl: this.app.AcFunc.objToUrl(query)
    }).then(res => {
      // this.app._setUser(res).then(()=>{
      //   wx.reLaunch({
      //     url: '/pages/index/index',
      //   })
      // })
      this.app.logout();
      this.app.getToken().then(res => {
        wx.reLaunch({
          url: '/pages/index/index',
        })
      })
    }).catch(e => {
      query.bindOrder = 'fail';
      console.log("this.app._getPageNow().route.indexOf('login/index') > -1", this.app._getPageNow().route.indexOf('login/index') > -1)
      if (this.app._getPageNow().route.indexOf('login/index') > -1) {
        let that=this
        wx.navigateBack({
          complete:function(){
            wx.navigateTo({
              url: `/pages/login/index` + that.app.AcFunc.objToUrl(query),
            })
          }
        })
      }else{
        wx.navigateTo({
          url: `/pages/login/index` + this.app.AcFunc.objToUrl(query),
        })
      }
    })
  }

  //消息模板查看云单
  viewOwnCloudShopOrder(query){
    wx.navigateTo({
      url: '/pages/order/orderDetail/orderDetail' + this.app.AcFunc.objToUrl(query),
    })
  }

  //消息模板查看物流单
  viewOwnLogisticsOrder(query){
    wx.navigateTo({
      url: '/pages/order/logistDetail/logistDetail' + this.app.AcFunc.objToUrl(query),
    })
  }
}


export default Action;,import __config from '../etc/config'
import WxResource from '../assets/plugins/wx-resource/lib/index'

class HttpResource {
    constructor(url, paramDefaults, actions, options) {
        Object.assign(this, {
            url,
            paramDefaults,
            actions,
            options,
        })
    }

    /**
     * 返回实例对象
     */
    init() {
        const resource = new WxResource(this.setUrl(this.url), this.paramDefaults, this.actions, this.options)
        resource.interceptors.use(this.setInterceptors())
        return resource
    }

    /**
     * 设置请求路径
     */
    setUrl(url) {
        return `${__config.basePath}${url}`
    }

    /**
     * 拦截器
     */
    setInterceptors() {
        return {
            request(request) {
                request.header = request.header || {}
                request.header['content-type'] = 'application/json'
                if (request.url.indexOf('/api') !== -1 && wx.getStorageSync('token')) {
                    request.header.Authorization = 'Bearer ' + wx.getStorageSync('token')
                }
                wx.showLoading({
                    title: '加载中',
                })
                return request
            },
            requestError(requestError) {
                wx.hideLoading()
                return Promise.reject(requestError)
            },
            response(response) {
                wx.hideLoading()
                if (response.statusCode === 401) {
                    wx.removeStorageSync('token')
                    wx.redirectTo({
                        url: '/pages/login/index'
                    })
                }
                return response
            },
            responseError(responseError) {
                wx.hideLoading()
                return Promise.reject(responseError)
            },
        }
    }
}

export default HttpResource,import WxRequest from '../assets/plugins/wx-request/lib/index'

class HttpService extends WxRequest {
  constructor(options) {
    super(options)
    this.$$prefix = ''
    this.$$path = {
      wechatSignUp: '/user/wechat/sign/up',
      wechatSignIn: '/user/wechat/sign/in',
      getToken: '/sys/user/token/get',//通用根据code获取Token
      getTokenByPhone: '/sys/user/token/get',//根据手机+店铺获取Token，登陆界面使用
      bindWX: '/sys/user/weixin/serviceAccount/bind',//绑定微信公众号，发消息
      getValidcodeMsg: '/sys/common/validcode/sms/send',
      singleUpload:'/sys/common/file/single/upload',
      downFile: '/sys/common/file/{fileId}/download',
      getxsfile: '/sys/common/file/{photoType}/{fileId}/xs/get',
      getfile: '/sys/common/file/{photoType}/{fileId}/get',
      addrSend: '/sys/user/notoken/{shopId}/get', //发货地址
      addrList: '/sys/address/pageList', //get  收货地址
      addrParse: '/sys/address/parse',
      addrCreate: '/sys/address/create',
      addrDelete: '/sys/address/delete',
      addrUpdate: '/sys/address/update',
      proclassify: '/prod/type/pageList', //产品分类
      prolist: '/prod/pageList', //产品列表
      prodDetail: '/prod/{prodId}/get', //产品详情
      logistList: '/order/logistic/pageList',
      logistDetail: '/order/logistic/{logisticOrderId}/get',
      logistCreate: '/order/logistic/create',
      logistUpdate: '/order/logistic/update',
      logistMatchLine: '/order/logistic/specialline/match', //物流路线
      logistQuery: '/order/logistic/fee/query', //查询运费
      logistClone: '/order/logistic/{id}/clone', //再次下单
      logistBind: '/order/logistic/binding', //绑定物流单据
      logistCancel: '/order/logistic/{id}/cancel', //取消物流单
      logistShare:'/order/logistic/share/get',
      orderList: '/order/pageList',
      orderCreate: '/order/create',
      orderUpdate: '/order/update',
      orderDelete: '/order/{orderId}/delete',
      orderDetail: '/order/{orderId}/get',
      orderBind: '/order/binding', //绑定销售单据
      orderShare:'/order/share/sales/get',
      cloudOrderShare:'/order/share/cloudShop/get',
      cartCount: '/order/cart/count',
      cartlist:'/order/cart/pageList',//购物车列表
      delcart:'/order/cart/delete',
      editcart:'/order/cart/update',
      cartCreate:'/order/cart/create',
      orderNumber: '/sys/common/number/get', //获取单号
      msglist: '/sys/msg/pageList', //获取信息列表
      msgCount: '/sys/msg/count',
      readmsg:'/sys/msg/status/read/update',
      userInfo: '/sys/user/get',
      browseshop:'/sys/user/shop/pageList',
      changeshop:'/sys/user/shop/switch',
      edituserInfo: '/sys/user/update',
      editusertel:'/sys/user/phone/update',
      orderPay: '/bss/account/order/create',
      payMsg: '/bss/account/order/pay/create',
      outlogo:'/sys/user/logout',
      notokenGetUser: '/sys/user/notoken/{shopCode}/get',
      createPayAccount:'/bss/account/order/create',
      createPayOrder:'/bss/account/order/pay/create',
      creatOrderNumber:'/bss/account/order/number/get',
      createWxOrder:'/bss/account/order/wechat/qrcode/get',
      getPayStatus: '/bss/account/order/status/get',
    }
    this.urlConf = function(pathName, ...arr) {
      let url = '';
      url = this.$$path[pathName].replace(/{[a-zA-Z0-9\$]+}/g, function() {
        return arr.shift()
      })
      return url;
    }
    this.blackList = [
      '/sys/user/token/get',
      '/sys/common/validcode/sms/send',
      '/order/share/sales/get',
      '/order/logistic/share/get',
      '/order/share/cloudShop/get',
      '/bss/account/order/create',
      '/bss/account/order/pay/create',
      '/bss/account/order/number/get',
      '/bss/account/order/wechat/qrcode/get',
      // '/order/binding',
    ]
    this.interceptors.blackList = this.blackList;
    this.interceptors.use({
      request(request, blackList) {
        request.header = request.header || {}
        request.header['content-type'] = 'application/json'
        request.header['user-client'] = 'weixin-mini'
        wx.showLoading({
          title: '加载中',
          mask:true,
        })
        let token = wx.getStorageSync('access_token');
        let needaddtoken = !blackList.includes(request.url.replace(getApp().__config.basePath, ''));
        if (!needaddtoken) {
          return request;
        } else{
          request.url = request.url + '?access_token=' + token;
          return request;
        }
        if (!needaddtoken) {
          return request;
        } else if (needaddtoken && token) {
          request.url = request.url + '?access_token=' + token;
          return request;
        } else {
          let promise = new Promise((resolve, reject) => {
            let time=0;
            let waitnum = setInterval(function() {
              time++;
              if(time>99){
                reject({
                  data: {
                    errorMsg: '缓存失效，请重新登录',
                    errorCode: 500,
                  }
                });
              }
              let access_token = wx.getStorageSync('access_token')
              if (access_token) {
                clearInterval(waitnum)
                request.url = request.url + '?access_token=' + access_token;
                resolve()
              }
            }, 100)
          });
          return promise.then(() => {
            return request;
          })
        }
      },
      requestError(requestError) {
        wx.hideLoading()
        return Promise.reject(requestError)
      },
      response(response) {
        wx.hideLoading()
        // if (response.statusCode === 401) {
        //   wx.removeStorageSync('token')
        //   wx.redirectTo({
        //     url: '/pages/login/index'
        //   })
        // }
        console.info('HttpService class response :',response)
        return response.data.data
      },
      responseError(responseError={data:{}}) {
        wx.hideLoading()
        console.warn('HttpService class responseError :',responseError);
        let data = responseError.data;
        let { errorMsg = '', errorCtx = '', errorCode=''}=data;
        if (errorCode =='402.00000000001'){
          let owner = wx.getStorageSync('owner');
          getApp()._closeShop({
            errCode: '402.00000000001',
            shopCode: owner.cloudShopVO.code
          })
          return new Promise((res, rej) => {})
        }
        if (errorCode =='402.00000000002'){
          let owner = wx.getStorageSync('owner');
          getApp()._closeShop({
            errCode: '402.00000000002',
            shopName: owner.cloudShopVO.name,
            contactNo: owner.cloudShopVO.contactNo
          })
          return new Promise((res,rej)=>{})
        }
        if (errorCode == '402.00000000003') {
          let owner = wx.getStorageSync('owner');
          getApp()._closeShop({
            errCode: '402.00000000003',
            shopName: owner.cloudShopVO.name,
            contactNo: owner.cloudShopVO.contactNo
          })
          return new Promise((res, rej) => { })
        } 
        let msg = errorMsg + '\n' + errorCtx;
        wx.showToast({
          title: msg,
          icon: 'none',
          duration: 1500
        })
        return Promise.reject(msg)
      },
    })
  }

  wechatSignUp(params) {
    return this.postRequest(this.$$path.wechatSignUp, {
      data: params,
    })
  }

  wechatSignIn(params) {
    return this.postRequest(this.$$path.wechatSignIn, {
      data: params,
    })
  }

  getToken(code) {
    let params = {
      loginType: 'WEIXIN_OPENID',
      weixinCode: code,
    }
    // params.weixinCode='17702761686'
    return this.postRequest(this.$$path.getTokenByPhone, {
      data: params
    })
  }

  getTokenByPhone(params) {
    let data = Object.assign({
      loginType: 'MOBILE_VERIFY_CODE',
      shareUrl : '',
    }, params)
    // data.weixinCode = data.mobile
    return this.postRequest(this.$$path.getTokenByPhone, {
      data: data
    })
  }
  bindWX(code){
    let params={
      weixinCode:code
    }
    return this.postRequest(this.$$path.bindWX, {
      data: params
    })
  }
  getValidcodeMsg(params) {
    return this.postRequest(this.$$path.getValidcodeMsg, {
      data: params
    })
  }
  
  logistList(params) {
    return this.postRequest(this.$$path.logistList, {
      data: params
    })
  }

  logistDetail(id) {
    return this.getRequest(this.urlConf('logistDetail', id))
  }

  logistCreate(params) {
    return this.postRequest(this.$$path.logistCreate, {
      data: params
    })
  }

  logistUpdate(params) {
    return this.postRequest(this.$$path.logistUpdate, {
      data: params
    })
  }

  logistMatchLine(params) {
    return this.postRequest(this.$$path.logistMatchLine, {
      data: params
    })
  }

  logistQuery(params) {
    return this.postRequest(this.$$path.logistQuery, {
      data: params
    })
  }

  logistClone(id) {
    return this.postRequest(this.urlConf('logistClone', id))
  }

  logistBind(params) {
    return this.postRequest(this.$$path.logistBind, {
      data: params
    })
  }

  logistCancel(id) {
    return this.postRequest(this.urlConf('logistCancel', id))
  }

  logistShare(params) {
    return this.postRequest(this.$$path.logistShare, {
      data: params
    })
  }

  singleUpload(){
    return this.postRequest(this.$$path.singleUpload)
  }

  downFile(id) {
    return this.getRequest(this.urlConf('downFile', id))
  }

  addrSend(id) {
    return this.getRequest(this.urlConf('addrSend', id))
  }

  addrList() {
    return this.getRequest(this.$$path.addrList)
  }

  addrCreate(params) {
    return this.postRequest(this.$$path.addrCreate, {
      data: params
    })
  }

  addrDelete(params) {
    return this.postRequest(this.$$path.addrDelete, {
      data: params
    })
  }

  addrUpadte(params) {
    return this.postRequest(this.$$path.addrUpadte, {
      data: params
    })
  } 

  addrParse(params) {
    return this.postRequest(this.$$path.addrParse, {
      data: params
    })
  }
  
  proclassify(params) {
    return this.postRequest(this.$$path.proclassify, {
      data: params
    })
  }

  prolist(params) {
    return this.postRequest(this.$$path.prolist, {
      data: params
    })
  }

  prodDetail(id) {
    return this.getRequest(this.urlConf('prodDetail', id))
  }

  orderList(params) {
    return this.postRequest(this.$$path.orderList, {
      data: params
    })
  }

  orderCreate(params) {
    return this.postRequest(this.$$path.orderCreate, {
      data: params
    })
  }

  orderUpdate(params) {
    return this.postRequest(this.$$path.orderUpdate, {
      data: params
    })
  }

  orderDelete(id) {
    return this.deleteRequest(this.urlConf('orderDelete', id))
  }

  orderDetail(id) {
    return this.getRequest(this.urlConf('orderDetail', id))
  }

  orderBind(params) {
    return this.postRequest(this.$$path.orderBind, {
      data: params
    })
  }
  orderShare(params) {
    return this.postRequest(this.$$path.orderShare, {
      data: params
    })
  }
  cloudOrderShare(params) {
    return this.postRequest(this.$$path.cloudOrderShare, {
      data: params
    })
  }
  getCartCount() {
    return this.getRequest(this.$$path.cartCount)
  }
  cartlist(params){
    return this.postRequest(this.$$path.cartlist,{
      data: params
    })
  }
  delcart(params) {
    return this.postRequest(this.$$path.delcart, {
      data: params
    })
  } 
  editcart(params) {
    return this.postRequest(this.$$path.editcart, {
      data: params
    })
  }
  cartCreate(params) {
    return this.postRequest(this.$$path.cartCreate, {
      data: params
    })
  }
  orderNumber(params) {
    return this.postRequest(this.$$path.orderNumber, {
      data: params
    })
  }

  getmsglist(params) {
    return this.postRequest(this.$$path.msglist, {
      data: params
    })
  }
  msgCount() {
    return this.getRequest(this.$$path.msgCount)
  }
  readmsg(params) {
    return this.postRequest(this.$$path.readmsg, {
      data: params
    })
  }
  userInfo() {
    return this.postRequest(this.$$path.userInfo)
  }
  browseshop(){
    return this.getRequest(this.$$path.browseshop)
  }
  changeshop(data){
    let params = Object.assign({shareUrl:''}, data);
    return this.postRequest(this.$$path.changeshop, {
      data: params
    })
  }
  getxsfile(photoType, fileId){
    return this.getRequest(this.urlConf('getxsfile', photoType, fileId))
  }
  edituserInfo(params) {
    return this.postRequest(this.$$path.edituserInfo, {
      data: params
    })
  }
  editusertel(params) {
    return this.postRequest(this.$$path.editusertel, {
      data: params
    })
  }
  addrUpdate(params) {
    return this.postRequest(this.$$path.addrUpdate, {
      data: params
    })
  }
  orderPay(params){
    return this.postRequest(this.$$path.orderPay, {
      data: params
    })
  }
  payMsg(params) {
    return this.postRequest(this.$$path.payMsg, {
      data: params
    })
  }
  outlogo(){
    return this.getRequest(this.$$path.outlogo)
  }
  notokenGetUser(code){
    return this.getRequest(this.urlConf('notokenGetUser', code))
  }
  createPayAccount(params) {
    return this.postRequest(this.$$path.createPayAccount, {
      data: params
    })
  }
  createPayOrder(params) {
    return this.postRequest(this.$$path.createPayOrder, {
      data: params
    })
  }
  creatOrderNumber(params){
    let data = Object.assign({ prefix: 'GMFWZF', length: 8 }, params)
    return this.postRequest(this.$$path.creatOrderNumber, {
      data: data
    })
  }
  createWxOrder(params) {
    return this.postRequest(this.$$path.createWxOrder, {
      data: params
    })
  }
  getPayStatus(params){
    return this.postRequest(this.$$path.getPayStatus, {
      data: params
    })
  }
}

export default HttpService,/**
 * 支付
 * @param {Object} options 参数 { logisticOrderId: '0', logisticCompName: '物流商名字', totalAmt: '1' }
 * @param {string} options.totalAmt 订单金额
 * @param {string} options.logisticOrderId 物流单id
 * @param {string} options.logisticCompName 物流商名字
 * @param {string} options.ownerId 未登录时传ownerId
 * 获取单号，创建bss订单，创建支付订单，创建微信支付订单获取微信支付信息，调用微信支付API,支付完成后查询支付结果
 */
class Pay {
  constructor(options) {
    this.totalAmt = options.totalAmt;
    this.logisticOrderId = options.logisticOrderId
    this.logisticCompName = options.logisticCompName
    this.ownerId = options.ownerId
    this.app = getApp();
    this.code = '';
    //bss订单号
    this.orderCode = '';
    //bss订单id
    this.accountOrderId = '0'
  }

  init() {
    return this.app._getCode().then(res => {
        this.code=res;
        return this.creatOrderNumber()
      })
      .then(res => {
        return this.createPayAccount()
      })
      .then(res => {
        return this.createPayOrder()
      })
      .then(res => {
        return this.createWxOrder()
      })
      .then(res => {
        return this.wxPay(res)
      })
      .then(res => {
        return this.getPayStatus()
      })
  }

  /**
   * 获取单号
   */
  creatOrderNumber() {
    return this.app.HttpService.creatOrderNumber({
      ownerId: this.ownerId
    }).then(res => {
      this.orderCode = res;
    })
  }

  /**
   * 创建bss订单
   */
  createPayAccount() {
    let data = {
      // userName:null,
      code: this.code,
      ownerId: this.ownerId,
      productDetailList: [{
        id: 16,
        buyTime: "1",
        productCode: "0018"
      }],
      logisticsPayVO: {
        "logisticOrderId": this.logisticOrderId,
        "logisticCompName": this.logisticCompName
      },
      timeNum: '24',
      "totalAmt": this.totalAmt,
      "channel": "WEIXIN",
      "timeNum": 24,
      "orderBeginDate": Date.getLocalTime(),
      "orderEndDate": Date.getLocalTime(24),
      "orderCreateDate": Date.getLocalTime(24),
      "orderCode": this.orderCode,
    }
    console.log('createPayAccount', JSON.stringify(data));
    return this.app.HttpService.createPayAccount(data).then(res => {
      this.accountOrderId = res.id
    })
  }

  /**
   * 创建用户支付订单
   */
  createPayOrder() {
    let data = {
      ownerId: this.ownerId,
      "currency": "RMB",
      "payWay": "wechatpay",
      "totalAmt": this.totalAmt,
      "accountOrderId": this.accountOrderId,
      "accountAmt": 0,
      "amt": this.totalAmt,
      // "payDate": "2018-11-30",
      // "payStatus": "notpaid",
      // "remark": "",
      "vouchertAmt": 0
    }
    return this.app.HttpService.createPayOrder(data).then(res => {
      // this.orderNumber = res;
    })
  }

  /**
   * 创建微信支付订单
   */
  createWxOrder() {
    let data = {
      code: this.code,
      ownerId: this.ownerId,
      "orderId": this.orderCode,
      "actualPay": Math.floor(this.totalAmt * 100), //后台王歆说这个值微信需要乘100
      "type": "JSAPI"
    }
    return this.app.HttpService.createWxOrder(data)
  }

  /**
   * 调用微信支付方法
   */
  wxPay(res) {
    return new Promise((resolve, reject) => {
      let data = {
        'timeStamp': res.timestamp.toString(),
        'nonceStr': res.nonce_str,
        'package': 'prepay_id=' + res.prepay_id,
        'signType': 'MD5',
        'paySign': res.sign,
      }
      console.log('调用微信支付方法参数为：', data, JSON.stringify(data))
      wx.requestPayment({
        'timeStamp': res.timestamp.toString(),
        'nonceStr': res.nonce_str,
        'package': 'prepay_id=' + res.prepay_id,
        'signType': 'MD5',
        'paySign': res.sign,
        'success': function(res) {
          console.warn('微信支付requestPayment 成功时间：', (new Date()).format('yyyy-MM-dd hh:mm:ss'))
          resolve(res)
        },
        'fail': function(res) {
          console.error('requestPayment方法fail：', res)
          reject(res)
        },
        'complete': function(res) {}
      })
    })
  }

  /**
   * 查询支付是否成功
  */
  getPayStatus(){
    let data = {
      "ordercode": this.orderCode,
      "ownerId": this.ownerId,
    }
    return this.app.HttpService.getPayStatus(data)
  }
}
// var p = new Pay({ totalAmt: '1' })
// p.init()

export default Pay;,/**
 * 初始化权限，默认读取商户设置信息，传入单据初始化单据信息
 * 
 * @param {Object} orderVO 传入单据信息
 * 
 */
const P = function(orderVO) {
  let json = {};
  let owner = {};
  if (orderVO) {
    owner = orderVO.ownerCfg;
    owner.cloudShopVO = {};
    owner.cloudShopVO.productPermissionVO = owner.productPermissionVO
  } else {
    owner = wx.getStorageSync('owner')
  }
  let {
    ownerBizVO,
    ownerIndustryVO,
    ownerItemVO,
    ownerMZServiceVO
  } = owner;
  let {
    cloudShopFlag,
    clientPermissionVO,
    productPermissionVO
  } = owner.cloudShopVO
  json = Object.assign({}, ownerBizVO, ownerIndustryVO, ownerItemVO, ownerMZServiceVO,
    cloudShopFlag, clientPermissionVO, productPermissionVO);
  if (ownerItemVO.measType == 'size') {
    json.extent = true;
    json.width = true;
    json.height = true;
    json.volume = false;
  } else {
    json.extent = false;
    json.width = false;
    json.height = false;
    json.volume = true;
  }
  for (let i in json) {
    if (!json[i]) {
      json[i] = false;
    } else {
      json[i] = true;
    }
  }
  return json
}


export default P,var _createClass=function(){function a(e,c){for(var b=0;b<c.length;b++){var d=c[b];d.enumerable=d.enumerable||false;d.configurable=true;if("value" in d){d.writable=true}Object.defineProperty(e,d.key,d)}}return function(d,b,c){if(b){a(d.prototype,b)}if(c){a(d,c)}return d}}();function _classCallCheck(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}var ERROR_CONF={KEY_ERR:311,KEY_ERR_MSG:"key格式错误",PARAM_ERR:310,PARAM_ERR_MSG:"请求参数信息有误",SYSTEM_ERR:600,SYSTEM_ERR_MSG:"系统错误",WX_ERR_CODE:1000,WX_OK_CODE:200};var BASE_URL="https://apis.map.qq.com/ws/";var URL_SEARCH=BASE_URL+"place/v1/search";var URL_SUGGESTION=BASE_URL+"place/v1/suggestion";var URL_GET_GEOCODER=BASE_URL+"geocoder/v1/";var URL_CITY_LIST=BASE_URL+"district/v1/list";var URL_AREA_LIST=BASE_URL+"district/v1/getchildren";var URL_DISTANCE=BASE_URL+"distance/v1/";var Utils={location2query:function location2query(c){if(typeof c=="string"){return c}var b="";for(var a=0;a<c.length;a++){var e=c[a];if(!!b){b+=";"}if(e.location){b=b+e.location.lat+","+e.location.lng}if(e.latitude&&e.longitude){b=b+e.latitude+","+e.longitude}}return b},getWXLocation:function getWXLocation(c,b,a){wx.getLocation({type:"gcj02",success:c,fail:b,complete:a})},getLocationParam:function getLocationParam(b){if(typeof b=="string"){var a=b.split(",");if(a.length===2){b={latitude:b.split(",")[0],longitude:b.split(",")[1]}}else{b={}}}return b},polyfillParam:function polyfillParam(a){a.success=a.success||function(){};a.fail=a.fail||function(){};a.complete=a.complete||function(){}},checkParamKeyEmpty:function checkParamKeyEmpty(c,b){if(!c[b]){var a=this.buildErrorConfig(ERROR_CONF.PARAM_ERR,ERROR_CONF.PARAM_ERR_MSG+b+"参数格式有误");c.fail(a);c.complete(a);return true}return false},checkKeyword:function checkKeyword(a){return !this.checkParamKeyEmpty(a,"keyword")},checkLocation:function checkLocation(c){var a=this.getLocationParam(c.location);if(!a||!a.latitude||!a.longitude){var b=this.buildErrorConfig(ERROR_CONF.PARAM_ERR,ERROR_CONF.PARAM_ERR_MSG+" location参数格式有误");c.fail(b);c.complete(b);return false}return true},buildErrorConfig:function buildErrorConfig(a,b){return{status:a,message:b}},buildWxRequestConfig:function buildWxRequestConfig(c,a){var b=this;a.header={"content-type":"application/json"};a.method="GET";a.success=function(d){var e=d.data;if(e.status===0){c.success(e)}else{c.fail(e)}};a.fail=function(d){d.statusCode=ERROR_CONF.WX_ERR_CODE;c.fail(b.buildErrorConfig(ERROR_CONF.WX_ERR_CODE,result.errMsg))};a.complete=function(d){var e=+d.statusCode;switch(e){case ERROR_CONF.WX_ERR_CODE:c.complete(b.buildErrorConfig(ERROR_CONF.WX_ERR_CODE,d.errMsg));break;case ERROR_CONF.WX_OK_CODE:var f=d.data;if(f.status===0){c.complete(f)}else{c.complete(b.buildErrorConfig(f.status,f.message))}break;default:c.complete(b.buildErrorConfig(ERROR_CONF.SYSTEM_ERR,ERROR_CONF.SYSTEM_ERR_MSG))}};return a},locationProcess:function locationProcess(f,e,c,a){var d=this;c=c||function(g){g.statusCode=ERROR_CONF.WX_ERR_CODE;f.fail(d.buildErrorConfig(ERROR_CONF.WX_ERR_CODE,g.errMsg))};a=a||function(g){if(g.statusCode==ERROR_CONF.WX_ERR_CODE){f.complete(d.buildErrorConfig(ERROR_CONF.WX_ERR_CODE,g.errMsg))}};if(!f.location){d.getWXLocation(e,c,a)}else{if(d.checkLocation(f)){var b=Utils.getLocationParam(f.location);e(b)}}}};var QQMapWX=function(){function b(i){_classCallCheck(this,b);if(!i.key){throw Error("key值不能为空")}this.key=i.key}_createClass(b,[{key:"search",value:function f(i){var l=this;i=i||{};Utils.polyfillParam(i);if(!Utils.checkKeyword(i)){return}var k={keyword:i.keyword,orderby:i.orderby||"_distance",page_size:i.page_size||10,page_index:i.page_index||1,output:"json",key:l.key};if(i.address_format){k.address_format=i.address_format}if(i.filter){k.filter=i.filter}var n=i.distance||"1000";var j=i.auto_extend||1;var m=function m(o){k.boundary="nearby("+o.latitude+","+o.longitude+","+n+","+j+")";wx.request(Utils.buildWxRequestConfig(i,{url:URL_SEARCH,data:k}))};Utils.locationProcess(i,m)}},{key:"getSuggestion",value:function h(i){var k=this;i=i||{};Utils.polyfillParam(i);if(!Utils.checkKeyword(i)){return}var j={keyword:i.keyword,region:i.region||"全国",region_fix:i.region_fix||0,policy:i.policy||0,output:"json",key:k.key};wx.request(Utils.buildWxRequestConfig(i,{url:URL_SUGGESTION,data:j}))}},{key:"reverseGeocoder",value:function a(i){var k=this;i=i||{};Utils.polyfillParam(i);var j={coord_type:i.coord_type||5,get_poi:i.get_poi||0,output:"json",key:k.key};if(i.poi_options){j.poi_options=i.poi_options}var l=function l(m){j.location=m.latitude+","+m.longitude;wx.request(Utils.buildWxRequestConfig(i,{url:URL_GET_GEOCODER,data:j}))};Utils.locationProcess(i,l)}},{key:"geocoder",value:function g(i){var k=this;i=i||{};Utils.polyfillParam(i);if(Utils.checkParamKeyEmpty(i,"address")){return}var j={address:i.address,output:"json",key:k.key};wx.request(Utils.buildWxRequestConfig(i,{url:URL_GET_GEOCODER,data:j}))}},{key:"getCityList",value:function c(i){var k=this;i=i||{};Utils.polyfillParam(i);var j={output:"json",key:k.key};
wx.request(Utils.buildWxRequestConfig(i,{url:URL_CITY_LIST,data:j}))}},{key:"getDistrictByCityId",value:function d(i){var k=this;i=i||{};Utils.polyfillParam(i);if(Utils.checkParamKeyEmpty(i,"id")){return}var j={id:i.id||"",output:"json",key:k.key};wx.request(Utils.buildWxRequestConfig(i,{url:URL_AREA_LIST,data:j}))}},{key:"calculateDistance",value:function e(i){var k=this;i=i||{};Utils.polyfillParam(i);if(Utils.checkParamKeyEmpty(i,"to")){return}var j={mode:i.mode||"walking",to:Utils.location2query(i.to),output:"json",key:k.key};var l=function l(m){j.from=m.latitude+","+m.longitude;wx.request(Utils.buildWxRequestConfig(i,{url:URL_DISTANCE,data:j}))};if(i.from){i.location=i.from}Utils.locationProcess(i,l)}}]);return b}();module.exports=QQMapWX;,class rpn {
  constructor(exp) {
    if (!exp) return this;
    this.$exp = exp;
    this.$rpnExp = this.$outputRpn().join('');
  }

  toRpn() {
    return this.$rpnExp;
  }

  calculate() {
    return this.$calCommonExp(this.$exp)
  }

  $outputRpn() {
    let exp = this.$exp;
    let inputStack = [], outputStack = [], outputQueue = [], firstIsOperator = false;

    exp.replace(/\s/g, '');
    if (this.$isOperator(exp[0])) {
      exp = exp.substring(1);
      firstIsOperator = true;
    }
    for (let i = 0, max = exp.length; i < max; i++) {
      if (!this.$isOperator(exp[i]) && !this.$isOperator(exp[i - 1]) && (i !== 0)) {
        inputStack[inputStack.length - 1] = inputStack[inputStack.length - 1] + exp[i] + '';
      } else {
        inputStack.push(exp[i]);
      }
    }
    if (firstIsOperator) {
      inputStack[0] = -inputStack[0]
    }
    while (inputStack.length > 0) {
      let cur = inputStack.shift();
      if (this.$isOperator(cur)) {
        if (cur === '(') {
          outputStack.push(cur);
        } else if (cur === ')') {
          let po = outputStack.pop();
          while (po !== '(' && outputStack.length > 0) {
            outputQueue.push(po);
            po = outputStack.pop();
          }
        } else {
          while (this.$prioraty(cur, outputStack[outputStack.length - 1]) && outputStack.length > 0) {
            outputQueue.push(outputStack.pop());
          }
          outputStack.push(cur)
        }
      } else {
        outputQueue.push(Number(cur));
      }
    }
    if (outputStack.length > 0) {
      while (outputStack.length > 0) {
        outputQueue.push(outputStack.pop());
      }
    }
    return outputQueue;
  }

  $isOperator(value) {
    const operatorString = '+-*/()×÷';
    return operatorString.includes(value);
  }

  $getPrioraty(value) {
    if (value === '-' || value === '+') {
      return 1;
    } else if (value === '*' || value === '/' || value === '×' || value === '÷') {
      return 2;
    } else {
      return 0;
    }
  }

  $prioraty(v1, v2) {
    return this.$getPrioraty(v1) <= this.$getPrioraty(v2);
  }

  $calRpnExp(rpnArr) {
    const stack = [];
    for (let i = 0, max = rpnArr.length; i < max; i++) {
      if (!this.$isOperator(rpnArr[i])) {
        stack.push(rpnArr[i]);
      } else {
        let num1 = stack.pop(), num2 = stack.pop(), num;
        if (rpnArr[i] === '-') {
          num = num2 - num1;
        } else if (rpnArr[i] === '+') {
          num = num2 + num1;
        } else if (rpnArr[i] === '*' || rpnArr[i] === '×') {
          num = num2 * num1;
        } else if (rpnArr[i] === '/' || rpnArr[i] === '÷') {
          num = num2 / num1;
        }
        stack.push(num);
      }
    }
    return stack[0];
  }

  $calCommonExp(exp) {
    let rpnArr = this.$outputRpn(exp);
    return this.$calRpnExp(rpnArr)
  }
}

export default rpn;,export default {
  // 线上环境
  // basePath: 'https://yundian.ydcfo.com/api', 
  // wxappid: 'wxee3ef2a474742906',
  // domain: 'https://yundian.ydcfo.com/', 
  
  // 本地环境
  basePath: 'https://ydtest.ydcfo.com/CXF/rs',
  // basePath: 'http://192.168.1.105:8310/CXF/rs',
  wxappid: 'wxc52ed58bf82ea628',//测试环境的微信公众号appid
  domain: 'https://logtest.ydcfo.com',
},
/*个人新增*/
image{
  vertical-align: middle;
}
.float-left {
  float: left;
}

.float-right {
  float: right;
}

.text-right {
  text-align: right;
}
.text-left {
  text-align: left;
}
.text-center {
  text-align: center;
}

.clearfix:after {
  display: block;
  clear: both;
  content: "";
}
.border-box{
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
}
.overflow{
  overflow: hidden;
}
.breakWord{
  word-break: break-all;
}
.flex {
  display: -webkit-box;
  display: flex;
}

.flex.f-row {
  -webkit-box-orient: horizontal;
  -webkit-box-direction: normal;
  flex-direction: row;
}

.flex.row-rev {
  -webkit-box-orient: horizontal;
  -webkit-box-direction: reverse;
  flex-direction: row-reverse;
}

.flex.f-col {
  -webkit-box-orient: vertical;
  -webkit-box-direction: normal;
  flex-direction: column;
}

.flex.col-rev {
  -webkit-box-orient: vertical;
  -webkit-box-direction: reverse;
  flex-direction: column-reverse;
}

.flex.nowrap {
  flex-wrap: nowrap;
}

.flex.f-wrap {
  flex-wrap: wrap;
}

.flex.wrap-rev {
  flex-wrap: wrap-reverse;
}

.flex.item-base {
  -webkit-box-align: baseline;
  align-items: baseline;
}

.flex.item-top {
  -webkit-box-align: start;
  align-items: flex-start;
}

.flex.item-bottom {
  -webkit-box-align: end;
  align-items: flex-end;
}

.flex.item-center {
  -webkit-box-align: center;
  align-items: center;
}

.flex.item-full {
  -webkit-box-align: stretch;
  align-items: stretch;
}

.flex.just-con-l {
  -webkit-box-pack: start;
  justify-content: flex-start;
}

.flex.just-con-r {
  -webkit-box-pack: end;
  justify-content: flex-end;
}

.flex.just-con-c {
  -webkit-box-pack: center;
  justify-content: center;
}

.flex.just-con-b {
  -webkit-box-pack: justify;
  justify-content: space-between;
}

.flex.just-con-a {
  justify-content: space-around;
}

.flex.align-top {
  align-content: flex-start;
}

.flex.align-bottom {
  align-content: flex-end;
}

.flex.align-center {
  align-content: center;
}

.flex.align-full {
  align-content: stretch;
}

.flex.align-between {
  align-content: space-between;
}

.flex.align-round {
  align-content: space-around;
}

.flex.align-stretch {
  align-content: stretch;
}

.flex .order {
  -webkit-box-ordinal-group: 2;
  order: 1;
}

.flex .flex-1 {
  -webkit-box-flex: 1;
  flex-grow: 1;
}

.flex .flex-2 {
  -webkit-box-flex: 2;
  flex-grow: 2;
}

.flex .flex-3 {
  -webkit-box-flex: 3;
  flex-grow: 3;
}

.flex .flex-4 {
  -webkit-box-flex: 4;
  flex-grow: 4;
}

.flex .shrink-0 {
  flex-shrink: 0;
}

.flex .shrink-1 {
  flex-shrink: 1;
}

.flex .flex-basis {
  flex-basis: auto;
}

.flex .flex-basis-0 {
  flex-basis: 0;
}

.flex .self {
  align-self: auto;
}

.flex .self-top {
  align-self: flex-start;
}

.flex .self-base {
  align-self: baseline;
}

.flex .self-bottom {
  align-self: flex-end;
}

.flex .self-center {
  align-self: center;
}

.flex .self-full {
  align-self: stretch;
}

.clamp {
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  display: box;
  -webkit-box-orient: vertical;
}

.textEllipsis {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.clamp.clamp-3 {
  -webkit-line-clamp: 3;
}
.clamp.clamp-2 {
  -webkit-line-clamp: 2;
}
.clamp.clamp-1 {
  -webkit-line-clamp: 1;
}
.imagemiddle{
  align-items:center;
  display: -webkit-flex;
}
.overpoint{
  text-overflow:ellipsis;
  white-space: nowrap;
  overflow: hidden;
}
.largeimg{
  width: 400rpx;
  height: 400rpx;
  position: fixed;
  left: 175rpx;
  top:300rpx;
},
page {
  line-height: 1.6;
  font-family: -apple-system-font, Helvetica Neue, sans-serif;
}

icon {
  vertical-align: middle;
}

.weui-cells {
  position: relative;
  margin-top: 1.17647059em;
  background-color: #fff;
  line-height: 1.41176471;
  font-size: 17px;
}

.weui-cells:before {
  top: 0;
  border-top: 1rpx solid #d9d9d9;
}

.weui-cells:after, .weui-cells:before {
  content: " ";
  position: absolute;
  left: 0;
  right: 0;
  height: 1px;
  color: #d9d9d9;
}

.weui-cells:after {
  bottom: 0;
  border-bottom: 1rpx solid #d9d9d9;
}

.weui-cells__title {
  margin-top: 0.77em;
  margin-bottom: 0.3em;
  padding-left: 15px;
  padding-right: 15px;
  color: #999;
  font-size: 14px;
}

.weui-cells_after-title {
  margin-top: 0;
}

.weui-cells__tips {
  margin-top: 0.3em;
  color: #999;
  padding-left: 15px;
  padding-right: 15px;
  font-size: 14px;
}

.weui-cell {
  padding: 10px 15px;
  position: relative;
  display: -webkit-box;
  display: -webkit-flex;
  display: flex;
  -webkit-box-align: center;
  -webkit-align-items: center;
  align-items: center;
}

.weui-cell:before {
  content: " ";
  position: absolute;
  top: 0;
  right: 0;
  height: 1px;
  border-top: 1rpx solid #d9d9d9;
  color: #d9d9d9;
  left: 15px;
}

.weui-cell:first-child:before {
  display: none;
}

.weui-cell_active {
  background-color: #ececec;
}

.weui-cell_primary {
  -webkit-box-align: start;
  -webkit-align-items: flex-start;
  align-items: flex-start;
}

.weui-cell__bd {
  -webkit-box-flex: 1;
  -webkit-flex: 1;
  flex: 1;
}

.weui-cell__ft {
  text-align: right;
  color: #999;
}

.weui-cell_access {
  color: inherit;
}

.weui-cell__ft_in-access {
  padding-right: 13px;
  position: relative;
}

.weui-cell__ft_in-access:after {
  content: " ";
  display: inline-block;
  height: 6px;
  width: 6px;
  border-width: 2px 2px 0 0;
  border-color: #c8c8cd;
  border-style: solid;
  -webkit-transform: matrix(0.71, 0.71, -.71, 0.71, 0, 0);
  transform: matrix(0.71, 0.71, -.71, 0.71, 0, 0);
  top: -2px;
  position: absolute;
  top: 50%;
  margin-top: -4px;
  right: 2px;
}

.weui-cell_link {
  color: #586c94;
  font-size: 14px;
}

.weui-cell_link:active {
  background-color: #ececec;
}

.weui-cell_link:first-child:before {
  display: block;
}

.weui-icon-radio {
  margin-left: 3.2px;
  margin-right: 3.2px;
}

.weui-icon-checkbox_circle, .weui-icon-checkbox_success {
  margin-left: 4.6px;
  margin-right: 4.6px;
}

.weui-check__label:active {
  background-color: #ececec;
}

.weui-check {
  position: absolute;
  left: -9999px;
}

.weui-check__hd_in-checkbox {
  padding-right: 0.35em;
}

.weui-cell__ft_in-radio {
  padding-left: 0.35em;
}

.weui-cell_input {
  padding-top: 0;
  padding-bottom: 0;
}

.weui-label {
  width: 105px;
  word-wrap: break-word;
  word-break: break-all;
}

.weui-input {
  height: 2.58823529em;
  min-height: 2.58823529em;
  line-height: 2.58823529em;
}

.weui-toptips {
  position: fixed;
  -webkit-transform: translateZ(0);
  transform: translateZ(0);
  top: 0;
  left: 0;
  right: 0;
  padding: 5px;
  font-size: 14px;
  text-align: center;
  color: #fff;
  z-index: 5000;
  word-wrap: break-word;
  word-break: break-all;
}

.weui-toptips_warn {
  background-color: #e64340;
}

.weui-textarea {
  display: block;
  width: 100%;
}

.weui-textarea-counter {
  color: #b2b2b2;
  text-align: right;
}

.weui-cell_warn, .weui-textarea-counter_warn {
  color: #e64340;
}

.weui-form-preview {
  position: relative;
  background-color: #fff;
}

.weui-form-preview:before {
  top: 0;
  border-top: 1rpx solid #d9d9d9;
}

.weui-form-preview:after, .weui-form-preview:before {
  content: " ";
  position: absolute;
  left: 0;
  right: 0;
  height: 1px;
  color: #d9d9d9;
}

.weui-form-preview:after {
  bottom: 0;
  border-bottom: 1rpx solid #d9d9d9;
}

.weui-form-preview__value {
  font-size: 14px;
}

.weui-form-preview__value_in-hd {
  font-size: 26px;
}

.weui-form-preview__hd {
  position: relative;
  padding: 10px 15px;
  text-align: right;
  line-height: 2.5em;
}

.weui-form-preview__hd:after {
  content: " ";
  position: absolute;
  bottom: 0;
  right: 0;
  height: 1px;
  border-bottom: 1rpx solid #d9d9d9;
  color: #d9d9d9;
  left: 15px;
}

.weui-form-preview__bd {
  padding: 10px 15px;
  font-size: 0.9em;
  text-align: right;
  color: #999;
  line-height: 2;
}

.weui-form-preview__ft {
  position: relative;
  line-height: 50px;
  display: -webkit-box;
  display: -webkit-flex;
  display: flex;
}

.weui-form-preview__ft:after {
  content: " ";
  position: absolute;
  left: 0;
  top: 0;
  right: 0;
  height: 1px;
  border-top: 1rpx solid #d5d5d6;
  color: #d5d5d6;
}

.weui-form-preview__item {
  overflow: hidden;
}

.weui-form-preview__label {
  float: left;
  margin-right: 1em;
  min-width: 4em;
  color: #999;
  text-align: justify;
  text-align-last: justify;
}

.weui-form-preview__value {
  display: block;
  overflow: hidden;
  word-break: normal;
  word-wrap: break-word;
}

.weui-form-preview__btn {
  position: relative;
  display: block;
  -webkit-box-flex: 1;
  -webkit-flex: 1;
  flex: 1;
  color: #3cc51f;
  text-align: center;
}

.weui-form-preview__btn:after {
  content: " ";
  position: absolute;
  left: 0;
  top: 0;
  width: 1px;
  bottom: 0;
  border-left: 1rpx solid #d5d5d6;
  color: #d5d5d6;
}

.weui-form-preview__btn:first-child:after {
  display: none;
}

.weui-form-preview__btn_active {
  background-color: #eee;
}

.weui-form-preview__btn_default {
  color: #999;
}

.weui-form-preview__btn_primary {
  color: #0bb20c;
}

.weui-cell_select {
  padding: 0;
}

.weui-select {
  position: relative;
  padding-left: 15px;
  padding-right: 30px;
  height: 2.58823529em;
  min-height: 2.58823529em;
  line-height: 2.58823529em;
  border-right: 1rpx solid #d9d9d9;
}

.weui-select:before {
  content: " ";
  display: inline-block;
  height: 6px;
  width: 6px;
  border-width: 2px 2px 0 0;
  border-color: #c8c8cd;
  border-style: solid;
  -webkit-transform: matrix(0.71, 0.71, -.71, 0.71, 0, 0);
  transform: matrix(0.71, 0.71, -.71, 0.71, 0, 0);
  top: -2px;
  position: absolute;
  top: 50%;
  right: 15px;
  margin-top: -4px;
}

.weui-select_in-select-after {
  padding-left: 0;
}

.weui-cell__bd_in-select-before, .weui-cell__hd_in-select-after {
  padding-left: 15px;
}

.weui-cell_vcode {
  padding-right: 0;
}

.weui-vcode-btn, .weui-vcode-img {
  margin-left: 5px;
  height: 2.58823529em;
  vertical-align: middle;
}

.weui-vcode-btn {
  display: inline-block;
  padding: 0 0.6em 0 0.7em;
  border-left: 1px solid #e5e5e5;
  line-height: 2.58823529em;
  font-size: 17px;
  color: #3cc51f;
  white-space: nowrap;
}

.weui-vcode-btn:active {
  color: #52a341;
}

.weui-cell_switch {
  padding-top: 6px;
  padding-bottom: 6px;
}

.weui-uploader__hd {
  display: -webkit-box;
  display: -webkit-flex;
  display: flex;
  padding-bottom: 10px;
  -webkit-box-align: center;
  -webkit-align-items: center;
  align-items: center;
}

.weui-uploader__title {
  -webkit-box-flex: 1;
  -webkit-flex: 1;
  flex: 1;
}

.weui-uploader__info {
  color: #b2b2b2;
}

.weui-uploader__bd {
  margin-bottom: -4px;
  margin-right: -9px;
  overflow: hidden;
}

.weui-uploader__file {
  float: left;
  margin-right: 9px;
  margin-bottom: 9px;
}

.weui-uploader__img {
  display: block;
  width: 79px;
  height: 79px;
}

.weui-uploader__file_status {
  position: relative;
}

.weui-uploader__file_status:before {
  content: " ";
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  background-color: rgba(0, 0, 0, 0.5);
}

.weui-uploader__file-content {
  position: absolute;
  top: 50%;
  left: 50%;
  -webkit-transform: translate(-50%, -50%);
  transform: translate(-50%, -50%);
  color: #fff;
}

.weui-uploader__input-box {
  float: left;
  position: relative;
  margin-right: 9px;
  margin-bottom: 9px;
  width: 77px;
  height: 77px;
  border: 1px solid #d9d9d9;
}

.weui-uploader__input-box:after, .weui-uploader__input-box:before {
  content: " ";
  position: absolute;
  top: 50%;
  left: 50%;
  -webkit-transform: translate(-50%, -50%);
  transform: translate(-50%, -50%);
  background-color: #d9d9d9;
}

.weui-uploader__input-box:before {
  width: 2px;
  height: 39.5px;
}

.weui-uploader__input-box:after {
  width: 39.5px;
  height: 2px;
}

.weui-uploader__input-box:active {
  border-color: #999;
}

.weui-uploader__input-box:active:after, .weui-uploader__input-box:active:before {
  background-color: #999;
}

.weui-uploader__input {
  position: absolute;
  z-index: 1;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
}

.weui-article {
  padding: 20px 15px;
  font-size: 15px;
}

.weui-article__section {
  margin-bottom: 1.5em;
}

.weui-article__h1 {
  font-size: 18px;
  font-weight: 400;
  margin-bottom: 0.9em;
}

.weui-article__h2 {
  font-size: 16px;
  font-weight: 400;
  margin-bottom: 0.34em;
}

.weui-article__h3 {
  font-weight: 400;
  font-size: 15px;
  margin-bottom: 0.34em;
}

.weui-article__p {
  margin: 0 0 0.8em;
}

.weui-msg {
  padding-top: 36px;
  text-align: center;
}

.weui-msg__link {
  display: inline;
  color: #586c94;
}

.weui-msg__icon-area {
  margin-bottom: 30px;
}

.weui-msg__text-area {
  margin-bottom: 25px;
  padding: 0 20px;
}

.weui-msg__title {
  margin-bottom: 5px;
  font-weight: 400;
  font-size: 20px;
}

.weui-msg__desc {
  font-size: 14px;
  color: #999;
}

.weui-msg__opr-area {
  margin-bottom: 25px;
}

.weui-msg__extra-area {
  margin-bottom: 15px;
  font-size: 14px;
  color: #999;
}

@media screen and (min-height:438px) {
  .weui-msg__extra-area {
    position: fixed;
    left: 0;
    bottom: 0;
    width: 100%;
    text-align: center;
  }
}

.weui-flex {
  display: -webkit-box;
  display: -webkit-flex;
  display: flex;
}

.weui-flex_item {
  -webkit-box-flex: 1;
  -webkit-flex: 1;
  flex: 1;
}
.weui-flex_center{
  align-items:center;
  justify-content:center;
  align-self: center;
}
.weui-flex-col {
  -webkit-box-orient: vertical;
  -webkit-box-direction: normal;
  flex-direction: column;
}

.weui-btn {
  margin-top: 15px;
}

.weui-btn:first-child {
  margin-top: 0;
}

.weui-btn-area {
  margin: 1.17647059em 15px 0.3em;
}

.weui-agree {
  display: block;
  padding: 0.5em 15px;
  font-size: 13px;
}

.weui-agree__text {
  color: #999;
}

.weui-agree__link {
  display: inline;
  color: #586c94;
}

.weui-agree__checkbox {
  position: absolute;
  left: -9999px;
}

.weui-agree__checkbox-icon {
  position: relative;
  top: 2px;
  display: inline-block;
  border: 1px solid #d1d1d1;
  background-color: #fff;
  border-radius: 3px;
  width: 11px;
  height: 11px;
}

.weui-agree__checkbox-icon-check {
  position: absolute;
  top: 1px;
  left: 1px;
}

.weui-footer {
  color: #999;
  font-size: 14px;
  text-align: center;
}

.weui-footer_fixed-bottom {
  position: fixed;
  bottom: 0.52em;
  left: 0;
  right: 0;
}

.weui-footer__links {
  font-size: 0;
}

.weui-footer__link {
  display: inline-block;
  vertical-align: top;
  margin: 0 0.62em;
  position: relative;
  font-size: 14px;
  color: #586c94;
}

.weui-footer__link:before {
  content: " ";
  position: absolute;
  left: 0;
  width: 1px;
  border-left: 1rpx solid #c7c7c7;
  color: #c7c7c7;
  left: -.65em;
  top: 0.36em;
  bottom: 0.36em;
}

.weui-footer__link:first-child:before {
  display: none;
}

.weui-footer__text {
  padding: 0 0.34em;
  font-size: 12px;
}

.weui-grids {
  border-top: 1rpx solid #d9d9d9;
  border-left: 1rpx solid #d9d9d9;
  overflow: hidden;
}

.weui-grid {
  position: relative;
  float: left;
  padding: 20px 10px;
  width: 33.33333333%;
  box-sizing: border-box;
  border-right: 1rpx solid #d9d9d9;
  border-bottom: 1rpx solid #d9d9d9;
}

.weui-grid_active {
  background-color: #ececec;
}

.weui-grid__icon {
  display: block;
  width: 28px;
  height: 28px;
  margin: 0 auto;
}

.weui-grid__label {
  margin-top: 5px;
  display: block;
  text-align: center;
  color: #000;
  font-size: 14px;
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}

.weui-loading {
  margin: 0 5px;
  width: 20px;
  height: 20px;
  display: inline-block;
  vertical-align: middle;
  -webkit-animation: a 1s steps(12) infinite;
  animation: a 1s steps(12) infinite;
  background: transparent url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHBhdGggZmlsbD0ibm9uZSIgZD0iTTAgMGgxMDB2MTAwSDB6Ii8+PHJlY3Qgd2lkdGg9IjciIGhlaWdodD0iMjAiIHg9IjQ2LjUiIHk9IjQwIiBmaWxsPSIjRTlFOUU5IiByeD0iNSIgcnk9IjUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAgLTMwKSIvPjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjIwIiB4PSI0Ni41IiB5PSI0MCIgZmlsbD0iIzk4OTY5NyIgcng9IjUiIHJ5PSI1IiB0cmFuc2Zvcm09InJvdGF0ZSgzMCAxMDUuOTggNjUpIi8+PHJlY3Qgd2lkdGg9IjciIGhlaWdodD0iMjAiIHg9IjQ2LjUiIHk9IjQwIiBmaWxsPSIjOUI5OTlBIiByeD0iNSIgcnk9IjUiIHRyYW5zZm9ybT0icm90YXRlKDYwIDc1Ljk4IDY1KSIvPjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjIwIiB4PSI0Ni41IiB5PSI0MCIgZmlsbD0iI0EzQTFBMiIgcng9IjUiIHJ5PSI1IiB0cmFuc2Zvcm09InJvdGF0ZSg5MCA2NSA2NSkiLz48cmVjdCB3aWR0aD0iNyIgaGVpZ2h0PSIyMCIgeD0iNDYuNSIgeT0iNDAiIGZpbGw9IiNBQkE5QUEiIHJ4PSI1IiByeT0iNSIgdHJhbnNmb3JtPSJyb3RhdGUoMTIwIDU4LjY2IDY1KSIvPjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjIwIiB4PSI0Ni41IiB5PSI0MCIgZmlsbD0iI0IyQjJCMiIgcng9IjUiIHJ5PSI1IiB0cmFuc2Zvcm09InJvdGF0ZSgxNTAgNTQuMDIgNjUpIi8+PHJlY3Qgd2lkdGg9IjciIGhlaWdodD0iMjAiIHg9IjQ2LjUiIHk9IjQwIiBmaWxsPSIjQkFCOEI5IiByeD0iNSIgcnk9IjUiIHRyYW5zZm9ybT0icm90YXRlKDE4MCA1MCA2NSkiLz48cmVjdCB3aWR0aD0iNyIgaGVpZ2h0PSIyMCIgeD0iNDYuNSIgeT0iNDAiIGZpbGw9IiNDMkMwQzEiIHJ4PSI1IiByeT0iNSIgdHJhbnNmb3JtPSJyb3RhdGUoLTE1MCA0NS45OCA2NSkiLz48cmVjdCB3aWR0aD0iNyIgaGVpZ2h0PSIyMCIgeD0iNDYuNSIgeT0iNDAiIGZpbGw9IiNDQkNCQ0IiIHJ4PSI1IiByeT0iNSIgdHJhbnNmb3JtPSJyb3RhdGUoLTEyMCA0MS4zNCA2NSkiLz48cmVjdCB3aWR0aD0iNyIgaGVpZ2h0PSIyMCIgeD0iNDYuNSIgeT0iNDAiIGZpbGw9IiNEMkQyRDIiIHJ4PSI1IiByeT0iNSIgdHJhbnNmb3JtPSJyb3RhdGUoLTkwIDM1IDY1KSIvPjxyZWN0IHdpZHRoPSI3IiBoZWlnaHQ9IjIwIiB4PSI0Ni41IiB5PSI0MCIgZmlsbD0iI0RBREFEQSIgcng9IjUiIHJ5PSI1IiB0cmFuc2Zvcm09InJvdGF0ZSgtNjAgMjQuMDIgNjUpIi8+PHJlY3Qgd2lkdGg9IjciIGhlaWdodD0iMjAiIHg9IjQ2LjUiIHk9IjQwIiBmaWxsPSIjRTJFMkUyIiByeD0iNSIgcnk9IjUiIHRyYW5zZm9ybT0icm90YXRlKC0zMCAtNS45OCA2NSkiLz48L3N2Zz4=) no-repeat;
  background-size: 100%;
}

.weui-loading.weui-loading_transparent {
  background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 100 100'%3E%3Cpath fill='none' d='M0 0h100v100H0z'/%3E%3Crect xmlns='http://www.w3.org/2000/svg' width='7' height='20' x='46.5' y='40' fill='rgba(255,255,255,.56)' rx='5' ry='5' transform='translate(0 -30)'/%3E%3Crect width='7' height='20' x='46.5' y='40' fill='rgba(255,255,255,.5)' rx='5' ry='5' transform='rotate(30 105.98 65)'/%3E%3Crect width='7' height='20' x='46.5' y='40' fill='rgba(255,255,255,.43)' rx='5' ry='5' transform='rotate(60 75.98 65)'/%3E%3Crect width='7' height='20' x='46.5' y='40' fill='rgba(255,255,255,.38)' rx='5' ry='5' transform='rotate(90 65 65)'/%3E%3Crect width='7' height='20' x='46.5' y='40' fill='rgba(255,255,255,.32)' rx='5' ry='5' transform='rotate(120 58.66 65)'/%3E%3Crect width='7' height='20' x='46.5' y='40' fill='rgba(255,255,255,.28)' rx='5' ry='5' transform='rotate(150 54.02 65)'/%3E%3Crect width='7' height='20' x='46.5' y='40' fill='rgba(255,255,255,.25)' rx='5' ry='5' transform='rotate(180 50 65)'/%3E%3Crect width='7' height='20' x='46.5' y='40' fill='rgba(255,255,255,.2)' rx='5' ry='5' transform='rotate(-150 45.98 65)'/%3E%3Crect width='7' height='20' x='46.5' y='40' fill='rgba(255,255,255,.17)' rx='5' ry='5' transform='rotate(-120 41.34 65)'/%3E%3Crect width='7' height='20' x='46.5' y='40' fill='rgba(255,255,255,.14)' rx='5' ry='5' transform='rotate(-90 35 65)'/%3E%3Crect width='7' height='20' x='46.5' y='40' fill='rgba(255,255,255,.1)' rx='5' ry='5' transform='rotate(-60 24.02 65)'/%3E%3Crect width='7' height='20' x='46.5' y='40' fill='rgba(255,255,255,.03)' rx='5' ry='5' transform='rotate(-30 -5.98 65)'/%3E%3C/svg%3E");
}

@-webkit-keyframes a {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }

  to {
    -webkit-transform: rotate(1turn);
    transform: rotate(1turn);
  }
}

@keyframes a {
  0% {
    -webkit-transform: rotate(0deg);
    transform: rotate(0deg);
  }

  to {
    -webkit-transform: rotate(1turn);
    transform: rotate(1turn);
  }
}

.weui-badge {
  display: inline-block;
  padding: 0.15em 0.4em;
  min-width: 8px;
  border-radius: 18px;
  background-color: #e64340;
  color: #fff;
  line-height: 1.2;
  text-align: center;
  font-size: 12px;
  vertical-align: middle;
}

.weui-badge_dot {
  padding: 0.4em;
  min-width: 0;
}

.weui-loadmore {
  width: 65%;
  margin: 1.5em auto;
  line-height: 1.6em;
  font-size: 14px;
  text-align: center;
}

.weui-loadmore__tips {
  display: inline-block;
  vertical-align: middle;
}

.weui-loadmore_line {
  border-top: 1px solid #e5e5e5;
  margin-top: 2.4em;
}

.weui-loadmore__tips_in-line {
  position: relative;
  top: -.9em;
  padding: 0 0.55em;
  background-color: #fff;
  color: #999;
}

.weui-loadmore__tips_in-dot {
  position: relative;
  padding: 0 0.16em;
  width: 4px;
  height: 1.6em;
}

.weui-loadmore__tips_in-dot:before {
  content: " ";
  position: absolute;
  top: 50%;
  left: 50%;
  margin-top: -1px;
  margin-left: -2px;
  width: 4px;
  height: 4px;
  border-radius: 50%;
  background-color: #e5e5e5;
}

.weui-panel {
  background-color: #fff;
  margin-top: 10px;
  position: relative;
  overflow: hidden;
}

.weui-panel:first-child {
  margin-top: 0;
}

.weui-panel:before {
  top: 0;
  border-top: 1rpx solid #e5e5e5;
}

.weui-panel:after, .weui-panel:before {
  content: " ";
  position: absolute;
  left: 0;
  right: 0;
  height: 1px;
  color: #e5e5e5;
}

.weui-panel:after {
  bottom: 0;
  border-bottom: 1rpx solid #e5e5e5;
}

.weui-panel__hd {
  padding: 14px 15px 10px;
  color: #999;
  font-size: 13px;
  position: relative;
}

.weui-panel__hd:after {
  content: " ";
  position: absolute;
  bottom: 0;
  right: 0;
  height: 1px;
  border-bottom: 1rpx solid #e5e5e5;
  color: #e5e5e5;
  left: 15px;
}

.weui-media-box {
  padding: 15px;
  position: relative;
}

.weui-media-box:before {
  content: " ";
  position: absolute;
  top: 0;
  right: 0;
  height: 1px;
  border-top: 1rpx solid #e5e5e5;
  color: #e5e5e5;
  left: 15px;
}

.weui-media-box:first-child:before {
  display: none;
}

.weui-media-box__title {
  font-weight: 400;
  font-size: 17px;
  width: auto;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  word-wrap: break-word;
  word-break: break-all;
}

.weui-media-box__desc {
  color: #999;
  font-size: 13px;
  line-height: 1.2;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-box-orient: vertical;
  -webkit-line-clamp: 2;
}

.weui-media-box__info {
  margin-top: 15px;
  padding-bottom: 5px;
  font-size: 13px;
  color: #cecece;
  line-height: 1em;
  list-style: none;
  overflow: hidden;
}

.weui-media-box__info__meta {
  float: left;
  padding-right: 1em;
}

.weui-media-box__info__meta_extra {
  padding-left: 1em;
  border-left: 1px solid #cecece;
}

.weui-media-box__title_in-text {
  margin-bottom: 8px;
}

.weui-media-box_appmsg {
  display: -webkit-box;
  display: -webkit-flex;
  display: flex;
  -webkit-box-align: center;
  -webkit-align-items: center;
  align-items: center;
}

.weui-media-box__thumb {
  width: 100%;
  height: 100%;
  vertical-align: top;
}

.weui-media-box__hd_in-appmsg {
  margin-right: 0.8em;
  width: 60px;
  height: 60px;
  line-height: 60px;
  text-align: center;
}

.weui-media-box__bd_in-appmsg {
  -webkit-box-flex: 1;
  -webkit-flex: 1;
  flex: 1;
  min-width: 0;
}

.weui-media-box_small-appmsg {
  padding: 0;
}

.weui-cells_in-small-appmsg {
  margin-top: 0;
}

.weui-cells_in-small-appmsg:before {
  display: none;
}

.weui-progress {
  display: -webkit-box;
  display: -webkit-flex;
  display: flex;
  -webkit-box-align: center;
  -webkit-align-items: center;
  align-items: center;
}

.weui-progress__bar {
  -webkit-box-flex: 1;
  -webkit-flex: 1;
  flex: 1;
}

.weui-progress__opr {
  margin-left: 15px;
  font-size: 0;
}

.weui-navbar {
  display: -webkit-box;
  display: -webkit-flex;
  display: flex;
  position: absolute;
  z-index: 500;
  top: 0;
  width: 100%;
  border-bottom: 1rpx solid #ccc;
}

.weui-navbar__item {
  position: relative;
  display: block;
  -webkit-box-flex: 1;
  -webkit-flex: 1;
  flex: 1;
  padding: 13px 0;
  text-align: center;
  font-size: 0;
}

.weui-navbar__item.weui-bar__item_on {
  color: #1aad19;
}

.weui-navbar__slider {
  position: absolute;
  content: " ";
  left: 0;
  bottom: 0;
  width: 6em;
  height: 3px;
  background-color: #1aad19;
  -webkit-transition: -webkit-transform 0.3s;
  transition: -webkit-transform 0.3s;
  transition: transform 0.3s, -webkit-transform 0.3s;
}

.weui-navbar__title {
  display: inline-block;
  font-size: 15px;
  max-width: 8em;
  width: auto;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  word-wrap: normal;
}

.weui-tab {
  position: relative;
  height: 100%;
}

.weui-tab__panel {
  box-sizing: border-box;
  height: 100%;
  padding-top: 50px;
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

.weui-search-bar {
  position: relative;
  padding: 8px 10px;
  display: -webkit-box;
  display: -webkit-flex;
  display: flex;
  box-sizing: border-box;
  background-color: #efeff4;
  border-top: 1rpx solid #d7d6dc;
  border-bottom: 1rpx solid #d7d6dc;
}

.weui-icon-search {
  margin-right: 8px;
  font-size: inherit;
}

.weui-icon-search_in-box {
  position: absolute;
  left: 10px;
  top: 7px;
}

.weui-search-bar__text {
  display: inline-block;
  font-size: 14px;
  vertical-align: middle;
}

.weui-search-bar__form {
  position: relative;
  -webkit-box-flex: 1;
  -webkit-flex: auto;
  flex: auto;
  border-radius: 5px;
  background: #fff;
  border: 1rpx solid #e6e6ea;
}

.weui-search-bar__box {
  position: relative;
  padding-left: 30px;
  padding-right: 30px;
  width: 100%;
  box-sizing: border-box;
  z-index: 1;
}

.weui-search-bar__input {
  height: 28px;
  line-height: 28px;
  font-size: 14px;
}

.weui-icon-clear {
  position: absolute;
  top: 0;
  right: 0;
  padding: 7px 8px;
  font-size: 0;
}

.weui-search-bar__label {
  position: absolute;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  z-index: 2;
  border-radius: 3px;
  text-align: center;
  color: #9b9b9b;
  background: #fff;
  line-height: 28px;
}

.weui-search-bar__cancel-btn {
  margin-left: 10px;
  line-height: 28px;
  color: #09bb07;
  white-space: nowrap;
}

,let allMan = new Array(); //日历容器


const formatTime = date => {
  const _date = new Date(date)
  const year = _date.getFullYear()
  const month = _date.getMonth() + 1
  const day = _date.getDate()
  const hour = _date.getHours()
  const minute = _date.getMinutes()
  const second = _date.getSeconds()

  return [year, month, day].map(formatNumber).join('/') + ' ' + [hour, minute, second].map(formatNumber).join(':')
}

const formatNumber = n => {
  n = n.toString()
  return n[1] ? n : '0' + n
}

const getToday = (name) => {
  let date = new Date();
  let cur_year = date.getFullYear();
  let cur_month = date.getMonth() + 1;
  let cur_day = date.getDate();
  let cur_hour = date.getHours()
  let cur_minute = date.getMinutes()
  let cur_second = date.getSeconds()
  if(name=='day'){
    return [cur_year, cur_month, cur_day].map(formatNumber).join('-')
  }else if(name=='dayAndMint'){
    return [cur_year, cur_month, cur_day].map(formatNumber).join('-') + ' ' + [cur_hour, cur_minute].map(formatNumber).join(':')
  }else{
    return [cur_year, cur_month, cur_day].map(formatNumber).join('-') + ' ' + [cur_hour, cur_minute, cur_second].map(formatNumber).join(':')
  }
  
}
const getMyDays = (days) => {
  let n = 10;
  let allDays = []
  if (days) {
    n = days
  }
  let date = new Date();
  let cur_year = date.getFullYear();
  let cur_month = date.getMonth() + 1;
  let cur_day = date.getDate();
  let _day=cur_year+'/' + cur_month + '/' + cur_day
  let now = new Date(_day).getTime()
  for (let i = 0; i < n; i++) {
    let nextTime = 24 * 60 * 60 * 1000 * i;
    let newTime = formatDay(nextTime + now);
    allDays.push(newTime)
  }
  return allDays;
}
const formatDay = (times) => {
  let _date = new Date(times);
  let y = _date.getFullYear()
  let m = _date.getMonth() + 1;
  let d = _date.getDate()
  m = m > 9 ? m : '0' + m
  d = d > 9 ? d : '0' + d
  let newday = y + '-' + m + '-' + d;
  return newday
}

//获取购物车商品数量
const getCartGoods = (n) => {
  //请求后台接口
  //设置tabBar购物车数量
  wx.setTabBarBadge({
    index: 1,
    text: ''+n
  })
}
//获未读消息数量
const getnewsnum = (num) => {
  wx.showTabBarRedDot({
    index: num,
  })
}
module.exports = {
  formatTime: formatTime,
  getCartGoods: getCartGoods,
  getMyDays: getMyDays,
  getToday: getToday,
  getnewsnum: getnewsnum,
  formatDay: formatDay
},let app=getApp()
//let qqmap = require('../../helpers/qqmap-wx-jssdk.min.js')
let qqmapsdk
Page({
  data: {
    region: ['', '', '请选择'],
    customItem: '请选择',
    addrDetail: '',
    textArea:'',
    isEdit: false,
    hasAddr: false,
    showdelbtn:false,
    delid:null
  },
  onLoad: function (options) {
    let addressEdit = options.addr
    if (addressEdit) {
      addressEdit = JSON.parse(addressEdit)
      console.log(addressEdit)
      this.setData({
        region: [addressEdit.province, addressEdit.city, addressEdit.district],
        addrDetail: addressEdit.addressDetail,
        addressEdit:addressEdit,
        isEdit: true,
        delid: addressEdit.id//“我的-修改地址”中的删除地址用的
      })
      if (options.candel) {//“我的-修改地址”中的删除地址用的
        this.setData({
          showdelbtn:true
        })
      }
    }
    // qqmapsdk = new qqmap({
    //   key: 'EFZBZ-VFC3X-REB4R-7HPCG-5EPIQ-GHFTG' //这里自己的key秘钥进行填充
    // });
  },
  onReady: function () {

  },
  onShow: function () {

  },
  onUnload:function(){
    this.setData({
      region: ['', '', '请选择'],
      addrDetail: '请输入详细地址',
      isEdit: false,
      hasAddr:false
    })
  },
  bindRegionChange: function (e) {
    this.setData({
      region: e.detail.value
    })
  },
  inputChange: function (e) {
    this.setData({
      addrDetail: e.detail.value
    })
  },
  //“我的-修改地址”中的删除地址用的
  delBtn(){
    let that = this
    wx.showModal({
      title: '提示',
      content: '确定删除吗？',
      success(res) {
        if (res.confirm) {
          let params = [that.data.delid]
          app.HttpService.addrDelete(params).then((res) => {
            wx.navigateBack({});
          }).catch((res) => {

          })
        } else if (res.cancel) {
          
        }
      }
    })
    
  },
  saveBtn: function (e) {
    let val = this.data.addrDetail
    let region = this.data.region
    let picker = false
    let isEdit = this.data.isEdit
    for (let i in region) {
      if (region[i] == '请选择') {
        picker = true
        break
      }
    }
    if (picker) {
      wx.showModal({
        title: '提示',
        content: '请选择省市区',
      })
      return
    }
    if (val == '') {
      wx.showModal({
        title: '提示',
        content: '请输入详细地址',
      })
      return
    }
    let pamars=[{
      province: region[0],
      city: region[1],
      district: region[2],
      addressDetail: val
    }]
    if (isEdit) {
      pamars[0].id = this.data.addressEdit.id
      app.HttpService.addrUpdate(pamars).then((res) => {
        if (res.length > 0){
          wx.navigateBack({})
        }
      }).catch((error) => {
        console.log(error)
      })
    }else{
      app.HttpService.addrCreate(pamars).then((res) => {
          console.log(res)
        if (res.length>0) {
          wx.navigateBack({})
        }
      }).catch((error) => {
        app.AcFunc.myTotal(error, 'none')
      })
    }
  },
  getAddress: function () {
    let textArea = this.data.textArea
    let that =this
    if (textArea){
      app.HttpService.addrParse({
        addressDetail: textArea
      }).then((res)=>{
        console.log(res)
        that.setData({
          region: [res.province, res.city, res.district],
          addrDetail: res.addressDetail,
        })
      }).catch((error)=>{
        app.AcFunc.myTotal(error)
      })
    }else{
      app.AcFunc.myTotal('请输入地址信息','none')
    }
    this.setData({
      hasAddr: true
    })
  },
  getUserLocation: function () {
    let that = this;
    wx.getSetting({
      success: (res) => {
        // res.authSetting['scope.userLocation'] == undefined    表示 初始化进入该页面
        // res.authSetting['scope.userLocation'] == false    表示 非初始化进入该页面,且未授权
        // res.authSetting['scope.userLocation'] == true    表示 地理位置授权
        if (res.authSetting['scope.userLocation'] != undefined && res.authSetting['scope.userLocation'] != true) {
          wx.showModal({
            title: '请求授权当前位置',
            content: '需要获取您的地理位置，请确认授权',
            success: function (res) {
              if (res.cancel) {
                wx.showToast({
                  title: '拒绝授权',
                  icon: 'none',
                  duration: 1000
                })
              } else if (res.confirm) {
                wx.openSetting({
                  success: function (dataAu) {
                    if (dataAu.authSetting["scope.userLocation"] == true) {
                      wx.showToast({
                        title: '授权成功',
                        icon: 'success',
                        duration: 1000
                      })
                      //再次授权，调用wx.getLocation的API
                      that.getLocation();
                    } else {
                      wx.showToast({
                        title: '授权失败',
                        icon: 'none',
                        duration: 1000
                      })
                    }
                  }
                })
              }
            }
          })
        } else if (res.authSetting['scope.userLocation'] == undefined) {
          //调用wx.getLocation的API
          that.getLocation();
        }
        else {
          //调用wx.getLocation的API
          that.getLocation();
        }
      }
    })
  },
  // 微信获得经纬度
  getLocation: function () {
    let that = this;
    wx.getLocation({
      type: 'wgs84',
      success: function (res) {
        var latitude = res.latitude
        var longitude = res.longitude
        var speed = res.speed
        var accuracy = res.accuracy;
        that.getLocal(latitude, longitude)
      },
      fail: function (res) {
        console.log('fail' + JSON.stringify(res))
      }
    })
  },
  // 获取当前地理位置
  getLocal: function (latitude, longitude) {
    let that = this;
    qqmapsdk.reverseGeocoder({
      location: {//120.741459,31.260328
        latitude: latitude,
        longitude: longitude
      },
      success: function (res) {
        console.log(res)
        let address = res.result.address
        let province = res.result.ad_info.province
        let city = res.result.ad_info.city
        let district = res.result.ad_info.district ? res.result.ad_info.district : ''
        let street = res.result.address_component.street ? res.result.address_component.street : ''
        let street_number = res.result.address_component.street_number ? res.result.address_component.street_number : ''
        that.setData({
          region: [province, city, district],
          addrDetail: street,
          textArea: address
        })

      },
      fail: function (res) {
        console.log(res);
      },
      complete: function (res) {
        // console.log(res);
      }
    });
  },
  textChange:function(e){
    let val=e.detail.value
    this.setData({
      textArea: val
    })
  }
})
,{"navigationBarTitleText": "新增收货地址"},<form>
  <view class='addressMod'>
    <view class='inputMod flex'>
      <view class='name'>选择地址</view>
      <view class='flex-1'>

        <picker mode="region" bindchange="bindRegionChange" value="{{region}}" custom-item="{{customItem}}">
          <view class="picker c666">
            {{region[0]}}{{region[1]}}{{region[2]}}
          </view>
          <icon class='iconfont icon-Right'></icon>
        </picker>

      </view>
    </view>
    <view class='inputMod flex'>
      <view class='name'>详细地址</view>
      <view class='flex-1'>
        <!-- <icon class='iconfont icon-Right'></icon> -->
        <input type='text' class='c666' placeholder='请输入详细地址' value='{{addrDetail}}' bindinput='inputChange'></input>
      </view>
    </view>
    <view class='intelAddr'>
      <view class='title'>
        <image src='/images/order/ai.png' mode='widthFix'></image><text>地址智能识别</text>
      </view>
      <view>
        <textarea class='border-box' name='aiAddress' value='{{textArea}}' placeholder='例:上海市徐汇区枫林街道斜土路100号' bindinput='textChange'></textarea>
      </view>
      <view class='clearfix'>
        <button type='{{textArea?"success":""}}' bindtap='getAddress'>智能识别</button>
      </view>
    </view>
    <view class='btnBox'>
      <button type='success' bindtap='saveBtn'>保存</button>
    </view>
    <view class='btnBox del' wx:if='{{showdelbtn}}'>
      <button type='success' bindtap='delBtn'>删除</button>
    </view>
  </view>

</form>,.addressMod{
  margin-top:24rpx;
}
.inputMod{
  background: #fff;
  padding:0 20rpx;
  height:80rpx;
  line-height: 80rpx;
  border-bottom:1px solid #EDEDF2;
}
.inputMod .name{
  width: 140rpx;
}
.inputMod .flex-1{
  text-align: right;
  position: relative;
}
.inputMod input{
  height:100%;
  line-height: 80rpx;
}
.inputMod picker,.inputMod input{
  padding-right:40rpx;
}
.inputMod .icon-Right{
  position: absolute;
  font-size:24rpx;
  right:0;
  top:0;
}
.intelAddr{
  margin-top:24rpx;
  background: #fff;
  padding:0 20rpx;
}
.intelAddr .title{
  padding:20rpx 0;
  font-size:28rpx;
}
.intelAddr .title image{
  display: inline-block;
  width: 50rpx;
  vertical-align: top;
}
.intelAddr .title text{
  display: inline-block;
  margin-left:20rpx;
}
.intelAddr textarea{
  width: 100%;
  background: #f8f8f8;
  height:140rpx;
  border-radius: 0.3em;
  padding:20rpx;
}
.intelAddr .clearfix{
  padding:20rpx 0;
}
.intelAddr button{
  float:right;
  font-size:28rpx;
  color:#999;
}
.btnBox{
  margin-top:60rpx;
  padding:20rpx;
}
.del{
  margin-top: 30rpx;
}
.del button{
  background: transparent;
  color: #333!important;
  border-color: #CFCFCF;
},const app = getApp()
import AcFunc from '../../helpers/acFunc.js'
Page({
  data: {
    p: null,
    carts: [],
    tiptext: '管理',
    origincheck: 0,
    originnum: 0,
    totalnum: AcFunc.money(0, 2, false),
    allcheck: false,
    txtStyle: "left:0;",
    editIndex: 0,
    delBtnWidth: 158, //删除按钮宽度单位（rpx）
    stateshow: true,
    showtip: false,
    showtiptext: '',
  },
  onLoad: function(option) {
  },
  onShow: function() {
    this.setData({
      allcheck: false,
      totalnum: AcFunc.money(0, 2, false),
      originnum: 0,
      origincheck: 0,
      stateshow: true,
      tiptext: '管理',
    })
    this.getCart();
    app.setMsgCount()
  },
  //获取购物车信息
  getCart() {
    let that = this;
    let topnum = 0;
    let param = {
      pageNum: 0,
      pageSize: 1000
    }
    let againpro = wx.getStorageSync('againOrder')
    app.setCartCount();
    that.sv = that.selectComponent("#cartlazyRoll");
    app.HttpService.cartlist(param).then(res => {
      let p = getApp().P();
      if (res.cartVOS && res.cartVOS.length > 0) {
        for (let a = 0; a < res.cartVOS.length; a++) {
          res.cartVOS[a].modalname = res.cartVOS[a].name
          if ((res.cartVOS[a].specId !== 0 && p.specFlag) && (res.cartVOS[a].colorId !== 0 && p.colorFlag)){
            res.cartVOS[a].modalname = res.cartVOS[a].modalname + '-' + res.cartVOS[a].specName + '-' + res.cartVOS[a].colorName
          }
          if ((res.cartVOS[a].specId == 0 || !p.specFlag) && (res.cartVOS[a].colorId !== 0 && p.colorFlag)) {
            res.cartVOS[a].modalname = res.cartVOS[a].modalname + '-' + res.cartVOS[a].colorName
          }
          if ((res.cartVOS[a].specId !== 0 && p.specFlag) && (res.cartVOS[a].colorId == 0 || !p.colorFlag)) {
            res.cartVOS[a].modalname = res.cartVOS[a].modalname + '-' + res.cartVOS[a].specName
          }
          res.cartVOS[a].colorNamebool = res.cartVOS[a].colorId == 0?false:true
          res.cartVOS[a].specNamebool = res.cartVOS[a].specId == 0 ? false : true
          res.cartVOS[a].selected = false;
          topnum = topnum + res.cartVOS[a].qty
          //再次下单的产品需勾选
          if (againpro.length>0){
            for (let b = 0; b < againpro.length;b++){
              if (res.cartVOS[a].id == againpro[b].id){
                res.cartVOS[a].selected = true;
              }
            }
          }       
          res.cartVOS[a].imgsrc = res.cartVOS[a].photo ? app.getxsimg('thumbnail', res.cartVOS[a].photo) : '/images/buy/defaultpro.png'
          if (res.cartVOS[a].unitPrice || res.cartVOS[a].unitPrice == 0){
            res.cartVOS[a].unitPricemark = '￥' + res.cartVOS[a].unitPrice;
            if (res.cartVOS[a].unitName && (((p['viewProductSalesPriceOne'] || p['viewProductSalesPriceTwo'] || p['viewProductSalesPriceThree'] || p['viewProductSalesPriceFour']) && p['morePriceFlag']) || (!p['morePriceFlag'] && p['viewProductSalesPriceOne']))) {
              res.cartVOS[a].unitNameline = '/' + res.cartVOS[a].unitName
            } else if (res.cartVOS[a].unitName){
              res.cartVOS[a].unitNameline = res.cartVOS[a].unitName
            }
          }else{
            if (res.cartVOS[a].unitName) {
              res.cartVOS[a].unitNameline = res.cartVOS[a].unitName
            }
          }
        }
        that.setData({
          p: p,
          carts: res.cartVOS,
          allcheck: false,
          totalnum: AcFunc.money(0, 2, false),
          originnum: 0,
          origincheck: 0,
        });
      }else{
        that.setData({
          p: p,
          carts: [],
          allcheck: false,
          totalnum: AcFunc.money(0, 2, false),
          originnum: 0,
          origincheck: 0,
        });
      }
      that.sv.init({
        height: 194,
        metaArray: this.data.carts,
        showLength: 10,
        scrollHeight: 1100
      });
      if (againpro.length > 0) {
        this.checknumFunc()
        this.checktotalnumFunc()
        this.getTotalPrice()
        this.ifcheckAll(this.data.carts)
      }
      this.sv.reload();
      wx.setNavigationBarTitle({
        title: '购物车(' + AcFunc.money(topnum, 6, true)+')'
      })
      wx.removeStorageSync('againOrder')
    })
  },
  //点击产品名称弹框出现
  viewProname(e) {
    this.setData({
      showtip: true,
      showtiptext: e.currentTarget.dataset.name
    })
  },
  //隐藏产品名称弹框
  hidetip() {
    this.setData({
      showtip: false,
    })
  },
  //左滑开始
  touchS: function (e) {
    console.log("touchS:" + e);
    var list = this.data.carts;
    for (let a = 0; a < list.length;a++){
      list[a].txtStyle = "left:0px";
    }
    this.setData({
      carts: list
    });
    if (e.touches.length == 1) {
      this.setData({
        startX: e.touches[0].clientX
      });
    }
    this.sv.reload();
  },
  //左滑移动
  touchM: function(e) {
    console.log(e);
    var that = this
    if (e.touches.length == 1) {
      var moveX = e.touches[0].clientX;
      var disX = that.data.startX - moveX;
      var delBtnWidth = that.data.delBtnWidth;
      var txtStyle = "";
      if (disX == 0 || disX < 0) {
        txtStyle = "left:0px";
      } else if (disX > 0) {
        txtStyle = "left:-" + disX + "rpx";
        if (disX >= delBtnWidth) {
          txtStyle = "left:-" + delBtnWidth + "rpx";
        }
      }
      var index = e.currentTarget.dataset.index;
      var list = that.data.carts;
      list[index].txtStyle = txtStyle;
      this.setData({
        carts: list
      });
      this.sv.reload();
    }
  },
  //左滑移动结束
  touchE: function(e) {
    var that = this
    if (e.changedTouches.length == 1) {
      var endX = e.changedTouches[0].clientX;
      var disX = that.data.startX - endX;
      var delBtnWidth = that.data.delBtnWidth;
      var txtStyle = disX > delBtnWidth / 2 ? "left:-" + delBtnWidth + "rpx" : "left:0px";
      var index = e.currentTarget.dataset.index;
      var list = that.data.carts;
      list[index].txtStyle = txtStyle;
      that.setData({
        carts: list
      });
      this.sv.reload();
    }
  },
  //购物车管理批量删除
  manageCarts(e) {
    var that = this;
    var tip = e.currentTarget.dataset.tip;
    if (tip == "管理") {
      that.setData({
        tiptext: '完成',
        stateshow: false
      });
    } else {
      that.setData({
        tiptext: '管理',
        stateshow: true
      });
    }
  },
  //数量输入改变
  changeqty(e){
    let changeindex = e.currentTarget.dataset.index;
    let changeiteminfo = e.currentTarget.dataset.iteminfo;
    let val = e.detail.value;
    let point = val.indexOf('.');
    if (point>-1){
      let valother = val.substr(0, point);
      if (valother.length > 10) {
        val = val.substr(0, 10);                                                           
      }
    }else{
      val = val.substr(0, 10); 
    }
    val = app.AcFunc.money(val, 6, true)
    if (val == 0 || val == '' || val <0) {
      val = 1
    }
    let carts = this.data.carts;
    carts[changeindex].qty = val;
    this.editcart(carts, changeindex, changeiteminfo);
  },
  //数量减操作
  touchminus(e) {
    let minusindex = e.currentTarget.dataset.index;
    let minusiteminfo = e.currentTarget.dataset.iteminfo;
    let carts = this.data.carts;
    if (carts[minusindex].qty > 1) {
      carts[minusindex].qty--
      carts[minusindex].qty = app.AcFunc.money(carts[minusindex].qty, 6, true);
      this.editcart(carts, minusindex, minusiteminfo);
    }
  },
  //数量加操作
  touchplus(e) {
    let plusindex = e.currentTarget.dataset.index;
    let plusiteminfo = e.currentTarget.dataset.iteminfo;
    let carts = this.data.carts;
    carts[plusindex].qty++
    carts[plusindex].qty = app.AcFunc.money(carts[plusindex].qty, 6, true);
    this.editcart(carts, plusindex, plusiteminfo);
  },
  // 编辑购物车数量
  editcart(carts, index, iteminfo) {
    let that = this;
    let topnum = 0;
    let param = {
      id: iteminfo.id,
      qty: carts[index].qty,
      prodId: iteminfo.prodId,
      specId: iteminfo.specId,
      unitId: iteminfo.unitId,
      colorId: iteminfo.colorId,     
      multiPriceId: iteminfo.multiPriceId,
      onlyUpdateQty:true,
      eachCarton: iteminfo.eachCarton,
      cartons: iteminfo.cartons,
    }
    app.HttpService.editcart(param).then(res => {
      for (let a = 0; a < this.data.carts.length;a++){
        topnum = topnum + this.data.carts[a].qty
      }
      that.setData({
        carts: carts,
      });
      wx.setNavigationBarTitle({
        title: '购物车(' + AcFunc.money(topnum, 6, true) + ')'
      })
      that.checknumFunc();
      that.getTotalPrice();
      that.sv.reload();
    }).catch(error => {
      console.log(error)
    })
  },
  //购物车商品选中状态改变
  changeState: function(e) {
    var checkindex = e.currentTarget.dataset.index;
    var carts = this.data.carts;
    var selected = carts[checkindex].selected;
    carts[checkindex].selected = !selected;
    this.setData({
      carts: carts
    });
    //如果所有产品都被选中了，全选的勾也要勾上
    this.ifcheckAll(this.data.carts)
    // let choose = 0;
    // for(let a = 0;a<this.data.carts.length;a++){
    //   if (this.data.carts[a].selected){
    //     choose++;
    //   }
    // }
    // if (choose == this.data.carts.length){
    //   this.setData({
    //     allcheck: true
    //   });
    // }else{
    //   this.setData({
    //     allcheck: false
    //   });
    // }
    this.checknumFunc();
    this.checktotalnumFunc();
    this.getTotalPrice();
    this.sv.reload();
  },
  //全选事件
  selectAll: function() {
    var allcheck = !this.data.allcheck;
    var carts = this.data.carts;
    if (allcheck) {
      for (var i = 0; i < carts.length; i++) {
        carts[i].selected = true;
      }
    } else {
      for (var i = 0; i < carts.length; i++) {
        carts[i].selected = false;
      }
    }
    this.setData({
      allcheck: allcheck,
      carts: carts
    });
    this.checknumFunc();
    this.getTotalPrice();
    this.checktotalnumFunc();
    this.sv.reload();
  },
  //计算顶部数量
  checknumFunc() {
    var carts = this.data.carts;
    var total = 0;
    for (var j = 0; j < carts.length; j++) {
      if (carts[j].selected) {
        total += carts[j].qty;
      }
    }
    this.setData({
      originnum: AcFunc.money(total, 6, true),
    });
    this.sv.reload();
  },
  //计算顶部已选数量
  checktotalnumFunc() {
    var carts = this.data.carts;
    var checktotal = 0;
    for (var b = 0; b < carts.length; b++) {
      if (carts[b].selected) {
        checktotal++;
      }
    }
    this.setData({
      origincheck: checktotal
    });
    this.sv.reload();
  },
  //计算合计价格
  getTotalPrice() {
    let that = this
    var carts = this.data.carts;
    var totalprice = 0;
    for (var c = 0; c < carts.length; c++) {
      if (carts[c].selected) {
        let amountFormula = carts[c].amountFormula //金额公式
        let price = app.AcFunc.countTotalPrice(amountFormula, carts[c])
        if (isNaN(price)){
          price = 0;
        }
        totalprice = totalprice + parseFloat(price)
      }
    }
    this.setData({
      totalnum: AcFunc.money(totalprice, 2, false),
    });
    this.sv.reload();
  },
  //左滑删除单个购物车事件
  delItem(e) {
    let that = this;
    wx.showModal({
      title: '提示',
      content: '确定删除吗',
      success(res) {
        if (res.confirm) {
          let delid = e.currentTarget.dataset.delid;
          that.delFunc([delid]);
        } else if (res.cancel) {}
      }
    })
  },
  //批量删除事件
  deltogether() {
    let that = this;
    let idarr = [];
    let carts = that.data.carts;
    for (var d = 0; d < carts.length; d++) {
      if (carts[d].selected) {
        idarr.push(carts[d].id);
      }
    }
    if (idarr.length>0){
      wx.showModal({
        title: '提示',
        content: '确定删除吗',
        success(res) {
          if (res.confirm) {
            that.delFunc(idarr);
          } else if (res.cancel) { }
        }
      })
    }else{
      wx.showToast({
        'title': '请先选择产品哦',
        icon: 'none'
      });
    }
    
  },
  //删除购物车事件（单个删除，多个删除）
  delFunc(delid) {
    let that = this;
    app.HttpService.delcart(delid).then(res => {
      that.getCart();
    })
  },
  //跳转产品详情
  toprodetail: function (e) {
    let proditem = e.currentTarget.dataset.proditem;
    delete proditem.imgsrc
    proditem.fromType = 'cart'
    proditem = JSON.stringify(proditem)
    wx.navigateTo({
      url: '/pages/productdetail/productdetail?detailVO=' + proditem
    })
  },
  //提交订单
  confirmOrder: function() {
    let paypro = []
    var carts = this.data.carts;
    for (var d = 0; d < carts.length; d++) {
      if (carts[d].selected) {
        delete carts[d].imgsrc
        paypro.push(carts[d])
      }
    }
    if (paypro.length==0){
      wx.showToast({
        'title': '请先选择产品哦',
        icon: 'none'
      });
      return;
    }
    paypro = JSON.stringify(paypro)
    wx.navigateTo({
      url: '/pages/order/confirmOrder/index?cartdata=' + paypro + '&totalPrice=' + this.data.totalnum,
    })
  },
  showimgBig(event) {
    AcFunc.imgBig(event)
  },
  ifcheckAll(carts) {    //如果所有产品都被选中了，全选的勾也要勾上
    let choose = 0;
    for (let a = 0; a < this.data.carts.length; a++) {
      if (this.data.carts[a].selected) {
        choose++;
      }
    }
    if (choose == this.data.carts.length) {
      this.setData({
        allcheck: true
      });
    } else {
      this.setData({
        allcheck: false
      });
    }
  },
  emptyFunc(){//输入框防止跳转产品详情的空函数
  }
}),{
  "navigationBarTitleText": "购物车",
  "usingComponents": {
    "lazyRoll": "/assets/components/lazyRoll/index"
  } 
},<view catchtap='hidetip'>
  <view class='carthead flex'>
    <view catchtap='selectAll'>
      <image src='/images/common/checked.png' class='checkimg' wx:if='{{allcheck}}'></image>
      <image src='/images/common/uncheck.png' class='checkimg' wx:if='{{!allcheck}}'></image>
    </view>
    <view class='fontsize26'>已选:{{origincheck}}</view>
    <view class='flex-1 nums fontsize26'>数量:{{originnum}}</view>
    <view class='blue fontsize26' catchtap='manageCarts' data-tip='{{tiptext}}'>{{tiptext}}</view>
  </view>
  <view class='cartList'>
    <lazyRoll id='cartlazyRoll'>
      <view class='cartone proDetail flex' wx:for="{{array}}" style="top:{{item._top}}rpx;" wx:key="">
        <view class="goodDetail" style="{{item.txtStyle}}" bindtouchstart="touchS" bindtouchmove="touchM" bindtouchend="touchE" data-index="{{item._index}}">
          <view class='flex f-row' catchtap='toprodetail' data-proditem='{{item}}'>
            <view class='self-center' catchtap='changeState' data-index="{{item._index}}">
              <image src='/images/common/checked.png' class='checkimg' wx:if='{{item.selected}}'></image>
              <image src='/images/common/uncheck.png' class='checkimg' wx:if='{{!item.selected}}'></image>
            </view>
            <view class='self-center' wx:if="{{(p['imgFlag']&&p['viewProductPhoto'])}}" catchtap='showimgBig' data-src='{{item.imgsrc}}'>
              <image src='{{item.imgsrc}}' class='proimg' lazy-load="true"></image>
            </view>
            <view class='flex-1'>
              <view class='proname proremark overpoint'>
                <text catchtap='viewProname' data-name='{{item.modalname}}'>
                  <text>{{item.name}}</text>
                  <text wx:if="{{(p['specFlag']&&item.specNamebool)||(p['colorFlag']&&item.colorNamebool)}}">-</text>
                  <text wx:if="{{p['specFlag']}}">{{item.specName}}</text>
                  <text wx:if="{{p['specFlag']&&p['colorFlag']&&item.specNamebool&&item.colorNamebool}}">-</text>
                  <text wx:if="{{p['colorFlag']}}">{{item.colorName}}</text>
                </text>
              </view>
              <view class='fs10 c666 proremark overpoint' wx:if="{{p['viewProductRemark']}}">备注:{{item.remark}}</view>
              <view class='flex opernum'>
                <view class='red flex-1 self-center flex'>
                  <view wx:if="{{((p['viewProductSalesPriceOne']||p['viewProductSalesPriceTwo']||p['viewProductSalesPriceThree']||p['viewProductSalesPriceFour'])&&(p['morePriceFlag']))||(!p['morePriceFlag']&&p['viewProductSalesPriceOne'])}}">
                  {{item.unitPricemark}}
                  </view>
                  <view wx:if="{{(p['unitFlag'])&&(p['viewProductUnit'])}}">{{item.unitNameline}}</view>
                </view>
                <view class='operInput clearfix'>
                  <view class='iconfont icon-minus float-left' hover-class='touch' hover-stay-time='100' data-index="{{item._index}}" catchtap='touchminus' data-iteminfo='{{item}}'></view>
                  <input value='{{item.qty}}' catchtap='emptyFunc' bindblur="changeqty" data-index="{{item._index}}" data-iteminfo='{{item}}' type='digit' maxlength='17'></input>
                  <view class='iconfont icon-plus float-right' hover-class='touch' hover-stay-time='100' data-index="{{item._index}}" catchtap='touchplus' data-iteminfo='{{item}}'></view>
                </view>
              </view>
            </view>
          </view>
        </view>
        <view catchtap="delItem" class="posit" data-index="{{item._index}}" data-delid="{{item.id}}">
          <view>删除</view>
        </view>
      </view>
    </lazyRoll>
  </view>
  <view class='flex just-con-b payline' wx:if="{{stateshow}}">
    <view class='totalnum'>
      合计:
      <text>￥{{totalnum}}</text>
    </view>
    <view class='paybtn' catchtap='confirmOrder'>提交订单</view>
  </view>
  <view class='flex just-con-r payline' wx:if="{{!stateshow}}">
    <view class='paybtn' catchtap='deltogether'>删除</view>
  </view>
</view>
<view class='pronametip' wx:if="{{showtip}}">
  <view class='closeimg' catchtap='hidetip'>
    <image src='/images/common/proname.png'></image>
  </view>
  {{showtiptext}}
</view>,page{
  background: #EFEFF4;
}
.fontsize26{
  font-size: 26rpx;
}
.checkimg{
  width: 40rpx;
  height: 40rpx;
  margin-right: 20rpx;
}
.carthead{
  width: 100%;
  background: #fff;
  height:80rpx;
  line-height: 80rpx;
  padding:0 20rpx;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  position: fixed;
  top:0;
  left:0;
  z-index: 99999;
}
.carthead .nums{
  margin-left:80rpx;
}
.cartList{
  margin-top:104rpx;
  padding-bottom: 90rpx;
  background: #fff;
  height: 100%;
}
.cartone{
  position: relative;
  border-bottom: 2rpx solid #EFEFF4;
  height: 190rpx;
}
.proname{
  font-size: 26rpx;
  color: #333;
  line-height: 52rpx;
}
.posit{
  position: absolute;
  right: 0;
  top:0rpx;
  background: #FE3824;
  width: 158rpx;
  color: #fff;
  text-align: center;
  font-size: 30rpx;
  height: 100%;
  align-items:center; 
  display: -webkit-flex;
  justify-content:center;
}
.goodDetail {
  width: 750rpx;
  padding:20rpx;
  position: relative;
  left: 0;
  top:0;
  background: #fff;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  z-index: 9999;
}
.proimg{
  width: 130rpx;
  height: 130rpx;
  margin-right:20rpx;
}
.goodDetail .opernum{
  margin-top:10rpx;
}
.goodOper{
  display: inline-block;
}
.goodOper{
  height: 100%;
  width: 158rpx;
  background: #FE3824;
  color: #fff;
  font-size: 30rpx;
  text-align: center;
}
.operInput input{
  width: 92rpx;
}
.proremark{
  width: 500rpx;
}
.payline{
  background: #fff;
  width: 750rpx;
  height: 90rpx;
  line-height: 90rpx;
  padding-left: 20rpx;
  position: fixed;
  left: 0;
  bottom: 0;
  z-index: 9999;

}
.totalnum{
  font-size: 26rpx;
  color: #333;
}
.totalnum text{
  font-size: 26rpx;
  color: #FE3824;
}
.paybtn{
  width: 238rpx;
  height: 90rpx;
  background:#00A6F5;
  text-align: center;
  line-height: 90rpx;
  color: #fff;
}
.pronametip{
  width: 410rpx;
  padding: 30rpx;
  box-sizing: border-box;
  background: #000;
  opacity: 0.5;
  color: #fff;
  position: fixed;
  top:300rpx;
  left: 170rpx;
  z-index: 9999;
  border-radius: 8rpx;
  text-align: center;
}
.closeimg image{
  width: 26rpx;
  height: 26rpx;
  position: absolute;
  right: 10rpx;
  top:10rpx;
  z-index: 10000;
},Page({
  data: {
    //判断小程序的API，回调，参数，组件等是否在当前版本可用。
    canIUse: wx.canIUse('button.open-type.getUserInfo')
  },
  onLoad: function () {
    var that = this;
    // 查看是否授权
    wx.getSetting({
      success: function (res) {
        if (res.authSetting['scope.userInfo']) {
          wx.getUserInfo({
            success: function (res) {
              //从数据库获取用户信息
              //用户已经授权过
              wx.switchTab({
                url: '/pages/index/index'
              })
            }
          });
        }
      }
    })
  },
  bindGetUserInfo: function (e) {
    if (e.detail.userInfo) {
      //用户按了允许授权按钮
      var that = this;
      //插入登录的用户的相关信息到数据库
     
      //授权成功后，跳转进入小程序首页
      wx.switchTab({
        url: ''
      })
    } else {
      //用户按了拒绝按钮
      wx.showModal({
        title: '警告',
        content: '您点击了拒绝授权，将无法进入小程序，请授权之后再进入!!!',
        showCancel: false,
        confirmText: '返回授权',
        success: function (res) {
          if (res.confirm) {
            console.log('用户点击了“返回授权”')
          }
        }
      })
    }
  },
  //获取用户信息接口
  queryUsreInfo: function () {
    wx.request({
      url: getApp().globalData.urlPath + 'hstc_interface/queryByOpenid',
      data: {
        openid: getApp().globalData.openid
      },
      header: {
        'content-type': 'application/json'
      },
      success: function (res) {
        console.log(res.data);
        getApp().globalData.userInfo = res.data;
      }
    })
  },

}),{
  "navigationBarTitleText": "授权登录"
},<view wx:if="{{canIUse}}">
    <view class='header'>
        <image src='/images/chatLogo.png' mode='aspectFit'></image>
    </view>
 
    <view class='content'>
        <view>申请获取以下权限</view>
        <text>获得你的公开信息(昵称，头像等)</text>
    </view>
 
    <button class='bottom' type='primary' open-type="getUserInfo" lang="zh_CN" bindgetuserinfo="bindGetUserInfo">
        授权登录
    </button>
</view>
 
<view wx:else>请升级微信版本</view>
,.header {
    margin: 90rpx 0;
    border-bottom: 1px solid #ccc;
    text-align: center;
    width: 100%;
    height: 300rpx;
    line-height: 360rpx;
}
 
.header image {
    width: 160rpx;
    height: 160rpx;
}
 
.content {
    margin-left: 50rpx;
    margin-bottom: 90rpx;
}
 
.content text {
    display: block;
    color: #9d9d9d;
    margin-top: 40rpx;
}
 
.bottom {
    border-radius: 80rpx;
    margin: 70rpx 50rpx;
    font-size: 35rpx;
},let app = getApp();
Page({
  /**
   * 页面的初始数据
   */
  data: {
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function(options) {
    let {
      shopCode
    } = options;
    console.log('action onLoad options is：', options)
    app.HttpService.notokenGetUser(shopCode).then(res => {
      console.log('notokenGetUser', res)
      let {
        shareUrl,
        logoId,
        name,
        contactNo
      } = res;
      let ownerId = app.AcFunc.getUrlParams(shareUrl).ownerId;
      let src = '/images/buy/defaultshop.png'
      if (logoId) {
        src = app.__config.basePath + `/sys/common/file/original/${logoId}/${ownerId}/xs/get`;
      }
      this.setData({
        name: name,
        src: src,
        contactNo: contactNo,
      })
    })
  },
  onShow: function(options) {
    console.log('action onShow options is：', options)
  },
  onUnload: function() {
    app.canget = null;
  },
  gettel: function() {
    let tel = this.data.contactNo
    if (!tel) {
      app.AcFunc.myTotal('商家真懒，没有留下联系方式', 'none')

    } else {
      let reg = /^[0-9]+-*[0-9]+-*[0-9]+/
      tel = tel.match(reg).toString();
      wx.makePhoneCall({
        phoneNumber: tel
      })
    }

  },
  toshopList: function() {
    if (wx.getStorageSync('access_token')){
      wx.redirectTo({
        url: '/pages/myhome/browseshop/browseshop',
      })
    }else{
      // wx.navigateBack()
      wx.reLaunch({
        url: '/pages/login/index',
      })
    }
  }
}),{"navigationBarTitleText": "秒账云店"},<view class='container'>
<view class='logo'>
<image src='/images/buy/defaultshop.png' mode='widthFix'></image>
</view>
<view class='shopName fs15'>{{name}}</view>
<view class='shopMsg fs13'>抱歉,{{name}}秒账云店功能已经关闭不可以访问了</view>
<view class='shopBtn'>
<button type='success' bindtap='gettel'>联系卖家</button>
<button type='blue' bindtap='toshopList'>换个店铺</button>
</view>
</view>
,/* pages/action/index.wxss */
page{
  background: #fff;
}
.container{
  padding:0 30rpx;
  text-align: center;
}
.logo{
  padding:60rpx 0 30rpx;
}
image{
  width: 160rpx;
  height:160rpx;
  border-radius: 160rpx;
  border:1px solid #979797;
}
.shopMsg{
  padding:60rpx 0;
}
.shopBtn button{
  margin-bottom: 40rpx;
},const app = getApp();
import AcFunc from '../../helpers/acFunc.js'
let downanimation = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
});
let openimg;//打开图片会触发用onshow事件，此值是用于阻止此类情况的
Page({
  data: {
    p: null,
    sortShow: false,
    sortlistshow: false,
    sortAnimate: {},
    downAnimate: {},
    sortList: [{
      sorttype: 'name',
      name: '产品名称',
      sortorder: 'asc'
    },  {
      sorttype: 'sku',
      name: '货号',
      sortorder: 'asc'
    }, {
      sorttype: 'barcode',
      name: '条形码',
      sortorder: 'asc'
    }, {
      sorttype: 'clearSort',
      name: '清除排序',
      sortorder: 'asc'
    }],
    sortordername: '排序',
    searchcontent: '',
    tabindex: 'all',
    tabtx: '全部',
    prolisttotal: 0,
    searchobj: {},
    refresh: true,
    shopmodal: true,
    openlimit:false,//排序的权限只有第一次需要判断，不然会多次执行
    indexnum: 0,
    classifylist: [],
    prolist: [],
    salerlogo: '',
    salerdes: '暂无该店介绍哦',
    salermodal: [],
    placeholder1: '',
    placeholder2: '',
    placeholder3: '',
    classifyheight: 0
  },
  onLoad: function(options) {
    app.loginInfo();
    let h = wx.getSystemInfoSync().screenHeight - 200
    this.setData({
      classifyheight: h,
      openlimit: true,
    })
  },
  onShow: function() {
    if (openimg) {
      openimg = false;
      return;
    }
    if (!wx.getStorageSync('refresh')) {
      let sortList = this.data.sortList
      for (let a = 0; a < sortList.length; a++) {
        sortList[a].sortorder = 'asc'
      }
      if (this.data.sortShow) {
        this.endSort()
      }
      this.setData({
        sortList: sortList,
        searchcontent: '',
        tabindex: 'all',
        prolist: [],
        prolisttotal: 0,
        tabtx: '全部',
        sortordername: '排序',
        searchobj: {
          pageSize: 10,
          pageNum: 0,
          prodTypeIdList: []
        },
        refresh: true
      })
      this.resClassify();
      this.resFunc();
      app.setMsgCount()     
    }
    wx.setStorageSync('refresh', false);
    app.setCartCount();
    //加入购物车返回(返回产品id)时，需保留当前页面
    if (wx.getStorageSync('prodId')){
      let prolist = this.data.prolist
      for (let v = 0; v<prolist.length;v++){
        if (prolist[v].id == wx.getStorageSync('prodId')){
          prolist[v].existCart = true
        }
      }
      this.setData({
        prolist: prolist
      })
      wx.removeStorageSync('prodId')
    }
  },
  bindSort: function(e) { //展开排序事件
    let sortShow = this.data.sortShow;
    if (sortShow) {
      this.endSort()
    } else {
      downanimation.rotate('180').step()
      this.setData({
        sortlistshow: true,
        downAnimate: downanimation.export(),
        sortShow: true
      })
    }
  },
  endSort: function() { //缩起排序事件
    downanimation.rotate('0').step()
    this.setData({
      sortlistshow: false,
      downAnimate: downanimation.export(),
      sortShow: false
    })
  },
  BindSearch(e) { //排序选择事件
    let sort = {};
    let sortindex = e.target.dataset.sortindex;
    let sortname = e.target.dataset.sortname;
    let search = this.data.searchobj;
    let sortres = this.data.sortList;
    let sortordername = this.data.sortordername
    sort.sortColumn = e.target.dataset.type;
    sort.sortOrder = e.target.dataset.sort;
    search.sortList = [];
    search.sortList.push(sort);
    search.pageNum = 0;
    if (sortres[sortindex].sortorder == 'desc') {
      sortres[sortindex].sortorder = 'asc';
      sortordername = sortname + '倒序';
    } else {
      sortres[sortindex].sortorder = 'desc';
      sortordername = sortname + '正序';
    }
    if (e.target.dataset.type == 'clearSort') {
      sortordername = '排序';
      search.sortList = [];
    }
    this.setData({
      sortlistshow: false,
      sortList: sortres,
      searchobj: search,
      refresh: true,
      prolist: [],
      sortordername: sortordername
    });
    this.endSort();
    this.resFunc();
  },
  chooseType: function(e) { //产品分类选择事件
    this.setData({
      tabindex: e.target.dataset.typeid,
      tabtx: e.target.dataset.typetx,
    });
    var search = this.data.searchobj;
    search.prodTypeIdList = [];
    if (this.data.tabindex !== 'all' && this.data.tabindex !== 'buyed') {
      search.prodTypeIdList.push(this.data.tabindex);
    }
    if (this.data.tabindex == 'buyed') {
      search.buyFlag = true
    } else {
      delete search.buyFlag
    }
    search.pageNum = 0;
    search.mobileSearch = this.data.searchcontent;
    this.setData({
      searchobj: search,
      prolist: [],
      refresh: true
    });
    this.resFunc();
  },
  fillInput: function(e) { //获取模糊搜索内容
    this.setData({
      searchcontent: e.detail.value
    });
  },
  clearInput: function() { //情况模糊搜索内容
    this.setData({
      searchcontent: ''
    })
  },
  mobileSearch: function() { //模糊搜索事件
    var search = this.data.searchobj;
    search.pageNum = 0;
    search.mobileSearch = this.data.searchcontent;
    this.setData({
      searchobj: search,
      prolist: [],
      refresh: true
    });
    this.resFunc();
  },
  showshop: function() {
    this.setData({
      shopmodal: false
    })
  },
  closeintro: function() {
    this.setData({
      shopmodal: true
    })
  },
  toTel: function(e) {
    if (e.target.dataset.telbtn.length > 0) {
      wx.makePhoneCall({
        phoneNumber: e.target.dataset.telbtn[0]
      })
    }
  },
  selectPrice: function() {

  },
  toprodetail: function(e) {
    wx.setStorageSync('refresh', true);
    let id = e.currentTarget.dataset.id
    wx.navigateTo({
      url: '/pages/productdetail/productdetail?id=' + id
    })
  },
  //查询产品信息接口
  resFunc: function() {
    let that = this;
    let prolist = that.data.prolist;
    app.HttpService.prolist(that.data.searchobj).then(res => {
      let p = getApp().P();
      that.resSaler();
      if (that.data.openlimit){
        that.limitFunc();
      }
      let data = res.list
      for (let i = 0; i < data.length; i++) {
        if (data[i].photo) {
          data[i].imgsrc = app.getxsimg('thumbnail', data[i].photo)
        } else {
          data[i].imgsrc = '/images/buy/defaultpro.png'
        }
        //开启多单位没有开启多价位
        if (p.unitFlag && !p.morePriceFlag) {
          let s1 = data[i].prodDimUnitVOList;
          if (!s1) { //当后台不返回prodDimUnitVOList时
            continue
          }
          data[i].indexnum = 0;
          if (s1.length > 1) {
            data[i].cornerhidden = false;
          } else {
            data[i].cornerhidden = true;
          }
          for (let j = 0; j < s1.length; j++) {
            if (s1[j].salePrice || s1[j].salePrice == 0) {
              data[i].showmoney = true;
              s1[j].pickerdata = s1[j].name + ':￥' + s1[j].salePrice
            } else {
              data[i].showmoney = false;
            }

          }
          data[i].customprolist = data[i].prodDimUnitVOList;
        }

        //同时开启多价位、多单位，只显示多价位  或者  开启多价位没有开启多单位
        if ((p.unitFlag && p.morePriceFlag) || (!p.unitFlag && p.morePriceFlag)) {
          let s2 = data[i].prodMultiPriceVOList;
          if (!s2) { //当后台不返回prodMultiPriceVOList
            continue
          }
          data[i].indexnum = 0;
          if (s2.length == 0) {
            data[i].showmoney = false;
            continue;
          }
          data[i].showmoney = true;
          if (s2.length > 1) {
            data[i].cornerhidden = false;
          } else {
            data[i].cornerhidden = true;
          }
          for (let j = 0; j < s2.length; j++) {
            s2[j].salePrice = s2[j].price
            s2[j].pickerdata = s2[j].showName + ':￥' + s2[j].price
          }
          data[i].customprolist = data[i].prodMultiPriceVOList;
        }
        //没有开启多价位、多单位
        if (!p.unitFlag && !p.morePriceFlag) {
          let s3 = data[i].prodMultiPriceVOList;
          if (!s3) { //当后台不返回prodMultiPriceVOList
            continue
          }
          if (s3.length == 0) {
            data[i].showmoney = false;
            continue;
          }
          data[i].showmoney = true;
          data[i].cornerhidden = true;
          for (let j = 0; j < s3.length; j++) {
            s3[j].salePrice = s3[j].price
          }
          data[i].customprolist = data[i].prodMultiPriceVOList;
        }
      }
      prolist = prolist.concat(data)
      console.log(prolist)
      console.log(data)
      that.setData({
        p: p,
        prolist: prolist,
        prolisttotal: res.total
      })
      console.log(this.data.prolist)
      if (that.data.prolisttotal == prolist.length) {
        that.setData({
          refresh: false
        })
      }
    }).catch(error => {
      console.log(error)
      // wx.showToast({ 'title': error, icon:'none'})
    })
  },
  //查询产品分类接口
  resClassify() {
    let param = {
      'pageNum': 0,
      'pageSize': 10000,
      'canShopDisplay': true,
      'showDefaultType': true
    };
    app.HttpService.proclassify(param).then(res => {
      let p = getApp().P();
      //如果没有打开分类的权限，则不执行
      let classify = {};
      let classarr = [{
          id: 'all',
          name: '全部'
        },
        {
          id: 'buyed',
          name: '买过'
        }
      ];
      if (!p.viewProductClassify || !p.productTypeFlag) {
        this.setData({
          classifylist: classarr
        })
      } else {
        res.list.forEach((vv, ii) => {
          if (vv.createBy == "system") {
            classify = vv;
          } else {
            classarr.push(vv);
          }
        })
        if (Object.keys(classify).length !== 0) {
          classarr.push(classify);
        }
        this.setData({
          classifylist: classarr
        })
      }
    }).catch(error => {
      console.log(error)
      // wx.showToast({ 'title': error, icon:'none'})
    });
  },
  //查询商户信息接口
  resSaler() {
    let salerinfo = wx.getStorageSync('owner').cloudShopVO;
    let salermodal = [];
    let salerobj = {};
    let salerlogo = salerinfo.logoId ? app.getxsimg('original', salerinfo.logoId) : '/images/buy/defaultshop.png';
    let des = salerinfo.description ? salerinfo.description : '暂无该店介绍哦'
    salerobj.salername = salerinfo.legalPerson;
    salerobj.salershopname = salerinfo.name;
    salerobj.salertel = salerinfo.contactNo;
    let reg = /^[0-9]+-*[0-9]+-*[0-9]+/
    salerobj.salercalltel = salerinfo.contactNo.match(reg);
    if (salerinfo.addressVOs.length > 0) {
      salerobj.address = salerinfo.addressVOs[0].fullAddress
    }
    salermodal.push(salerobj)
    this.setData({
      salermodal: salermodal,
      salerlogo: salerlogo,
      salerdes: des
    });
    wx.setNavigationBarTitle({
      title: salerinfo.name
    })
  },
  //权限部分
  limitFunc() {
    let cloudlimit = getApp().P();
    //placeholder提示语权限
    if (cloudlimit.skuFlag && cloudlimit.viewProductSku) {
      this.setData({
        placeholder1: '、货号'
      })
    }
    if (cloudlimit.viewProductBarcode) {
      this.setData({
        placeholder2: '、条形码'
      })
    }
    if (cloudlimit.viewProductLabel) {
      this.setData({
        placeholder3: '、标签'
      })
    }
    //排序的货号、条形码的权限
    let sortList = this.data.sortList;
      if (!cloudlimit.viewProductSku || !cloudlimit.skuFlag){
        sortList.splice(1, 1);
        if (!cloudlimit.viewProductBarcode){
          sortList.splice(1, 1);
        }
      }
    if (!cloudlimit.viewProductBarcode){
      sortList.splice(2, 1);
    }
    this.setData({
      sortList: sortList,
      openlimit:false
    })
  },
  //选择价格
  bindtypePickerChange(e) {
    let i = e.target.dataset.noindex;
    let prolist = this.data.prolist;
    prolist[i].indexnum = e.detail.value
    this.setData({
      prolist: prolist
    })
  },
  scrollbottom: function() {
    if (this.data.refresh) {
      var search = this.data.searchobj;
      search.pageNum++;
      this.setData({
        searchobj: search
      });
      console.log('数据结束依旧请求数据')
      this.resFunc();
    }
  },
  showimgBig(event) {
    openimg = true
    AcFunc.imgBig(event)
  },
  //下拉刷新
  onPullDownRefresh() {
    let sortList = this.data.sortList
    for (let a = 0; a < sortList.length; a++) {
      sortList[a].sortorder = 'asc'
    }
    if (this.data.sortShow) {
      this.endSort()
    }
    this.setData({
      sortList: sortList,
      searchcontent: '',
      tabindex: 'all',
      prolist: [],
      prolisttotal: 0,
      tabtx: '全部',
      sortordername: '排序',
      searchobj: {
        pageSize: 10,
        pageNum: 0,
        prodTypeIdList: []
      },
      refresh: true
    })
    this.resClassify();
    this.resFunc();
    setTimeout(function(){
      wx.stopPullDownRefresh();
    },500)
  },
  emptyfunc() {
    //此函数为空函数，用于防止事件toprodetail触发bindtypePickerChange
  }
}),{
  "enablePullDownRefresh":true
},<view class='flex f-col flexone'>
  <view class='shopMsg flex content-center'>
    <view class='shopImg'>
      <image src='{{salerlogo}}' mode='aspectFit'></image>
    </view>
    <view class='shopText flex-1 self-center clamp clamp-3' bindtap='showshop'>简介:{{salerdes}}</view>
    <view></view>
  </view>
  <view class='linecolor'></view>
  <view class='topsearch clearfix'>
    <view class='searchinput flex nowrap just-con-c item-top'>
      <icon type="search" size="16" class='searchicon' />
      <input class='searchinput' placeholder='输入产品名称{{placeholder1}}{{placeholder2}}{{placeholder3}}查找' placeholder-class="phcolor" value='{{searchcontent}}' bindinput='fillInput'></input>
      <icon type="cancel" size="18" color='#8F8E94' class='cancelicon' wx:if="{{searchcontent}}" bindtap='clearInput' />
    </view>
    <view class='searchbtn' bindtap='mobileSearch'>搜索</view>
  </view>
  <view class='clearfix con'>
    <view class='leftlist'>
      <scroll-view scroll-y='true' class='classifyheight'>
        <view wx:for="{{classifylist}}" wx:for-item="classifylistitem" wx:for-index="classifylistindex" wx:key="" bindtap='chooseType'>
          <view class="{{tabindex== classifylistitem.id ? 'leftlistdetai checktype overpoint' : 'leftlistdetai overpoint'}}" data-typeid='{{classifylistitem.id}}' data-typetx='{{classifylistitem.name}}'>
            {{classifylistitem.name}}
          </view>
        </view>
      </scroll-view>
    </view>
    <view class='rightlist'>
      <view class='ordersearch flex row nowrap just-con-b'>
        <view class='proclassify'>
          <text>{{tabtx}}</text>
          <text class='tenorder' wx:if="{{tabindex=='buyed'}}">(显示最近10单)</text>
        </view>
        <view class='flex row nowrap'>
          <view bindtap='bindSort'>
            <text class='bluecolor'>{{sortordername}}</text>
            <image src='../../images/buy/todown.png' class='downimg' animation="{{downAnimate}}"></image>
          </view>
        </view>
      </view>
      <scroll-view class='scrollview' scroll-y="true" bindscrolltolower="scrollbottom">
        <view class='orderdetaillist flex f-row nowrap' wx:for="{{prolist}}" wx:key="" catchtap='toprodetail' data-id='{{item.id}}'>
          <view class='proimg' wx:if="{{(p['imgFlag']&&p['viewProductPhoto'])}}">
            <image mode='widthFix' src='{{item.imgsrc}}' lazy-load="true" catchtap='showimgBig' data-src='{{item.imgsrc}}'></image>
          </view>
          <view class='prodetail'>
            <view class='protitle'>{{item.name}}</view>
            <view class='flex f-row f-wrap'>
              <view class='prolabel' wx:for="{{item.labelList}}" wx:key="">{{item}}</view>
            </view>
            <view class='flex f-row nowrap just-con-b'>
              <view>
                <view class='proprice flex' wx:if="{{item.showmoney}}">
                  <picker catchtap="emptyfunc" bindchange="bindtypePickerChange" data-noindex='{{index}}' value="{{item.indexnum}}" range-key="pickerdata" range="{{item.customprolist}}">
                    <view class='flex'>
                      <view class="picker" hidden='{{item.cornerhidden}}'>￥{{item.customprolist[item.indexnum].salePrice}}</view>
                      <view hidden='{{item.cornerhidden}}' class='downcorner'></view>
                    </view>
                  </picker>
                  <view hidden='{{!item.cornerhidden}}'>￥{{item.customprolist[indexnum].salePrice}}</view>
                </view>
              </view>
              <view class='topro self-bottom'>
                <image src='/images/buy/bluebtn.png' wx:if="{{!item.existCart}}"></image>
                <image src='/images/buy/yellowbtn.png' wx:if="{{item.existCart}}"></image>
              </view>
            </view>
            <view class='pronum'>
              <view>
                <text wx:if="{{p['viewProductSku']&&p['skuFlag']}}">货号：{{item.sku}}</text>
                <text wx:if="{{(p['viewProductSku']&&p['skuFlag'])&&(p['viewProductBarcode'])}}">|</text>
                <text wx:if="{{p['viewProductBarcode']}}">条形码：{{item.barcode}}</text>
              </view>
            </view>
            <view class='proremark' wx:if="{{p['viewProductRemark']}}">备注:{{item.remark}}</view>
          </view>
        </view>
        <view style='height:84rpx;'></view>
      </scroll-view>
    </view>
  </view>
</view>
<view class='shopintroduce' hidden='{{shopmodal}}' bindtap='closeintro'></view>
<view class='shopview' hidden='{{shopmodal}}' wx:for="{{salermodal}}" wx:key="">
  <view class='shopblue'>
    <icon type="cancel" size="20" color="#fff" bindtap='closeintro' />
  </view>
  <view class='shopwhite'>
    <view>
      <image src='{{salerlogo}}' class='shopimage'></image>
    </view>
    <view class='shopname overpoint'>{{item.salershopname}}</view>
    <view class='shopline flex row nowrap'>
      <view>
        <image src='/images/buy/salename.png' class='shopicon'></image>
      </view>
      <view>
        <text>{{item.salername}}</text>
      </view>
    </view>
    <view class='shopline flex row nowrap'>
      <view>
        <image src='/images/buy/saletel.png' class='shopicon'></image>
      </view>
      <view class='shopphone'>
        <text data-telbtn='{{item.salercalltel}}' bindtap='toTel'>{{item.salertel}}</text>
      </view>
    </view>
    <view class='shopline flex row nowrap'>
      <view>
        <image src='/images/buy/saleloca.png' class='shopicon'></image>
      </view>
      <view class='shopaddress'>
        <text>{{item.address}}</text>
      </view>
    </view>
    <view class='shopintro'>简介：{{salerdes}}</view>
  </view>
</view>
<view class="sortMod flex f-col" wx:if="{{sortlistshow}}">
  <view class='sortList'>
    <view wx:for="{{sortList}}" hover-class='touch' wx:key="" bindtap='BindSearch' data-type='{{item.sorttype}}' data-sort='{{item.sortorder}}' wx:for-index='sortindex' data-sortindex='{{sortindex}}' data-sortname='{{item.name}}'>
      {{item.name}}
    </view>
  </view>
  <view bindtap='endSort' class='flex-1'></view>
</view>,page{
  background: #EFEFF4;
  height:100%;
  overflow: hidden;
}
page > .flexone{
  height:100%;
  /* padding-top:252rpx; */
}
page .con{
  height:calc(100% - 256rpx);
  /* position: fixed;
  left: 0;
  top:256; */
}
page .con .leftlist{
  height:100%;
  width: 160rpx;
  float:left;
  overflow: hidden;
}
.rightlist{
  height:100%;
  float: right;
  width: 590rpx;
  background: #fff;
  overflow: hidden;
}
.scrollview{
  height:100%;
}
.shopMsg{
  padding:20rpx;
  background: #00a6f5;
  /* position: fixed;
  left: 0;
  top:0;
  z-index: 9999; */
}
.shopImg image{
  width: 100rpx;
  height:100rpx;
}
.shopText{
  width: 610rpx;
  font-size:24rpx;
  padding-left:20rpx;
  box-sizing: border-box;
  color:#fff;
}
.linecolor{
  width: 750rpx;
  height: 10rpx;
  background: #EFEFF4;
  /* position: fixed;
  left: 0;
  top:140rpx;
  z-index: 9999; */
}
/* 复制来的 */
.searchinput{
  background: #EFEFF4;
  width: 640rpx;
  height: 56rpx;
  line-height: 56rpx;
  float: left;
  border-radius: 41rpx;
}
.searchinput input{
    padding: 0 20rpx;
    box-sizing: border-box;
    font-size: 24rpx;
    text-align: left;
}
.searchinput icon{
  display: block;
}
icon.searchicon{
  margin:12rpx 0 0 16rpx;
}
icon.cancelicon{
  margin:10rpx 16rpx 0 0;
}
.phcolor{
  font-size: 24rpx;
  color: #c8c8c8;
}
.searchbtn{
  float: right;
  font-size: 24rpx;
  color: #00a6f5;
  line-height: 56rpx;
}
.topsearch{
  width: 750rpx;
  background: #fff;
  padding: 24rpx 16rpx 24rpx 24rpx;
  box-sizing: border-box;
  /* position: fixed;
  top:150rpx;
  left: 0;
  z-index: 10; */
  border-bottom: 2rpx solid #EFEFF4;
}
.checktype{
  background: #fff;
  color: #00A6F5;
}

.ordersearch{
  width: 100%;
  background: #fff;
  height: 84rpx;
  line-height: 84rpx;
  padding: 0 16rpx;
  box-sizing: border-box;
  border-bottom: 1px solid #EFEFF4;
}

.ordersearch text{
  font-size: 24rpx;
}
.leftlistdetai{
  padding: 0 6rpx;
  box-sizing: border-box;
  height: 100rpx;
  line-height: 100rpx;
  font-size: 22rpx;
  text-align: center;
  border-bottom: 1px solid #E9E9F1;
}
.rightlistdetai{
  padding: 16px 18px;
  box-sizing: border-box;
  border-bottom: 1px solid #EFEFF4;
}
.name{
  font-size: 30rpx;
  color: #333;
}
.tel{
  font-size: 26rpx;
  color: #666;
}
.orderdetaillist{
  background: #fff;
  padding: 14rpx 14rpx 10rpx 10rpx;
  box-sizing: border-box;
  border-bottom: 2rpx solid #EFEFF4;
}
.downimg{
  width: 22rpx;
  height: 14rpx;
  margin:0 8rpx;
}
.tenorder{
  color: #999999;
}
.bluecolor{
  color: #00a6f5;
}
.proclassify{
  width: 220rpx;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.prodetail{
  width: 100%;
}
.proimg{
  align-items:center;
  display: -webkit-flex;
}
.proimg image{
  width: 130rpx;
  height: 130rpx;
  margin-right: 10rpx;
  border-radius: 8rpx;
}
.protitle{
  font-size: 26rpx;
  color:#333;
  word-break:break-all;
}
.prolabel{
  padding: 0 18rpx;
  font-size: 18rpx;
  box-sizing: border-box;
  background: #FEEBE9;
  color: #FE3824;
  height: 28rpx;
  line-height: 28rpx;
  border-radius: 14rpx;
  margin:6rpx 14rpx 6rpx 0;
}
.proprice{
  line-height: 60rpx;
  font-size: 26rpx;
  color: #FE3824;
  font-weight: 700;
}
.downcorner{
  width:0;
  height:0;
  border:12rpx solid #999;
  border-bottom-color:transparent;
  border-right-color:transparent;
  border-left-color:transparent;
  margin:26rpx 0 0 10rpx;
}
.pronum view{
  word-break:break-all;
  line-height: 20rpx;
  margin-bottom: 10rpx;
}
.pronum view text{
  font-size: 18rpx;
  color: #666;
}
.proremark{
  width: 400rpx;
  font-size: 18rpx;
  color: #666;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
.shopintroduce{
  width: 750rpx;
  background: #000;
  opacity: 0.3;
  z-index: 9999;
  height: 100%;
  position: fixed;
  left: 0;
  top: 0;
}
.shopview{
  width: 588rpx;
  position: fixed;
  top:206rpx;
  left:80rpx;
  z-index: 99999;
  border-radius: 4rpx;
}
.shopblue{
  width: 588rpx;
  height: 166rpx;
  background: #00A6F5;
  border-top-left-radius: 8rpx;
  border-top-right-radius: 8rpx;
}
.shopblue icon{
  position: absolute;
  right: 10rpx;
  top:10rpx;
}
.shopwhite{
  background: #fff;
  position: relative;
  padding: 0 20rpx 52rpx 20rpx;
  box-sizing: border-box;
  border-bottom-left-radius: 8rpx;
  border-bottom-right-radius: 8rpx;
}
.shopimage{
  width: 176rpx;
  height: 176rpx;
  border-radius: 88rpx;
  border:10rpx solid #fff;
  position: absolute;
  top: -134rpx;
  left:196rpx; 
}
.shopname{
  font-size: 32rpx;
  color: #333;
  padding: 70rpx 0 30rpx;
  font-weight: 700;
  text-align: center;
}
.shopicon{
  width: 44rpx;
  height: 44rpx;
  vertical-align: middle;
  margin-right: 10rpx;
}
.shopline{
  margin-bottom: 20rpx;
}
.shopline text,.shopintro{
  font-size: 24rpx;
  color: #666;
}
.shopintro{
  height: 200rpx;
  overflow-x: hidden;
  overflow-y: scroll;
}
.shopphone text,.shopaddress text{
  word-break:break-all;
}
.topro image{
  width: 60rpx;
  height: 60rpx;
}
.classifyheight{
    height:100%;
}
.sortMod{
  position: fixed;
  left: 160rpx;
  width: 590rpx;
  top:340rpx;
  height:calc(100% - 340rpx);
  background: rgba(0,0,0,0.3);
  z-index: 50;
}
.sortList{
  background: #fff;
  font-size:24rpx;
}
.sortList view{
  padding:20rpx;
  color:#393939;
  border-bottom:1px solid #f2f2f2;
}
.sortList .touch{
  background: #f6f6f6;
},//logs.js
const util = require('../../utils/util.js')

// Page({
//   data: {
//     logs: [],
//     src:''
//   },
//   onLoad: function () {
//     this.setData({
//       logs: (wx.getStorageSync('logs') || []).map(log => {
//         return util.formatTime(new Date(log))
//       })
//     })
//   },
//   takePhoto() {
//     const ctx = wx.createCameraContext()
//     ctx.takePhoto({
//       quality: 'high',
//       success: (res) => {
//         this.setData({
//           src: res.tempImagePath
//         })
//       }
//     })
//   },
//   error(e) {
//     console.log(e.detail)
//   }
// })
Page({
  data: {

  },
  onLoad: function (options) {

  },
  onReady: function () {

  },
  onShow: function () {
    app.HttpService.getPageList({
      pageSize: 10,
      pageNum: 0
    }).then((res) => {
      console.log(res)
    }).catch((res) => {

    })
  },
  onPullDownRefresh: function () {

  },
})
,{
  "navigationBarTitleText": "查看启动日志"
},<!--logs.wxml-->
<!-- <view class="container log-list">
  <block wx:for="{{logs}}" wx:for-item="log">
    <text class="log-item">{{index + 1}}. {{log}}</text>
  </block>
</view> -->
<camera device-position="back" flash="off" binderror="error" style="width: 100%; height: 300px;"></camera>
<button type="primary" bindtap="takePhoto">拍照</button>
<view>预览</view>
<image mode="widthFix" src="{{src}}"></image>
,.log-list {
  display: flex;
  flex-direction: column;
  padding: 40rpx;
}
.log-item {
  margin: 10rpx;
}
,// pages/login/index.js
let app=getApp();
Page({

  /**
   * 页面的初始数据
   */
  data: {
    oaCanIUse: wx.canIUse('official-account'),
    validcode_placeholder:'获取验证码',
    validcodeCanTap:true,
    count:1,
    metaArray:[],
    orderType:null,
    orderId:null,
    query:null
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (query={}) {
    let { action, code, id, q, ownerId } = query
    this.shareUrl = app.AcFunc.objToUrl(query);
      if(code){
        app.HttpService.notokenGetUser(code).then(res=>{
          console.log('notokenGetUser',res)
          this.setData({
            yd_name:res.name,
            src: app.__config.basePath + `/sys/common/file/original/${res.logoId}/${ownerId}/xs/get`
          })
        })
      }

    //校验初始化，传入校验字段和规则
    this.WxValidate = app.WxValidate({
      phone:{
        required: true,
        tel: true, 
      },
    },{
        phone:{
          required: '电话号码不能为空', 
        },
    })
    //校验初始化，传入校验字段和规则
    this.WxValidate_login = app.WxValidate({
      mobile: {
        required: true,
        tel: true,
      },
      verifyCode: {
        required: true,
      },
      shopCode: {
        required: true,
      },
    }, {
        mobile: {
          required: '电话号码不能为空',
        },
        shopCode: {
          required: '店铺ID不能为空',
        },
        verifyCode: {
          required: '验证码不能为空',
        },
      })
    this.setData({
      shopid: code,
      action: action,
      query: query,
      id:id,
    });
    console.log('login query:', query,this.data)
  },

  phoneinput(e) {
    this.setData({
      phone: e.detail.value,
    })
  },
  getValidcodeMsg(e) {
    if (this.data.validcodeCanTap) {
      if (!this.WxValidate.checkObj({ phone: this.data.phone })) {
        const error = this.WxValidate.errorList[0]
        wx.showModal({
          title: '提示',
          content: `${error.msg}`,
          showCancel: !1,
        })
        return false
      }
      app._getCode().then((res)=>{
       return app.HttpService.getValidcodeMsg({
          count: this.data.count++,
          phone: this.data.phone,
          areacode: '86',
          code: res,
       }).then(res => {
         let s = 60;
         this.setData({
           validcodeCanTap: false,
           validcode_placeholder: s + 's',
         })
         let siv = setInterval(() => {
           this.setData({
             validcode_placeholder: --s + 's',
           })
           if (s == 0) {
             this.setData({
               validcode_placeholder: '重新获取',
               validcodeCanTap: true
             })
             clearInterval(siv)
           }
         }, 1000)
       }).catch((e)=>{
          console.error('getValidcodeMsg',e);
          wx.showToast({ 'title': e, icon: 'none' })
        })
      }).catch((e) => {
          wx.showToast({ 'title': e, icon: 'none' })
      })
    }
  },

  login(e) {
    let query = this.data.query
    let that=this
    if (!this.WxValidate_login.checkObj(e.detail.value)) {
      const error = this.WxValidate_login.errorList[0]
      wx.showModal({
        title: '提示',
        content: `${error.msg}`,
        showCancel: !1,
      })
      return false
    }
    // let value = e.detail.value
    // value.mobile='13333333333'
    // value.verifyCode = '1234'
    // value.shopCode = '9h7tb'
    app._getCode().then(()=>{
      app.HttpService.getTokenByPhone(Object.assign({ weixinCode: wx.getStorageSync('code'), shareUrl: that.shareUrl }, e.detail.value)).then(res => {
        app._setUser(res).then(res=>{
          if (query.action && query.action != 'viewCloudShop') {
            app.queryFunc(query, true)
            // if (orderType == 'viewSaleOrder') {
            //   wx.redirectTo({
            //     url: '/pages/order/orderDetail/orderDetail?id=' + that.orderId,
            //   })
            // } else {
            //   wx.redirectTo({
            //     url: '/pages/order/logistDetail/logistDetail?id=' + that.orderId,
            //   })
            // }
          } else {
            if (!app.isNotAction) {
              app.isNotAction = true;
              wx.navigateBack();
            } else {
              wx.switchTab({
                url: '/pages/index/index',
              })
            }
          }
        }).catch(e=>{
          if(e=='clear'){
            this.setData({
              shopid:''
            })
          }
        })
      }).catch(e => {
        console.error(e);
        // app.WxService.showModal({ showCancel: false, content: e })
      })
    }).catch(e => {
      console.error(e);
      app.WxService.showModal({ showCancel: false, content: e })
    })
    console.log(e)
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function (options) {
// var t=wx;
  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function (options) {
    
    // var context = wx.createCanvasContext('cvs');
    // wx.getImageInfo({
    //   src: 'http://localhost/images/common/magnify/smallProgram.png',
    //   success:function(res){        
    //     context.drawImage(res.path, 0, 0, 200, 200)
    //     wx.getImageInfo({
    //       src: 'http://localhost/images/common/logo.png',
    //       success: function (res) {
    //         context.setFillStyle('#fff')
    //         context.fillRect(80, 80, 40, 40)
    //         context.drawImage(res.path,80, 80, 40, 40)
    //         context.draw(true)
    //        }
    //     })   
      
    //     context.setTextAlign('center')    // 文字居中
    //     context.setFillStyle('#000000')  // 文字颜色：黑色
    //     context.setFontSize(22)         // 文字字号：22px
    //     context.fillText('Object有限公司', 100, 215)
    //     context.draw()
    //   }
    // })


    // var cvs = document.createElement('canvas');
    // cvs.width=200;
    // cvs.height=220;
    // var context = cvs.getContext('2d')
    // context.textAlign = 'center'  // 文字居中
    // context.fillStyle = '#000000'// 文字颜色：黑色
    // context.fontSize=22       // 文字字号：22px
    // context.fillText('Object有限公司', 100, 215)
    // context.drawImage(edituserSetCloud_QRcode, 0, 0, 200, 200)
    // edituserSetCloud_QRcode.replaceWith(cvs)
  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {
    app.isNotAction = true;
  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {

  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {

  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {

  },

  oaLoad(e){
    console.log('oaLoad:',e)
  },

  oaError(e) {
    console.error('oaError:', e)
  },
  

}),{
  "usingComponents": {
    "lazyRoll": "/assets/components/lazyRoll/index"
  }},<form bindsubmit='login'>
<!-- <canvas canvas-id="cvs" style="width: 200px; height: 220px;border: 1px solid black;"></canvas> -->
<view class="page">
  <view wx:if="{{shopid}}" class="shoplogo">
    <image src="{{src}}" class='shoplogoimg' mode='aspectFit'></image>   
    <view class='shoplogoname'>{{yd_name}}</view> 
  </view>
  <view wx:else class="logo">
    <image src='/images/login/logo.png' class='logoimg' mode='aspectFit'></image>
  </view>

  <view class='form'>
    <view class="weui-cell weui-cell_input login_first_input">
      <view class="weui-cell__hd">
        <image src='/images/login/mytel.png' class='phone'></image>
      </view>
      <view class="weui-cell__bd">
        <input class="weui-input" type='number' name="mobile" bindinput='phoneinput' value='{{phone}}' placeholder="请输入手机号" />
      </view>
    </view>
    <view class="weui-cell weui-cell_input weui-cell_vcode">
      <view class="weui-cell__hd">
        <image src='/images/login/mycode.png' class='phone'></image>
      </view>
      <view class="weui-cell__bd ">
        <input class="weui-input" type='number' name="verifyCode"  value='{{validcode}}' placeholder="请输入验证码" />
      </view>
      <view class="weui-cell__ft">
        <button class="btn  wd88 p-0" disabled="{{validcodeCanTap?'':'disabled'}}" bindtap='getValidcodeMsg'>{{validcode_placeholder}}</button>
      </view>
    </view>


    <view hidden="{{shopid}}" class="weui-cell weui-cell_input weui-cell_vcode ">
      <view class="weui-cell__hd">
        <image src='/images/login/lock.png' class='phone'></image>
      </view>
      <view class="weui-cell__bd">
        <input class="weui-input" value='{{shopid}}' name="shopCode" placeholder="请输入店铺ID" />
      </view>
      <view class="weui-cell__ft">
      </view>
    </view>

      <view class="weui-cell weui-cell_input weui-cell_vcode">
       </view>
  </view>

  <view class="login">  
    <button class='btn h80' formType="submit">登录{{wx.getStorageSync('access_token')}}</button>
  </view>

  <!-- <official-account bindload='oaLoad' binderror='oaError'>关注秒账公众号</official-account> -->

<!-- <lazyRoll id="test">
  <view class='proDetail flex' wx:for="{{array}}" style="top:{{item._top}}pt;">
   <view>
          这一条记录是：{{item.name}} {{item._index}}
        </view>
          </view>
</lazyRoll> -->


</view>
</form>,/* pages/login/index.wxss */
page{
  background: #fff;
}

button {
    background: #00A6F5;
    color: #FFFFFF;
    height: 64rpx;
    font-size: 26rpx;
}

.button-hover {
    background: #FFFFFF;
    color: #00A6F5;
}
.shoplogo{
  margin-top: 32rpx;
  text-align: center;
  margin-bottom: 64rpx;
}
.shoplogoimg{
  width: 168rpx;
  height:168rpx;
}
.shoplogoname{
   margin-top: 24rpx;
   font-size: 15px;
}
.logo{
  margin-top: 118rpx;
  text-align: center;
  margin-bottom: 124rpx;
}
.logoimg{
  width: 280rpx;
  height:120rpx;
}

.form{
  padding: 0 24rpx 0 0;
}

.phone{
  width: 36rpx;
  height: 36rpx;
}

.login_first_input:before{
  border-top:0;
}

.weui-cell__hd image{
 margin-top: 24rpx;
}

.weui-cell__bd{
  padding-left:10rpx;
  
}
.weui-cell__bd input{
  margin-top: 24rpx;
height: 40rpx;
}
.wd88{
width: 176rpx;
}

.h20{
  height: 40rpx;
}
.h64{
  height: 64rpx;
}
.h80{
  height: 80rpx;
}
.btn{
  height: 64rpx;
  margin: 16rpx 0;
}

.p-0{
  padding: 0;
}

.login{
  padding: 64rpx 24rpx ;
}
,const app = getApp();
import AcFunc from '../../helpers/acFunc.js'
Page({
  data: {
    userlist:{},
  },
  tobrowseshop:function(){
    wx.navigateTo({
      url: '/pages/myhome/browseshop/browseshop'
    })
  },
  tobbaseinfo: function () {
    wx.navigateTo({
      url: '/pages/myhome/baseinfo/baseinfo'
    })
  },
  outLogo(){
    app.HttpService.outlogo().then(res=>{
      app.globalData.loginInfo = null
      app.logout();
      app.clearSet();
      app.globalData.loginInfo=null
      if(res){
        wx.navigateTo({
          url: '/pages/login/index',
        })
      }
    })
  },
  onLoad: function (options) {
  },
  onShow: function () {
    wx.setNavigationBarTitle({
      title: '我的'
    })
    this.userInfores();
    app.setMsgCount()
  },
  //查询用户基本信息
  userInfores(){
    let userlist = this.data.userlist;
    app.HttpService.userInfo().then(res=>{
      console.log(JSON.stringify(res))
      // app.AcFunc.myTotal(res.name)
      res.imgurl = res.photo ? app.getimg('thumbnail', res.photo) : 'http://www.ydcfo.com/chatLogo.png'
      if (!res.name) {
        res.name = '某用户'
      }
      this.setData({
        userlist: res,
        largeimg: res.imgurl
      })
    })
  },
  onShareAppMessage: function () {
    let url =''
    if (wx.getStorageSync('owner').cloudShopVO.shareUrl){
      let i = wx.getStorageSync('owner').cloudShopVO.shareUrl.indexOf('?')
      url = wx.getStorageSync('owner').cloudShopVO.shareUrl.slice(i);
    }
    return {
      title: wx.getStorageSync('owner').cloudShopVO.name,
      path: '/pages/index/index'+url,
      imageUrl:'/images/sharelogo.jpg'
    }
  },
  showimgBig(event){
    AcFunc.imgBig(event)
  }
}),{"navigationBarTitleText": "我的"},<view class='myinfo flex just-con-b align-center' bindtap='tobbaseinfo'>
  <view class='self-center flex'>
    <view><image src='{{userlist.imgurl}}' mode='aspectFit' class='mylogo' catchtap="showimgBig" data-src='{{userlist.imgurl}}'></image></view>
    <view class='self-center'>
      <view class='myname'>{{userlist.name}}</view>
      <view class='mytel'>电话：{{userlist.phone}}</view>
    </view>
  </view>
  <view class='self-center'><image src='/images/my/tonext.png' class='tonextimg'></image></view>
</view>
<view class='myinfo myinfo1'>
  <view class='flex myinfolist' bindtap='tobrowseshop'>
    <view class='wid1'><image src='/images/my/browse.png' class='tolistimg'></image></view>
    <view class='myinfoborder wid2'>我浏览的店铺</view>
  </view>
  <view class='flex myinfolist'>
    <view class='wid1'><image src='/images/my/share.png' class='tolistimg'></image></view>
    <button class='wid2' open-type="share">分享店铺</button>
  </view>
</view>
<view class='outlogo' bindtap='outLogo'>退出登录</view>
,page{
  background: #EFEFF4;
}
.myinfo{
  width: 750rpx;
  height: 212rpx;
  background: #fff;
  padding: 26rpx;
  box-sizing: border-box;
  margin-bottom: 24rpx;
}
.mylogo{
  width: 120rpx;
  height: 120rpx;
  border-radius: 120rpx;
  -webkit-box-shadow: #8DD4F6 0px 0px 16px;
  -moz-box-shadow: #8DD4F6 0px 0px 16px;
  box-shadow: #8DD4F6 0px 0px 16px;
  margin-right: 30rpx;
}
.tonextimg{
  width: 12rpx;
  height: 22rpx;
}
.myname{
  font-size: 32rpx;
  color: #666;
  margin-bottom: 16rpx;
}
.mytel{
  font-size: 22rpx;
  color: #333;
}
.myinfolist{
  height: 104rpx;
  line-height: 104rpx;
  width: 750rpx;
}
.wid1{
  width: 90rpx;
  text-align: center;
}
button.wid2::after{
  border: 0;
}
.wid2{
  padding: 0;
  text-align: left;
  background: #fff;
  width: 660rpx;
  font-size: 32rpx;
  color: #333;
  line-height: 104rpx;
}
.myinfoborder{
  border-bottom: 2rpx solid #F2F2F2;
}
.myinfo1{
  padding: 0 26rpx;
  overflow: hidden;
}
.outlogo{
  height: 80rpx;
  line-height: 80rpx;
  text-align: center;
  background: #fff;
  color: #FE3824;
  font-size: 36rpx;
}
.tolistimg{
  width: 36rpx;
  height: 36rpx;
  vertical-align: middle;
}
,const app = getApp();
Page({
  data: {
    searchobj: {
      pageSize: 10,
      pageNum: 0,
      messageType: 'cloudShopRemind',
      flag: 0,
    },
    newslist: [],
    newslisttotal:0,
    refresh:true,
  },
  onLoad: function (options) {

  },
  onReady: function () {
    
  },
  onShow: function () {
    this.setData({
      searchobj: {
        pageSize: 10,
        pageNum: 0,
        messageType: 'cloudShopRemind',
        flag: 0,
      },
      newslist: [],
      newslisttotal: 0,
      refresh: true,
    })
    wx.setNavigationBarTitle({
      title: '消息中心'
    })
    this.resmsg();
  },
  toorderpage(e){
    let ele = e;
    if (e.currentTarget.dataset.biztype =='cloudShopTel'){
      return;
    }
    this.missMsg(ele)
  },
  resmsg(){
    let param = this.data.searchobj;
    let that = this;
    let newslist = this.data.newslist;
    app.HttpService.getmsglist(param).then(res => {
      if (res.total !== 0){
        for (let i = 0; i < res.list[0].messageVOs.length; i++) {
          res.list[0].messageVOs[i].lastUpdateDate = res.list[0].messageVOs[i].lastUpdateDate.slice(0, 10);
          res.list[0].messageVOs[i].logosrc = res.list[0].messageVOs[i].logo ? app.getxsimg('thumbnail', res.list[0].messageVOs[i].logo) : '/images/chatLogo.png'
          newslist.push(res.list[0].messageVOs[i]);
        }
        that.setData({
          newslist: newslist,
          newslisttotal: res.total,
        })
        if (that.data.newslisttotal == newslist.length) {
          that.setData({
            refresh: false,
          })
        }
      }
      app.setMsgCount();
    }).catch(error => {
      console.error(error)
      wx.showToast({ title: error.errorMsg, icon: 'none' })
    })
  },
  tocancel(e){
    this.missMsg(e)
  },
  tosure(e) {
    let msgtelobj = {};
    //msgtelobj.tel='18896533020',
    msgtelobj.tel = e.currentTarget.dataset.number,
    msgtelobj.id = e.currentTarget.dataset.id;
    msgtelobj.ownerid = e.currentTarget.dataset.ownerid;
    wx.navigateTo({
      url: '/pages/myhome/edittel/edittel?msgtelobj=' + JSON.stringify(msgtelobj),
    });
  },
  missMsg(ele){
    let that = this;
    let bizType = ele.currentTarget.dataset.biztype;
    let bizid = ele.currentTarget.dataset.bizid;
    let id = ele.currentTarget.dataset.id;
    let param = {
      id: id,
      messageType: 'cloudShopRemind'
    }
    app.HttpService.readmsg(param).then(res => {
      if (res) {
        if (bizType == 'cloudShopOrder') {
          wx.navigateTo({
            url: '/pages/order/orderDetail/orderDetail?id=' + bizid,
          });
        } else if (bizType == 'logistic') {
          wx.navigateTo({
            url: '/pages/order/logistDetail/logistDetail?id=' + bizid,
          });
        } else if (bizType == 'cloudShopTel'){//忽略电话更改的，列表刷新
          that.setData({
            searchobj: {
              pageSize: 10,
              pageNum: 0,
              messageType: 'cloudShopRemind',
              flag: 0,
            },
            newslist: [],
            newslisttotal: 0,
            refresh: true,
          })
          that.resmsg()
        }
      }
    }).catch(error => {
      wx.showToast({ 'title': error, icon: 'none' })
    })
  },
  onReachBottom: function () {
    if (this.data.refresh) {
      var search = this.data.searchobj;
      search.pageNum++;
      this.setData({
        searchobj: search
      });
      this.resmsg();
    }
  }
}),{"navigationBarTitleText": "消息中心"},<view class='newsall'>
  <view wx:if="{{newslist.length>0}}">
    <view class='newlist' wx:for="{{newslist}}" wx:key="">
      <view class='flex just-con-b titleheight'>
        <view class='newstip'>
          <text>{{item.headline}}</text>
          <text wx:if="{{item.shopName}}">-{{item.shopName}}</text>
        </view>
        <view class='newstime'>{{item.lastUpdateDate}}</view>
      </view>
      <view class='newdetail'>
        <view class='flex f-row nowrap' bindtap='toorderpage' data-bizid='{{item.bizId}}' data-bizType='{{item.bizType}}' data-id='{{item.id}}'>
          <view class='newslogo'>
            <image src='{{item.logosrc}}' mode='aspectFit'></image>
          </view>
          <view>
            <view>{{item.content}}</view>
            <view class='tipred' wx:if='{{item.bizType=="cloudShopTel"}}'>若不同步更改，可能联系不上客户哦</view>
          </view>
        </view>
        <view class='flex just-con-r' wx:if='{{item.bizType=="cloudShopTel"}}'>
          <view class='cancelbtn btnsame' bindtap='tocancel' data-bizType='{{item.bizType}}' data-id='{{item.id}}'>取消</view>
          <view class='surebtn btnsame' bindtap='tosure' data-id='{{item.id}}' data-number='{{item.number}}' data-ownerid='{{item.messageBizDataJsonVO.ownerId}}'>确认</view>
        </view>
      </view>
    </view>
  </view>
  <view wx:else>
    <image class='newsimg' src='/images/defaultnews.png'></image>
  </view>
</view>,page{
  background: #EFEFF4;
}
.newsall{
  padding: 26rpx 22rpx;
  box-sizing: border-box;
}
.newlist{
  background: #fff;
  width: 706rpx;
  border-radius: 20rpx;
  padding: 26rpx 18rpx;
  box-sizing: border-box;
  margin-bottom: 40rpx;
}
.newdetail{
  background: #EFEFF4;
  padding: 34rpx 22rpx;
  box-sizing: border-box;
  border-radius: 4rpx;
  margin-top:20rpx;
}
.newstip{
  font-size: 30rpx;
  color: #333;
  font-weight: 700;
}
.newstime{
  font-size: 24rpx;
  color: #999;
}
.newslogo{
  align-items:center;
  display: -webkit-flex;
}
.newslogo image{
  width: 88rpx;
  height:86rpx;
  margin-right: 10rpx;
}
.titleheight{
  height: 50rpx;
  line-height: 50rpx;
}
.newsimg{
  width: 348rpx;
  height: 420rpx;
  margin-top: 100rpx;
  margin-left: 160rpx;
}
.cancelbtn{
  border:2rpx solid #8F8F8F;
  color: #8F8F8F; 
  margin-right: 20rpx;
}
.surebtn{
  border:2rpx solid #00A6F5;
  color: #00A6F5; 
}
.btnsame{
  width: 136rpx;
  height: 50rpx;
  line-height: 50rpx;
  text-align: center;
  font-size: 24rpx; 
  margin-top:14rpx;
  border-radius: 50rpx;
}
.tipred{
  color: #FE3824;
  font-size: 22rpx;
},const app = getApp()
import AcFunc from '../../helpers/acFunc.js'
let date = new Date()
let year = date.getFullYear()
let month = date.getMonth() + 1
let day = date.getDate()
let today = year + '-' + month + '-' + day
let sortanimation = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let downanimation = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let lineanimation = wx.createAnimation({
  duration: 300,
  timingFunction: 'ease',
})
Page({
  data: {
    p: null,
    sortList: [],
    sortListorder: [{
      sorttype: 'orderNumber',
      name: '单号',
      sortorder: 'asc'
    }, {
      sorttype: 'contractAmt',
      name: '金额',
      sortorder: 'asc'
    }, {
      sorttype: 'orderDate',
      name: '日期',
      sortorder: 'asc'
    }, {
      sorttype: 'cloudStatus',
      name: '订单状态',
      sortorder: 'asc'
    }, {
      sorttype: 'orderPaidStatus',
      name: '付款状态',
      sortorder: 'asc'
    }, {
      sorttype: 'orderStatus',
      name: '收货状态',
      sortorder: 'asc'
    }, {
      sorttype: 'clearSort',
      name: '清除排序',
      sortorder: 'asc'
    }],
    sortListlogist: [{
      sorttype: 'orderNo',
      name: '物流单号',
      sortorder: 'asc'
    }, {
      sorttype: 'enterpriseName',
      name: '物流公司',
      sortorder: 'asc'
    }, {
      sorttype: 'orderDate',
      name: '下单日期',
      sortorder: 'asc'
    }, {
      sorttype: 'consignee',
      name: '收货人',
      sortorder: 'asc'
    }, {
      sorttype: 'deliveryNo',
      name: '运单号',
      sortorder: 'asc'
    }, {
      sorttype: 'orderStatus',
      name: '物流状态',
      sortorder: 'asc'
    }, {
      sorttype: 'clearSort',
      name: '清除排序',
      sortorder: 'asc'
    }],
    sortShow: false,
    sortAnimate: {},
    downAnimate: {},
    lineAnimate: {},
    pamars: '',
    orderBar: {
      order: true,
      logist: false
    },
    cloudSearchobj: {
      'pageNum': 0,
      'pageSize': 10
    },
    logistSearchobj: {
      'pageNum': 0,
      'pageSize': 10
    },
    cloudlist: [],
    logistlist: [],
    cloudrefresh: true,
    logistrefresh: true,
    cloudtotal: 0,
    logisttotal: 0,
    placeholdertxt: '输入单号、产品名称、备注查找',
    sortordername: '排序',
    filtersure: false, //在筛选页面点“确定”返回此值为true,直接返回的话，此值为false
    firstlogistorder: true
  },
  onLoad: function(options) {

  },
  onShow: function() {
    wx.setNavigationBarTitle({
      title: '订单'
    })
    let sortListorder = this.data.sortListorder
    let sortListlogist = this.data.sortListlogist
    for (let a = 0; a < sortListorder.length; a++) {
      sortListorder[a].sortorder = 'asc'
    }
    for (let b = 0; b < sortListlogist.length; b++) {
      sortListlogist[b].sortorder = 'asc'
    }
    if (this.data.sortShow) {
      this.endSort()
    }
    if (!wx.getStorageSync('refreshorder')) { //tarbar切换时刷新
      lineanimation.left('0').step()
      this.setData({
        firstlogistorder: true,
        sortList: sortListorder,
        sortListlogist: sortListlogist,
        lineAnimate: {},
        sortAnimate: {},
        downAnimate: {},
        pamars: '',
        inputval: '',
        orderBar: {
          order: true,
          logist: false
        },
        cloudSearchobj: {
          'pageNum': 0,
          'pageSize': 10
        },
        logistSearchobj: {
          'pageNum': 0,
          'pageSize': 10
        },
        cloudlist: [],
        logistlist: [],
        cloudrefresh: true,
        logistrefresh: true,
        cloudtotal: 0,
        logisttotal: 0,
        placeholdertxt: '输入单号、产品名称、备注查找',
        sortordername: '排序',
        lineAnimate: lineanimation.export(),
      })
      this.getCloudlist();
    } else { //跳转订单详情/筛选页面后，返回订单列表刷新
      if (this.data.orderBar.order) {
        if (!this.data.filtersure) { //从云单详情页左上角直接返回,返回时的筛选条件以带去的为主，除非点击了“确定”才以新的筛选条件搜索（重置也需点击确认）
          let ss = this.data.cloudSearchobj
          ss.pageNum = 0
          ss.pageSize = 10
          this.setData({
            cloudSearchobj: ss,
            cloudlist: [],
            cloudrefresh: true,
            cloudtotal: 0,
            sortordername: '排序',
          })
        }
        this.getCloudlist();
      } else {
        if (!this.data.filtersure) { //从物流详情页左上角直接返回,返回时的筛选条件以带去的为主，除非点击了“确定”才以新的筛选条件搜索（重置也需点击确认）
          let ss = this.data.logistSearchobj
          ss.pageNum = 0
          ss.pageSize = 10
          this.setData({
            logistSearchobj: ss,
            logistlist: [],
            logistrefresh: true,
            logisttotal: 0,
            sortordername: '排序',
          })
        }
        this.getlogistlist();
      }
    }
    app.setMsgCount()
    wx.setStorageSync('refreshorder', false);
  },
  //获取云单列表
  getCloudlist() {
    app.HttpService.orderList(this.data.cloudSearchobj).then((res) => {
      this.EntoChclound(res);
    })
  },
  //获取物流单列表
  getlogistlist() {
    app.HttpService.logistList(this.data.logistSearchobj).then((res) => {
      this.EntoChlogist(res);
    })
  },
  toorderDetail(e) {
    wx.setStorageSync('refreshorder', true);
    wx.navigateTo({
      url: '/pages/order/orderDetail/orderDetail?id=' + e.currentTarget.dataset.cloundid,
    })
  },
  tologistDetail(e) {
    wx.setStorageSync('refreshorder', true);
    wx.navigateTo({
      url: '/pages/order/logistDetail/logistDetail?id=' + e.currentTarget.dataset.logistid + '&isshare=' + e.currentTarget.dataset.isshare,
    })
  },
  bindSort: function(e) {
    if (this.data.orderBar.logist) {
      this.setData({
        sortList: this.data.sortListlogist
      })
    } else {
      this.setData({
        sortList: this.data.sortListorder
      })
    }
    let sortShow = this.data.sortShow;
    if (sortShow) {
      this.endSort()
    } else {
      sortanimation.top('182rpx').step()
      downanimation.rotate('180').step()
      this.setData({
        sortAnimate: sortanimation.export(),
        downAnimate: downanimation.export(),
        sortShow: true
      })
    }
  },
  //模糊搜素
  searchtxt() {
    let search = {}
    if (this.data.orderBar.order) {
      search = this.data.cloudSearchobj
    } else {
      search = this.data.logistSearchobj
    }
    search.mobileSearch = this.data.pamars
    search.pageNum = 0
    search.sortList = []
    if (this.data.orderBar.order) {
      this.setData({
        cloudlist: [],
        cloudSearchobj: search,
        cloudrefresh: true,
      })
      this.getCloudlist()
    } else {
      this.setData({
        logistlist: [],
        logistSearchobj: search,
        logistrefresh: true,
      })
      this.getlogistlist()
    }

  },
  //排序事件
  BindSearch(e) {
    let sort = {};
    let sortindex = e.target.dataset.sortindex;
    let sortname = e.target.dataset.sortname;
    let search = {};
    let sortres = {}
    if (this.data.orderBar.order) {
      search = this.data.cloudSearchobj;
      sortres = this.data.sortListorder;
    } else {
      search = this.data.logistSearchobj;
      sortres = this.data.sortListlogist;
    }

    let sortordername = this.data.sortordername
    sort.sortColumn = e.target.dataset.type;
    sort.sortOrder = e.target.dataset.sort;
    search.sortList = [];
    search.sortList.push(sort);
    search.pageNum = 0;
    search.mobileSearch = '';
    if (sortres[sortindex].sortorder == 'desc') {
      sortres[sortindex].sortorder = 'asc';
      sortordername = sortname + '倒序';
    } else {
      sortres[sortindex].sortorder = 'desc';
      sortordername = sortname + '正序';
    }
    if (e.target.dataset.type == 'clearSort') {
      sortordername = '排序';
      search.sortList = [];
    }
    this.endSort();
    if (this.data.orderBar.order) {
      this.setData({
        sortList: sortres,
        cloudSearchobj: search,
        cloudrefresh: true,
        cloudlist: [],
        sortordername: sortordername
      });
      this.getCloudlist()
    } else {
      this.setData({
        sortListlogist: sortres,
        logistSearchobj: search,
        logistrefresh: true,
        logistlist: [],
        sortordername: sortordername
      });
      this.getlogistlist()
    }
  },
  endSort: function() {
    sortanimation.top('-100%').step()
    downanimation.rotate('0').step()
    this.setData({
      sortAnimate: sortanimation.export(),
      downAnimate: downanimation.export(),
      sortShow: false
    })
  },
  inputfocus() {
    if (this.data.sortShow) {
      this.endSort()
    }
  },
  inputChange: function(e) {
    this.setData({
      pamars: e.detail.value
    })
  },
  clickBar: function(e) {
    if (this.data.sortShow) {
      this.endSort()
    }
    let ind = e.currentTarget.dataset.index //{ order: true, logist: false }
    let left = 160 * ind
    let orderBar = this.data.orderBar
    let placeholdertxt = this.data.placeholdertxt
    if (ind == 0) {
      orderBar.order = true
      orderBar.logist = false
      placeholdertxt = '输入单号、产品名称、备注查找'
    } else {
      orderBar.logist = true
      orderBar.order = false
      placeholdertxt = '输入收货人、电话号码、单号、制单人查找'
    }
    lineanimation.left(left + 'rpx').step()
    //第一次点到物流单时调获取物流单方法
    if (this.data.firstlogistorder) {
      this.getlogistlist();
    }
    this.setData({
      lineAnimate: lineanimation.export(),
      orderBar: orderBar,
      placeholdertxt: placeholdertxt,
      sortordername: '排序',
      firstlogistorder: false,
      inputval: ''
    });
  },
  //筛选事件
  tofilter() {
    let filter = true
    let search = JSON.stringify(this.data.cloudSearchobj)
    if (this.data.orderBar.logist) {
      filter = false
      search = JSON.stringify(this.data.logistSearchobj)
    }
    wx.setStorageSync('refreshorder', true);
    wx.navigateTo({
      url: '/pages/order/orderfilter/index?filter=' + filter + '&search=' + search,
    })
  },
  //转换云单
  EntoChclound(data) {
    let p = getApp().P();
    let datalist = data.list
    let obj = {
      'waitReceive': ['待接单', 'orderStatus subOrder', ],
      'refused': ['已拒绝', 'orderStatus refuseOrder', ],
      'deleted': ['卖家删除', 'orderStatus deleteOrder'],
      'received': ['已完成', 'orderStatus overOrder',
        {
          'noSalesPaid': ['未付款', 'orderpay unpay'],
          'someSalesPaid': ['部分付款', 'orderpay partpay'],
          'allSalesPaid': ['全部付款', 'orderpay allpay'],
          'overchargeSalesPaid': ['超付款', 'orderpay overpay']
        },
        {
          'unDelivered': ['未收货', '/images/order/unsend.png'],
          'partialDelivered': ['部分收货', '/images/order/partsend.png'],
          'allDelivered': ['全部收货', '/images/order/addsend.png'],
          'stop': ['拒收', '/images/order/refuse.png']
        },
      ],
      'shared': ['分享订单', 'orderStatus shareOrder',
        {
          'noSalesPaid': ['未付款', 'orderpay unpay'],
          'someSalesPaid': ['部分付款', 'orderpay partpay'],
          'allSalesPaid': ['全部付款', 'orderpay allpay'],
          'overchargeSalesPaid': ['超付款', 'orderpay overpay'],
          // 'waitSalesPaid': ['草稿', 'waitpay']
        },
        {
          'unDelivered': ['未收货', '/images/order/unsend.png'],
          'partialDelivered': ['部分收货', '/images/order/partsend.png'],
          'allDelivered': ['全部收货', '/images/order/addsend.png'],
          'stop': ['拒收', '/images/order/refuse.png'],
          'wait': ['草稿', '/images/order/wait.png']
        },
      ]
    }
    for (let a = 0; a < datalist.length; a++) {
      datalist[a].customview = {};
      let state1 = datalist[a].cloudStatus; //云单状态
      let state2 = datalist[a].orderPaidStatus; //付款状态
      let state3 = datalist[a].orderStatus; //送货状态
      if (state1 == 'received') {
        let obj1 = {}
        obj1.paytxt = obj[state1][2][state2][0];
        obj1.paycolor = obj[state1][2][state2][1];
        obj1.sendimg = obj[state1][3][state3][1];
        if (state2 == 'noSalesPaid' || state2 == 'someSalesPaid') {
          obj1.moneyshow = '未付款：￥' + AcFunc.money(datalist[a].unpaidAmt, 2, false)
          obj1.moneyshowcolor = 'classtwo'
        }
        if (state2 == 'overchargeSalesPaid') {
          obj1.moneyshow = '超付款：￥' + AcFunc.money(datalist[a].overpaidAmt, 2, false)
        }
        datalist[a].customview = obj1
      } else if (state1 == 'refused') {
        let obj1 = {}
        obj1.paytxt = datalist[a].refuseReason;
        obj1.paycolor = 'refuseclasstwo'
        datalist[a].customview = obj1
      } else if (state1 == 'shared') {
        let obj1 = {}
        obj1.paytxt = obj[state1][2][state2][0];
        obj1.paycolor = obj[state1][2][state2][1];
        obj1.sendimg = obj[state1][3][state3][1];
        if (state2 == 'noSalesPaid' || state2 == 'someSalesPaid') {
          obj1.moneyshow = '未付款：￥' + AcFunc.money(datalist[a].unpaidAmt, 2, false)
          obj1.moneyshowcolor = 'classtwo'
        }
        if (state2 == 'overchargeSalesPaid') {
          obj1.moneyshow = '超付款：￥' + AcFunc.money(datalist[a].overpaidAmt, 2, false)
        }
        datalist[a].customview = obj1
        datalist[a].shareicon = true
      }
      datalist[a].classone = obj[state1][1]
      datalist[a].cloudStatus = obj[datalist[a].cloudStatus][0];
      datalist[a].contractAmt = '￥' + AcFunc.money(datalist[a].contractAmt, 2, false);
      datalist[a].orderDate = datalist[a].orderDate.substring(0, 11);
    }
    console.log(datalist);
    let cloudlist = this.data.cloudlist
    cloudlist = cloudlist.concat(datalist)
    this.setData({
      p: p,
      cloudlist: cloudlist,
      cloudtotal: data.total,
      filtersure: false
    })
    if (this.data.cloudlist.length == this.data.cloudtotal) {
      this.setData({
        cloudrefresh: false
      })
    }
  },
  //物流单
  EntoChlogist(data) {
    let datalist = data.list;
    for (let b = 0; b < datalist.length; b++) {
      datalist[b].orderDate = datalist[b].orderDate.substring(0, 11);
      if (datalist[b].paymentStatus == 'paid' && datalist[b].balanceAmt > 0) { //差额未付的图标显示
        datalist[b].balanceAmtimg = true
      }
      if (datalist[b].deliveryNo) {
        datalist[b].deliveryNo = '运单号:' + datalist[b].deliveryNo
      }
    }
    let logistlist = this.data.logistlist
    logistlist = logistlist.concat(datalist)
    this.setData({
      logistlist: logistlist,
      logisttotal: data.total,
      filtersure: false
    })
    if (this.data.logistlist.length == this.data.logisttotal) {
      this.setData({
        logistrefresh: false
      })
    }
    console.log(datalist)
  },
  //上拉加载分页
  onReachBottom() {
    if (this.data.orderBar.order) {
      if (this.data.cloudrefresh) {
        var search = this.data.cloudSearchobj;
        search.pageNum++;
        this.setData({
          cloudSearchobj: search
        });
        this.getCloudlist();
      }
    } else {
      if (this.data.logistrefresh) {
        var search = this.data.logistSearchobj;
        search.pageNum++;
        this.setData({
          logistSearchobj: search
        });
        this.getlogistlist();
      }
    }
  },
  //下拉刷新
  onPullDownRefresh() {
    if (this.data.orderBar.order) {
      let sortListorder = this.data.sortListorder
      for (let a = 0; a < sortListorder.length; a++) {
        sortListorder[a].sortorder = 'asc'
      }
      if (this.data.sortShow) {
        this.endSort()
      }
      lineanimation.left('0').step()
      this.setData({
        // firstlogistorder: true,
        sortList: sortListorder,
        lineAnimate: {},
        sortAnimate: {},
        downAnimate: {},
        pamars: '',
        inputval: '',
        orderBar: {
          order: true,
          logist: false
        },
        cloudSearchobj: {
          'pageNum': 0,
          'pageSize': 10
        },
        cloudlist: [],
        cloudrefresh: true,
        cloudtotal: 0,
        placeholdertxt: '输入单号、产品名称、备注查找',
        sortordername: '排序',
        lineAnimate: lineanimation.export(),
      })
      this.getCloudlist();
    } else {
      let sortListlogist = this.data.sortListlogist
      for (let b = 0; b < sortListlogist.length; b++) {
        sortListlogist[b].sortorder = 'asc'
      }
      if (this.data.sortShow) {
        this.endSort()
      }
      this.setData({
        // firstlogistorder: true,
        sortListlogist: sortListlogist,
        lineAnimate: {},
        sortAnimate: {},
        downAnimate: {},
        pamars: '',
        inputval: '',
        logistSearchobj: {
          'pageNum': 0,
          'pageSize': 10
        },
        logistlist: [],
        logistrefresh: true,
        logisttotal: 0,
        placeholdertxt: '输入收货人、电话号码、单号、制单人查找',
        sortordername: '排序',
        lineAnimate: lineanimation.export(),
      })
      this.getlogistlist();
    }
    wx.stopPullDownRefresh();
  },
}),{"navigationBarTitleText": "订单","enablePullDownRefresh": true},<view class="sortMod flex f-col" animation="{{sortAnimate}}">
  <view class='sortList'>
    <view wx:for="{{sortList}}" hover-class='touch' wx:key="" bindtap='BindSearch' data-type='{{item.sorttype}}' data-sort='{{item.sortorder}}' wx:for-index='sortindex' data-sortindex='{{sortindex}}' data-sortname='{{item.name}}' wx:if="{{(((p['viewProductSalesPriceOne']||p['viewProductSalesPriceTwo']||p['viewProductSalesPriceThree']||p['viewProductSalesPriceFour'])&&(p['morePriceFlag']))||(!p['morePriceFlag']&&p['viewProductSalesPriceOne']))||(item.sorttype !=='contractAmt')}}">{{item.name}}</view>
  </view>
  <view bindtap='endSort' class='flex-1'></view>
</view>
<view class='fixhead'>
  <view class='orderSearch flex'>
    <view class='searchText flex-1'>
      <input placeholder='{{placeholdertxt}}' bindinput='inputChange' value='{{inputval}}' bindfocus='inputfocus'></input>
      <icon class='iconfont icon-search'></icon>
    </view>
    <view class='searchBtn self-center' bindtap='searchtxt'>搜索</view>
  </view>
  <view class='orderChoose flex'>
    <view class='orderBar flex-1'>
      <text bindtap='clickBar' data-index='0' class='{{orderBar.order?"blue":""}}'>订单</text>
      <text bindtap='clickBar' data-index='1' class='{{orderBar.logist?"blue":""}}' wx:if="{{p['mzLogisticsFlag']}}">物流单</text>
      <view class='line' animation="{{lineAnimate}}"></view>
    </view>
    <view class='oper' bindtap='bindSort'>{{sortordername}}
      <icon class='iconfont icon-Down' animation="{{downAnimate}}"></icon>
    </view>
    <view class='oper' bindtap='tofilter'>筛选
      <icon class='iconfont icon-Down'></icon>
    </view>
  </view>
</view>
<view wx:if="{{orderBar.order}}" class='orderList'>
  <view class='listMod' wx:for="{{cloudlist}}" wx:key="" bindtap='toorderDetail' data-cloundid='{{item.id}}'>
      <view class='flex'>
        <view class='flex-1 c666 self-center'>订单编号:{{item.orderNumber}}</view>
        <view class='{{item.classone}}'>{{item.cloudStatus}}</view>
      </view>
      <view class='shopName flex'>
        <view class='flex-1 self-center overpoint'>{{item.shopName}}</view>
        <view class='c666 p-r20' wx:if="{{((p['viewProductSalesPriceOne']||p['viewProductSalesPriceTwo']||p['viewProductSalesPriceThree']||p['viewProductSalesPriceFour'])&&(p['morePriceFlag']))||(!p['morePriceFlag']&&p['viewProductSalesPriceOne'])}}">{{item.contractAmt}}</view>
      </view>
      <view class='orderDate flex just-con-b'>
        <view class='orderdatewidth c666 self-center'>{{item.orderDate}}<image wx:if="{{item.shareicon}}" class='shareimg' src='/images/order/share.png'></image></view>
        <view class='orderotherwidth c666 p-r20 flex just-con-r'>
          <view class='{{item.customview.moneyshowcolor}}'>{{item.customview.moneyshow}}</view>
          <view wx:if="{{item.customview.sendimg}}"><image class='sendstate' src='{{item.customview.sendimg}}'></image></view>
          <view class='{{item.customview.paycolor}}'>{{item.customview.paytxt}}</view>
        </view>
      </view>
  </view>
</view>
<view wx:else class='logistList'>
  <block>
    <view class="logistMod" wx:for="{{logistlist}}" wx:key="" bindtap='tologistDetail' data-logistid='{{item.id}}' data-isshare='{{item.isShare}}'>
        <view class='flex logistposition'>
          <view class='flex-1 self-center fs13 c000 w480 overpoint'>{{item.enterpriseName}}</view>
          <view class='shareOrder' wx:if="{{item.isShare}}">分享订单</view>
          <view class='orderState right self-center'>
            <image src='/images/order/{{item.paymentStatus}}{{item.orderStatus}}.png' class='logistimg'></image>
            <view class='unpayimg' wx:if="{{item.balanceAmtimg}}"><image src='/images/order/unpay.png'></image></view>
          </view>
        </view>
        <view class='flex c666 m-t-b-10 logistposition just-con-b'>
          <view class='fs11 w460 overpoint'>收货人：{{item.consignee}}({{item.consigneeContactNo}})</view>
          <view class='right fs11 w230 overpoint'>下单时间:{{item.orderDate}}</view>
          <view><image wx:if="{{item.isShare}}" class='shareimg' src='/images/order/share.png'></image></view>
        </view>
        <view class='flex c666'>
          <view class='flex-1 fs11 overpoint'>物流单号:{{item.orderNo}}</view>
          <view class='flex-1 right fs11 overpoint text-right'>{{item.deliveryNo}}</view>
        </view>
    </view>
  </block>
</view>,.fixhead{
  position: fixed;
  width: 100%;
  top:0;
  left:0;
  z-index: 100;
}
.orderSearch{
  background: #00A6F5;
  padding:20rpx 0 20rpx 30rpx;
}
.searchText{
  height:60rpx;
  background: #fff;
  border-radius: 60rpx;
  padding:0 20rpx 0 60rpx;
  position: relative;
  overflow: hidden;
}
.searchText .icon-search{
  position: absolute;
  left:20rpx;
  width: 30rpx;
  top:0;
  height:100%;
  color:#8E8E93;
}
.searchText .icon-search:before{
  position: absolute;
  line-height: 60rpx;
  left:0;
}
.orderSearch input{
  height:100%;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size:24rpx;
}
.searchBtn{
  padding:0 30rpx;
    color: #fff;
}
.orderChoose{
  height:80rpx;
  line-height: 80rpx;
  background: #fff;
  border-bottom: 1px solid #EFEFF4;
  color:#00A6F5;
  padding-left:20rpx;
}
.orderBar{
  position: relative;
}
.orderBar text{
  display: inline-block;
  width: 160rpx;
  line-height: 80rpx;
  color:#666;
  text-align: center;
}
.orderBar .line{
  width: 160rpx;
  position: absolute;
  height:2px;
  background: #00A6F5;
  left:0;
  bottom:0;
}
.orderChoose icon{
  font-size:28rpx;
}
.orderChoose .oper{
  margin-right:20rpx;
}
.orderChoose picker{
  display: inline-block;
}
.orderList,.logistList{
  padding-top:182rpx;
}
.listMod,.logistMod{
  background: #fff;
  border-bottom: 1px solid #EFEFF4;
  padding:20rpx;
  font-size:24rpx;
}
.listMod .orderStatus{
  height:44rpx;
  width: 140rpx;
  text-align: center;
  line-height: 44rpx;
  font-size:22rpx;
  border-radius:44rpx;
}
.listMod .orderStatus.subOrder{
  color:#00A6F5;
  background: rgba(0,166,245,0.1);
}
.listMod .orderStatus.refuseOrder{
  background: #FFF2D9;
  color:#FFAA00;
}
.listMod .orderStatus.deleteOrder{
  background: #FEDEE0;
  color:#F5222D;
}
.listMod .orderStatus.overOrder{
  background: #f6f6f6;
  color:#666;
}
.listMod .orderStatus.shareOrder,.logistMod .shareOrder{
  background: #B6B7F0;
  color:#6922F5;
  width: 112rpx;
  height: 44rpx;
  line-height: 44rpx;
  text-align: center;
  border-radius: 44rpx;
  font-size: 22rpx;
}
.listMod .shopName{
  margin:10rpx 0;
  font-size:28rpx;
}
.p-r20{
  padding-right:20rpx;
}
.orderpay{
    width: 106rpx;
  height: 44rpx;
  line-height: 44rpx;
    text-align: center;
}
.unpay{
  border:2px solid #36D4C8;
  color:#36D4C8;
}
.partpay{
  border:2px solid #00A6F5;
  color:#00A6F5;
}
.allpay,.overpay,.waitpay{
  border:2px solid #005692;
  color:#005692;
}
.icon-transport{
  color:#00A6F5;
  font-size:50rpx;
}
.sortMod{
  position: fixed;
  width: 100%;
  height:calc(100% - 182rpx);
  background: rgba(0,0,0,0.3);
  top:-100%;
  z-index: 50;
}
.sortList{
  background: #fff;
  font-size:24rpx;
}
.sortList view{
  padding:20rpx;
  color:#393939;
  border-bottom:1px solid #f2f2f2;
}
.sortList .touch{
  background: #f6f6f6;
}
.sendstate{
  width:50rpx;
  height: 36rpx;
  margin: 0 10rpx 0 20rpx;
}
.classtwo{
  color: #FE3824
}
.refuseclasstwo{
  color: #FE3824;
  width: 530rpx;
  text-overflow:ellipsis;
  white-space: nowrap;
  overflow: hidden;
  text-align: right;
}
.shareimg{
  width: 16rpx;
  height: 18rpx;
  vertical-align: 0;
}
.m-t-b-10{
  margin: 20rpx 0 10rpx;
}
logistposition{
  position: relative;
}
.unpayimg{
  position: absolute;
  left: -70rpx;
  top: 80rpx;
}
.logistMod .unpayimg image{
  width: 70rpx!important;
  height: 70rpx!important;
}
.logistimg{
  width: 210rpx;
  height: 50rpx;
}
.orderdatewidth{
  width: 170rpx;
}
.orderotherwidth{
  width: 530rpx;
}
.w480{
  width: 480rpx;
}
.w460{
  width: 460rpx;
}
.w230{
  width: 230rpx;
  text-align: right;
},<view class='addressMod'>
    <view class="section__title">省市区选择器</view>
  <picker mode="region" bindchange="bindRegionChange" value="{{region}}" custom-item="{{customItem}}">
    <view class="picker">
      当前选择：{{region[0]}}，{{region[1]}}，{{region[2]}}
    </view>
  </picker>
</view>,// pages/webview/index.js
let app=getApp();
Page({

  /**
   * 页面的初始数据
   */
  data: {
    src: `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${app.__config.wxappid}&redirect_uri=${app.__config.domain}/page/getChatCodeYD.html&response_type=code&scope=snsapi_base&state=1&connect_redirect=1#wechat_redirect`
  },

  message(e){
    let wxcode = e.detail.data[0];
    if (wxcode) {
      app._bindwx(wxcode);
    }
  },

  load2(e){
    console.log('webview打开成功',e)
  },
  error(e){
    wx.switchTab({
      url: '/pages/index/index',
    })
    console.error('webview打开失败',e);
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {

  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {

  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {

  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {

  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {

  }
}),{},<web-view bindmessage="message" binderror="error" bindload="load2" src="{{src}}">
</web-view>
,/* pages/webview/index.wxss */,// pages/webview/test.js
Page({

  /**
   * 页面的初始数据
   */
  data: {

  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {

  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {

  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {

  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {

  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {

  }
}),{},<!--pages/webview/test.wxml-->
<!-- <text>pages/webview/test.wxml</text> -->
<web-view src="http://192.168.1.44/translate/ajax.html"></web-view>
,/* pages/webview/test.wxss */,@font-face {
    font-family: "iconfont";
    src: url('data:application/x-font-woff;charset=utf-8;base64,d09GRgABAAAAABVsAAsAAAAAIYgAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAABHU1VCAAABCAAAADMAAABCsP6z7U9TLzIAAAE8AAAARAAAAFY8d0qOY21hcAAAAYAAAAE4AAADmOx3Jl9nbHlmAAACuAAAD70AABfIf1bhHmhlYWQAABJ4AAAAMQAAADYUulr5aGhlYQAAEqwAAAAgAAAAJAk/BkhobXR4AAASzAAAABsAAAB4eq3//2xvY2EAABLoAAAAPgAAAD5aVlPabWF4cAAAEygAAAAfAAAAIAE0AJtuYW1lAAATSAAAAUUAAAJtPlT+fXBvc3QAABSQAAAA2gAAASzF/xnzeJxjYGRgYOBikGPQYWB0cfMJYeBgYGGAAJAMY05meiJQDMoDyrGAaQ4gZoOIAgCKIwNPAHicY2BkEWecwMDKwMHUyXSGgYGhH0IzvmYwYuRgYGBiYGVmwAoC0lxTGByeMb5oZm7438AQw9zE0AAUZgTJAQDupgyCeJzdkztuAkEQRGt3Yf0Df/j4h1eyCIyEMQE49B24BZETzsAZyDgEp6olJnSCq7csIluyU0/rrWZGrZmerloAdQCZGIkakI6QaIbkSbtJtZ/htNqv4aNaP2rWYMKMOZvssseCfQ445pQzzrngimtuuCvTcrJd7vdAlV1XduuQPfw5+9cjUTURY8XrId6+DaCNLlJ0cKL3ZHjADc7QwpE6cIxCZ10j18t6uMcdmrhFAxe4xBXOdVH+h6r+62jEJ3n/WhWhqlFnwcyox2DdqNtgbtR3sGmkANgy4S22TfiQHSN9wK6RUmDPSDOwMIgz+kY6ggMTnubQSFvw2VQ1j0x4my9GyoNjg6h3auJ/4Mwg7p8bOQRcGHkFXBnE+9ZG/gE3JjrHnZGnUKZG7kI5MfIZtkuD809DqYF8eJyVWAtwXNV5Pv8597l39969j90r6a72qd21kJC82tWuK2PZsmzLDxzHNphHQJaBhBrMpJBAXPOwbBqwcWBI64QJCQOluKHlUQI4zGQyTXBdhraOk+ERwjMmuEzDgCEQE2h0r/ufu5JYiN1ppbvn/uf/z3/uefyP7xwiEfxjP6NHiUE8kiJzyDyylBDI6ZAwnWQ1N1BvmH0AfVAehkYaXB3KBXxhBVk6F/RAXjJACtv2gyNhvVSrz4eBJNsx9Xa2pyfLnGwPQE+wYWKS0smJTdsZ277pLjhvdPQ8SnkJGcFU/12NC71MUmGpIgsXRJVrVU1Tr1Wi9FboyQYO7wiwO/9V7GJikjFeHkHdmX5gVIlElPMVTVMWUcYExnBqAiEn/pZtZRtJlLSTM8gCnFvLXGQTf7PTMXHgjbrVnJnsJN2kDqUynW4tEVkqVCg556uUfvWcZjm0mtLVQ80yllDXHYuyh3fufJj9xWUqcz31tyA8f/fdzwuJ4PmMpkM7+8q03jlfYbAh1AQI9f2qnYqsh9Grb3xIEB66ccG/7dRSFtOg89v3PCcIz92zL7jJi+B8AOczKRB2A+4W7hJuTV6STdwtHG3OTAPfrtww1ErsP4ItkD49DcEWN512YW9Ygb3JdBr2h6/kSRoQkffPTrBJspiMkVXkLLKRkOJAfVDERbDrfbSQKxfykpOcDzaaCH4Vy+YC1krl3GwFl5DX+6CQL+H6FcUyyzXkXNnmtjGA61p0JDnfB/UqDmpIlGnMyUpXCLLj6X67/TeGaRoTk52FXFtbDkYqlREwIvCNiNGkob9gGv6zQlR1MiB6tOZ/LI3RvaUO/6yO851MR8WDND3Xa3PSgEXmTSrK0G7DTw3Pjk+YadN/yajnO2uGUU3z3kYqTpdhdDlNunxGBL8jUK45JEmQvWdiYuqIN9fDp8p7nOuJHYRO78Mk0UgRdwKNI0ncOmmUCK6LLJXKuAKlhVDPQHKgUawny24aKHkpOMK7fOklyEpScCRXfnzUS0vlNUlF7VS1KxSqgaLHxQQDNonyl1raB3fVnhlzZLn7kqyqphX1bFn7QI0KSRYLXRjH8xj7Bfscjscl3YSIJVLG4eCgJMJajNwulMqlsjmM7pkwcfEdibKDwZQognDwIAiiGEwdfOCoIBx94ME3BOGNFcd1RQKIt5m/isbjZ7a2Qi32hZl2Dz5wNGiAqmiQjcXNaOCjShzHFQ0HN0WnML5kSQWtajk5G21qC7mGbCO3kNvQugqD1cFyYTCX4L+qi5ZRyKHVVIYBQ0oyUUl8luH+CQO7MKt2q2MPcpcYqKMRiqdgVxOFBnZUyZcWQK3eqKQhUUxUy+yP57fvfiToHqHn3fqgf7tjBD81bADbgEWG8+naiGsGt1hJgKQF15juh2/cO3JVbQnAklp1KcDSakc+X8vnO4IFzWpTNMN88/vfX2zrus1/9PydQ2ePHL77iTW3P/H0KyHPsmN7ORGz7di3dcsKW744Arf6v57tCrv9IfDeankkTsZNjVS4XrduAVj6r5cvJ80YgvaxiT5KbKwUxQEMdJIMUr6MobGBawo/gMdgfyIj6RALKnqXHlRioEueRx+hAhO1rlggxmLwx1ghKmLA4DHjF+wtNje0vR6yEOMGKea4pzdy3MLKIc23ypEY5gqzbBbRCnFTUOxyeTPcihlgroneMlgvsVCTb/NgnT0T/Jeq6yq08bKFfsr+y90/Cn4vCh1Q76bnzmmAsda/32oHdHjJZGzcBDUqJsufKMKPdAuzFhbfwB+nV1hXTgZLL4Tx/xbB+3wDoDHHyW2CdgvT0Ud6Z/B0P/yVfjxqOh3+xRDDnVHd6Th8Hw3YJuLgAqCLQ71WhhJGRheSDn7dAUcvGbAnlQqu0kudOmzR9eAO/XO6Dns6V3fCbXqqbAR7sU1wh1EK48mz7F/Y2Zil5hJi49rUkxgywp2RQedJi0eUelGScbF04LI0361GvdxHf3D6ttGF2wYWLGNCTw+oQ8HxP7v55qvL7Vkx0gt20hm9rDOuM3H1osXfXTZ6XlSz7It201er80Whq9y368zF1w8EfxiCaHcmuaJRWHPaqm/uoKJ53nBhVWnl9nK3nM9es2J0ZOzyGkG8cOLr7BmMexlSI8NkJdlALsLlmM4JZs6scu/imIDjBxdz0aBZK4lhTuqZBg2yGzZv8CDkOnIBN5sr4WZLXOXkNLt3qxbTI1unfrwtouuRbY7nOWwJlv5tsJVzVgAsrlQWA6zA2g4oD5UBdsE/wCtcGHTx8hQ0Y7FEbOp1lsGX50y97ngA2HnG8SoQc3R1ADtdPKDqTmxeulxO8/D3BlZQdAg18DmEJDLQLvj63MceYxeEvlAgSzCDbuaZusUDMCuezDPsHIcg005hOhJavsnnLpt8HZI8X/KsshCGIQ0GmkQZW5Rr9YUwkAapgDaRQF+iTwRbucvDLl620FuCX4b0abptfdH/eYjIsvRpfNueDRF/XgQgQis81IiaEGHqAdVzhMgBUWcxm3ZnbsAYYhk3CKJg0YtRBZ/gEFgpHlk6re80Of4r0Jtl6Wwv4Nt/iH+Qrte0qaMR/EoCBKZ2aB9GBKc98gdRsmx9f6aHUtSjILL9hhPiNcwXAX2HdKEfnIH5Am1rsGkDMuKb+dBMZLnmC42tMVjrhxJIpdAXkrgMYgtdHqwOYFS5aFfC8K+MOwBOvIuuG16wHqAL1i8YXke7kMt2S/72ck0SMsk5NUnM0Ap/pd0yr1xxRUSYoNYPjUTCCKiRQB3soVkmjEtF8bAarJaqc5IZ4U/K5/5auSXMzQ+xZ9n60CZqGC9aMhJrQQ6slDfQx9HaMwghME8tRP9HD+jHydQo2feyILy8r1k+FXyMKVt+6imQ0Ro/zmjZ6Nat0Yyrbd2quRlOZ5Oc/kRj38tsHbZ8qkUzeEv7pH1TN8n70bLhmA+yD9hVJEYSpBFm6abvJgpmUWSFwdB5cX05Au2EYkniUSqN5om71Dw2uMlhKLFV++j4smXjdB+sglUf/T30L+sH2LMZ3EJbcFxr14IhQ3aymFR7c/SeXC/aWM6W3TvHLqQwPvYdWnrxRf/FO7v6+7vg9qVfN9vazDX/hOE1+GUkm5bUaMDSc+akwY+qUjo7jffvZU+j/8WIiTjoDEJcs8pBKUagxmDDZIncYLGAU+E5p8BPANMyfsqR0b90QMhWreDa1/tA2nMdgk04s9AP1/08eJx6u7SiGzzuFrVdyEIRfSt8Bx/86+ejOQ+0L0dtK3pUg45chP62u9mmG/wks9ev77Y5VLChr+AnuaSvi2sH971wfoy6Of06Xf8olmuDcO3vYUfYxKy9nALLMSnfj4aCIWQhmg3i6gwaCkYKA83GoeRQ8DvcaePQITDQRn536NF3RPGdR8NSibiR7dsjrqVMTipWCz3RqoAdsO1c5ZgoHkNF/wnls+2n6XDM32X/yb4Y+u2FzVNWQeYLPdgIM1chz3GxLKUp5q0MDNNSq+nbmNaoXMj3UUSnpUa9MUzxBMmTXEIO06BbbVTDlEePRNZkYIAuvLy9gdYoqXE5mtBSItNzlfTI16rq3H5ZevNw8C7O3Tx8GEycyrsITVWvNwup0bElnYu7ehTBiM3JC5IXj3hqA7Ss3VuBuRDZ3G7GICJaYiVx2RLagNSYqjE14na5C5Yu6RxeKoAwrzNJN2KXh1s+4d8YM610OzilanrZ4jULs67ToTjGOQU6D9r6nD6rnzqakp/BXuwxOIB7S+wwrBfCHHAbfSNVLKb8zlRXFzxZnFfEB5vSsP0X6CuI1cqojim/jlgDD1t5WSyigSLeEItN3DEtw2gpwauaFxMEmGuCl9ODd4P39JwXo+MzFJyueVER5XEvD3sUQQKGJyzbTGjHj2uQyEaCF35/XOPvY4ogUhRqKIQm1vtndoCNYlQokXnoX4s41mtmtGRNbsltxTK3y1l7lPJoEjyMGzDrcixn5oqNoku/FtwdicUisGnt2hlq5djy4OFLFeVS1bXU9esV04VX1ZTpH4in1Cugy2OC1wWLpqaYMDU1TldeMI64KwHwd4Cn0gTQtdeu23WJmlQvUcyksnatmjTpMt0w9Pv861EP9emN/vV0dNEk7OBLrIRx4zU2Pp23+8l8PP+eTS7+9H1Bq/f9f/nFPMI3BLeYrGVRgnwZt28YXDGNbkFfHttI6caxsXFKx8eqHMdXB3jp/7jJaopD1kAopvNPpfFyDLdMhYxqRSQleF2CiyQx2KtKqqXCFlXGs7Yxqze2ETpnekR1/4FTSh6cHcTYOJdUZ8byflS1xbtE0cKSBY/Q/YJtSeLjoqXGZtf1TraRqIhsi3gCXEBWkNU8Qtiz+JCFyKeJgxImwvNPQFFBDPMMMhH82PzqINGERnYrPyfnXPQiDo24GgZw6V1Hh9d0Jx/ke4YQitMv6Q4M+V82bNugx3jpvwZ2Jz/KYbHbTtv47PqEc1pwxITFvcGXzISQZ3YUNkRtlhcS9Jv+1uYBkO7yTRjqpf+oO47ub+gdosecTtvudH7Gew/e5WwwT07TS5cu6Yjvjup6dHe8IzyOnThx4lsCZTtJnvSRIbKMrAvPZtM40ACpD72e2wu6uQ79tCmAJjAMvc5uod1T8Nmi4MngJwjaurOaZ1ENXnBsG36lMsvT2uciPyAwySFgEJb/B5quev03/uUxy4rRzV6bLLWnFFgZh3iwX/E6JDle8O8IhVnL40jRs06QGWpyhoBZ1mdyX/enb1ZYi2fZHCiFuTo8e2E4/F8TnhG8c5XaZoN6k9quQrdqtUXYxHSOm9GZ2jHTGku6Mnj7yojVrt6sKNAdabPUlrEVyCC/JRVnETu/0SrkWtFE01RxnPx6oTBj0Nx4RbTYUq0RRkaOmZjj3z/CLzBH0E7jYEeCt7vrEB5o8R1PxWHDZj0+pcfjOnRg6f9G1EVVpXEVB+V/KOoTqErPxS5423q3f39THXq5SvAcCv48rk+hEGtv6vEPqaC2cXWrTfXfE2g4ryfZT9hCzDBnkRtImIzD61+XH0FDMIcJGR21XOtD0+ujBTy3SHzWYYMMhAk6zVUwwct8KfgcMe3j2a+pK1YTyaaMXw+HssZgNeG4zS7mQ/gN/B/8niIw/BMU0TTpNtMUeR2owLTrBVkR44Fsmnn42LCUuCHp2pWaJqqMUlk2Unquw7+pI6enDFlu1mlqOWZ+OxMvZd7KlOIZW1VhOQMmxhS37a02V4mJWKPvhV/zb5r+2vTX4eO4qMiCdj0TKLAzKWWqqOEHdcmIK5YRyJ/6VAfdNl1f8b5XQI4s4XRTRsF7/31HEUVVxJ4xMIui4szggNfpDfz+wA5vDWbsOLyIKeUHTn5TQLdw4upUCvmlTh35OmzW/wfHsV/JAAAAeJxjYGRgYADiXeu31cXz23xl4GZhAIEbst21MPr///8NrInMTUAuBwMTSBQAX68MugAAAHicY2BkYGBu+N/AEMO2+v////9YExmAIihADgC44weReJxjYWBgYMGD2VbjlycO///PwoQqBgB7UAMmAAAAAAAAcADYAQgBnAHkAjAC+gMiA5wDxAQYBKgFSAWyBgwGaAbKByQHuAfQCBgIhAkwCcQKSAqWCwILvAvkAAB4nGNgZGBgkGPoZ+BhAAEmIOYCQgaG/2A+AwAafwHQAHicZY9NTsMwEIVf+gekEqqoYIfkBWIBKP0Rq25YVGr3XXTfpk6bKokjx63UA3AejsAJOALcgDvwSCebNpbH37x5Y08A3OAHHo7fLfeRPVwyO3INF7gXrlN/EG6QX4SbaONVuEX9TdjHM6bCbXRheYPXuGL2hHdhDx18CNdwjU/hOvUv4Qb5W7iJO/wKt9Dx6sI+5l5XuI1HL/bHVi+cXqnlQcWhySKTOb+CmV7vkoWt0uqca1vEJlODoF9JU51pW91T7NdD5yIVWZOqCas6SYzKrdnq0AUb5/JRrxeJHoQm5Vhj/rbGAo5xBYUlDowxQhhkiMro6DtVZvSvsUPCXntWPc3ndFsU1P9zhQEC9M9cU7qy0nk6T4E9XxtSdXQrbsuelDSRXs1JErJCXta2VELqATZlV44RelzRiT8oZ0j/AAlabsgAAAB4nG3OWXLDIBAEUNoBZCv7vjuXyQlygyk0FrgwqBhkJ7cPKf+mP/ujX6uFOqZX/2eNBU6gYWDRYYkVepziDOe4wCWucI0b3OIO93jAI57wjBe84g3vWONDWUc7LtTRMBQW0VOcRTsqtZPZudZ04sM2UOoHjmHPJaSxE0qtynYTYuVivsLoqxWm4nw/pyHIRNV5faBQV7VQkimX2qTkOGqfd2wljCkk42IWblyMZhdSk/PEyRbesqtGPBW2jeXKf7NH/8fUMrMsN5y+261RC+1Zf+ZDUuoXwZ1LmgAA') format('woff'),url('iconfont.ttf?t=1540351647660') format('truetype'), /* chrome, firefox, opera, Safari, Android, iOS 4.2+*/
    url('iconfont.svg?t=1540351647660#iconfont') format('svg');
    /* iOS 4.1- */
}

.iconfont {
    font-family: "iconfont" !important;
    font-size: 32rpx;
    font-style: normal;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.icon-camera:before { content: "\e62c"; }

.icon-address:before { content: "\e605"; }

.icon-plus:before { content: "\e613"; }

.icon-cart:before { content: "\e633"; }

.icon-success:before { content: "\e627"; }

.icon-shijian:before { content: "\e62e"; }

.icon-delivering:before { content: "\e622"; }

.icon-sanjiao:before { content: "\e62a"; }

.icon-filter:before { content: "\e60d"; }

.icon-Right:before { content: "\e612"; }

.icon-search:before { content: "\e61b"; }

.icon-undispatch:before { content: "\e6b0"; }

.icon-wait:before { content: "\e695"; }

.icon-transport:before { content: "\e883"; }

.icon-cancel:before { content: "\e6f2"; }

.icon-home:before { content: "\e702"; }

.icon-signin:before { content: "\e732"; }

.icon-close:before { content: "\e61d"; }

.icon-call:before { content: "\e601"; }

.icon-minus:before { content: "\e606"; }

.icon-open:before { content: "\e603"; }

.icon-reject:before { content: "\e62d"; }

.icon-share:before { content: "\e615"; }

.icon-delete:before { content: "\e69c"; }

.icon-undelivery:before { content: "\e671"; }

.icon-trues:before { content: "\e666"; }

.icon-fenxiang:before { content: "\e64f"; }

.icon-save:before { content: "\e614"; }

.icon-Down:before { content: "\e62b"; }

,const app = getApp()
Page({
  data: {
    settings: null,
    owner: null,
    proMsg: {},
    proPrice: [],
    proPriceVO: [],
    cartDetail: null,
    priceTotal: '0.00',
    p_index: 0,
    specList: null,
    colorList: null,
    prodDimList: null,
    proDimVO: null,
    unitList: null,
    unitName: '无',
    unitNames: '',
    s_unitList: [],
    u_index: 0,
    u_id: 0,
    baseUnit: '',
    inputVal: {
      weight: 1,
      allBox: 0,
      buy: 1
    },
    pamars: {
      color: '',
      spec: '',
      unitName: '',
    },
    qty: 0,
    imgUrl: '',
    cartNum: 0,
    amountFormula: '', //金额公式
    isEdit: false,
    commonFlag: false
  },
  onLoad: function(options) {

    let proId = options.id
    let detailVO = options.detailVO
    let owner = wx.getStorageSync('owner')

    let isEdit = this.data.isEdit
    let _detail = null
    if (detailVO) {
      _detail = JSON.parse(detailVO)
      proId = _detail.prodId
      isEdit = true
    }
    this.setData({
      owner: owner ? owner : null,
      cartDetail: _detail,
      isEdit: isEdit
    }, () => {
      this.getOrderDetail(proId)
    })
    if (proId) {
      this.productId = proId
    }
  },
  onReady: function() {
    //this.getOrderDetail(this.productId)

  },
  onShow: function() {

  },
  getOrderDetail: function(id) {
    let that = this
    let s_unitList = []
    let unitName = ''
    app.HttpService.prodDetail(id).then((res) => {
      console.log(res)
      let specList = res.specList
      let owner = that.data.owner
      let colorList = res.colorList
      let prodDimList = res.prodDimList
      let proDimVO = null
      let unitList = res.unitList
      let settings = app.P()
      let pamars = this.data.pamars
      let proPrice = [],
        qty = 0,
        u_index = 0,
        baseUnit = '',
        u_id = 0

      var prodDim = app.AcFunc.getProdDim(res)
      for (let i = 0; i < prodDim.length; i++) {
        if (prodDim[i].commonFlag) {
          proDimVO = prodDim[i]
          break
        } else {
          proDimVO = prodDim[0]
        }
      }
      if (settings.specFlag && settings.viewProductSpec && specList.length > 0) {
        pamars.spec = specList[0].name
      }
      if (settings.colorFlag && settings.viewProductColor && colorList.length > 0) {
        pamars.color = colorList[0].name
      }
      if (unitList.length > 0) {
        that.setUnitList(unitList)
        for (let i in unitList) {
          if (unitList[i].id == proDimVO.unitId) {
            u_index = i
            baseUnit = unitList[i].name
            u_id = unitList[i].id
          }
          if (unitList[i].mainUnitFlag) {
            s_unitList.push(unitList[i].name)
          } else {
            s_unitList.push(unitList[i].name + '(' + unitList[i].rate + proDimVO.zhudanwei + ')')
          }
        }
      } else {
        if (proDimVO.unitName) {
          u_index = 0
          s_unitList.push(proDimVO.unitName)
          baseUnit = proDimVO.unitName
          u_id = proDimVO.unitId
        }
      }
      let prodSalePriceVOList = proDimVO.prodSalePriceVOList
      prodSalePriceVOList = that.filterPrice(proDimVO.prodSalePriceVOList)
      for (let i = 0; i < prodSalePriceVOList.length; i++) {
        if (prodSalePriceVOList[i].isShow) {
          proPrice.push(prodSalePriceVOList[i].showName + ':' + prodSalePriceVOList[i].price)
        }

      }
      that.setData({
        proMsg: res,
        inventoryFormula: res.inventoryFormula,
        amountFormula: res.amountFormula,
        specList: specList,
        colorList: colorList,
        unitList: unitList,
        s_unitList: s_unitList,
        u_index: u_index,
        u_id: u_id,
        baseUnit: baseUnit,
        prodDimList: prodDim,
        proPrice: proPrice,
        proPriceVO: prodSalePriceVOList,
        p_index: 0,
        proDimVO: proDimVO,
        settings: settings,
      }, () => {
        that.setOrderDetail()
      })
    }).catch((error) => {
      console.log(error)
    })


  },
  setOrderDetail: function(prodDim) {
    let that = this
    let cartNum = this.data.cartNum
    let cartDetail = this.data.cartDetail
    let inputVal = this.data.inputVal
    let unitList = this.data.unitList
    let pamars = this.data.pamars
    let u_index = this.data.u_index
    if (cartDetail) {
      console.log(cartDetail)
      pamars = {
        spec: cartDetail.specName,
        color: cartDetail.colorName,
        unitName: cartDetail.unitName,
      }
      if (unitList.length > 0) {
        for (let i = 0; i < unitList.length; i++) {
          if (unitList[i].id == cartDetail.unitId) {
            u_index = i
            console.log(u_index)
          }
        }
      }
      inputVal.buy = cartDetail.qty
      cartNum = 1
    } else {
      pamars.unitName = this.data.baseUnit

    }

    this.setData({
      inputVal: inputVal,
      cartNum: cartNum,
      pamars: pamars,
      u_index: u_index
    }, () => {
      that.getGoodsPrice()
    })

  },

  chooseSpec: function(e) {
    let that = this
    let specList = this.data.specList
    let ind = e.currentTarget.dataset.index
    let pamars = this.data.pamars
    let specid = 0,
      spec = ''
    for (let i in specList) {
      if (i == ind) {
        specList[i].bizFlag = specList[i].bizFlag ? false : true
        if (specList[i].bizFlag) {
          specid = specList[i].id
          spec = specList[i].name
        }
      } else {
        specList[i].bizFlag = false
      }
    }
    pamars.spec = spec
    this.setData({
      specList: specList,
      pamars: pamars,
      p_index: 0
    }, () => {
      that.getGoodsPrice()
      // setTimeout(() => {
      //   //that.setBaseUnit()
      // }, 0)
    })
  },
  chooseColor: function(e) {
    let colorList = this.data.colorList
    let ind = e.currentTarget.dataset.index
    let pamars = this.data.pamars
    let colorid = 0,
      color = ''
    let that = this
    for (let i in colorList) {
      if (i == ind) {
        colorList[i].bizFlag = colorList[i].bizFlag ? false : true
        if (colorList[i].bizFlag) {
          colorid = colorList[i].id
          color = colorList[i].name
        }
      } else {
        colorList[i].bizFlag = false
      }
    }
    pamars.color = color
    this.setData({
      colorList: colorList,
      pamars: pamars,
      p_index: 0
    }, () => {
      that.getGoodsPrice()
      //  setTimeout(()=>{
      //    //that.setBaseUnit()
      //  },0)
    })
  },
  priceChange: function(e) {
    let val = e.detail.value
    let that = this
    this.setData({
      p_index: val
    }, () => {
      that.countTotalPrice()
    })
  },
  unitChange: function(e) {
    let val = e.detail.value
    let that = this
    let u_id = this.data.u_id
    let u_index = this.u_index
    let proDimVO = this.data.proDimVO
    let baseUnit = this.data.baseUnit
    let unitList = this.data.unitList
    let pamars = this.data.pamars
    pamars.unitName = unitList[val].name
    proDimVO.unitNameline = '/' + unitList[val].name
    this.setData({
      pamars: pamars,
      baseUnit: unitList[val].name,
      proDimVO: proDimVO,
      u_id: unitList[val].id,
      u_index: val
    }, () => {
      that.getGoodsPrice('unit')
      that.setUnitList(unitList)
    })
  },
  setBaseUnit: function(e) {
    let that = this
    let pamars = this.data.pamars
    let proDimVO = this.data.proDimVO
    let _pamars = {}
    let unitList = this.data.unitList
    let prodDimList = this.data.prodDimList
    _pamars.color = pamars.color
    _pamars.spec = pamars.spec
    _pamars.commonFlag = true
    let _proDimVO = app.AcFunc.getMapArrByObj(prodDimList, _pamars)[0]
    let u_index = this.data.u_index
    if (unitList.length > 0) {
      for (let i = 0; i < unitList.length; i++) {
        if (unitList[i].id == _proDimVO.unitId) {
          u_index = i
          proDimVO.unitNameline = _proDimVO.unitNameline
        }
      }
    }
    this.setData({
      u_index: u_index,
      proDimVO: proDimVO
    }, () => {
      that.countTotalPrice()
    })
  },
  touchminus: function(e) {
    let that = this
    let name = e.currentTarget.dataset.name
    let inputVal = this.data.inputVal
    let n = inputVal[name]
    if (n > 1) {
      n--;
      inputVal[name] = app.AcFunc.filterNumber(n)
    }
    this.setData({
      inputVal: inputVal
    }, function() {
      that.countBox(name)
    })
  },
  touchplus: function(e) {
    let that = this
    let name = e.currentTarget.dataset.name
    let inputVal = this.data.inputVal
    let n = inputVal[name]
    n++;
    inputVal[name] = app.AcFunc.filterNumber(n)
    this.setData({
      inputVal: inputVal
    }, function() {
      that.countBox(name)
    })
  },
  goodsadd: function() {
    let that = this
    let params = this.setMyCart()
    let cartNum = this.data.cartNum
    if (params) {
      app.HttpService.cartCreate(params).then((res) => {
        if (res) {
          cartNum++
          that.setData({
            cartNum: cartNum
          })
          app.setCartCount()
        }
      }).catch((error) => {
        console.log(error)
      })
    }

  },
  addCart: function() {
    let params = this.setMyCart()
    let prodVO = this.data.prodVO
    console.log(params)
    if (params) {
      app.HttpService.cartCreate(params).then((res) => {
        if (res) {
          wx.setStorageSync('prodId', prodVO.id);
          app.setCartCount()
          wx.navigateBack({})
          app.setCartCount()
        }
      }).catch((error) => {
        console.log(error)
      })
    }

  },
  setMyCart: function() {
    let settings = this.data.settings
    let proDimVO = this.data.proDimVO
    let specList = this.data.specList
    let colorList = this.data.colorList
    let specid = proDimVO.specId ? proDimVO.specId : 0
    let colorid = proDimVO.colorId ? proDimVO.colorId : 0
    let qty = this.data.inputVal.buy
    let proPriceVO = this.data.proPriceVO
    let price = proPriceVO.length > 0 ? this.data.proPriceVO[this.data.p_index].price : ''
    let priceCfgId = proPriceVO.length > 0 ? this.data.proPriceVO[this.data.p_index].priceCfgId : null
    if (settings.specFlag && settings.viewProductSpec) { //严格进销存strictModeFlag
      if (specList.length > 0 && !specid) {
        app.AcFunc.myTotal('请选择规格', 'none')
        return false
      }
    }
    if (settings.colorFlag && settings.viewProductColor) {
      if (colorList.length > 0 && !colorid) {
        app.AcFunc.myTotal('请选择颜色', 'none')
        return false
      }
    }
    if (qty <= 0) {
      app.AcFunc.myTotal('请输入正确的购买数量', 'none')
      return false
    }
    let params = [{
      "prodId": proDimVO.prodId,
      "name": proDimVO.name,
      "photo": proDimVO.photo,
      "remark": proDimVO.remark,
      "specId": specid,
      "specName": proDimVO.spec ? proDimVO.spec : '',
      "colorId": colorid,
      "colorName": proDimVO.color ? proDimVO.color : '',
      "unitId": proDimVO.unitId ? proDimVO.unitId : 0,
      "unitName": proDimVO.unitName ? proDimVO.unitName : '',
      "multiPriceId": priceCfgId,
      "unitPrice": price,
      "amountFormula": proDimVO.amountFormula,
      "qty": qty
    }]
    if (!settings.unitFlag){
      params.unitId=0
      params.unitName=''
    }
    return params
  },
  goodsUpdate: function() {
    let cartDetail = this.data.cartDetail
    let params = this.setMyCart()
    params[0].id = cartDetail.id
    app.HttpService.editcart(params[0]).then((res) => {
      if (res) {
        wx.navigateBack({})
      }
    }).catch((error) => {
      app.AcFunc.myTotal(error, 'none')
    })
  },
  getGoodsPrice: function(flag = null) {
    let that = this
    let proDimVO = this.data.proDimVO
    let unitList = this.data.unitList
    let specList = this.data.specList
    let colorList = this.data.colorList
    let cartDetail = this.data.cartDetail
    let settings = this.data.settings
    let u_index = this.data.u_index
    let pamars = this.data.pamars
    let prodDimList = this.data.prodDimList
    let proPrice = [],
      _proDimVO = {}
    if (settings.boxFlag) {
      delete pamars.unitName
    }
    if (prodDimList.length > 1) {
      _proDimVO = app.AcFunc.getMapArrByObj(prodDimList, pamars)[0]
    } else {
      _proDimVO = prodDimList[0]
    }
    if (_proDimVO) {
      proDimVO = _proDimVO
    }
    if (cartDetail && flag!='unit') {
      proDimVO.rate = cartDetail.unitRate
      proDimVO.qty = cartDetail.qty
      proDimVO.unitPrice = cartDetail.unitPrice
      proDimVO.unitId = cartDetail.unitId
      proDimVO.unitName = cartDetail.unitName
      proDimVO.unitNameline = cartDetail.unitNameline
    }

    if (!proDimVO.available) {
      app.AcFunc.myTotal('该组合被禁用，请选择其他组合！', 'none', 3000)
      return
    }
    for (let i = 0; i < specList.length; i++) {
      if (specList[i].id == proDimVO.specId) {
        specList[i].bizFlag = true
      }
    }
    for (let i = 0; i < colorList.length; i++) {
      if (colorList[i].id == proDimVO.colorId) {
        colorList[i].bizFlag = true
      }
    }
    let photo = proDimVO.photo ? app.getxsimg('thumbnail', proDimVO.photo) : '/images/buy/defaultpro.png'
    let prodSalePriceVOList = proDimVO.prodSalePriceVOList //多价位
    prodSalePriceVOList = that.filterPrice(prodSalePriceVOList)
    for (let i = 0; i < prodSalePriceVOList.length; i++) {
      if (prodSalePriceVOList[i].isShow) {
        proPrice.push(prodSalePriceVOList[i].showName + ':' + prodSalePriceVOList[i].price)
      }
    }
    console.log(proDimVO)
    that.setData({
      proPriceVO: prodSalePriceVOList,
      proPrice: proPrice,
      specList: specList,
      colorList: colorList,
      imgUrl: photo,
      proDimVO: proDimVO,
    }, () => {
      that.countTotalPrice()
      if (app.P().boxFlag) {
        that.allCounts()
      }
    })
    //let primdata = app.AcFunc.getMapArrByObj(that.data.prodDimList, pamars)
    // if (primdata.length > 0) {
    //   if (!primdata[0].available) {
    //     app.AcFunc.myTotal('该组合被禁用，请换个组合！', 'none', 3000)
    //     return
    //   }
    //   let photo = primdata[0].photo ? app.getxsimg('thumbnail', primdata[0].photo) : '/images/buy/defaultpro.png'
    //   let prodSalePriceVOList = primdata[0].prodSalePriceVOList //多价位
    //   prodSalePriceVOList = that.filterPrice(prodSalePriceVOList)
    //   for (let i = 0; i < prodSalePriceVOList.length;i++) {
    //     if (prodSalePriceVOList[i].isShow){
    //       proPrice.push(prodSalePriceVOList[i].showName + ':' + prodSalePriceVOList[i].price)
    //     }
    //   }
    //   if (unitList.length > 0) {
    //     for (let i = 0; i < unitList.length; i++) {
    //       if (unitList[i].id == primdata[0].unitId) {
    //         u_index = i
    //       }
    //     }
    //   }
    //   that.setData({
    //     proDimVO: primdata[0],
    //     proPriceVO: prodSalePriceVOList,
    //     proPrice: proPrice,
    //     u_index: u_index,
    //     imgUrl: photo
    //   }, () => {
    //     that.countTotalPrice()
    //   })
    // } else {
    //   let photo = proDimVO.photo ? app.getxsimg('thumbnail', proDimVO.photo) : '/images/buy/defaultpro.png'
    //   let prodSalePriceVOList = proDimVO.prodSalePriceVOList //多价位
    //   prodSalePriceVOList = that.filterPrice(prodSalePriceVOList)
    //   for (let i = 0; i < prodSalePriceVOList.length; i++) {
    //     if (prodSalePriceVOList[i].isShow) {
    //       proPrice.push(prodSalePriceVOList[i].showName + ':' + prodSalePriceVOList[i].price)
    //     }
    //   }
    //   if (flag == 'unit') {

    //   } else {
    //     if (unitList.length > 0) {
    //       for (let i = 0; i < unitList.length; i++) {
    //         if (unitList[i].id == proDimVO.unitId) {
    //           u_index = i
    //         }
    //       }
    //     }
    //   }

    //   that.setData({
    //     proDimVO: proDimVO,
    //     proPriceVO: prodSalePriceVOList,
    //     proPrice: proPrice,
    //     u_index: u_index,
    //     imgUrl: photo
    //   }, () => {
    //     that.countTotalPrice()
    //   })
    // }

  },
  countTotalPrice: function(formula, data, formtype) {
    let settings = this.data.settings
    let amountFormula = this.data.amountFormula //金额公式
    let proDimVO = this.data.proDimVO
    proDimVO.unitPrice = this.data.proPriceVO[this.data.p_index].price
    proDimVO.qty = this.data.inputVal.buy
    let price = app.AcFunc.countTotalPrice(amountFormula, proDimVO)
    this.setData({
      priceTotal: app.AcFunc.money(price, 2, false)
    })
  },
  setUnitList: function(unitList) {
    let sum = this.data.inputVal.buy
    let u_index = this.data.u_index
    let unit = unitList[u_index]
    let row = this.data.proDimVO
    row = row == null ? {} : row
    row.rate = row.rate == null ? 1 : row.rate
    let unitNames = app.AcFunc.unitConversion(sum * row.rate, unitList)
    this.setData({
      unitNames: unitNames
    })
  },
  boxChange: function(e) {
    let that = this
    let unitList = this.data.unitList
    let name = e.currentTarget.dataset.name
    let inputVal = this.data.inputVal
    let val = app.AcFunc.money(e.detail.value, 6, true)
    if (name == 'allBox') {
      if (val == '') {
        val = 0
      }
    } else {
      if (val == 0 || val == '') {
        val = 1
      }
    }

    inputVal[name] = app.AcFunc.filterNumber(val)
    this.setData({
      inputVal: inputVal
    }, function() {
      that.countBox(name)
    })
  },
  countBox: function(name) {
    let that = this
    let proDimVO = this.data.proDimVO
    let inputVal = this.data.inputVal
    let unitList = this.data.unitList
    let owner = this.data.owner
    let all = inputVal.allBox
    let buy = inputVal.buy
    let eachCarton = proDimVO.eachCarton
    if (name == 'allBox') {
      let _all = eachCarton * all
      if (_all == 0) {
        inputVal.buy = 1
      } else {
        inputVal.buy = _all
      }
      if (all == 0) {
        proDimVO.eachCarton = 0
      }
    } else {
      let _each = 0
      if (all != 0) {
        _each = app.AcFunc.money(buy / all, 6, true)
      }
      proDimVO.eachCarton = _each
    }
    if (owner.ownerItemVO.showUnitType == "showSelectAndDeputyUnit") {
      this.setUnitList(unitList)
    }
    this.setData({
      inputVal: inputVal,
      proDimVO: proDimVO,
    }, function() {
      that.countTotalPrice()
    })
  },
  filterPrice: function(priceVO) {
    let _price = []
    let settings = app.P()
    let morePriceFlag = settings.morePriceFlag
    let viewProductSalesPriceOne = settings.viewProductSalesPriceOne
    let viewProductSalesPriceTwo = settings.viewProductSalesPriceTwo
    let viewProductSalesPriceThree = settings.viewProductSalesPriceThree
    let viewProductSalesPriceFour = settings.viewProductSalesPriceFour
    for (let i in priceVO) {
      let seq = priceVO[i].seq
      if (seq == 1 && viewProductSalesPriceOne) {
        priceVO[i].isShow = true
      } else if (seq == 2 && viewProductSalesPriceTwo) {
        priceVO[i].isShow = true
        continue
      } else if (seq == 3 && viewProductSalesPriceThree) {
        priceVO[i].isShow = true
        continue
      } else if (seq == 4 && viewProductSalesPriceFour) {
        priceVO[i].isShow = true
        continue
      } else {
        priceVO[i].isShow = false
      }
    }
    return priceVO;
  },
  allCounts: function() {
    let proDimVO = this.data.proDimVO
    let inputVal = this.data.inputVal
    let eachCarton = proDimVO.eachCarton
    let qty = inputVal.buy
    let allBox = 0
    if (qty > 0 && eachCarton > 0) {
      allBox = app.AcFunc.money((qty / eachCarton), 6, true)
    }
    inputVal.allBox = allBox
    this.setData({
      inputVal: inputVal
    })
  }
}),<view class='container'>
  <view class='modBox flex border-box'>
    <view class='proImg self-center'>
      <image wx:if='{{settings.imgFlag&&settings.viewProductPhoto}}' src='{{imgUrl}}' lazy-load='true' mode='aspectFit'></image>
    </view>
    <view class='proMsg flex-1'>
      <view class='p_title overpoint'>{{proMsg.name}}</view>
      <view class='p_price clearfix'>
        <picker class='priceList' wx:if="{{settings.morePriceFlag}}" bindchange="priceChange" value="{{p_index}}" range="{{proPrice}}">
          <view class="picker">
            <text class='red float-left'>￥{{proPriceVO[p_index].price}}<text wx:if='{{settings.unitFlag}}'>{{proDimVO.unitNameline}}</text></text>
            <icon class='iconfont icon-sanjiao float-left'></icon>
          </view>
        </picker>
        <view class='red' wx:elif='{{settings.viewProductSalesPriceOne}}'>￥{{proPriceVO[p_index].price}}<text wx:if='{{settings.unitFlag}}'>{{proDimVO.unitNameline?proDimVO.unitNameline:''}}</text></view>
      </view>
      <view class='text' wx:if='{{settings.disInvCountFlag&&settings.viewProductInventoryQty}}'>
        库存:<text class='{{proDimVO.warnMinQty>=proDimVO.stockQty?"red":""}}'>{{proDimVO.stockQty?proDimVO.stockQty:0}}</text>
      </view>
      <view class='text'>
        <text class='text_s' wx:if='{{settings.skuFlag&&settings.viewProductSku}}'>货号:{{proMsg.sku}}</text>
        <text class='text_s' wx:if='{{settings.viewProductBarcode}}'>条形码:{{proMsg.barcode}}</text>
      </view>
      <view class='text overpoint' wx:if='{{settings.remarkFlag&&settings.viewProductRemark}}'>
        {{proMsg.remark}}
      </view>
    </view>
  </view>
  <view class='modBox' wx:if='{{settings.specFlag&&settings.viewProductSpec&&specList.length>0}}'>
    <view class='proTitle'>规格</view>
    <scroll-view scroll-x='true'>
      <text wx:for="{{specList}}" data-index="{{index}}" wx:for-item="item" wx:key="" class='textbtn {{item.bizFlag?"choose":""}}' bindtap='chooseSpec' id='{{index}}'>{{item.name}}</text>
    </scroll-view>
  </view>
  <view class='modBox' wx:if='{{settings.colorFlag&&settings.viewProductColor&&colorList.length>0}}'>
    <view class='proTitle'>颜色</view>
    <scroll-view scroll-x='true'>
      <text wx:for="{{colorList}}" data-index="{{index}}" wx:for-item="item" wx:key="" class='textbtn {{item.bizFlag?"choose":""}}' bindtap='chooseColor'>{{item.name}}</text>
    </scroll-view>
  </view>
  <!-- <view class='modBox flex row' wx:if='{{settings.weightFlag&&owner.ownerItemVO.weightFlag}}'>
    <view class='flex-1 self-center'>
      <text class='proTitle'>重量（kg）</text>
    </view>
    <view class='operInput clearfix'>
      <view class='iconfont icon-minus float-left' hover-class='touch' hover-stay-time='100' bindtap='touchminus' data-name='weight'></view>
      <input value='{{inputVal.weight}}'></input>
      <view class='iconfont icon-plus float-right' hover-class='touch' hover-stay-time='100' bindtap='touchplus' data-name='weight'></view>
    </view>
  </view> -->
  <view class='modBox flex row unit' wx:if='{{settings.unitFlag&&settings.viewProductUnit}}'>
    <view class='flex-1 self-center'>
      <text class='proTitle'>单位</text>
      <text class='fs12 c999' wx:if='{{owner.ownerItemVO.showUnitType=="showSelectAndDeputyUnit"}}'>副单位:{{unitNames}}</text>
    </view>
    <view wx:if='{{unitList.length>0}}'>
      <picker class='proInput' bindchange="unitChange" value="{{u_index}}" range="{{s_unitList}}">
        <view class="picker">
          {{s_unitList[u_index]}}
        </view>
      </picker>
    </view>
    <view wx:else class='{{!proDimVO.unitName?"c999":""}}'>
      {{proDimVO.unitName?proDimVO.unitName:''}}
    </view>
  </view>
  <view class='modBox' wx:if='{{settings.measFlag&&settings.viewProductMeas}}'>
    <view class='flex'>
      <view class='fs15 flex-1 self-center'>外箱尺寸
        <text class='fs12' wx:if='{{owner.ownerItemVO.measType=="volume"}}'>(m³)</text>
        <text class='fs12' wx:else>(长*宽*高*/m)</text>
      </view>
      <view wx:if='{{owner.ownerItemVO.measType=="volume"}}'>
        <input class='proInput' value='{{proDimVO.volume}}' disabled='disabled'></input>
      </view>
    </view>
    <view wx:if='{{owner.ownerItemVO.measType=="size"}}' class='proSize flex row just-con-b'>
      <input class='proInput' value='{{proDimVO.extent}}' disabled='disabled'></input>
      <input class='proInput' value='{{proDimVO.width}}' disabled='disabled'></input>
      <input class='proInput' value='{{proDimVO.height}}' disabled='disabled'></input>
    </view>
  </view>
  <!-- <view class='modBox flex row'>
    <view class='flex-1 self-center'>
      <text class='proTitle'>缸号</text>
    </view>
    <view>
      <input class='proInput' value='' placeholder='请输入缸号'></input>
    </view>
  </view>
  <view class='modBox fineCode'>
    <navigator url='/pages/order/fineCode/index' class='' hover-class='none'>
      <view class=''>
        <text class='proTitle'>细码数量</text>
        <icon class='iconMore iconfont icon-Right'></icon>
      </view>
      <view class='fs12'>
        匹数：0匹
      </view>
    </navigator>
  </view> -->
  <view class='modBox flex row' wx:if='{{settings.boxFlag}}'>
    <view class='flex-1 self-center' style='overflow:hidden;'>
      <view class='proTitle overpoint'>{{owner.ownerItemVO.tittltNameCn}}</view>
    </view>
    <view class='operInput clearfix'>
      <view class='iconfont icon-minus float-left' hover-class='touch' hover-stay-time='100' bindtap='touchminus' data-name='allBox'></view>
      <input value='{{inputVal.allBox}}' type='digit' data-name='allBox' bindblur='boxChange'></input>
      <view class='iconfont icon-plus float-right' hover-class='touch' hover-stay-time='100' bindtap='touchplus' data-name='allBox'></view>
    </view>
  </view>
  <view class='modBox flex row' wx:if='{{settings.boxFlag}}'>
    <view class='flex-1 self-center' style='overflow:hidden;'>
      <view class='proTitle overpoint'>{{owner.ownerItemVO.detailNameCn}}</view>
    </view>
    <view>
      <input class='proInput c999' value='{{proDimVO.eachCarton}}' disabled='disabled'></input>
    </view>
  </view>
  <view class='modBox flex row'>
    <view class='flex-1 self-center'>
      <view class='proTitle'>购买数量</view>
    </view>
    <view class='operInput clearfix'>
      <view class='iconfont icon-minus float-left' hover-class='touch' hover-stay-time='100' bindtap='touchminus' data-name='buy'></view>
      <input value='{{inputVal.buy}}' type='digit' data-name='buy' bindblur='boxChange' bindchange='boxChange'></input>
      <view class='iconfont icon-plus float-right' hover-class='touch' hover-stay-time='100' bindtap='touchplus' data-name='buy'></view>
    </view>
  </view>
  <view class='proFootBar flex row'>
    <view class='flex-1 self-center'>
      <icon class='iconfont icon-cart'></icon>
      <text class='c999 fs12'>金额:</text>
      <text class='red' wx:if='{{settings.viewProductSalesPriceOne}}'>{{priceTotal}}</text>
      <text class='cartnum' wx:if='{{cartNum>0}}'>{{cartNum}}</text>
    </view>
    <view class='clearfix'>
    <block wx:if='{{isEdit}}'>
    <button hover-class='none' class='goodSave' bindtap='goodsUpdate'>保存</button>
    </block>
     <block wx:else>
      <button hover-class='none' class='goonadd' bindtap='goodsadd'>继续添加</button>
      <button hover-class='none' class='addcart' bindtap='addCart'>加入购物车</button>
     </block>
    </view>
  </view>
</view>,const app = getApp()
Page({
  data: {
    pamars: {
      color: '',
      spec: '',
      unitName: '',
    },
    imgUrl: '',
    unit_index: 0,
    proPrice: [],
    price_index: 0,
    picker: {
      priceCfgId: 0,
      unitId: 0
    },
    cartNum: 0,
    input: {
      qty: 1,
      cartons: 0,
    },

    amountFormula: '', //金额公式
    isEdit: false,
    commonFlag: false
  },
  onLoad: function(options = {}) {
    console.log(options)
    let proId = options.id

    if (options.detailVO) {
      this.data.order = JSON.parse(options.detailVO);
      this.data.isEdit = true;
      if (this.data.order.ownerCfg) {
        proId = this.data.order.details[0].prodId
        this.data.fromType = 'order'
      } else {
        proId = this.data.order.prodId;
        this.data.fromType = 'cart'
      }

    }
    this.data.unit_index = 0;
    this.data.price_index = 0;
    this.data.spec_index = null;
    this.data.color_index = null;

    this.setData({
      isEdit: this.data.isEdit
    }, () => {
      this.getProd(proId)
      // this.getOrderDetail(proId)
    })
  },
  onReady: function() {
    //this.getOrderDetail(this.productId)

  },
  onShow: function() {

  },
  setRowData: function(row) {
    let photo = row.photo ? app.getxsimg('thumbnail', row.photo) : '/images/buy/defaultpro.png'
    this.setData({
      imgUrl: photo,
    })
  },
  selectRow(targetName, index) {
    let that = this;
    let unit_index = this.data.unit_index,
      price_index = this.data.price_index,
      spec_index = this.data.spec_index,
      color_index = this.data.color_index;
    let row = Object.assign({}, this.data.rows[0]);
    for (let i in row) {
      row[i] = '-';
    }

    if (that.data[targetName + '_index'] != index || that.data[targetName + '_index'] == null) {
      that.data[targetName + '_index'] = index;
    } else {
      if (targetName == 'spec' || targetName == 'color') {
        that.data[targetName + '_index'] = index = null
        that.data[targetName + '_index'] = index;
      }
    }

    // if (unit_index != null) {
    //   json.unitName = that.data.view_unitList[unit_index].name;
    // }else{
    //   json.unitName = that.data.view_unitList[0].name;
    // }
    // delete json.unitName;
    // if(json.unitName==''){
    //   delete json.unitName;
    // }
    let data = {}
    let json = {
      spec: '',
      color: '',
      // unitName:'',
    };
    if (that.data.spec_index != null) {
      json.spec = that.data.prodVO.specList[that.data.spec_index].name;
    }
    if (that.data.color_index != null) {
      json.color = that.data.prodVO.colorList[that.data.color_index].name;
    }
    let _rows = app.AcFunc.getMapArrByObj(this.data.rows, json);
    let view_unitList = []
    _rows.forEach((v, i) => {
      view_unitList[i] = Object.assign({}, v);
      view_unitList[i].name = v.unitName;
      if (v.unitName != v.zhudanwei) {
        view_unitList[i].name = v.unitName + '(' + v.rate + v.zhudanwei + ')';
        // v.unitName=
      }
    })
    data.view_unitList = view_unitList
    if (targetName == 'spec' || targetName == 'color') {
      if (_rows.length > 0) {
        if (_rows[0].id) {
          row = _rows[0]
          that.data.picker.priceCfgId = row.prodSalePriceVOList[0].priceCfgId;
          that.data.picker.unitId = row.unitId;
          that.data.unit_index = 0;
          that.data.price_index = 0;
        }
      }
    } else if (targetName == 'unit') {
      data.unit_index = index
      row = _rows[index];
    } else if (targetName == 'price') {
      data.price_index = index
      data.picker.priceCfgId = row.prodSalePriceVOList[index].priceCfgId
    }
    data[targetName + '_index'] = index;
    data.row = row;
    ///多价位选择器数据
    let proPrice = []
    row.prodSalePriceVOList.forEach && that.filterPrice(row.prodSalePriceVOList).forEach(function(v, i) {
      proPrice[i] = Object.assign({}, v);
      proPrice[i].name = v.showName + ':' + v.price
    })
    data.proPrice = proPrice
    this.setData(data)
    this.setRowData(row)
    this.countBox('');
  },
  chooseSpec: function(e) {
    let that = this
    let specList = this.data.specList
    let index = e.currentTarget.dataset.index
    // this.data.spec_index = index
    this.selectRow('spec', index);
  },
  chooseColor: function(e) {
    let colorList = this.data.colorList
    let index = e.currentTarget.dataset.index
    // this.data.color_index = index
    this.selectRow('color', index);
  },
  priceChange: function(e) {
    let that = this;
    let index = e.detail.value
    // this.data.price_index = index
    this.setData({
      price_index: index,
      picker: {
        priceCfgId: that.data.proPrice[index].priceCfgId
      }
    })
    this.countTotalPrice();
    // this.selectRow('price', index);
  },
  unitChange: function(e) {
    let index = e.detail.value
    this.data.unit_index = index
    this.selectRow('unit', index);
    this.setUnitList()
  },

  setMyCart() {
    var t = this;
    t.row = t.data.row
    if (t.row.id == '-' || t.row.id == '' || t.row.id == null) {
      let arr = [];
      let arr_
      if (t.data.spec_index != null) {
        arr.push('规格' + t.data.prodVO.specList[t.data.spec_index].name)
      }
      if (t.data.color_index != null) {
        arr.push('颜色' + t.data.prodVO.colorList[t.data.color_index].name)
      }
      let conf_msg = `${arr.join('和')}的组合卖家不销售`;
      if (arr.length == 0) {
        conf_msg = `未选择规格颜色`
      }
      let msg = `抱歉，${conf_msg}，不可以加入购物车哦。`
      app.AcFunc.myTotal(msg)
      return null;
    }
    if (t.data.input.qty == 0) {
      app.AcFunc.myTotal('购买数量不能为0');
      return null;
    }
    t.prodVO = t.data.prodVO
    let params = {
      "prodId": t.prodVO.id,
      "name": t.prodVO.name,
      "photo": t.row.photo,
      "remark": t.row.remark,
      "specId": t.row.specId,
      "specName": t.row.spec,
      "colorId": t.row.colorId,
      "colorName": t.row.color,
      "unitId": t.row.unitId,
      "unitName": t.row.unitName,
      "multiPriceId": t.data.picker.priceCfgId,
      "unitPrice": t.data.proPrice.length==0?0:t.data.proPrice[t.data.price_index].price,
      "amountFormula": t.prodVO.amountFormula,
      "qty": t.data.input.qty,
      //单据过来的直接取单据上的每箱数量
      "eachCarton": t.data.fromType == 'order' ? t.data.eachCarton : app.AcFunc.money(t.data.row.eachCarton, 6, true),
      "cartons": app.AcFunc.money(t.data.input.cartons, 6, true),
    }
    console.log(params)
    return [params]
  },
  getProd(proId) {
    let that = this
    let orderFunc = (res) => {
      console.log('接口返回产品数据为', res)
      console.log('getProdDim返回产品数据为', app.AcFunc.getProdDim(res))
      let specList = res.specList
      let colorList = res.colorList
      let unitList = res.unitList
      // if(specList&&specList.length==0){
      //   res.specList=[{name:''}]
      // }
      // if(colorList&&colorList.length==0){
      //   res.colorList=[{name:''}]
      // }
      // if(unitList&&unitList.length==0){
      //   res.unitList=[{name:''}]
      // }
      let rows = app.AcFunc.getProdDim(res);
      let settings = app.P();
      let owner = wx.getStorageSync('owner')
      let view_unitList = []
      let baseunit = '';
      let row = {};
      let input = {
        qty: 1,
        cartons: 0,
      }
      let picker = {
        priceCfgId: 0,
        unitId: 0
      }
      ///多价位选择器数据
      let proPrice = []
      let unit_index = 0;
      let price_index = 0;
      let spec_index = null;
      let color_index = null;
      if (!this.data.isEdit) {
        let _rows = app.AcFunc.getMapArrByObj(rows, {
          spec: '',
          color: '',
          // unitName:'',
        });
        //如果能查到无规格无颜色的维度，默认就是第一条数据了；否则就显示-
        if (_rows.length == 1) {
          row = rows[0];
        } else {
          row = Object.assign({}, rows[0]);
          for (let i in row) {
            if (i != 'prodSalePriceVOList') {
              row[i] = '-';
            }
          }
        }
        picker.priceCfgId = rows[0].prodSalePriceVOList[0].priceCfgId;
        picker.unitId = rows[0].unitId;
        res.unitList.forEach((v, i) => {
          view_unitList[i] = Object.assign({}, v);
          if (i == 0) {
            baseunit = ''
          } else {
            view_unitList[i].name = v.name + '(' + v.rate + baseunit + ')';;
          }
        })
        row.prodSalePriceVOList.forEach && that.filterPrice(row.prodSalePriceVOList).forEach(function(v, i) {
          proPrice[i] = Object.assign({}, v);
          proPrice[i].name = v.showName + ':' + v.price
        })
        that.setRowData(row);
      } else {
        //单据过来的
        if (this.data.isEdit && this.data.order.ownerCfg) {
          let detail = this.data.order.details[0];
          row = Object.assign({}, detail, detail.prodDimUnitVO, detail.prodDimUnitVO.prodDimAttrVO)
          row.unitId = detail.prodDimUnitVO.unitId
          row.stockQty = row.prodDimUnitVO.qty
          row.photo = row.photoId
          input.qty = row.displayQty
          this.data.eachCarton = row.eachCarton
          input.cartons = row.cartons
          res.specList.forEach((v, i) => {
            if (v.id == row.specId) {
              spec_index = i
            }
          })
          res.colorList.forEach((v, i) => {
            if (v.id == row.colorId) {
              color_index = i
            }
          })
          row.unitGroup.forEach((v, i) => {
            view_unitList[i] = Object.assign({}, v);
            if (i == 0) {
              baseunit = ''
            } else {
              view_unitList[i].name = v.name + '(' + v.rate + baseunit + ')';;
            }
            if (v.id == row.unitId) {
              unit_index = i
            }
          })
          row.salePriceJson.forEach && that.filterPrice(row.salePriceJson).forEach(function(v, i) {
            proPrice[i] = Object.assign({}, v);
            proPrice[i].name = v.showName + ':' + v.price
          })
          proPrice.forEach((v, i) => {
            if (v.price == row.unitPrice) {
              price_index = i;
            }
          })
        } else {
          //购物车过来的
          row = this.data.order;
          input.qty = row.qty
          input.eachCarton = row.eachCarton
          input.cartons = row.cartons
          picker.priceCfgId = row.multiPriceId;
          let json = {
            spec: '',
            color: '',
            // unitName:'',
          };
          res.specList.forEach((v, i) => {
            if (v.id == row.specId) {
              spec_index = i
              json.spec = v.name
            }
          })
          res.colorList.forEach((v, i) => {
            if (v.id == row.colorId) {
              color_index = i
              json.color = v.name
            }
          })
          let _rows = app.AcFunc.getMapArrByObj(rows, json);
          res.unitList.forEach((v, i) => {
            view_unitList[i] = Object.assign({}, v);
            if (i == 0) {
              baseunit = ''
            } else {
              view_unitList[i].name = v.name + '(' + v.rate + baseunit + ')';;
            }
            if (v.id == row.unitId) {
              unit_index = i
              _rows.forEach((vv, ii) => {
                if (vv.unitId == row.unitId) {
                  row = _rows[ii];
                }
              })
            }
            // if(row.)
          })
          // row=_rows[unit_index];
          //多价位取不到，说明没有匹配到单位维度，直接取根据规格颜色查出来的_rows的第一条数据
          if (row.prodSalePriceVOList == null) {
            row = _rows[0];
            // row.prodSalePriceVOList=_rows[0].prodSalePriceVOList
          }
          row.prodSalePriceVOList.forEach && that.filterPrice(row.prodSalePriceVOList).forEach(function(v, i) {
            proPrice[i] = Object.assign({}, v);
            proPrice[i].name = v.showName + ':' + v.price
          })
          proPrice.forEach((v, i) => {
            if (v.priceCfgId == picker.priceCfgId) {
              price_index = i;
            }
          })
        }
        console.log(row)

        picker.unitId = row.unitId;
        that.setRowData(row);
      }

      //编辑云单过来的取旧单子上的多价位id和单位id
      if (this.data.isEdit && this.data.order.ownerCfg) {
        owner = this.data.order.ownerCfg
        settings = app.P(this.data.order);
      }
      that.data.rows = rows;
      that.data.prodVO = res;
      that.setData({
        prodVO: res,
        specList: res.specList,
        colorList: res.colorList,
        unitList: res.unitList,
        owner: owner,
        row: row,
        // view_unitList: app.AcFunc.getArrByMetaFromArr(res.unitList,'name'),
        view_unitList: view_unitList,
        settings: settings, ///商户设置显示相关
        input: input,
        picker: picker,
        unit_index: unit_index,
        price_index: price_index,
        spec_index: spec_index,
        color_index: color_index,
        proPrice: proPrice,
      })

    }
    app.HttpService.prodDetail(proId).then(orderFunc).then(res => {
      that.setUnitList()
      that.countBox()
      that.countTotalPrice();
    })
    // if(!this.data.isEdit){
    //   app.HttpService.prodDetail(proId).then(orderFunc)
    // }else if(this.data.isEdit&&this.data.order){
    //   orderFunc(this.data.order)
    // }


  },



  touchminus: function(e) {
    let that = this
    let name = e.currentTarget.dataset.name
    let input = that.data.input;
    let {
      qty,
      cartons
    } = input;
    if (name == 'allBox') {
      // if (cartons>1){
      cartons = app.AcFunc.money(--cartons, 6, true)
      cartons = cartons < 0 ? 0 : cartons;
      // }
    } else {
      qty = app.AcFunc.money(--qty, 6, true)
      qty = qty < 0 ? 0 : qty;
    }
    that.data.input = {
      qty,
      cartons
    }
    that.countBox(name)
  },
  touchplus: function(e) {
    let that = this
    let name = e.currentTarget.dataset.name
    let input = that.data.input;
    let {
      qty,
      cartons
    } = input;
    if (name == 'allBox') {
      cartons = app.AcFunc.money(++cartons, 6, true)
    } else {
      qty = app.AcFunc.money(++qty, 6, true)
    }
    that.data.input = {
      qty,
      cartons
    }
    that.countBox(name)
  },
  goodsadd: function() {
    let that = this
    let params = this.setMyCart()
    let cartNum = this.data.cartNum
    if (params) {
      app.HttpService.cartCreate(params).then((res) => {
        if (res) {
          cartNum++
          that.setData({
            cartNum: cartNum
          })
          // app.setCartCount()
        }
      }).catch((error) => {
        console.log(error)
      })
    }

  },
  addCart: function() {
    let params = this.setMyCart()
    let prodVO = this.data.prodVO
    console.log(params)
    if (params) {
      app.HttpService.cartCreate(params).then((res) => {
        if (res) {
          wx.setStorageSync('prodId', prodVO.id);
          // app.setCartCount()
          wx.navigateBack({})
          // app.setCartCount()
        }
      }).catch((error) => {
        console.log(error)
      })
    }

  },
  setMyCart2: function() {
    let settings = this.data.settings
    let proDimVO = this.data.proDimVO
    let specList = this.data.specList
    let colorList = this.data.colorList
    let specid = proDimVO.specId ? proDimVO.specId : 0
    let colorid = proDimVO.colorId ? proDimVO.colorId : 0
    let qty = this.data.inputVal.buy
    let proPriceVO = this.data.proPriceVO
    let price = proPriceVO.length > 0 ? this.data.proPriceVO[this.data.p_index].price : ''
    let priceCfgId = proPriceVO.length > 0 ? this.data.proPriceVO[this.data.p_index].priceCfgId : null
    if (settings.specFlag && settings.viewProductSpec) { //严格进销存strictModeFlag
      if (specList.length > 0 && !specid) {
        app.AcFunc.myTotal('请选择规格', 'none')
        return false
      }
    }
    if (settings.colorFlag && settings.viewProductColor) {
      if (colorList.length > 0 && !colorid) {
        app.AcFunc.myTotal('请选择颜色', 'none')
        return false
      }
    }
    if (qty <= 0) {
      app.AcFunc.myTotal('请输入正确的购买数量', 'none')
      return false
    }
    let params = [{
      "prodId": proDimVO.prodId,
      "name": proDimVO.name,
      "photo": proDimVO.photo,
      "remark": proDimVO.remark,
      "specId": specid,
      "specName": proDimVO.spec ? proDimVO.spec : '',
      "colorId": colorid,
      "colorName": proDimVO.color ? proDimVO.color : '',
      "unitId": proDimVO.unitId ? proDimVO.unitId : 0,
      "unitName": proDimVO.unitName ? proDimVO.unitName : '',
      "multiPriceId": priceCfgId,
      "unitPrice": price,
      "amountFormula": proDimVO.amountFormula,
      "qty": qty
    }]
    if (!settings.unitFlag) {
      params.unitId = 0
      params.unitName = ''
    }
    return params
  },
  goodsUpdate: function() {
    let fromType = this.data.fromType
    let params = this.setMyCart()
    // params[0].id = cartDetail.id
    if (params) {
      if (fromType == 'cart') {
        params[0].onlyUpdateQty = false;
        params[0].id = this.data.order.id;
        app.HttpService.editcart(params[0]).then((res) => {
          if (res) {
            wx.navigateBack({})
          }
        }).catch((error) => {
          app.AcFunc.myTotal(error, 'none')
        })
      } else {
        params[0].id = this.data.order.details[0].id;
        var pages = getCurrentPages();
        if (pages.length > 1) {
          var prePage = pages[pages.length - 2];
          prePage.changeDetailVO(params)
        }
        wx.navigateBack({})
      }
    }
  },
  getGoodsPrice: function(flag = null) {
    let that = this
    let proDimVO = this.data.proDimVO
    let unitList = this.data.unitList
    let specList = this.data.specList
    let colorList = this.data.colorList
    let cartDetail = this.data.cartDetail
    let settings = this.data.settings
    let u_index = this.data.u_index
    let pamars = this.data.pamars
    let prodDimList = this.data.prodDimList
    let proPrice = [],
      _proDimVO = {}
    if (settings.boxFlag) {
      delete pamars.unitName
    }
    if (prodDimList.length > 1) {
      _proDimVO = app.AcFunc.getMapArrByObj(prodDimList, pamars)[0]
    } else {
      _proDimVO = prodDimList[0]
    }
    if (_proDimVO) {
      proDimVO = _proDimVO
    }
    if (cartDetail && flag != 'unit') {
      proDimVO.rate = cartDetail.unitRate
      proDimVO.qty = cartDetail.qty
      proDimVO.unitPrice = cartDetail.unitPrice
      proDimVO.unitId = cartDetail.unitId
      proDimVO.unitName = cartDetail.unitName
      proDimVO.unitNameline = cartDetail.unitNameline
    }

    if (!proDimVO.available) {
      app.AcFunc.myTotal('该组合被禁用，请选择其他组合！', 'none', 3000)
      return
    }
    for (let i = 0; i < specList.length; i++) {
      if (specList[i].id == proDimVO.specId) {
        specList[i].bizFlag = true
      }
    }
    for (let i = 0; i < colorList.length; i++) {
      if (colorList[i].id == proDimVO.colorId) {
        colorList[i].bizFlag = true
      }
    }
    let photo = proDimVO.photo ? app.getxsimg('thumbnail', proDimVO.photo) : '/images/buy/defaultpro.png'
    let prodSalePriceVOList = proDimVO.prodSalePriceVOList //多价位
    prodSalePriceVOList = that.filterPrice(prodSalePriceVOList)
    for (let i = 0; i < prodSalePriceVOList.length; i++) {
      if (prodSalePriceVOList[i].isShow) {
        proPrice.push(prodSalePriceVOList[i].showName + ':' + prodSalePriceVOList[i].price)
      }
    }
    console.log(proDimVO)
    that.setData({
      proPriceVO: prodSalePriceVOList,
      proPrice: proPrice,
      specList: specList,
      colorList: colorList,
      imgUrl: photo,
      proDimVO: proDimVO,
    }, () => {
      that.countTotalPrice()
      if (app.P().boxFlag) {
        that.allCounts()
      }
    })
    //let primdata = app.AcFunc.getMapArrByObj(that.data.prodDimList, pamars)
    // if (primdata.length > 0) {
    //   if (!primdata[0].available) {
    //     app.AcFunc.myTotal('该组合被禁用，请换个组合！', 'none', 3000)
    //     return
    //   }
    //   let photo = primdata[0].photo ? app.getxsimg('thumbnail', primdata[0].photo) : '/images/buy/defaultpro.png'
    //   let prodSalePriceVOList = primdata[0].prodSalePriceVOList //多价位
    //   prodSalePriceVOList = that.filterPrice(prodSalePriceVOList)
    //   for (let i = 0; i < prodSalePriceVOList.length;i++) {
    //     if (prodSalePriceVOList[i].isShow){
    //       proPrice.push(prodSalePriceVOList[i].showName + ':' + prodSalePriceVOList[i].price)
    //     }
    //   }
    //   if (unitList.length > 0) {
    //     for (let i = 0; i < unitList.length; i++) {
    //       if (unitList[i].id == primdata[0].unitId) {
    //         u_index = i
    //       }
    //     }
    //   }
    //   that.setData({
    //     proDimVO: primdata[0],
    //     proPriceVO: prodSalePriceVOList,
    //     proPrice: proPrice,
    //     u_index: u_index,
    //     imgUrl: photo
    //   }, () => {
    //     that.countTotalPrice()
    //   })
    // } else {
    //   let photo = proDimVO.photo ? app.getxsimg('thumbnail', proDimVO.photo) : '/images/buy/defaultpro.png'
    //   let prodSalePriceVOList = proDimVO.prodSalePriceVOList //多价位
    //   prodSalePriceVOList = that.filterPrice(prodSalePriceVOList)
    //   for (let i = 0; i < prodSalePriceVOList.length; i++) {
    //     if (prodSalePriceVOList[i].isShow) {
    //       proPrice.push(prodSalePriceVOList[i].showName + ':' + prodSalePriceVOList[i].price)
    //     }
    //   }
    //   if (flag == 'unit') {

    //   } else {
    //     if (unitList.length > 0) {
    //       for (let i = 0; i < unitList.length; i++) {
    //         if (unitList[i].id == proDimVO.unitId) {
    //           u_index = i
    //         }
    //       }
    //     }
    //   }

    //   that.setData({
    //     proDimVO: proDimVO,
    //     proPriceVO: prodSalePriceVOList,
    //     proPrice: proPrice,
    //     u_index: u_index,
    //     imgUrl: photo
    //   }, () => {
    //     that.countTotalPrice()
    //   })
    // }

  },
  countTotalPrice: function() {
    // let settings = this.data.settings
    let amountFormula = this.data.prodVO.amountFormula //金额公式
    let row = Object.assign({}, this.data.row)
    let proPrice = this.data.proPrice
    if (proPrice.length > 0) {
      row.unitPrice = proPrice[this.data.price_index].price
    } else {
      row.unitPrice = 0
    }
    row.qty = this.data.input.qty
    row.cartons = this.data.input.cartons
    let price = app.AcFunc.countTotalPrice(amountFormula, row)
    this.setData({
      priceTotal: app.AcFunc.money(price, 2, false)
    })
  },
  setUnitList: function() {
    let qty = this.data.input.qty
    let row = this.data.row
    row.rate = row.rate == null ? 1 : row.rate
    let unitNames = app.AcFunc.unitConversion(qty * row.rate, this.data.prodVO.unitList)
    this.setData({
      unitNames: unitNames
    })
  },
  boxChange: function(e) {
    let that = this
    let name = e.currentTarget.dataset.name
    let price = parseFloat(e.detail.value)
    if (price <= 0 || price == '') {
      price = 1
    }
    let val = app.AcFunc.money(price, 6, true)
    if (name == 'allBox') {
      this.data.input.cartons = val;
    } else {
      this.data.input.qty = val;
    }
    that.countBox(name)
  },
  countBox: function(name) {
    let that = this
    let input = that.data.input;
    let eachCarton = that.data.row.eachCarton;
    if (that.data.fromType == 'order') {
      eachCarton = that.data.eachCarton
    }
    let {
      qty,
      cartons
    } = input;
    if (name == 'allBox') {
      qty = app.AcFunc.money(cartons * eachCarton, 6, true)
    } else {
      if (eachCarton == 0) {
        cartons = 0
      } else {
        cartons = app.AcFunc.money(qty / eachCarton, 6, true)
      }
    }
    input = {
      qty,
      cartons
    };
    this.setUnitList()
    this.setData({
      input: input
    })
    this.countTotalPrice();
  },
  filterPrice: function(priceVO) {
    let _price = []
    let settings = app.P()
    let morePriceFlag = settings.morePriceFlag
    let viewProductSalesPriceOne = settings.viewProductSalesPriceOne
    let viewProductSalesPriceTwo = settings.viewProductSalesPriceTwo
    let viewProductSalesPriceThree = settings.viewProductSalesPriceThree
    let viewProductSalesPriceFour = settings.viewProductSalesPriceThree
    if (morePriceFlag) {
      for (let i in priceVO) {
        let seq = priceVO[i].seq
        if (seq == 1 && viewProductSalesPriceOne) {
          _price.push(priceVO[i])
          continue
        } else if (seq == 2 && viewProductSalesPriceTwo) {
          _price.push(priceVO[i])
          continue
        } else if (seq == 3 && viewProductSalesPriceThree) {
          _price.push(priceVO[i])
          continue
        } else if (seq == 4 && viewProductSalesPriceFour) {
          _price.push(priceVO[i])
          continue
        }
      }
    } else {
      for (let i in priceVO) {
        let seq = priceVO[i].seq
        if (seq == 1 && viewProductSalesPriceOne) {
          _price.push(priceVO[i])
        }
      }
    }
    return _price;
  },
  allCounts: function() {
    let proDimVO = this.data.proDimVO
    let inputVal = this.data.inputVal
    let eachCarton = proDimVO.eachCarton
    let qty = inputVal.buy
    let allBox = 0
    if (qty > 0 && eachCarton > 0) {
      allBox = app.AcFunc.money((qty / eachCarton), 6, true)
    }
    inputVal.allBox = allBox
    this.setData({
      inputVal: inputVal
    })
  },
  showimgBig: function(event) {
    app.AcFunc.imgBig(event)
  }
}),{
  "navigationBarTitleText": "产品详情"
},<view class='container'>
  <view class='modBox flex border-box'>
    <view class='proImg self-center'>
      <image wx:if='{{settings.imgFlag&&settings.viewProductPhoto}}' src='{{imgUrl}}' lazy-load='true' mode='aspectFit' data-src='{{imgUrl}}' bindtap='showimgBig'></image>
    </view>
    <view class='proMsg flex-1'>
      <view class='p_title overpoint'>{{prodVO.name}}</view>
      <view class='p_price clearfix'>
        <picker class='priceList' wx:if="{{settings.morePriceFlag&&proPrice.length>1}}" range-key="name" bindchange="priceChange" value="{{price_index}}" range="{{proPrice}}">
          <view class="picker">
            <text class='red float-left'>￥{{proPrice.length==0?'-':proPrice[price_index].price}}<text wx:if='{{settings.unitFlag}}'>{{row.unitNameline=='-'?'':row.unitNameline}}</text></text>
            <icon class='iconfont icon-sanjiao float-left'></icon>
          </view>
        </picker>
        <view class='red' wx:elif='{{settings.viewProductSalesPriceOne}}'>￥{{proPrice[price_index].price}}
          <text wx:if='{{settings.unitFlag}}'>{{row.unitNameline?row.unitNameline:''}}</text>
        </view>
      </view>
      <view class='text' wx:if='{{settings.disInvCountFlag&&settings.viewProductInventoryQty}}'>
        库存:
        <text class='{{row.warnMinQty>=row.stockQty?"red":""}}'>{{row.stockQty?row.stockQty:0}}</text>
      </view>
      <view class='text'>
        <text class='text_s' wx:if='{{settings.skuFlag&&settings.viewProductSku&&prodVO.sku}}'>货号:{{prodVO.sku}}</text>
        <text class='text_s' wx:if='{{settings.viewProductBarcode&&prodVO.barcode}}'>条形码:{{prodVO.barcode}}</text>
      </view>
      <view class='text overpoint' wx:if='{{settings.remarkFlag&&settings.viewProductRemark}}'>
        {{prodVO.remark}}
      </view>
    </view>
  </view>
  <view class='modBox' wx:if='{{settings.specFlag&&settings.viewProductSpec&&specList.length>0}}'>
    <view class='proTitle'>规格</view>
    <scroll-view scroll-x='true'>
      <text wx:for="{{specList}}" data-index="{{index}}" wx:for-item="item" wx:key="" class='textbtn {{index==spec_index?"choose":""}}' bindtap='chooseSpec' id='{{index}}'>{{item.name}}</text>
    </scroll-view>
  </view>
  <view class='modBox' wx:if='{{settings.colorFlag&&settings.viewProductColor&&colorList.length>0}}'>
    <view class='proTitle'>颜色</view>
    <scroll-view scroll-x='true'>
      <text wx:for="{{colorList}}" data-index="{{index}}" wx:for-item="item" wx:key="" class='textbtn {{index==color_index?"choose":""}}' bindtap='chooseColor'>{{item.name}}</text>
    </scroll-view>
  </view>
  <!-- <view class='modBox flex row' wx:if='{{settings.weightFlag&&owner.ownerItemVO.weightFlag}}'>
    <view class='flex-1 self-center'>
      <text class='proTitle'>重量（kg）</text>
    </view>
    <view class='operInput clearfix'>
      <view class='iconfont icon-minus float-left' hover-class='touch' hover-stay-time='100' bindtap='touchminus' data-name='weight'></view>
      <input value='{{inputVal.weight}}'></input>
      <view class='iconfont icon-plus float-right' hover-class='touch' hover-stay-time='100' bindtap='touchplus' data-name='weight'></view>
    </view>
  </view> -->
  <view class='modBox flex row unit' wx:if='{{settings.unitFlag&&settings.viewProductUnit&&view_unitList.length>0}}'>
    <view class='flex-1 self-center'>
      <text class='proTitle'>单位</text>
      <text class='fs12 c999' wx:if='{{owner.ownerItemVO.showUnitType=="showSelectAndDeputyUnit"}}'>副单位:{{unitNames}}</text>
    </view>
    <view wx:if='{{view_unitList.length>0}}'>
      <picker class='proInput' bindchange="unitChange" value="{{unit_index}}" range-key="name" range="{{view_unitList}}">
        <view class="picker">
          {{view_unitList[unit_index].name}}
        </view>
      </picker>
    </view>
    <view wx:else class='{{!row.unitName?"c999":""}}'>
      {{row.unitName?row.unitName:''}}
    </view>
  </view>
  <view class='modBox' wx:if='{{settings.measFlag&&settings.viewProductMeas}}'>
    <view class='flex'>
      <view class='fs15 flex-1 self-center'>外箱尺寸
        <text class='fs12' wx:if='{{owner.ownerItemVO.measType=="volume"}}'>(m³)</text>
        <text class='fs12' wx:else>(长*宽*高*/m)</text>
      </view>
      <view wx:if='{{owner.ownerItemVO.measType=="volume"}}'>
        <input class='proInput' value='{{row.volume}}' disabled='disabled'></input>
      </view>
    </view>
     <view wx:if='{{owner.ownerItemVO.measType=="size"}}' class='proSize flex row just-con-b'>
        <input class='proInput' value='{{row.extent}}' disabled='disabled'></input>
        <input class='proInput' value='{{row.width}}' disabled='disabled'></input>
        <input class='proInput' value='{{row.height}}' disabled='disabled'></input>
      </view>
  </view>
  <!-- <view class='modBox flex row'>
    <view class='flex-1 self-center'>
      <text class='proTitle'>缸号</text>
    </view>
    <view>
      <input class='proInput' value='' placeholder='请输入缸号'></input>
    </view>
  </view>
  <view class='modBox fineCode'>
    <navigator url='/pages/order/fineCode/index' class='' hover-class='none'>
      <view class=''>
        <text class='proTitle'>细码数量</text>
        <icon class='iconMore iconfont icon-Right'></icon>
      </view>
      <view class='fs12'>
        匹数：0匹
      </view>
    </navigator>
  </view> -->
  <view class='modBox flex row' wx:if='{{settings.boxFlag}}'>
    <view class='flex-1 self-center' style='overflow:hidden;'>
      <view class='proTitle overpoint'>{{owner.ownerItemVO.tittltNameCn}}</view>
    </view>
    <view class='operInput clearfix'>
      <view class='iconfont icon-minus float-left' hover-class='touch' hover-stay-time='100' bindtap='touchminus' data-name='allBox'></view>
      <input value='{{input.cartons}}' type='digit' data-name='allBox' bindblur='boxChange'></input>
      <view class='iconfont icon-plus float-right' hover-class='touch' hover-stay-time='100' bindtap='touchplus' data-name='allBox'></view>
    </view>
  </view>
  <view class='modBox flex row' wx:if='{{settings.boxFlag}}'>
    <view class='flex-1 self-center' style='overflow:hidden;'>
      <view class='proTitle overpoint'>{{owner.ownerItemVO.detailNameCn}}</view>
    </view>
    <view>
      <input class='proInput c999' value='{{row.eachCarton}}' disabled='disabled'></input>
    </view>
  </view>
  <view class='modBox flex row'>
    <view class='flex-1 self-center'>
      <view class='proTitle'>购买数量</view>
    </view>
    <view class='operInput clearfix'>
      <view class='iconfont icon-minus float-left' hover-class='touch' hover-stay-time='100' bindtap='touchminus' data-name='buy'></view>
      <input value='{{input.qty}}' type='digit' data-name='buy' bindblur='boxChange' bindchange='boxChange'></input>
      <view class='iconfont icon-plus float-right' hover-class='touch' hover-stay-time='100' bindtap='touchplus' data-name='buy'></view>
    </view>
  </view>
  <view class='proFootBar flex row border-box'>
    <view class='flex-1 self-center'>
      <icon class='iconfont icon-cart'></icon>
      <text class='c999 fs12'>金额:</text>
      <text class='red' wx:if='{{settings.viewProductSalesPriceOne}}'>{{priceTotal}}</text>
      <text class='cartnum' wx:if='{{cartNum>0}}'>{{cartNum}}</text>
    </view>
    <view class='clearfix'>
      <block wx:if='{{isEdit}}'>
        <button hover-class='none' class='goodSave' bindtap='goodsUpdate'>保存</button>
      </block>
      <block wx:else>
        <button hover-class='none' class='goonadd' bindtap='goodsadd'>继续添加</button>
        <button hover-class='none' class='addcart' bindtap='addCart'>加入购物车</button>
      </block>
    </view>
  </view>
</view>,button::after {
  border: none;
}

input {
  outline: none;
  border: none;
  list-style: none;
}
.container{
   display: block;
   padding-bottom: 100rpx;
}
.modBox{
  background: #fff;
  padding:20rpx;
  border-bottom:1px solid #EFEFF4;
}
.proImg{
  margin-right:20rpx;
}
.proImg image{
  width: 100rpx;
  height:100rpx;
}
.p_price{
  padding:6rpx 0;
}
.proMsg{
  overflow:hidden;
}
.proMsg .text{
  font-size:22rpx;
  color:#999;
  word-break: break-all;
  overflow: hidden;
}
.proMsg text{
  display: inline-block;
  line-height: 100%;
}
.proMsg .text_s{
  margin-right:20rpx;
  padding-right:20rpx;
  border-right:1px solid #999;
}
.proMsg .text_s:last-child{
  border-right:0;
}
.prodMod{
  width: 100%;
  overflow: hidden;
}
.proTitle{
  font-size:30rpx;
  max-width: 300rpx;
}
scroll-view{
  width: 100%;
  white-space: nowrap
}
.textbtn{
  display: inline-block;
  padding:10rpx;
  border:1px solid #c4c4c4;
  border-radius: 0.3em;
  min-width: 100rpx;
  text-align: center;
  margin:10rpx 20rpx 10rpx 0;
  font-size:26rpx;
}
.textbtn.choose{
  border-color:#FFBC51;
  color:#FFBC51;
}
.proInput{
  height:60rpx;
  line-height: 60rpx;
  width: 264rpx;
  border:1px solid #c4c4c4;
  border-radius: 0.3em;
  text-align: center;
}

.unit .fs12{
  display: inline-block;
  margin-left:20rpx;
}
.proSize{
  margin-top:10rpx;
}
.proSize .proInput{
  width: 200rpx;
}
.fineCode .iconMore{
  float: right;
}
.proFootBar{
  position: fixed;
  height:100rpx;
  background: #fff;
  left:0;
  width: 100%;
  bottom:0;
  z-index: 100;
  border-top: 1px solid #EFEFF4;
  padding-left:20rpx;
}
.proFootBar button{
  float:left;
  height:100%;
  border:0;
  min-width:192rpx;
  line-height: 100rpx;
  color:#fff;
  border-radius: 0;
  font-size:30rpx;
}
.proFootBar button:before,.proFootBar button:aftter{
  border:0;
}
.proFootBar .goodSave{
  float:right;
}
.proFootBar .goonadd,.proFootBar .goodSave{
  background: #35D2C6;
}
.proFootBar .addcart{
  background: #00A6F5;
}
.proFootBar .icon-cart{
  color:#00A6F5;
  margin-right:20rpx;
  font-size:40rpx;
}
.proFootBar .flex-1{
  position: relative;
}
.proFootBar .cartnum{
  position: absolute;
  top:-4rpx;
  left:30rpx;
  background: #f5222d;
  color:#fff;
  text-align: center;
  height:36rpx;
  line-height: 36rpx;
  width: 36rpx;
  border-radius:50%;
  font-size:11px;
},// components/lazyRoll/index.js
/**
 *  <lazyRoll id='cartlazyRoll'>
 *  <view wx:for="{{array}}" style="top:{{item._top}}pt;" >
 *    当前下标是：{{item._index}}
 *  </view>
 *  </lazyRoll>
 * lazyRoll里面对应当前的组件的数据wx:for="{{array}}" 下标是item._index，不要直接使用index
 */
Component({
  /**
   * 组件的属性列表
   */
  properties: {
    
  },

  /**
   * 组件的初始数据
   */
  data: {
    showLength: 10,
    height: 0, //子元素高度
    //scrollHeight: 400, //父元素的高度
    array: [], //返回数组
    metaArray: [], //数据集合
    dataLength: 0,
    _top: 0, //当前数据高度
    _index:0, //当前数据的下标
  },

  /**
   * 组件的方法列表
   */
  methods: {
    /**
     * 初始化
     */
    init: function(settings) {
      let page = getCurrentPages()[getCurrentPages().length - 1],
        that = this,
        array = [];
      let metaArray = settings.metaArray;
      let showLength = 0;
      if (showLength > metaArray.length){
        showLength = metaArray.length;
      }else{
        showLength = settings.showLength;
      }
      metaArray.forEach((v, i) => {
        v._index = i;
        v._top = settings.height * i;
      })
      for (let i = 0; i < showLength; i++) {
        if (metaArray[i]){
          array.push(metaArray[i])
        }
      }
      this.setData({
        metaArray: settings.metaArray,
        dataLength: settings.metaArray.length,
        height: settings.height,
        showLength: showLength,
        scrollHeight: settings.scrollHeight
      });
      page.setData({
        array: array,
      })
      console.log('init----------', this)
    },
    /**
     * 滚动事件
     */
    scroll: function(e) {
      let that = this;
      clearTimeout(this.time)
      this.time = setTimeout(() => {
        console.log(e.detail, e.detail.scrollTop);
        var top = e.detail.scrollTop / e.detail.scrollHeight * that.data.dataLength;
        console.info('当前滚动计算位置为：', top)
        top = Math.floor(top);
        this.data._top = top;
        this.resetArray(top)
        console.log('scroll----------', that)
      }, 30)
    },
    resetArray: function(top) {
      let page = getCurrentPages()[getCurrentPages().length - 1],
        metaArray = this.data.metaArray,
        array = [];
      for (let i = top; i < this.data.showLength + top; i++) {
        if (metaArray[i] != undefined && metaArray[i]._index!=undefined) {
          metaArray[i]._index = i;
          metaArray[i]._top = this.data.height * i;
          array.push(metaArray[i])
        }
      }
      page.setData({
        array: array,
      })
    },
    reload: function(e) {
      this.setData({
        dataLength: this.data.metaArray.length,
      });
      this.resetArray(this.data._top)
      console.log('reload----------', this)
    }
  },
  
}),{
  "component": true,
  "usingComponents": {}
},<!-- components/lazyRoll/index.wxml -->
<scroll-view class="lazyRoll" scroll-y="true" bindscroll="scroll" style='height:{{scrollHeight}}rpx'>
  <view class='v' style='height:{{dataLength*height}}rpx;'>
    <slot></slot>
  </view>
</scroll-view>
,/* components/lazyRoll/index.wxss */
.lazyRoll{
  /* height: 400pt; */
}
.lazyRoll .v >view{
  position: absolute;
},Page({

  /**
   * 页面的初始数据
   */
  data: {
    metaArray:[],
    array:[],
    cellH:0,
  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {
   
  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {
    let that=this, array = [], metaArray=[];
    for(let i=0;i<10000;i++){
      metaArray.push(i)
    }
    for (let i = 0; i < 50; i++) {
      array.push({index:i})
    }
    console.log('array', array)
    this.setData({
      metaArray: metaArray,
      array: array
    })
    const query = wx.createSelectorQuery();
    query.select('.vi').boundingClientRect();
    query.selectViewport().scrollOffset()
    query.exec(function (res) {
      console.log('选择器测试createSelectorQuery',res)
      that.setData({
        h:res[0].height,
      })     
    })
    
  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {
    
  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {
    
  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {
    
  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {
    
  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {
    
  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {
    
  },

  scroll:function(e){
    clearTimeout(this.time)
    this.time=setTimeout(()=>{
      console.log(e.detail,e.detail.scrollTop);
      var top = e.detail.scrollTop / e.detail.scrollHeight*this.data.metaArray.length;

      console.info('当前滚动计算位置为：',top)
      top = Math.floor(top)
      // return ;
      var arr=[];
      for (let i = top; i < 25 + top;i++){
        arr.push({index:i})
      }
      this.setData({
        array: arr
        })
    },10)
  },
}),{},<scroll-view class="lazyRoll" scroll-y="true" bindscroll="scroll">
  <view style='height:{{metaArray.length*h}}pt;'>

    <view class='vi' wx:for="{{array}}"  style='top:{{h*(item.index)}}pt;'>
     <!-- <slot></slot> -->
       <view>
          这一条记录是：{{item.index}}
        </view>
    </view>
  </view>
</scroll-view>,/* assets/plugins/lazyRoll/index.wxss */
.lazyRoll{
  height: 400pt;
}
.lazyRoll .vi{
  position: absolute;
border-bottom: 1px solid red;
},/**
 * Promise 封装 wx 原生方法
 */
class WxService {
    constructor() {
        this.__init()
    }

    /**
     * __init
     */
    __init() {
        this.__initTools()
        this.__initDefaults()
        this.__initMethods()
    }

    /**
     * 初始化工具方法
     */
    __initTools() {
        this.tools = {
            isArray(value) {
                return Array.isArray(value)
            },
            isObject(value) {
                return value !== null && typeof value === 'object'
            },
            isNumber(value) {
                return typeof value === 'number'
            },
            isDate(value) {
                return Object.prototype.toString.call(value) === '[object Date]'
            },
            isUndefined(value) {
                return typeof value === 'undefined'
            },
            toJson(obj, pretty) {
                if (this.isUndefined(obj)) return undefined
                if (!this.isNumber(pretty)) {
                    pretty = pretty ? 2 : null
                }
                return JSON.stringify(obj, null, pretty)
            },
            serializeValue(value) {
                if (this.isObject(value)) return this.isDate(value) ? value.toISOString() : this.toJson(value)
                return value
            },
            encodeUriQuery(value, pctEncodeSpaces) {
                return encodeURIComponent(value)
                    .replace(/%40/gi, '@')
                    .replace(/%3A/gi, ':')
                    .replace(/%24/g, '$')
                    .replace(/%2C/gi, ',')
                    .replace(/%3B/gi, ';')
                    .replace(/%20/g, (pctEncodeSpaces ? '%20' : '+'))
            },
            paramSerializer(obj) {
                if (!obj) return ''
                let parts = []
                for (let key in obj) {
                    const value = obj[key]
                    if (value === null || this.isUndefined(value)) return
                    if (this.isArray(value)) {
                        value.forEach((v) => {
                            parts.push(this.encodeUriQuery(key) + '=' + this.encodeUriQuery(this.serializeValue(v)))
                        })
                    } else {
                        parts.push(this.encodeUriQuery(key) + '=' + this.encodeUriQuery(this.serializeValue(value)))
                    }
                }
                return parts.join('&')
            },
            buildUrl(url, obj) {
                const serializedParams = this.paramSerializer(obj)
                if (serializedParams.length > 0) {
                    url += ((url.indexOf('?') == -1) ? '?' : '&') + serializedParams
                }
                return url
            },
        }
    }

    /**
     * __initDefaults
     */
    __initDefaults() {
        // 缓存非异步方法
        this.noPromiseMethods = [
            'stopRecord',
            'pauseVoice',
            'stopVoice',
            'pauseBackgroundAudio',
            'stopBackgroundAudio',
            'showNavigationBarLoading',
            'hideNavigationBarLoading',
            'createAnimation',
            'createContext',
            'hideKeyboard',
            'stopPullDownRefresh',
            'createSelectorQuery',
        ]

        // 缓存 wx 接口方法名
        this.instanceSource = {
            method: Object.keys(wx)
        }
    }

    /**
     * 遍历 wx 方法对象，判断是否为异步方法，是则构造 Promise
     */
    __initMethods() {
        for (let key in this.instanceSource) {
            this.instanceSource[key].forEach((method, index) => {
                this[method] = (...args) => {
                    // 判断是否为非异步方法或以 wx.on 开头，或以 Sync 结尾的方法
                    if (this.noPromiseMethods.indexOf(method) !== -1 || method.substr(0, 2) === 'on' || /\w+Sync$/.test(method)) {
                        return wx[method](...args)
                    }
                    return this.__defaultRequest(method, ...args)
                }
            })
        }

        const navigate = [
            'navigateTo',
            'redirectTo',
            'switchTab',
            // 'navigateBack', 
            'reLaunch',
        ]

        /**
         * 重写导航 API
         * @param {String} url  路径
         * @param {Object} params 参数
         */
        navigate.forEach((method, index) => {
            this[method] = (url, params) => {
                const obj = {
                    url,
                }
                if (method !== 'switchTab') {
                    obj.url = this.tools.buildUrl(url, params)
                }
                return this.__defaultRequest(method, obj)
            }
        })

        /**
         * 关闭当前页面，返回上一页面或多级页面
         * @param {Number} delta  返回的页面数，如果 delta 大于现有页面数，则返回到首页
         */
        this.navigateBack = (delta = 1) => {
            return wx.navigateBack({
                delta,
            })
        }
    }

    /**
     * 以 wx 下 API 作为底层方法
     * @param {String} method 方法名
     * @param {Object} obj    接收参数
     */
    __defaultRequest(method = '', obj = {}) {
        return new Promise((resolve, reject) => {
            obj.success = (res) => resolve(res)
            obj.fail = (res) => reject(res)
            wx[method](obj)
        })
    }
}

export default WxService,/**
 * 表单验证
 * 
 * @param {Object} rules 验证字段的规则
 * @param {Object} messages 验证字段的提示信息
 * 
 */
class WxValidate {
	constructor(rules = {}, messages = {}) {
		Object.assign(this, {
			rules, 
			messages, 
		})
		this.__init()
	}

	/**
	 * __init
	 */
	__init() {
		this.__initMethods()
		this.__initDefaults()
		this.__initData()
	}

	/**
	 * 初始化数据
	 */
	__initData() {
		this.form = {}
		this.errorList = []
	}

	/**
	 * 初始化默认提示信息
	 */
	__initDefaults() {
		this.defaults = {
			messages: {
				required: '这是必填字段。',
				email: '请输入有效的电子邮件地址。',
				tel: '请输入11位的手机号码。',
        phone:'请输入正确的联系方式。',
				url: '请输入有效的网址。',
				date: '请输入有效的日期。',
				dateISO: '请输入有效的日期（ISO），例如：2009-06-23，1998/01/22。',
				number: '请输入有效的数字。',
				digits: '只能输入数字。',
				idcard: '请输入18位的有效身份证。',
				equalTo: this.formatTpl('输入值必须和 {0} 相同。'),
				contains: this.formatTpl('输入值必须包含 {0}。'),
				minlength: this.formatTpl('最少要输入 {0} 个字符。'),
				maxlength: this.formatTpl('最多可以输入 {0} 个字符。'),
				rangelength: this.formatTpl('请输入长度在 {0} 到 {1} 之间的字符。'),
				min: this.formatTpl('请输入不小于 {0} 的数值。'),
				max: this.formatTpl('请输入不大于 {0} 的数值。'),
				range: this.formatTpl('请输入范围在 {0} 到 {1} 之间的数值。'),
			}
		}
	}

	/**
	 * 初始化默认验证方法
	 */
	__initMethods() {
		const that = this
		that.methods = {
			/**
			 * 验证必填元素
			 */
			required(value, param) {
				if (!that.depend(param)) {
					return 'dependency-mismatch'
				} else if (typeof value === 'number') {
					value = value.toString()
				} else if (typeof value === 'boolean') {
					return !0
				}

				return value.length > 0
			},
			/**
			 * 验证电子邮箱格式
			 */
			email(value) {
				return that.optional(value) || /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(value)
			},
			/**
			 * 验证手机号码
			 */
			tel(value) {
				return that.optional(value) || /^1[3456789]\d{9}$/.test(value)   
        
			},
      /**
       * 验证手机固话
       */
      phone(value){
        return that.optional(value) || /^((13[0-9])|(14[5|7])|(15([0-3]|[5-9]))|(17[0-9])|(18[0,5-9]))\d{8}$|^((13[0-9])|(14[5|7])|(15([0-3]|[5-9]))|(18[0,5-9]))\d{8}$|^0\d{2,3}-?\d{7,8}$/.test(value)
      },
			/**
			 * 验证URL格式
			 */
			url(value) {
				return that.optional(value) || /^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})).?)(?::\d{2,5})?(?:[/?#]\S*)?$/i.test(value)
			},
			/**
			 * 验证日期格式
			 */
			date(value) {
				return that.optional(value) || !/Invalid|NaN/.test(new Date(value).toString())
			},
			/**
			 * 验证ISO类型的日期格式
			 */
			dateISO(value) {
				return that.optional(value) || /^\d{4}[\/\-](0?[1-9]|1[012])[\/\-](0?[1-9]|[12][0-9]|3[01])$/.test(value)
			},
			/**
			 * 验证十进制数字
			 */
			number(value) {
				return that.optional(value) || /^(?:-?\d+|-?\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$/.test(value)
			},
			/**
			 * 验证整数
			 */
			digits(value) {
				return that.optional(value) || /^\d+$/.test(value)
			},
			/**
			 * 验证身份证号码
			 */
			idcard(value) {
				return that.optional(value) || /^[1-9]\d{5}[1-9]\d{3}((0\d)|(1[0-2]))(([0|1|2]\d)|3[0-1])\d{3}([0-9]|X)$/.test(value)
			},
			/**
			 * 验证两个输入框的内容是否相同
			 */
			equalTo(value, param) {
				return that.optional(value) || value === that.scope.detail.value[param]
			},
			/**
			 * 验证是否包含某个值
			 */
			contains(value, param) {
				return that.optional(value) || value.indexOf(param) >= 0
			},
			/**
			 * 验证最小长度
			 */
			minlength(value, param) {
				return that.optional(value) || value.length >= param
			},
			/**
			 * 验证最大长度
			 */
			maxlength(value, param) {
				return that.optional(value) || value.length <= param
			},
			/**
			 * 验证一个长度范围[min, max]
			 */
			rangelength(value, param) {
				return that.optional(value) || (value.length >= param[0] && value.length <= param[1])
			},
			/**
			 * 验证最小值
			 */
			min(value, param) {
				return that.optional(value) || value >= param
			},
			/**
			 * 验证最大值
			 */
			max(value, param) {
				return that.optional(value) || value <= param
			},
			/**
			 * 验证一个值范围[min, max]
			 */
			range(value, param) {
				return that.optional(value) || (value >= param[0] && value <= param[1])
			},
		}
	}

	/**
	 * 添加自定义验证方法
	 * @param {String} name 方法名
	 * @param {Function} method 函数体，接收两个参数(value, param)，value表示元素的值，param表示参数
	 * @param {String} message 提示信息
	 */
	addMethod(name, method, message) {
		this.methods[name] = method
		this.defaults.messages[name] = message !== undefined ? message : this.defaults.messages[name]
	}

	/**
	 * 判断验证方法是否存在
	 */
	isValidMethod(value) {
		let methods = []
		for(let method in this.methods) {
			if (method && typeof this.methods[method] === 'function') {
				methods.push(method)
			}
		}
		return methods.indexOf(value) !== -1
	}

	/**
	 * 格式化提示信息模板
	 */
	formatTpl(source, params) {
		const that = this
		if (arguments.length === 1) {
			return function() {
				let args = Array.from(arguments)
				args.unshift(source)
				return that.formatTpl.apply(this, args)
			}
		}
		if (params === undefined) {
			return source
		}
		if (arguments.length > 2 && params.constructor !== Array) {
			params = Array.from(arguments).slice(1)
		}
		if (params.constructor !== Array) {
			params = [ params ]
		}
		params.forEach(function(n, i) {
			source = source.replace(new RegExp("\\{" + i + "\\}", "g"), function() {
				return n
			})
		})
		return source
	}

	/**
	 * 判断规则依赖是否存在
	 */
	depend(param) {
		switch(typeof param) {
			case 'boolean':
				param = param
				break
			case 'string':
				param = !!param.length
				break
			case 'function':
				param = param()
			default:
				param = !0
		}
		return param
	}

	/**
	 * 判断输入值是否为空
	 */
	optional(value) {
		return !this.methods.required(value) && 'dependency-mismatch'
	}

	/**
	 * 获取自定义字段的提示信息
	 * @param {String} param 字段名
	 * @param {Object} rule 规则
	 */
	customMessage(param, rule) {
		const params = this.messages[param]
		const isObject = typeof params === 'object'
		if (params && isObject) return params[rule.method]
	}

	/**
	 * 获取某个指定字段的提示信息
	 * @param {String} param 字段名
	 * @param {Object} rule 规则
	 */
	defaultMessage(param, rule) {
		let message = this.customMessage(param, rule) || this.defaults.messages[rule.method]
		let type = typeof message
		
		if (type === 'undefined') {
			message = `Warning: No message defined for ${rule.method}.`
		} else if (type === 'function') {
			message = message.call(this, rule.parameters)
		}

		return message
	}

	/**
	 * 缓存错误信息
	 * @param {String} param 字段名
	 * @param {Object} rule 规则
	 * @param {String} value 元素的值
	 */
	formatTplAndAdd(param, rule, value) {
		let msg = this.defaultMessage(param, rule)

		this.errorList.push({
			param: param, 
			msg: msg, 
			value: value, 
		})
	}

	/**
	 * 验证某个指定字段的规则
	 * @param {String} param 字段名
	 * @param {Object} rules 规则
	 * @param {Object} event 表单数据对象
   * @param {boolean} bool 是否是表单数据
	 */
	checkParam(param, rules, event,bool=true) {
    let data={};
    if (!bool){
      let _event={
        detail:{
          value: event
        } 
      }
      // 缓存表单数据对象
      this.scope = _event

      // 缓存字段对应的值
      data = _event.detail.value
    }else{
      // 缓存表单数据对象
      this.scope = event

      // 缓存字段对应的值
       data = event.detail.value
    }
	
		const value = data[param] || ''

		// 遍历某个指定字段的所有规则，依次验证规则，否则缓存错误信息
		for(let method in rules) {

			// 判断验证方法是否存在
			if (this.isValidMethod(method)) {

				// 缓存规则的属性及值
				const rule = { 
					method: method, 
					parameters: rules[method] 
				}

				// 调用验证方法
				const result = this.methods[method](value, rule.parameters)
				
				// 若result返回值为dependency-mismatch，则说明该字段的值为空或非必填字段
				if (result === 'dependency-mismatch') {
					continue
				}

				this.setValue(param, method, result, value)

				// 判断是否通过验证，否则缓存错误信息，跳出循环
				if (!result) {
					this.formatTplAndAdd(param, rule, value)
					break
				}
			}
		}
	}

	/**
	 * 设置字段的默认验证值
	 * @param {String} param 字段名
	 */
	setView(param) {
		this.form[param] = {
			$name: param, 
			$valid: true, 
			$invalid: false, 
			$error: {}, 
			$success: {}, 
			$viewValue: ``, 
		}
	}

	/**
	 * 设置字段的验证值
	 * @param {String} param 字段名
	 * @param {String} method 字段的方法
	 * @param {Boolean} result 是否通过验证
	 * @param {String} value 字段的值
	 */
	setValue(param, method, result, value) {
		const params = this.form[param]
		params.$valid = result
		params.$invalid = !result
		params.$error[method] = !result
		params.$success[method] = result
		params.$viewValue = value
	}

	/**
	 * 验证所有字段的规则，返回验证是否通过
	 * @param {Object} event 表单数据对象
	 */
	checkForm(event) {
		this.__initData()

		for (let param in this.rules) {
			this.setView(param)
			this.checkParam(param, this.rules[param], event)
		}

		return this.valid()
	}

  /**
 * 验证所有字段的规则，返回验证是否通过
 * @param {Object} obj json对象
 */
  checkObj(obj) {
    this.__initData()

    for (let param in this.rules) {
      this.setView(param)
      this.checkParam(param, this.rules[param], obj,false)
    }

    return this.valid()
  }

	/**
	 * 返回验证是否通过
	 */
	valid() {
		return this.size() === 0
	}

	/**
	 * 返回错误信息的个数
	 */
	size() {
		return this.errorList.length
	}

	/**
	 * 返回所有错误信息
	 */
	validationErrors() {
		return this.errorList
	}
}

export default WxValidate,// pages/agreement/logist/index.js
Page({

  /**
   * 页面的初始数据
   */
  data: {

  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {

  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {

  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {

  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {

  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {

  }
}),{"navigationBarTitleText": "物流服务协议"},<view class='container'>
<view class='text-center fs14'></view>
<view>一、用户注册</view>
<view>1.1 如果用户是代表个人签订本协议，用户应具有完全民事行为能力；如果用户是代表法人
实体签订本协议，用户应获得授权并遵守本《物流服务协议》（并约束该法人实体）。</view>
<view>二、合同订立</view>
<view>2.1 用户理解并同意，用户通过在线点击选择使用秒账物流服务，即视为接受本《物流服务
协议》并依据本协议与我司达成了合约。</view>
<view>三、服务内容</view>
<view>3.1 用户通过使用我公司独立运营的秒账平台提出货物运输需求，并同意我司将业务分发给
珠海萃丰数据科技有限公司（以下简称“珠海萃丰”），珠海萃丰作为承运人承接用户的货运
服务需求并向用户提供货运服务。</view>
<view>四、服务使用</view>
<view>4.1 用户使用秒账物流服务，平台会根据用户提供的货物信息预估运费并提前支付到我公司
指定的对公账户。此费用为预估费用，最终运费以托运站核验为准。如因用户提供货物信息
如品名、体积、重量等信息有误而导致的预估价格不准时，客户有义务补足运费或我们会退
还超出部分的运费。如果用户未能及时预付费用，我公司有权终止货运运输。</view>
<view>4.2 用户可就其每次使用秒账物流服务实际消耗的金额向我公司申请开具发票，发票的税点
费用由用户自行承担。用户知晓并同意如下：（1）用户仅可就已实际消耗的运费要求我公司
开具相应的增值税发票；（2）发票的类型视我公司实际情况开具；（3）如实际发生的运费中
含有其他优惠活动金额的，则我公司开出的发票金额将不包含该优惠活动金额。</view>
<view>4.3 本协议自成立生效之日起一年内有效，除任意一方以书面形式提出解约并不再使用秒账
物流服务之外，用户同意本协议在期限届满后自动延续一年（续期次数不限）。</view>
<view>4.4 我公司将不时推出充值优惠活动，具体应当时优惠活动的活动公告为准。</view>
<view>五、双方权利义务</view>
<view>5.1 用户担保、用户向秒账物流提供的信息真实、准确、完整。为实现向用户提供服务的目、
为保证您托寄货物安全送达，您在办理交付货物时应履行以下义务：</view>
<view>5.1.1 如实填写货物品名和价值，并准确清楚写明托运人，收货人的地址信息和联系电话
等资料；</view>
<view>5.1.2 对于易损易碎物品，您应依据货物的性质，提供充分的防护措施，保证安全运输；</view>
<view>5.1.3 遵守禁止寄递物品法律法规的规定，本公司有权对托寄物进行验视，如发现禁止或限
制寄递的物品，有权交相关部门处理，并保留追究您法律责任的权利。</view>
<view>5.1.4 寄托物需要办理审批、检验等手续的，您应向本公司提交办理完相关手续的证明文
件。</view>
<view>5.2 您的违约赔偿责任</view>
<view>5.2.1 因寄托物质量缺陷或者包装破损，致使造成的其他损失，您应承担赔偿责任。</view>
<view>5.2.2 因托寄物属于或者含有禁止或限制寄递物品而被查没、扣留等，给本公司或者第三方
造成的经济损失的，应由您承担赔偿责任。</view>
<view>5.2.3 货物到达指定卸货点后，且卸货网点人员已经通知您的客户提货，需最迟在三日内提
货，超过三日未提货的，将会收取一定额度的保管费。</view>
<view>5.2.4 如果收货人拒绝收件，7 天之内您未明确给出拒收货物的处理意见（弃货处理或返回
发货人），则满 7 天后本公司有权通知物流将货物直接返回。</view>
<view>5.3 如果本条款中的某条款被法院或政府机构认定为无效或者部分无效，则双方同意除无效
条款外仍执行本合同其他条款，部分有效条款在其可执行的范围内仍继续执行。</view>
<view>5.4 本契约条款未约定或约定不明，且双方未达成补充约定的，按照相关法律法规和国家标
准的规定执行。</view>
<view>六、保价与赔偿</view>
<view>6.1 保险与赔偿</view>
<view>6.1.1 本公司实行托运人自愿购买货运运输保险，保险费用为保险金额的千分之四。若
购买货物运输保险，在我司承运期间，因我司原因，如有发生损坏，丢失等属于保险责任的
保险事故，按保险约定条款理赔。保险金额超过实际金额的，超出部分不予以赔偿。</view>
<view>6.1.2 若您未选择货物保险，则本公司在五倍运费的限额内向您赔偿托寄物的实际损失。
如您认为该赔偿标准不足以弥补您的损失，应根据托寄物的实际价值选择等值保险服务。</view>
<view>6.1.3 若您已经选择保价且支付保价费用，则本公司按照保价金额和损失的比例向您赔
偿，最高不超过托寄物的实际损失金额。具体参见中国人民财产保险股份有限公司的国内
货物运输保险条款，适用：国内水路、陆路货物运输保险条款（2009 版）国内水路、陆路
货物运输保险附加盗窃、抢劫保险条款（2009 版）。</view>
<view>发生以下情形一的，本公司不承担赔偿责任：</view>
<view>（1） 您自行包装或者容器不良，但外部无法发现。</view>
<view>（2） 您自行保证，到达时包装完好而内件缺失或损坏。</view>
<view>七、保密</view>
<view>7.1 未经一方事先许可，本协议向对方在任何情况下均不得将涉及另一方的机密信息泄露给
任何第三方。</view>
<view>7.2 尽管前款规定，一方可向其职员、顾问及供应商透露机密信息，前提是该种透露应为一
方履行本协议之义务所必须，且上述职员、顾问及供应商同意承担与本协议中所规定的保密
义务相同或更严格的保密义务。</view>
<view>7.3 为本协议之目的，“机密信息”是指与一方有关、被其指定为机密的任何信息，或是另
一方应合理认定为机密的任何信息。机密信息包括但不限于客户名单以及与一方业务有关的、
另一方以任何方式占有或了解的各种信息及材料，但不包括下列内容：</view>
<view>（1）一方从第三方合法获得的无需承担保密义务的信息和材料；</view>
<view>（2）非因接受方违反保密义务，当前或之后为公众所知的信息和材料；</view>
<view>（3）经接受信息一方书面授权公开或书面指定为不再保密或不再专有的任何信息或材料。</view>
<view>八、不可抗力</view>
<view>8.1 遭受不可抗力事件的一方可暂行中止履行本协议项下的义务直至不可抗力事件的影响
消除为止，并且无需为此承担违约责任，但应尽最大努力克服该事件，减少损失的扩大。不
可抗力指各方不能控制、不可预见或即使预见也无法避免的事件，该事件足以妨碍、影响或
延误任何一方根据本协议履行全部或部分义务。该事件包括但不限于自然灾害、战争、政策
变化、计算机病毒、黑客攻击或电信机构服务中断造成的事件。</view>
<view>九、 其他</view>
<view>9.1 用户同意不因本协议成立而与我公司成就任何雇佣、合伙、代理等法律关系，双方仅为
一般民事合作关系。</view>
<view>9.2 用户除应遵守本协议各项约定外，还需要认真查看我公司及秒账平台上的各项准则、规
定，包括但不限于保险投保、出险赔付等，上述准则、规定与本合同构成双方间就用户基于
其货物运输需求提出货物运输合作的全部约定。</view>
<view>9.3 用户理解并同意，我公司可根据公司实际运营情况将本协议项下的所有权利和义务转让
给与我公司有关联的第三方，我公司保证该第三方提供的货运服务质量不低于我公司提供的
服务质量。</view>
<view>9.4 用户不得向我公司的任何员工提供货赠与任何礼品，而且将来也不会提供或赠予此类物
品，以便为了从我公司获取任何业务，或为了在双方签订的任何协议或订单（包括但不限于
本协议）条款、条件或执行方面影响上述人员。</view>
<view>9.5 用户保证并承诺，其将严格遵守中国现行反商业贿赂法律中有关反腐败的规定，在本协
议履行过程中不向任何人员提供贿赂。</view>
<view>9.6 如因特定原因导致本《物流服务协议》的某一（些）条款被认定为无效而其他条款仍能
保持有效且其执行不受影响，我们可决定是否继续履行该等其他条款。</view>
<view>9.7 我们保留随时修改或替换本《物流服务协议》条款，或者更改、暂停或中断服务或应用
程序（包括但不限于），任何功能、数据库或内容的可用性的权利。届时，我们只需要在/
通过秒账平台上发布通告或发送通知。用户如果不同意我们对本《物流服务协议》所做的修
改，用户有权停止使用服务。如果用户继续使用服务，则视为用户接受我们对本《物流服务
协议》所做的修改。</view>
<view>9.8 用户同意并认可，在未经我公司事先的书面同意外，用户无权转让本《物流服务协议》
中的权利。</view>
<view>9.9 本协议以及与协议有关的任何事项均应由中华人民共和国法律的管辖及解释。与本协议
有关的一切争议均应提交被告所在地有管辖权的人民法院以诉讼方式解决。</view>
</view>
,.container{
  background: #fff;
  padding:20rpx;
  font-size:24rpx;
  line-height: 1.2
},const app = getApp();
import __config from '../../../etc/config'
import AcFunc from '../../../helpers/acFunc.js'
Page({
  data: {
    imagesrc: 'http://www.ydcfo.com/chatLogo.png',
    userlist: {},
  },
  toaddaddress(e) {
    let towhich = e.currentTarget.dataset.towhich;
    if (towhich == 'edit') {
      let addressone = JSON.stringify(e.currentTarget.dataset.addressdetail);
      wx.navigateTo({
        url: '/pages/address/address?addr=' + addressone + '&candel=true'
      })
    } else {
      wx.navigateTo({
        url: '/pages/address/address'
      })
    }
  },
  toedittel(e) {
    wx.navigateTo({
      url: '/pages/myhome/edittel/edittel'
    })
  },
  getbasename(e) {
    let userlist = this.data.userlist;
    userlist.name = e.detail.value
    this.setData({
      userlist: userlist
    })
  },
  changeimg() {
    var that = this;
    wx.setStorageSync('baseinforefresh', true);
    wx.chooseImage({
      count: 1,
      sizeType: ['original'], // 可以指定是原图还是压缩图，默认二者都有
      sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
      success: function(res) {
        var tempFilePaths = res.tempFilePaths;
        console.log(tempFilePaths)
        wx.uploadFile({
          url: app.getUploadUrl(), //仅为示例，非真实的接口地址
          filePath: tempFilePaths[0],
          name: 'file',
          success: function(res) {
            var imgid = JSON.parse(res.data).data.id;
            let userlist = that.data.userlist;
            userlist.photo = imgid
            that.setData({
              userlist: userlist,
              imagesrc: tempFilePaths[0],
            });
          }
        })
      }
    });
  },
  saveInfo() {
    let params = {}
    params.phone = this.data.userlist.phone
    if (this.data.userlist.photo) {
      params.photo = this.data.userlist.photo
    }
    params.name = this.data.userlist.name
    app.HttpService.edituserInfo(params).then(res => {
      wx.navigateBack({})
    })
  },
  onLoad: function(options) {

  },
  onShow: function() {
    if (!wx.getStorageSync('baseinforefresh')) {
      app.HttpService.userInfo().then(res => {
        let imagesrc = res.photo ? app.getimg('thumbnail', res.photo) :'http://www.ydcfo.com/chatLogo.png'
        app.globalData.loginInfo =res
        this.setData({
          userlist: res,
          imagesrc: imagesrc
        })
      })
    }
    wx.setStorageSync('baseinforefresh', false);
  },
  showbigimg(event){
    AcFunc.imgBig(event)
  }
}),{"navigationBarTitleText": "基本信息"},<view class='baselist'>
  <view class='baseone flex nowrap just-con-b height140'>
    <view class='self-center'>设置头像</view>
    <view class='self-center' bindlongpress='changeimg' bindtap='showbigimg' data-src='{{imagesrc}}'><image src='{{imagesrc}}' mode='aspectFit' class='mylogo'></image></view>
  </view>
  <view class='baseone flex nowrap just-con-b'>
    <view class='self-center'>名称</view>
    <view class='self-center'>
      <input class='basename' bindinput='getbasename' value='{{userlist.name}}' placeholder='请输入名称' maxlength='32'></input>
    </view>
  </view>
  <view class='baseone flex nowrap just-con-b'>
    <view class='self-center'>电话</view>
    <view class='self-center toedit' bindtap='toedittel' data-origintel='{{userlist.phone}}'>
      <text>{{userlist.phone}}</text>
      <image src='/images/my/tonext.png' class='tonextimg'></image>
    </view>
  </view>
  <view class='baseone flex nowrap just-con-b'>
    <view class='self-center'>收货地址</view>
    <view class='self-center addwidth' bindtap='toaddaddress' data-towhich='add'>
      <image src='/images/my/addadress.png' class='toadd'></image>
    </view>
  </view>
  <view class='baseone flex nowrap just-con-b' bindtap='toaddaddress' data-towhich='edit' wx:for="{{userlist.addressVOs}}" wx:key="" data-addressdetail='{{item}}'>
    <view class='self-center flex flex-1' style='width:600rpx;'>
      <view class='self-center'><image src='/images/my/location.png' class='locaimg'></image></view>
      <view class='clamp clamp-1'>{{item.province}}{{item.city}}{{item.district}}{{item.addressDetail}}</view>
    </view>
    <view class='self-center'>
      <image src='/images/my/tonext.png' class='tonextimg'></image>
    </view>
  </view>
</view>
<view class='savebtn' bindtap='saveInfo'>保存</view>,page{
  background: #EFEFF4;
}
.baselist{
  margin-top:24rpx;
  width: 750rpx;
  background: #fff;
}
.mylogo{
  width: 104rpx;
  height: 104rpx;
  border-radius: 120rpx;
  -webkit-box-shadow: #8DD4F6 0px 0px 16px;
  -moz-box-shadow: #8DD4F6 0px 0px 16px;
  box-shadow: #8DD4F6 0px 0px 16px;
}
.baseone{
  width: 750rpx;
  height: 104rpx;
  padding: 0 20rpx;
  box-sizing: border-box;
  border-bottom: 2rpx solid #EFEFF4;
}
.height140{
  height: 140rpx;
}
.tonextimg{
  width: 12rpx;
  height: 22rpx;
  margin-left: 10rpx;
  vertical-align: -2rpx;
}
.toadd{
  width: 34rpx;
  height: 34rpx;
  vertical-align: middle;
}
.locaimg{
  width: 28rpx;
  height: 36rpx;
  vertical-align: middle;
  margin-right: 10rpx;
}
.addwidth{
  width: 200rpx;
  text-align: right;
}
.toedit{
  height: 104rpx;
  line-height: 104rpx;
}
.savebtn{
  width: 702rpx;
  height: 80rpx;
  background: #00A6F5;
  color: #fff;
  text-align: center;
  line-height: 80rpx;
  margin:60rpx 0 0 24rpx;
  border-radius: 8rpx;
  font-size: 30rpx;
}
.basename{
  text-align: right;
  width: 600rpx;
},const app = getApp();
Page({
  data: {
    shoplist:[]
  },
  onShow: function () {
    app.HttpService.browseshop().then(res=>{
      for(let a = 0;a<res.length;a++){
        res[a].logosrc = res[a].logoId ? app.getxsimg('thumbnail', res[a].logoId) : '/images/chatLogo.png'
      }
      this.setData({
        shoplist: res
      })
    })
  },
  changeShop(e){
    let shopcode = e.currentTarget.dataset.shopcode;
    wx.setStorageSync('shopCode', shopcode)
    app.HttpService.changeshop({ shopCode : shopcode}).then(res => {
      app.logout();
      app.getToken(res).then(res=>{
        wx.switchTab({
          url: '/pages/index/index',
        })
      })    
    }).catch(e=>{
      console.error(e)
    })
  }
}),{"navigationBarTitleText": "我浏览的店铺"},<view class='shopall'>
  <view class='flex shoplist' wx:for="{{shoplist}}" wx:key=""> 
    <view class='flex self-center'>
      <view class='imagemiddle'><image src='{{item.logosrc}}' mode='aspectFit' class='shoplogo'></image></view>
      <view class='self-center shopnameloca'>
        <view class='myname clamp clamp-2'>{{item.name}}({{item.contactNo}})</view>
        <view class='myloca flex'>
          <image src='/images/my/location.png' class='locaimg'></image> 
          <view class='mylocadetail overpoint'>{{item.addressVOs[0].fullAddress}}</view>
        </view>
      </view>
      <view class='inshop self-center item-bottom' bindtap='changeShop' data-shopcode='{{item.code}}'>进店逛逛</view>
    </view>
  </view>
</view>
,page{
  background: #EFEFF4;
}
.shopall{
  margin-top:24rpx;
}
.shoplist{
  padding: 24rpx 20rpx;
  box-sizing: border-box;
  background: #fff;
  border-bottom: 2rpx solid #EFEFF4;
}
.shopdetail{
  width: 710rpx;
}
.shoplogo{
  width: 100rpx;
  height: 100rpx;
  margin-right: 20rpx;
}
.shopnameloca{
  width:420rpx; 
  margin-right: 20rpx;
}
.inshop{
  width: 150rpx;
  height: 64rpx;
  line-height: 64rpx;
  text-align: center;
  color: #00A6F5;
  border:2rpx solid #00A6F5;
  border-radius: 8rpx;
}
.locaimg{
  width: 28rpx;
  height: 36rpx;
  vertical-align: middle;
  margin-right: 10rpx;
}
.myname{
  font-size: 26rpx;
  color: #333;
  line-height: 40rpx;
}
.myloca{
  margin-top:10rpx;
}
.mylocadetail{
  width: 380rpx;
  font-size: 22rpx;
  color: #333;
},const app = getApp();
var codetime = 1;
Page({
  data: {
    origintel: '',
    telval:'',
    countdown: 60,
    codehidden: true,
    texttip: '获取验证码',
    code: '',
    phone: '',
    msgtelobj:{}
  },
  onLoad: function(options) {
    if (Object.keys(options).length==0){//我的-修改电话
      this.setData({
        code: wx.getStorageSync('code'),
        origintel: app.globalData.loginInfo.phone,
      }) 
    }else{//消息-修改电话
      let msgtelobj = JSON.parse(options.msgtelobj);
      this.setData({
        code: wx.getStorageSync('code'),
        origintel: app.globalData.loginInfo.phone,
        telval: msgtelobj.tel,
        msgtelobj: msgtelobj
      }) 
    }
      
  },
  onShow: function() {
    codetime = 1;
  },
  cutdowntime: function() {
    var that = this;
    var t = 60;
    codetime += 1;
    var time = function() {
      t -= 1;
      if (t == 0) {
        clearInterval(times);
        that.setData({
          texttip: '重新发送',
          codehidden: true,
          countdown: t
        })
      } else {
        that.setData({
          texttip: '获取验证码',
          countdown: t,
          codehidden: false
        })
      }
    }
    var times = setInterval(time, 1000);
  },
  gettel(e) {
    this.setData({
      phone: e.detail.value
    })
    if (!e.detail.value) {
      wx.showToast({
        title: '手机号码不能为空！',
        icon: 'none'
      });
    }
  },
  getCode: function() {
    if (!this.data.phone) {
      wx.showToast({
        title: '手机号码不能为空！',
        icon: 'none'
      });
      return;
    }
    var that = this;
    if (!that.data.codehidden) {
      return false;
    }
    var dataobj = { 
      count: codetime,
      phone: this.data.phone,
      areacode: '86',
      code: this.data.code,
    };
    app.HttpService.getValidcodeMsg(dataobj).then((res) => {
      that.cutdowntime();
    }).catch(e=>{
      wx.showToast({ 'title': e, icon: 'none' })
    })
  },
  formsubmitpwd: function(e) {
    let that = this
    if (e.detail.value.codename && e.detail.value.tel){
      let param = {
        count: codetime,
        areacode:'86',
        phone: e.detail.value.tel,
        validcode: e.detail.value.codename,
      }
      if (this.data.msgtelobj.ownerid){
        param.ownerId = this.data.msgtelobj.ownerid
      }
      app.HttpService.editusertel(param).then((res) => {
        if (Object.keys(that.data.msgtelobj).length > 0){//消息-修改电话号码，忽略此条消息
          let obj ={
            id: that.data.msgtelobj.id,
            messageType: 'cloudShopRemind'
          }
          app.HttpService.readmsg(obj).then(res => {
          }).catch(error => {
            wx.showToast({ 'title': error, icon: 'none' })
          })
        }
        wx.showToast({
          title: '修改成功！',
          icon: 'none'
        });
        wx.navigateBack({})
      }).catch(e => {
        wx.showToast({ 'title': e, icon: 'none' })
      })
    }else{
      wx.showToast({
        title: '手机号码或验证码不能为空！',
        icon: 'none'
      });
    }    
  }
}),{"navigationBarTitleText": "更换电话号码"},<view>
  <form bindsubmit='formsubmitpwd'>
    <view class='pwdcontent'>
      <view class='pwdlist imgposition'>
        <image src='/images/my/mytel.png' class='mytelimg'></image>
        <input placeholder='请输入手机号码' placeholder-class='placecolor' type="number" maxlength='11' bindinput='gettel' type='number' name="tel" value='{{telval}}'></input>
      </view>
      <view class='pwdlist imgposition'>
        <image src='/images/my/mycode.png' class='mytelimg'></image>
        <view><input placeholder='请输入验证码' placeholder-class='placecolor' name="codename"></input></view>
        <view class='getcode imgcodeposition' bindtap='getCode'><text hidden='{{!codehidden}}'>{{texttip}}</text><text hidden='{{codehidden}}'>({{countdown}}s)</text></view>
      </view>
    </view>
    <view class='savepwd'>
      <button form-type='submit'>确认</button>
    </view>
  </form>  
</view>
<view class='editteltip'>
  <view class='teltip'>更换手机号码{{origintel}}将会更新以下功能</view>
  <view class='flex just-con-c margintop36'>
    <view class='marginright100'>
      <view class='textcenter'><image src='/images/my/salertel.png' class='saletelimg'></image></view>      
      <view class='saleteltext'>上游卖家的通讯录</view>
    </view>
    <view>
      <view class='textcenter'><image src='/images/my/tellogo.png' class='saletelimg'></image></view>     
      <view class='saleteltext'>手机号码登录</view>
    </view>
  </view>
</view>

,page{
  background: #EFEFF4;
}
.pwdcontent{
  background: #fff;
  width: 750rpx;
  margin-top:24rpx;
}
.pwdlist{
  margin:0 22rpx;
  height: 104rpx;
  line-height: 104rpx;
  display: flex;
  flex-flow:row nowrap;
  justify-content:flex-start;
  align-items:center;
  border-bottom: 1px solid #EFEFF4;
  font-size: 30rpx;
} 
.imgposition{
  position: relative;
}
.imgcodeposition{
  position: absolute;
  top:20rpx;
  right: 20rpx;
  z-index: 9999;
}
.pwdtitle{
  width: 200rpx;
}
.placecolor{
  color: #C8C8C8;
  font-size: 28rpx;
}
.pwdlist input{
  height: 104rpx; 
}
.widthpo{
  width: 260rpx;
}
.pwdinput{
  width: 280rpx;
}
.getcode{
  line-height: 26rpx;
  background: #00A6F5;
  padding: 16rpx;
  white-space:nowrap;
  text-align: center;
  font-size: 26rpx;
  color: #fff;
  border-radius: 8rpx;
  box-sizing: border-box;
}
.savepwd button{
  width: 694rpx;
  height: 80rpx;
  line-height: 80rpx;
  text-align: center;
  background: #00A6F5;
  color: #fff;
  margin-top:62rpx; 
}
.codeimg{
  width: 176rpx;
  height: 64rpx;
}
.mytelimg{
  width: 36rpx;
  height: 36rpx;
  margin-right: 10rpx;
}
.teltip{
  font-size: 24rpx;
  color: #999;
  text-align: center
}
.editteltip{
  position: absolute;
  width: 714rpx;
  bottom: 92rpx; 
  left: 18rpx;
}
.telicon{
  margin-top:36rpx;
}
.textcenter{
  text-align: center;
}
.marginright100{
  margin-right:100rpx;
}
.margintop36{
  margin-top: 36rpx;
}
.saletelimg{
  width: 30rpx;
  height: 30rpx;
}
.saleteltext{
  font-size: 14rpx;
  color: #999;
},let t_x = 0;
let t_y = 0;
let timeInterval;
let times = 0;
let app = getApp()
Page({
  data: {
    move: [false, false],
    addressList: [],
    pageSize: 10,
    pageNum: 1,
    allPages: 0,
    addrId:0,
    addrData:null,
    cloudShopVO:null,
    userInfo:null,
    addrStatus:null,
    isOper:true,
    chosMore:false
  },
  //事件处理函数
  bindViewTap: function() {

  },
  onLoad: function(options) {
    console.log(options)
    let that=this
    let status = options.status
    let owner = wx.getStorageSync('owner')
    let userInfo = app.globalData.loginInfo
    let addrId = this.data.addrId
    let addrData = this.data.addrData
    let _status=null, _owner, _userInfo,chosMore=false
    if (status) {
      if (status =='confirmorder'){
        addrData = options.data? JSON.parse(options.data):[]
        chosMore=true
      } else {
        addrId = options.id
      }
      _status = status
    }
    if (owner){
      _owner = owner.cloudShopVO
    }
    if (userInfo){
      _userInfo = userInfo
    }
    this.setData({
      userInfo: _userInfo,
      cloudShopVO: _owner,
      addrStatus: _status,
      addrId: addrId,
      addrData: addrData,
      chosMore: chosMore
    },function(){
      that.getAddress()
      
    })
  },
  onShow: function() {
    if (this.data.addrStatus!='send'){
      this.userinfo()
    }
  },
  onHide: function() {
    this.reSetList()
  },
  sureAddr: function() {
    var pages = getCurrentPages();
    let addressList = this.data.addressList
    let addr = null
    let list = []
    for (let i in addressList) {
      if (addressList[i].isdefault) {
        list.push(addressList[i])
      }
    }
    if (list.length > 0) {
      addr = list
    }else{
      app.AcFunc.myTotal('请选择地址后再保存',2000)
      return
    }
    if (pages.length > 1) {
      var prePage = pages[pages.length - 2];
      prePage.changeData(addr, this.data.addrStatus)
    }
    wx.navigateBack({})
  },
  getAddress: function() {
    
    let that=this
    let isOper=true
    let addrStatus = this.data.addrStatus
    let cloudShopVO = this.data.cloudShopVO
    let userInfo = this.data.userInfo
    let id = this.data.addrId
    let addrData = this.data.addrData
    let addressList=[]
    if (addrStatus == 'confirmorder' || addrStatus =='delivery'){
      addressList = userInfo.addressVOs 
      that.setData({
        addressList: addressList,
        isOper: isOper
      })
    }else{
      this.getCloudShopInfo()
    }
    
   
  },
  touchstart: function(e) {
    if (!this.data.isOper){
      return
    }
    t_x = e.touches[0].pageX;
    t_y = e.touches[0].pageY; // 获取触摸时的原点
    // timeInterval = setInterval(function() {
    //   times++;
    // }, 50);
  },
  touchend: function(e) {
    if (!this.data.isOper) {
      return
    }
    let index = e.currentTarget.dataset.index;
    let touchMoveX = e.changedTouches[0].pageX;
    let touchMoveY = e.changedTouches[0].pageY;
    let addressList = this.data.addressList
    let tmX = touchMoveX - t_x;
    let tmY = touchMoveY - t_y;
    let absX = Math.abs(tmX);
    let absY = Math.abs(tmY);
    if (absX > 2 * absY && absX > 5) {
      if (tmX < 0) {
        console.log("左滑=====")
        addressList[index].left = -132
      } else {
        console.log("右滑=====")
        addressList[index].left = 0
      }
    }

    this.setData({
      addressList: addressList
    })
    t_y = 0
    t_x = 0
    times = 0
  },
  radioChange: function(e) {
    console.log(e)
    let addressList = this.data.addressList
    for (let i in addressList) {
      addressList[i].isdefault = addressList[i].id === parseInt(e.detail.value)
    }
    this.setData({
      addressList: addressList
    })
  },
  addAddr: function(e) {
    wx.navigateTo({
      url: '/pages/address/address',
    })
  },
  editAddr: function(e) {
    let ind = e.currentTarget.dataset.index
    let addressList = this.data.addressList
    let addr = JSON.stringify(addressList[ind])
    wx.navigateTo({
      url: '/pages/address/address?addr=' + addr,
    })
  },
  delAddr: function(e) {
    let that = this
    let ind = e.currentTarget.dataset.index
    let id = e.currentTarget.dataset.id
    let addressList = this.data.addressList
    let addrVO = addressList[ind]
    let pamars = [addrVO.id]
    wx.showModal({
      title: '删除地址',
      content: '确认删除这个地址吗？',
      success: (res) => {
        if (res.confirm) {
          app.HttpService.addrDelete(pamars).then((res) => {
            console.log(res)
            that.userinfo()
          }).catch((res) => {

          })
          that.setData({
            addressList: addressList,
          })
        } else {

        }
      }
    })

  },
  changeAddress: function(data) {
    this.setData({
      addressList: data
    })
  },
  chooseAddr: function(e) {
    let addressList = this.data.addressList
    let ind = e.currentTarget.dataset.index
    let isdefault = addressList[ind].isdefault
    let chosMore = this.data.chosMore
    if (chosMore){
      if (isdefault) {
        addressList[ind].isdefault = false
      } else {
        addressList[ind].isdefault = true
      }
    }else{
      for (let i in addressList) {
        if (i == ind) {
          addressList[i].isdefault = true
        } else {
          addressList[i].isdefault = false
        }

      }
    }
   
    this.setData({
      addressList: addressList
    })
  },
  reSetList: function() {
    let addressList = this.data.addressList
    for (let i in addressList) {
      addressList[i].left = 0
    }
    this.setData({
      addressList: addressList
    })
  },
  onReachBottom:function(){
    let pageNum = this.data.pageNum
    let allPages = this.data.allPages
    if (pagenum < allPages){
      pagenum++
    }else{
      app.AcFunc.myTotal('没有更多地址了，请新增地址', 'none')
    }
    this.setData({
      pagenum: pagenum
    })
    this.getAddress()
  },
  setAddrChos:function(){
    let addrId = this.data.addrId
    let addrStatus = this.data.addrStatus
    let addrData = this.data.addrData
    let addressList=this.data.addressList
    if (addrStatus == 'confirmorder') {
      for (let i in addressList) {
        addressList[i].isdefault = false
        for (let j in addrData) {
          if (addressList[i].id == addrData[j].id) {
            addressList[i].isdefault = true
          }
        }
      }
    } else {
      for (let i in addressList) {
        if (addressList[i].id == addrId) {
          addressList[i].isdefault = true
        } else {
          addressList[i].isdefault = false
        }
      }
    }
    this.setData({
      addressList: addressList
    })
  },
  userinfo: function () {
    let that = this
    app.HttpService.userInfo().then((res) => {
      console.log(res)
      that.setData({
        addressList: res.addressVOs
      },()=>{
        that.setAddrChos()
      })
      app.globalData.loginInfo = res
    }).catch((error) => {
      console.log(error)
    })
  },
  getCloudShopInfo:function(owner){
    let _code=wx.getStorageSync('shopCode')
    let code = this.data.cloudShopVO.code
    if (_code){
      code=_code
    }
    let that=this
    app.HttpService.notokenGetUser(code).then(res => {
      console.log(res)
      that.setData({
        cloudShopVO: res,
        addressList: res.addressVOs,
        isOper:false
      },()=>{
        that.setAddrChos()
      })
    })
  }
}),{"navigationBarTitleText": "选择地址"},<view class='container'>
    <view class='addressList'>
        <view class="goodmod" wx:for="{{addressList}}" wx:key="">
            <view class="goodbox flex" data-index='{{index}}' bindscroll="getleft" bindtouchstart='touchstart' bindtouchend='touchend' bindtap='chooseAddr' style="left:{{item.left}}px">
                <view class='flex-1 self-center overpoint'>
                    {{item.province}}{{item.city}}{{item.district}}{{item.addressDetail}}
                </view>
                <view class='radio self-center'>
                    <!-- <radio value="{{item.id}}" checked="{{item.isdefault}}" color='#FFBC51'/> -->
                    <image mode='widthFix' src='/images/common/{{item.isdefault?"checked":"uncheck"}}.png'></image>
                </view>
            </view>
            <view class="goodOper flex">
                <text class='edit' data-index='{{index}}' data-id='{{item.id}}' bindtap='editAddr'>编辑</text>
                <text class='delete' data-index='{{index}}' data-id='{{item.id}}' bindtap='delAddr'>删除</text>
            </view>
        </view>
    </view>
    <view class='footBtn flex'>
        <view wx:if='{{addrStatus!="send"}}' class='flex-1 addadress btnaddress' bindtap='addAddr'>新建地址</view>
        <view class='flex-1 saveadress btnaddress' bindtap='sureAddr'>保存</view>
    </view>
</view>,.container{
  padding-bottom: 120rpx;
}
.addressList{
  margin-top:24rpx;
  background: #fff;
}
.footBtn{
  position: fixed;
  background: #efeff4;
  width: 100%;
  bottom:0;
  padding:20rpx 10rpx;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  z-index: 10
}
.footBtn button{
  width: 100%;
  padding:0;
}
.goodmod {
  border-bottom:1px solid #f2f2f2;
  width: 100%;
  height:140rpx;
  white-space: nowrap;
  overflow: hidden;
  position: relative;
}

.goodbox {
  height: 100%;
  width: 100%;
  white-space: nowrap;
  background: #fff;
  position: absolute;
  top:0;
  left:0;
  z-index: 2;
  padding:20rpx;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  color:#666;
  transition: left 0.2s ease; 
}
.goodbox .radio{
  padding-left:20rpx;
}
.goodbox .radio image{
  width: 50rpx;
}
.goodOper {
  position: absolute;
  height: 140rpx;
  line-height: 140rpx;
  vertical-align: top;
  right:0;
}
.addrBox{
  height:100rpx;
}
.goodOper text {
  display: inline-block;
  height: 100%;
  width: 66px;
  text-align: center;
  color:#fff;
}
.goodOper text.edit{
  background: #ddd;
}
.goodOper text.delete{
  background: #FE3824;
}
.btnaddress{
  width: 340rpx;
  height: 80rpx;
  border-radius: 8rpx;
  line-height: 80rpx;
  text-align: center;
  font-size: 30rpx;
  border:1px solid #00A6F5;
  margin:0 10rpx;
}
.addadress{
  color:#00A6F5;
  
}
.saveadress{
  background: #00A6F5;
  color: #fff;
}
/* .move {
  animation: moveleft 0.5s ease;
  -webkit-animation: moveleft 0.5s ease;
  animation-fill-mode: forwards;
  -webkit-animation-fill-mode: forwards;
}
.remove{
  animation: moveright 0.5s ease;
  -webkit-animation: moveright 0.5s ease;
  animation-fill-mode: forwards;
  -webkit-animation-fill-mode: forwards;
}

@keyframes moveleft {
  from {
    left: 0;
  }

  to {
    left:-264rpx;
  }
}

@-webkit-keyframes moveleft {
  from {
    left: 0;
  }

  to {
    left:-264rpx;
  }
}
@keyframes moveright {
  from {
    left:-264rpx;
  }

  to {
    left:0;
  }
}

@-webkit-keyframes moveright {
  from {
    left:-264rpx;
  }

  to {
    left:0;
  }
} */
,let downanimation = wx.createAnimation({
  duration: 300,
  timingFunction: 'ease',
})
let moreanimation = wx.createAnimation({
  duration: 300,
  timingFunction: 'ease',
})
const app=getApp()
const util = require('../../../utils/util.js')
Page({
  data: {
    showProList: false,
    LogistMsg: null,
    downAnimate: {},
    moreAnimate: {},
    enclosure: [],
    address:null,
    logistList:[],
    orderNumber:'',
    orderTime: util.getToday('day'),
    remark:'',
    delyWay: "selfLogistic",//ydcfoLogistic 
    fileInfoIds:[],
    details:null,
    client:null,
    totalPrice:0.00,
    logisticOrderList:[],
    owner:{},
    setting:{},
    chosLogistText: '选秒账物流，享运费八折（线下退，最高减100元/单）'
  },
  onLoad: function (options) {
  
    let prods = options.cartdata
    let totalPrice = options.totalPrice
    let details = null, _userInfo=null
    if (prods){
      details= JSON.parse(prods)
      console.log(details)
    }else{
      wx.switchTab({
        url: '/pages/cart/cart',
      })
    }
    let owner = wx.getStorageSync('owner')
    this.setData({
      details: details,
      totalPrice: totalPrice,
      owner:owner
    })   
    this.userinfo();
    this.getOrderNumber('YDXS')
  },
  onReady: function () {
    
  },
  onShow: function () {
    
  },
  onUnload:function(){
    let details = this.data.details
    let againOrder = wx.getStorageSync('againOrder')
    if (againOrder) {
      wx.setStorageSync('againOrder', againOrder)
    }else{
      if (details) {
        wx.setStorageSync('againOrder', details)
      }
    }
    
  },
  onPullDownRefresh: function () {

  },
  uploadFile: function () {
    let enclosure = this.data.enclosure
    let that = this
    let fileInfoIds = this.data.fileInfoIds
    wx.chooseImage({
      count: 1,
      sizeType: ['original', 'compressed'],
      sourceType: ['album', 'camera'],
      success(res) {
        const tempFilePaths = res.tempFilePaths
        wx.uploadFile({
          url: app.getUploadUrl(),
          filePath: tempFilePaths[0],
          name: 'file',
          formData: {
          },
          success(res) {
            const data = JSON.parse(res.data)
            console.log(data)
            if (data.errorCode==0){
              fileInfoIds.push(data.data.id)
              enclosure.push(tempFilePaths[0])
            }
            that.setData({
              fileInfoIds: fileInfoIds,
              enclosure: enclosure
            })
          },
          fail(error){
            console.log(error)
          }
        })
      }
    })
  },
  operPic: function (e) {
    let ind = e.currentTarget.dataset.index
    let enclosure = this.data.enclosure
    let fileInfoIds = this.data.fileInfoIds
    let that = this
    wx.showActionSheet({
      itemList: ['删除'],
      success(res) {
        let tapIndex = res.tapIndex
        if (tapIndex == 0) {
          enclosure.splice(ind, 1)
          fileInfoIds.splice(ind, 1)
          that.setData({
            enclosure: enclosure,
            fileInfoIds: fileInfoIds
          })
        }
      },
      fail(res) {
        console.log(res.errMsg)
      }
    })
  },
  showMoreLogist: function () {
    let showMoreLogist = this.data.showMoreLogist
    if (showMoreLogist) {
      showMoreLogist = false
      moreanimation.rotate('0').step()
    } else {
      showMoreLogist = true
      moreanimation.rotate('180').step()
    }
    this.setData({
      moreAnimate: moreanimation.export(),
      showMoreLogist: showMoreLogist
    })
  },
  shooseAddr:function(){
    let address=this.data.address
    if(address){
      address = JSON.stringify(this.data.address)
    }else{
      address=null
    }
    wx.navigateTo({
      url: '/pages/order/addressList/index?status=confirmorder&data=' + address,
    })
  },
  changeData:function(addr,status){
    if (status =='confirmorder'){
      this.setData({
        address: addr
      })
    }
  },
  remarkChange:function(e){
    let val = e.detail.value
    console.log(val)
    this.setData({
      remark:val
    })
  },
  
  getParams:function(){
    let _data=this.data
    let that=this
    let address = _data.address
    let owner = wx.getStorageSync('owner')
    let details = this.data.details
    let cloudShop = owner.cloudShopVO
    let unitFlag = owner.ownerItemVO.unitFlag
    let delyWay = _data.delyWay
    let orderNumber = _data.orderNumber
    let logisticOrderList=[],_address=[],_details=[]
    for (let i in details){
      let _obj = {}
      _obj.colorId = details[i].colorId
      _obj.unitRate = details[i].unitRate ? details[i].unitRate:1
      _obj.prodId = details[i].prodId
      _obj.orderCartId = details[i].id
      _obj.qty = details[i].qty
      _obj.displayQty = details[i].qty
      _obj.eachCarton = details[i].eachCarton
      _obj.cartons = details[i].cartons
      _obj.sequence = parseInt(i)
      _obj.specId = details[i].specId
      _obj.unitId = unitFlag?details[i].unitId:0
      _obj.unitPrice = details[i].unitPrice ? details[i].unitPrice:0.00
      _obj.amountFormula = details[i].amountFormula ? details[i].amountFormula:"qty * unitPrice"
      _obj.inventoryFormula = details[i].inventoryFormula ? details[i].inventoryFormula :"qty"
      _details.push(_obj)
    }
    if (address&&address.length>0){
      for (let i in address) {
        delete address[i].isdefault
        delete address[i].left
        _address.push(address[i].id)
      }
    }else{
      app.AcFunc.myTotal('请选择收货地址','none');
      return false
    }
    delete owner.cloudShopVO
    delete owner.id
    delete owner.ownerId
    if (delyWay =='selfLogistic'){
      logisticOrderList=[]
    }else{
      logisticOrderList = this.data.logisticOrderList
    }
    if (!orderNumber){
      app.AcFunc.myTotal('亲，订单编号生成失败,正在重新生成单号,稍后再确认订单！', 'none');
      setTimeout(()=>{
        that.getOrderNumber('YDXS')
      },1500)
      return false
    }
    owner.productPermissionVO = cloudShop.productPermissionVO
    let pamaras = {
      delyWay: delyWay,
      cloudStatus:'waitReceive',
      orderNumber: orderNumber,
      orderDate: util.getToday('day'),
      remark: _data.remark,
      cloudShopFileInfoIds: this.data.fileInfoIds.join(','),//附件id
      details: _details,
      clientAddrIdList: _address,
      clientId: this.data.client.id,
      salesLogisticOrderList :logisticOrderList,
      ownerCfg: owner,
      //xsShopId: cloudShop.id,
      contractAmt: this.data.totalPrice
    }
    return pamaras
  },
  cancelOrder:function(){
    wx.navigateBack({})
  },
  confirmOrder:function(){
    let pamars = this.getParams()
    console.log(pamars)
    if (pamars){
      app.HttpService.orderCreate(pamars).then((res) => {
        console.log(res)
        //res=JSON.stringify(res)
        wx.removeStorageSync('againOrder')
        wx.reLaunch({
          url: '/pages/order/orderSuccess/index?id=' + res.id,
        })
      }).catch((error) => {
        console.log(error)
        app.AcFunc.myTotal(error,'none')
      })
    }
  },
  userinfo: function () {
    let that = this
    //let info=app.globalData.loginInfo
    let address=[]
    // if(info.id){
    //   if (info.addressVOs.length>0){
    //     address.push(info.addressVOs[0])
    //   }
    //   that.setData({
    //     client: info,
    //     address: address
    //   })
    // }else{
      app.HttpService.userInfo().then((res) => {
        console.log(res)
        if (res.addressVOs.length > 0) {
          address.push(res.addressVOs[0])
        }
        that.setData({
          client: res,
          address: address
        })
        app.globalData.loginInfo = res
      }).catch((error) => {
        console.log(error)
      })
    //}
    
  },
  operData:function(logistData){
    let that=this
    let logisticOrderList = this.data.logisticOrderList
    let logistList = this.data.logistList
    let reset=false
    logistData = app.AcFunc.changeObjStatus(logistData)
    if (logistList.length>0){
      for (let i = 0; i < logistList.length;i++){
        if (logistList[i].id == logistData.id){
          reset=true
          logistList[i]=logistData
          break
        }
      }
    }
    let _obj = {}
    if (reset){
      
    }else{
      _obj.id = logistData.id
      _obj.orderNo = logistData.orderNo
      logisticOrderList.push(_obj)
      logistList.push(logistData)
    }
    this.setData({
      logisticOrderList: logisticOrderList,
      logistList: logistList,
      delyWay:'ydcfoLogistic'
    })
  },
  /**获取单号 */
  getOrderNumber(name, len) {
    let pamars = {
      prefix: name,
      length: len ? len : 4
    }
    let that=this
    let orderNumber = ''
    getApp().HttpService.orderNumber(pamars).then((res) => {
      that.setData({
        orderNumber: res,
        setting:app.P()
      })
    }).catch((error) => {
      app.AcFunc.myTotal(error, 'none');
    })

  },
  chooseLogist:function(){
    let that=this
    let logistList = this.data.logistList
    let address=this.data.address
    if (address){
      address = JSON.stringify(address)
    }
    wx.showActionSheet({
      itemList: ['自行配送','秒账物流'],
      success:(res)=>{
        console.log(res.tapIndex)
        let sheetInd = res.tapIndex
        if(sheetInd==0){
          if (logistList.length > 0) {
              return
          }
        }else{
           wx.navigateTo({
             url: '/pages/order/logistEdit/index?address=' + address,
           })
        }
      },
      fail:(res)=>{
        console.log(res.errMsg)
      }
    })
  },
  logistDetail: function (e) {
    let id = e.currentTarget.id
    wx.navigateTo({
      url: '/pages/order/logistDetail/logistDetail?id=' + id,
    })
  }
}),{
  "navigationBarTitleText": "确认订单"
},<view class='container'>
    <view class='detailMod addressMod flex' bindtap='shooseAddr'>
        <view class='flex-1 overflow'>
            <view class='addritem'>
                <view class='fs16'>
                    <text>{{client.name}}</text>
                    <text>{{client.phone}}</text>
                </view>
                <block wx:if="{{address}}">
                    <view wx:for='{{address}}' wx:key='{{item.id}}' class='c666 fs12 overpoint'>
                        {{item.province}}{{item.city}}{{item.district}}{{item.addressDetail}}
                    </view>
                </block>
                <block wx:else>
                    <view class='text c999'>请选择收货地址</view>
                </block>
            </view>
        </view>
        <view class='morLink self-center'>
            <icon class='iconfont icon-Right'></icon>
        </view>
        <view class="addressLine">
            <image src='/images/order/addressLine.png' mode='aspectFit'></image>
        </view>
    </view>
    <view class='detailMod delivery'  wx:if='{{setting.mzLogisticsFlag}}'>
        <view bindtap='chooseLogist' class='chooseLog flex'>
            <view class='flex-1'>
                <view>送货方式</view>
                <text wx:if='{{logistList.length<1}}' class='tips'>{{chosLogistText}}</text>
            </view>
            <view class='self-top clearfix'>
                <text class='float-left'>{{logistList.length>0?"秒账物流":"自行配送"}}</text>
                <icon class='iconfont icon-Right'></icon>
            </view>
        </view>
        <view class='logistMod' wx:if="{{logistList.length>0}}">
            <view class='logistList' wx:for='{{logistList}}' wx:key='{{item.id}}' wx:if='{{index<2}}'  id='{{item.id}}' bindtap='logistDetail'>
                <view class='flex'>
                    <view class='flex-1 fs12 c666 self-center'>{{item.enterpriseVO.name}}, 物流单号:{{item.orderNo}}</view>
                    <view class='orderState'>
                     <image src='/images/order/{{item.paymentStatus}}{{item.orderStatus}}.png'></image>
                        <!-- <view class='state state_{{item.orderStatus}}'>
                            <icon class="iconfont icon-{{item.orderStatus}}"></icon>
                            <view class="text">
                                <text wx:if='{{item.paymentStatus=="unpaid"&&item.orderStatus!="wait"}}'>未支付</text>
                                <text>{{item.statusDesc}}</text>
                            </view>
                        </view> -->
                    </view>
                </view>
                <view class='fs12 c666'>卸货网点:{{item.detailVO.unloadAddressVO.fullAddress}}</view>
                <view class='fs12 c666'>电话:{{item.detailVO.consignorContactNo}}，预估到货时间:{{item.detailVO.planArriveDate}}</view>
            </view>
            <view class='logistMore' bindtap='showMoreLogist' wx:if='{{logistList.length>2}}'>
                <icon class='iconfont icon-open' animation="{{moreAnimate}}"></icon>
                <text class='fs12'>展开</text>
            </view>
        </view>
    </view>
    <view class='detailMod uploadImg clearfix'>
        <view class='imgList'>
            <view class='picBox' wx:for="{{enclosure}}" wx:key="" data-index="{{index}}" bindtap='operPic'>
                <image src='{{item}}'></image>
            </view>
            <view class='uploadBtn' bindtap='uploadFile'>
              <icon class='iconfont icon-camera'></icon>
            <view class='fs12'>上传附件</view>
        </view>
        </view>
        
    </view>
    <view class='detailMod remark'   wx:if='{{setting.remarkFlag}}'>
         <input class='textArea' placeholder='备注' bindinput='remarkChange'></input>
    </view>
    <view class='detailMod'>
        <view>订单信息</view>
        <view class='c666 fs12'>订单时间: {{orderTime}}</view>
        <view class='c666 fs12'>订单编号: {{orderNumber}}</view>
    </view>
</view>
<view class='detailbottom flex'>
    <view class='cancelBtn flex-1' bindtap='cancelOrder'>取消</view>
    <view class='sureBtn flex-1' bindtap='confirmOrder'>确认</view>
</view>,.container {
  padding-bottom: 100rpx;
}

.detailMod {
  background: #fff;
  margin-bottom: 24rpx;
  padding: 20rpx 20rpx 10rpx;
}
.addressMod{position: relative;}
.addressMod .addritem{
  border-bottom: 1px solid #f2f2f2;
  padding-bottom:10rpx;
  margin-bottom:10rpx;
}
.addressMod .addritem:last-child{
  border-bottom: 0;
}
.addressMod .addressLine{
  position: absolute;
  width: 100%;
  height:10rpx;
  overflow: hidden;
  bottom:0;
  left:0;
}
.addressMod .addressLine image{
  height:100%;
  width: 100%;
  vertical-align: top;
}
.addressMod .text{line-height: 60rpx;}
.addressMod text {
  display: inline-block;
  margin-right: 40rpx;
}

.addressMod .morLink {
  padding-left: 20rpx;
}

.addressMod .morLink .icon-Right {
  font-size: 28rpx;
  line-height: 60rpx;
}

.prodMod {
  padding: 0;
}

.prodMsg {
  padding: 20rpx;
}

.showList {
  position: relative;
  padding-right: 40rpx;
}

.prodMsg .icon-Down {
  position: absolute;
  right: 0;
  top: 6rpx;
  line-height: 100%;
  font-size: 24rpx;
}

.prodMsg .icon-Down:before {
  float: left;
}

.proDetail {
  padding: 20rpx;
  border-bottom: 1px dashed #efeff4;
}

.proDetail .price {
  margin-top: 20rpx;
}

.proList {
  border-top: 1px solid #efeff4;
}

.proList image {
  display: inline-block;
  height: 130rpx;
  width: 130rpx;
  margin-right: 20rpx;
}

.operInput input {
  width: 92rpx;
}

.numList {
  padding: 10rpx 20rpx;
}

.numList .flex {
  margin: 10rpx 0;
}
/**/
.delivery{
   padding:0;
}
.delivery .chooseLog{
  padding:20rpx;

}
.delivery .chooseLog icon {
  float: right;
  font-size: 24rpx;
  height: 48rpx;
  width: 48rpx;
  position: relative;
}

.delivery .chooseLog icon:before {
  position: absolute;
  right: 0;
  top: 4rpx;
}
.logistMod .logistList{
  padding:20rpx;
  border-top:1px solid #EFEFF4;
}
.logistMod .logistMore{
  text-align: center;
  border-top:1px solid #EFEFF4;
  color:#999;
  line-height: 60rpx;
}
.logistMod .logistMore icon{
  vertical-align: middle;
}


/*上传附件*/
.uploadImg {
  padding: 10rpx;
}

.uploadImg .imgList {
  overflow: hidden;
}

.uploadImg .imgList .picBox {
  position: relative;
  float:left;
  width: 120rpx;
  height: 120rpx;
  margin: 10rpx;
}

.uploadImg .imgList image {
  width: 120rpx;
  height: 120rpx;
}

.uploadImg .uploadBtn {
  float: left;
  margin: 10rpx;
  height: 120rpx;
  width: 120rpx;
  text-align: center;
  background: #f2f2f2;
}

.uploadImg icon {
  font-size: 48rpx;
  color: #999;
}

.remark textarea {
  width: 100%;
  height: 100rpx;
}

.detailbottom {
  height: 100rpx;
  position: fixed;
  width: 100%;
  bottom: 0;
  left: 0;
  background: #fff;
  border-top: 1px solid #f2f2f2;
  text-align: center;
  box-shadow: -2px -2px 5px rgba(0,0,0,0.1);
  -webkit-box-shadow: -2px -2px 5px rgba(0,0,0,0.1);
  z-index:90;
}

.detailbottom .cancelBtn, .detailbottom .sureBtn {
  font-size: 30rpx;
  line-height: 100rpx;
  color: #666;
}

.detailbottom .cancelBtn {
  color: #999;
  background: #f2f2f2;
}

.detailbottom .sureBtn {
  color: #fff;
  background: #00a6f5;
}
,const util = require('../../../utils/util.js')
const app = getApp()
let downanimate = wx.createAnimation({
  duration: 300,
  timingFunction: 'ease',
})
let goodsanimate = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let sendanimate = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let getanimate = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let discountanimate = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let timeanimate = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let date = new Date();
let hour = date.getHours()
let minute = date.getMinutes()
Page({
  data: {
    showLogist: false,
    choose: [false, false, false],
    downAnimation: {},
    goodsAnimation: {},
    sendAnimation: {},
    getAnimation: {},
    discountAnimation: {},
    timeAnimation: {},
    enclosure: [],
    fileInfoIds: [],
    showMask: false,
    props: [false, false],
    defaultAddr: false,
    logistDealer: '',
    logistCost: 0.00,
    logistAll: [],
    logistList: null,
    logistMsg: null,
    logistText: '物流路线尚未开通，敬请期待',

    logistVOMsg: null,
    discountList: null,
    /*{msg: '优惠一',isChos: false,id: 1001}, {msg: '优惠二',isChos: false,id: 1002}*/
    deliverTime: [],
    daysPageSize: 10,
    areaTime: [{
      start: hour + ':' + minute,
      end: (hour + 2) + ':' + minute,
      val: '2小时上门',
      name: '2小时',
      isChoose: false,
      disables: false
    }, {
      start: '9:00',
      end: '11:00',
      val: '9:00-11:00',
      isChoose: false,
      disables: false
    }, {
      start: '11:00',
      end: '13:00',
      val: '11:00-13:00',
      isChoose: false,
      disables: false
    }, {
      start: '13:00',
      end: '15:00',
      val: '13:00-15:00',
      isChoose: false,
      disables: false
    }, {
      start: '15:00',
      end: '18:00',
      val: '15:00-18:00',
      isChoose: false,
      disables: false
    }],
    arriveDate:'',
    chooseDay: util.getToday('day'),
    timeRange: '',
    startTime: '',
    endTime: '',
    sendTime: '',
    logistID: null,
    goodsMsg: {},
    goodsDesc: '',
    sendAddr: null,
    deliveryAddr: null,
    sendp: {
      name: '',
      tel: ''
    },
    deliverp: {
      name: '',
      tel: ''
    },
    logistNumber: '',
    deliveryFee: '0.00',
    totalAmt: '0.00',
    agreement: true,
    remark: '',
    sysGoodsType: '',
    P:{},
    dealerList:[],
    d_index:0,
  },
  onLoad: function(options) {
    let that = this
    let deliveryAddr = this.data.deliveryAddr
    let sendAddr = this.data.sendAddr
    let owner = this.data.owner
    let address = options.address
    let _owner = wx.getStorageSync('owner')
    if (address) {
      deliveryAddr = JSON.parse(address)
    }
    if (_owner) {
      sendAddr = _owner.cloudShopVO.addressVOs
    }
    app.AcFunc.get$('logistBtn').then(res => {
      this.setData({
        height: app.globalData.SystemInfo.screenHeight - res[0].height - app.globalData.SystemInfo.statusBarHeight - 80
      })
    })

    // this.WxValidate = app.WxValidate({
    //   phone: {
    //     required: true,
    //     phone: true,
    //   }
    // }, {
    //   phone: {
    //     required: '电话号码不能为空',
    //   }
    // })
    this.setData({
      sendAddr: sendAddr,
      deliveryAddr: deliveryAddr,
      P:app.P()
    })
    setTimeout(() => {
      if (sendAddr && deliveryAddr) {
        that.getLogistLine()
      }
    }, 300)
  },
  onReady: function() {
    this.getOrderNumber('YDWL')
  },
  onShow: function() {
    let allDays = util.getMyDays(this.data.daysPageSize)
    this.setData({
      deliverTime: this.setDaysVal(allDays)
    })
    this.setAreaTime()
    this.setUserInfo()
    //this.getLogistPrice()
  },
  onHide: function() {

  },
  onUnload: function() {

  },

  callLogist: function(e) {
    let tel = e.currentTarget.dataset.phone
    wx.makePhoneCall({
      phoneNumber: tel
    })
  },
  radioChange: function(e) {
    console.log(e)
  },
  discountChange: function(e) {

  },
  priceChange: function(e) {
    let val = e.detail.value
    let that = this
    val = app.AcFunc.money(val, 2, false)
    this.setData({
      deliveryFee: val
    }, function() {
      that.getTotaoPrice()
    })
  },
  agreChange: function() {
    let res = this.data.agreement
    if (res) {
      res = false
    } else {
      res = true
    }
    this.setData({
      agreement: res
    })
  },
  uploadFile: function() {
    let enclosure = this.data.enclosure
    let fileInfoIds = this.data.fileInfoIds
    let that = this
    console.log(app.uploadPath)
    wx.chooseImage({
      count: 1,
      sizeType: ['original', 'compressed'],
      sourceType: ['album', 'camera'],
      success(res) {
        const tempFilePaths = res.tempFilePaths
        wx.uploadFile({
          url: app.getUploadUrl(),
          filePath: tempFilePaths[0],
          name: 'file',
          formData: {},
          success(res) {
            const data = JSON.parse(res.data)
            console.log(data)
            if (data.errorCode == 0) {
              fileInfoIds.push(data.data.id)
              enclosure.push(tempFilePaths[0])
            }
            that.setData({
              fileInfoIds: fileInfoIds,
              enclosure: enclosure
            })
          },
          fail(error) {
            console.log(error)
          }
        })
      }
    })
  },
  operPic: function(e) {
    let ind = e.currentTarget.dataset.index
    let enclosure = this.data.enclosure
    let fileInfoIds = this.data.fileInfoIds
    let that = this
    wx.showActionSheet({
      itemList: ['删除'],
      success(res) {
        let tapIndex = res.tapIndex
        if (tapIndex == 0) {
          enclosure.splice(ind, 1)
          fileInfoIds.splice(ind, 1)
          that.setData({
            enclosure: enclosure,
            fileInfoIds: fileInfoIds
          })
        }
      },
      fail(res) {
        console.log(res.errMsg)
      }
    })
  },
  // chooseProp: function(e) {
  //   let props = this.data.props
  //   let ind = e.currentTarget.dataset.index
  //   let name = ''
  //   if (props[ind]) {
  //     props[ind] = false
  //   } else {
  //     props[ind] = true
  //   }
  //   for (let i in props) {
  //     if (i != ind) {
  //       props[i] = false
  //     }
  //   }
  //   this.setData({
  //     props: props,
  //     propsName: ind == 0 ? '重货' : '泡货'
  //   })
  // },
  fillInGoods: function(e) {
    goodsanimate.bottom('0').step()
    this.setData({
      goodsAnimation: goodsanimate.export(),
      showMask: true
    })
  },
  goodsSubmit: function(e) {
    let data = e.detail.value
    let that = this
    if (data.goodsname == '') {
      app.AcFunc.myTotal('请输入货品名称', 'none')
      return
    }
    if (data.boxnum == '') {
      app.AcFunc.myTotal('请输入货品箱数', 'none')
      return
    }
    if (data.weight == 0 && data.volume == 0){
      app.AcFunc.myTotal('重量和体积不能都为0', 'none')
      return
    }
    if (data.weight == '' && data.volume == '') {
      app.AcFunc.myTotal('重量和体积不能都为空', 'none')
      return
    }
    data.weight = data.weight == '' ? null : data.weight
    data.volume = data.volume == '' ? null : data.volume
    let goodsDesc = data.goodsname + '，' + data.boxnum + '箱' + (data.weight ? '，' + data.weight + '吨' : '') + (data.volume ? '，' + data.volume + 'm³' : '')
    this.setData({
      goodsMsg: data,
      goodsDesc: goodsDesc
    }, function() {
      that.goodsReset()
    })
    this.getLogistPrice()
  },
  goodsReset: function(e) {
    goodsanimate.bottom('-100%').step()
    this.setData({
      goodsAnimation: goodsanimate.export(),
    })
    setTimeout(() => {
      this.setData({
        showMask: false
      })
    }, 200)
  },
  addrDefault: function(e) {
    let defaultAddr = this.data.defaultAddr
    if (defaultAddr) {
      defaultAddr = false
    } else {
      defaultAddr = true
    }
    this.setData({
      defaultAddr: defaultAddr
    })
  },
  getLogistLine: function() {
    let that = this
    let sendAddr = this.data.sendAddr
    let deliveryAddr = this.data.deliveryAddr
    let dealerList=['请选择物流商']
    let d_index=0,isTop=false
    if (sendAddr && deliveryAddr) {
      let params = {
        fromAddressVO: {
          id: sendAddr[0].id,
          province: sendAddr[0].province,
          city: sendAddr[0].city,
          district: sendAddr[0].district,
          addressDetail: sendAddr[0].addressDetail
        },
        toAddressVO: {
          id: deliveryAddr[0].id,
          province: deliveryAddr[0].province,
          city: deliveryAddr[0].city,
          district: deliveryAddr[0].district,
          addressDetail: deliveryAddr[0].addressDetail
        },
      }
      app.HttpService.logistMatchLine(params).then((res) => {
        console.log(res)
        let data = res
        let _obj = [], logistList=[],logistVOMsg=null
        if (data.length > 0) {
          for (let i = 0; i < data.length;i++ ) {
            let VOLis = data[i].enterpriseSpeciallineUnloadVOList
            dealerList.push(data[i].name)
            for (let j = 0; j < VOLis.length; j++) {
              let phones = VOLis[j].contactNo.split((/[\s\,\，\;]+/))
              VOLis[j].tel = phones[0]
              VOLis[j].name = data[i].name
              VOLis[j].parid = data[i].id
              _obj.push(VOLis[j])
            }
            if (data[i].isTop) {
              isTop=true
              d_index = i+1
              logistList = VOLis,
                logistVOMsg = data[i]
            }
          }
        }else{
          app.AcFunc.myTotal('没有匹配到物流路线，换个地址再匹配吧！', 'none')
        }
        if (!isTop){
          logistList = _obj
        }
        that.setData({
          logistAll: data,
          logistList: logistList,
          dealerList: dealerList,
          d_index: d_index,
          logistVOMsg: logistVOMsg
        })
      }).catch((error) => {
        app.AcFunc.myTotal(error, 'none')
      })
    }
  },
  logistDealer: function() { //dealeranimate
    let logistAll = this.data.logistAll
    if (logistAll.length > 0) {
      
    } else {
      app.AcFunc.myTotal('物流路线暂未开通，敬请期待', 'none')
    }
  },
  chooseDealer: function(e) {
    console.log(e)
    let that=this
    let ind = parseInt(e.detail.value)-1
    if(ind<0){
      return
    }
    let logistAll = this.data.logistAll
    let logistVOMsg = logistAll[ind]
    let logistList = logistVOMsg.enterpriseSpeciallineUnloadVOList
    for (let i = 0; i < logistList.length;i++){
      logistList[i].ischose=false
    }
    this.setData({
      logistVOMsg: logistVOMsg,
      d_index: ind+1,
      logistList: logistList,
      logistMsg:null,
      logistCost:0
    },()=>{
      that.getTotaoPrice()
    })
  },
  logistMsgClick: function(e) {
    let that = this
    let id = e.currentTarget.dataset.parid
    let ind = e.currentTarget.dataset.childindex
    let logistAll = this.data.logistAll
    let logistList = this.data.logistList
    let logistMsg = []
    for (let i in logistList) {
      if (i == ind) {
        //logistMsg = logistAll[i].enterpriseSpeciallineUnloadVOList[ind2]
        logistList[i].ischose = true
        logistMsg = logistList[i]
      }else{
        logistList[i].ischose = false
      }
    }
    this.setData({
      logistList: logistList,
      logistMsg: logistMsg
    }, function() {
      that.getLogistPrice()
    })
  },
  showLogist: function() {
    let sendAddr = this.data.sendAddr
    let deliveryAddr = this.data.deliveryAddr
    let showLogist = this.data.showLogist
    let logistList = this.data.logistList
    let res = false
    if (sendAddr && deliveryAddr) {
      let len = logistList.length
      if (len > 0) {
        if (showLogist) {
          downanimate.rotate('0').step()
          res = false
        } else {
          downanimate.rotate('180').step()
          res = true
        }
        this.setData({
          downAnimation: downanimate.export(),
          showLogist: res
        })
      } else {
        app.AcFunc.myTotal('对不起，您所选择的物流路线尚未开通，敬请期待!', 'none', 3000)
      }
    } else {
      // wx.showModal({
      //   title: '提示',
      //   content: '请选择收送货地址',
      // })
      return
    }

  },

  sendMsg: function() {
    sendanimate.bottom('0').step()
    this.setData({
      sendAnimation: sendanimate.export(),
      showMask: true
    })
  },
  getMsg: function() {
    getanimate.bottom('0').step()
    this.setData({
      getAnimation: getanimate.export(),
      showMask: true
    })
  },
  setSendMsg: function() {
    sendanimate.bottom('-100%').step()
    this.setData({
      sendAnimation: sendanimate.export(),
    })
    setTimeout(() => {
      this.setData({
        showMask: false
      })
    }, 200)
  },
  setDeliverMsg: function() {
    getanimate.bottom('-100%').step()
    this.setData({
      getAnimation: getanimate.export(),
    })
    setTimeout(() => {
      this.setData({
        showMask: false
      })
    }, 200)
  },
  /**收送货人信息 */
  getSendMsg: function(e) {
    let val = e.detail.value
    if (val.name == '') {
      app.AcFunc.myTotal('请输入发货人姓名', 'none')
      return
    }
    if (val.tel == '') {
      app.AcFunc.myTotal('请输入发货人联系方式', 'none')
      return
    }
    // if (!this.WxValidate.checkObj({
    //     phone: val.tel
    //   })) {
    //   const error = this.WxValidate.errorList[0]
    //   app.AcFunc.myTotal(`${error.param} : ${error.msg}`, 'none')
    //   return false
    // }
    this.setData({
      sendp: val
    })
    this.setSendMsg()
  },
  getDeliverMsg: function(e) {
    let val = e.detail.value
    if (val.name == '') {
      app.AcFunc.myTotal('请输入收货人姓名', 'none')
      return
    }
    if (val.tel == '') {
      app.AcFunc.myTotal('请输入收货人联系方式', 'none')
      return
    }
    // if (!this.WxValidate.checkObj({
    //     phone: val.tel
    //   })) {
    //   const error = this.WxValidate.errorList[0]
    //   app.AcFunc.myTotal(`${error.param} : ${error.msg}`, 'none')
    //   return false
    // }
    this.setData({
      deliverp: val
    })
    this.setDeliverMsg()
  },

  discountChose: function() {
    discountanimate.bottom('0').step()
    this.setData({
      discountAnimation: discountanimate.export(),
      showMask: true
    })
  },
  canlelDiscount: function() {
    discountanimate.bottom('-100%').step()
    this.setData({
      discountAnimation: discountanimate.export(),
    })
    setTimeout(() => {
      this.setData({
        showMask: false
      })
    }, 200)
  },
  chooseDeliverTime: function() {
    timeanimate.bottom('0').step()
    this.setData({
      timeAnimation: timeanimate.export(),
      showMask: true
    })
  },
  sureDelivery: function() {
    this.cancelDelivery()
  },
  cancelDelivery: function() {
    timeanimate.bottom('-100%').step()
    this.setData({
      timeAnimation: timeanimate.export(),
    })
    setTimeout(() => {
      this.setData({
        showMask: false
      })
    }, 200)
  },
  setDaysVal: function(days) {
    let deliverTime = []
    for (let i in days) {

      let _obj = {
        day: days[i],
        isChoose: false
      }
      if (i == 0) {
        _obj.isChoose = true
      }
      deliverTime.push(_obj)
    }
    return deliverTime;
  },
  addOtherDays: function() {
    wx.showLoading({
      title: '加载中...',
    })
    let daysPageSize = this.data.daysPageSize;
    daysPageSize += 10
    let allDays = util.getMyDays(daysPageSize)
    console.log(allDays)
    this.setData({
      deliverTime: this.setDaysVal(allDays),
      daysPageSize: daysPageSize
    }, () => {
      wx.hideLoading()
    })
  },
  setAreaTime: function() {
    date = new Date();
    hour = date.getHours()
    minute = date.getMinutes()
    let chooseDay = this.data.chooseDay.replace(/\-/g, "/")

    let areaTime = this.data.areaTime
    for (let i in areaTime) {
      let end = areaTime[i].end
      let start = areaTime[i].start
      if (areaTime[i].name) {
        continue
      } else {
        let n_time = date.getTime()
        let _time = new Date(chooseDay + ' ' + start).getTime()
        if (n_time > _time) {
          areaTime[i].disabled = true
        }
      }
    }
    this.setData({
      areaTime: areaTime
    })
  },
  chooseDate: function(e) {
    let that = this
    date = new Date();
    hour = date.getHours()
    minute = date.getMinutes()
    let day = e.currentTarget.dataset.val
    let _today = util.getToday('day')
    let ind = e.currentTarget.dataset.index
    let deliverTime = this.data.deliverTime
    let areaTime = this.data.areaTime
    let _time = date.getTime
    let _obj = {
      start: hour + ':' + minute,
      end: (hour + 2) + ':' + minute,
      val: '2小时上门',
      name: '2小时',
      isChoose: false,
      disables: false
    }
    if (ind == 0) {
      if (areaTime.length < 5) {
        areaTime.unshift(_obj)
      }
    } else {
      if (areaTime.length > 4) {
        areaTime.splice(0, 1);
      }
    }
    for (let i in areaTime) {
      areaTime[i].isChoose = false
      areaTime[i].disabled = false
    }
    for (let i in deliverTime) {
      deliverTime[i].isChoose = false
      if (i == ind) {
        deliverTime[i].isChoose = true
      }
    }
    this.setData({
      deliverTime: deliverTime,
      areaTime: areaTime,
      chooseDay: day
    }, function() {
      if (_today == day) {
        that.setAreaTime()
      }

    })
    //unshift  shift
  },
  chooseAreaDate: function(e) {
    let that=this
    let ind = e.currentTarget.dataset.index
    let name = e.currentTarget.dataset.name
    let start = e.currentTarget.dataset.start
    let end = e.currentTarget.dataset.end
    let day = this.data.chooseDay.replace(/\-/g, "/")
    let _day = util.getToday('day').replace(/\-/g, "/")
    let oldDay = new Date(_day).getTime()
    let newDay = new Date(day).getTime()
    let areaTime = this.data.areaTime
    let len = areaTime.length - 1
    let sendTime=''
    for (let i in areaTime) {
      areaTime[i].isChoose = false
      if (i == ind) {
        areaTime[i].isChoose = true
        if (ind == len) {
          app.AcFunc.myTotal('亲，请联系客服今天是否能发货哦！', 'none')
        }
      }
    }
    day = day.replace(/\//g, "-")
    let startTime = day + ' ' + start
    let endTime = day + ' ' + end
    let timeRange = start + '-' + end
    sendTime = day + ' ' + timeRange
    if (name == '2小时') {
      timeRange = '-1'
      sendTime = day + ' 2小时上门'
    }
    this.setData({
      areaTime: areaTime,
      startTime: startTime,
      endTime: endTime,
      sendTime: sendTime,
      timeRange: timeRange
    },()=>{
      that.sunArriveDate()
    })
  },
  changeData: function(address, status) {
    if (status == 'send') {
      this.setData({
        sendAddr: address
      })
    } else {
      this.setData({
        deliveryAddr: address
      })
    }
    this.getLogistLine()
  },
  getLogistPrice: function() {
    let that = this
    let goodsMsg = this.data.goodsMsg
    let sendAddr = this.data.sendAddr
    let deliveryAddr = this.data.deliveryAddr
    let logistMsg = this.data.logistMsg
    if (goodsMsg && logistMsg) {
      let params = {
        enterpriseSpeciallineId: logistMsg.enterpriseSpeciallineId,
        //goodsType: goodsMsg.propsName == '重货' ? 'heavy' : 'light', //['heavy', 'light']
        goodsQty: goodsMsg.boxnum,
        goodsWeight: goodsMsg.weight,
        goodsVolume: goodsMsg.volume,
      }
      app.HttpService.logistQuery(params).then((res) => {
        that.setData({
          logistCost: res.cost,
          sysGoodsType: res.sysGoodsType
        })
        setTimeout(()=>{
          that.getTotaoPrice()
        },300)
      }).catch((error) => {
        app.AcFunc.myTotal(error, 'none')
      })

    } else {
      // if (!goodsMsg) {
      //   app.AcFunc.myTotal('请输入货品信息','none')
      //   return
      // }
      // if (!logistMsg) {
      //   app.AcFunc.myTotal('请选择提货点', 'none')
      //   return
      // }
    }
  },
  getParams: function() {
    let _data = this.data
    let goodsMsg = _data.goodsMsg
    let sendp = _data.sendp
    let deliverp = _data.deliverp
    let startTime = _data.startTime
    let endTime = _data.endTime
    let sendAddr = _data.sendAddr ? _data.sendAddr[0] : ''
    let deliveryAddr = _data.deliveryAddr ? _data.deliveryAddr[0] : ''
    let logistMsg = _data.logistMsg
    let logistVOMsg = _data.logistVOMsg
    let declared = this.data.agreement
    let clientName = app.globalData.loginInfo.name
    let sysGoodsType=this.data.sysGoodsType
    if (!clientName){
      app.loginInfo()
      clientName=''
    }
    if (!goodsMsg) {
      app.AcFunc.myTotal('请输入物品信息', 'none')
      return false
    }
    if (!sendAddr) {
      app.AcFunc.myTotal('请选择发货地址', 'none')
      return false
    }
    if (!deliveryAddr) {
      app.AcFunc.myTotal('请选择收货地址', 'none')
      return false
    }
    if (!logistVOMsg){
      app.AcFunc.myTotal('请选择物流商', 'none')
      return false
    }
    if (!logistMsg) {
      app.AcFunc.myTotal('请选择物流路线', 'none')
      return false
    }
    if (!sendp.name) {
      app.AcFunc.myTotal('请输入发货人信息', 'none')
      return false
    }
    if (!deliverp.name) {
      app.AcFunc.myTotal('请输入收货人信息', 'none')
      return false
    }
    if (!startTime) {
      app.AcFunc.myTotal('请选择发货时间', 'none')
      return false
    }
    if (!declared) {
      app.AcFunc.myTotal('请同意物流协议', 'none')
      return false
    }
    if (!sysGoodsType){
      app.AcFunc.myTotal('请重新选择卸货点', 'none')
      return false
    }
    let params = {
      ownerId: wx.getStorageSync('owner').cloudShopVO.ownerId,
      clientName: clientName,
      orderNo: _data.logistNumber, //秒账单号
      enterpriseId: logistVOMsg.id ? logistVOMsg.id : null, //物流商id
      enterpriseSpeciallineId: logistMsg.enterpriseSpeciallineId, //专线id
      enterpriseSpeciallineUnloadId: logistMsg.id,
      detailVO: {
        goodsName: goodsMsg.goodsname,
        //goodsType: goodsMsg.propsName == '重货' ? 'heavy' : 'light',
        goodsQty: goodsMsg.boxnum,
        goodsWeight: goodsMsg.weight,
        goodsVolume: goodsMsg.volume,
        consignor: sendp.name,
        consignorContactNo: sendp.tel,
        consignee: deliverp.name,
        consigneeContactNo: deliverp.tel,
        minPlanDelyDate: this.data.chooseDay,
        timeRange: this.data.timeRange,
        planArriveDate: this.data.arriveDate,
        sysGoodsType: this.data.sysGoodsType,
        remark: this.data.remark,
        delyAddressVO: {
          id: sendAddr.id,
          province: sendAddr.province,
          city: sendAddr.city,
          district: sendAddr.district,
          addressDetail: sendAddr.addressDetail
        },
        recvAddressVO: {
          id: deliveryAddr.id,
          province: deliveryAddr.province,
          city: deliveryAddr.city,
          district: deliveryAddr.district,
          addressDetail: deliveryAddr.addressDetail
        },
      },
      proxyAmt: app.AcFunc.money(this.data.deliveryFee,2,false),
      totalAmt: app.AcFunc.money(this.data.totalAmt,2,false),
      cloudShopFileInfoIds: this.data.fileInfoIds.join(','),
      declared: declared,
      discountIdList: [],
      isShare: false,
      //remark: this.data.remark
    }

    return params
  },
  submitOrder: function(e) {
    //util.reloadPage()
    let params = this.getParams()
    params.clientName = app.globalData.loginInfo.name
    let that = this
    let _type = e.currentTarget.dataset.type
    if (_type == 'wait') {
      params.isWait = true
    }else{
      params.isWait = false
    }
    if (params) {
      app.HttpService.logistCreate(params).then((res) => {
        app.AcFunc.myTotal('创建成功', 'none')
        if (_type == 'paysubmit') {
          that.payOrder(res)
        }else{
          that.setParentPage(res)
        } 
        
      }).catch((error) => {
        console.log(error)
        app.AcFunc.myTotal(error, 'none')
      })
    }

  },
  payOrder: function(detail) {
    let that = this
    app.pay({
      ownerId: detail.ownerId.toString(),
      logisticOrderId: detail.id,
      logisticCompName: detail.enterpriseVO.name,
      totalAmt: app.AcFunc.money(detail.totalAmt,2,true)  //balanceAmt
    }).init().then((res) => {
      that.setParentPage(detail)
    }).catch((error) => {
      that.setParentPage(detail)
      console.log(error)
    })

  },
  getOrderNumber(name, len) {
    let pamars = {
      prefix: name,
      length: len ? len : 4
    }
    app.HttpService.orderNumber(pamars).then((res) => {
      console.log(res)
      this.setData({
        logistNumber: res
      })
    }).catch((error) => {
      console.log(error)
    })
  },
  agreementMsg: function() {
    wx.navigateTo({
      url: '/pages/agreement/logist/index',
    })
  },
  getTotaoPrice: function() {
    let logistCost = parseFloat(this.data.logistCost)
    let deliveryFee = parseFloat(this.data.deliveryFee)

    let totalPrice = app.AcFunc.money(logistCost + deliveryFee, 2, false)
    this.setData({
      totalAmt: totalPrice
    })
  },
  setParentPage: function(data) {
    var pages = getCurrentPages();
    if (pages.length > 1) {
      var prePage = pages[pages.length - 2];
      setTimeout(()=>{
        if (prePage.operData) {
          prePage.operData(data)
        }
        wx.navigateBack({})
      },1500)
      
    }
   
  },
  setUserInfo: function() {
    let sendp = {
        name: '',
        tel: ''
      },
      deliverp = {
        name: '',
        tel: ''
      }
    let owner = wx.getStorageSync('owner')
    let info = app.globalData.loginInfo
    if (!owner || !info) {
      return
    }
    sendp.name = owner.cloudShopVO.name
    sendp.tel = owner.cloudShopVO.contactNo
    deliverp.name = info.name
    deliverp.tel = info.phone
    this.setData({
      sendp: sendp,
      deliverp: deliverp
    })
  },
  goodsChange: function(e) {
    let val = e.detail.value
    let name = e.currentTarget.dataset.name
    let goodsMsg = this.data.goodsMsg
    if (name != 'goodsname') {
      val = app.AcFunc.money(val,6,true)
    }
    goodsMsg[name] = val
    this.setData({
      goodsMsg: goodsMsg
    })
  },
  areaChange: function(e) {
    let val = e.detail.value
    this.setData({
      remark: val
    })
  },
  sunArriveDate:function(){
    let endTime = this.data.endTime.replace(/\-/g, "/")
    let logistMsg = this.data.logistMsg
    let _h = parseInt(logistMsg.estimateTime)
    let m1 = _h*60*60*1000
    let m2 = new Date(endTime).getTime()
    let _date = util.formatTime(m1+m2)
    let arriveDate=_date.replace(/\//g, "-")
    this.setData({
      arriveDate: arriveDate
    })
  }
}),{"navigationBarTitleText": "物流信息"},<scroll-view style="height:{{height}}px" scroll-y>
  <view class='container'>
    <view class='logistMod logistOper flex'>
      <view class='flex-1 self-center text'>
        <view class='fs10  blue'>①以托运站最终验货后开单价格为准，多退少补</view>
        <view class='fs10  blue'>②如需人工帮助,请致电0579-85059881,85059882</view>
      </view>
      <view bindtap='submitOrder' data-type='wait' class='operbtn self-center'>
        <icon class='iconfont icon-wait'></icon>
        <view class='fs10'>存为草稿</view>
      </view>
    </view>
    <view class='logistMod'>
      <view class='msgMod logistStatus flex'>
        <view class='flex-1'>
          <view class='fs13'>物流单号:{{logistNumber}}</view>
          <view class='fs13'>预估到货时间:{{arriveDate}}</view>
        </view>
      </view>
      <view class='msgMod flex' bindtap='fillInGoods'>
        <view class='flex-1 self-center'>
          <block wx:if="{{goodsMsg.goodsname}}">
            <view class='fs13'>
              物品信息:{{goodsDesc}}
            </view>
            <!-- <view class='fs13 c999'>{{goodsMsg.remark}}</view> -->
          </block>
          <block wx:else>
            <view class='c999'>请填写物品信息</view>
          </block>
        </view>
        <view class='self-center'>
          <image mode='widthFix' src='/images/order/Right.png'></image>
        </view>
      </view>
      <view class='addrMod flex'>
        <view class='self-center left-icon'>
          <view class='icon-box'>
            <image mode='widthFix' src='/images/order/send2x.png'></image>
            <view class='line'></view>
            <image mode='widthFix' src='/images/order/get2x.png'></image>
          </view>
        </view>
        <view class='flex-1'>
          <view class='flex sendAddr'>
            <navigator hover-class='none' class='flex-1 self-center flex' url='/pages/order/addressList/index?status=send&id={{sendAddr[0].id}}'>
              <view class='flex-1 breakWord'>
                <text wx:if='{{sendAddr.length>0}}'>{{sendAddr[0].province}}{{sendAddr[0].city}}{{sendAddr[0].district}}{{sendAddr[0].addressDetail}}</text>
                <input wx:else disabled='disabled' placeholder-class='c999' value='' placeholder='请选择发货地址'></input>
              </view>
              <view class='self-center m-20'>
                <image mode='widthFix' src='/images/order/Right.png'></image>
              </view>
            </navigator>
            <!-- <view class='self-center status' wx:if="{{1==1}}" bindtap='addrDefault'>
            <text class='{{defaultAddr?"isDefault":""}}'>默认</text>
          </view> -->
          </view>
          <navigator hover-class='none' class='flex delivAddr' url='/pages/order/addressList/index?status=delivery&id={{deliveryAddr[0].id}}'> 
            <view class='flex-1 self-center breakWord'>
            <text wx:if='{{deliveryAddr.length>0}}'>{{deliveryAddr[0].province}}{{deliveryAddr[0].city}}{{deliveryAddr[0].district}}{{deliveryAddr[0].addressDetail}}</text>
              <input wx:else placeholder='请选择收货地址' placeholder-class='c999' disabled='disabled'></input>
            </view>
            <view class='self-center  m-20'>
              <image mode='widthFix' src='/images/order/Right.png'></image>
            </view>
          </navigator>
        </view>
      </view>
    </view>
    <view class='logistMod'>
      <view class='msgMod flex'>
        <view class='name self-center'>物流商</view>
        <view class='flex-1 self-center center' bindtap='logistDealer'>
          <picker bindchange="chooseDealer" disabled='{{(logistAll.length>0)?false:true}}' value="{{d_index}}" range="{{dealerList}}">
            <view class="picker {{d_index==0?'c999':''}}">
              {{dealerList[d_index]}}
            </view>
            <image mode='widthFix' src='/images/order/Right.png'></image>
          </picker>
        </view>
      </view>
      <view class='msgMod logistMsg flex' bindtap='showLogist'>
        <view class='name self-center'>物流信息</view>
        <block wx:if='{{logistList.length>0}}'>
          <view class='flex-1 self-center center'></view>
          <view class='self-center'>
            <image mode='widthFix' src='/images/order/Down.png' animation='{{downAnimation}}'></image>
          </view>
        </block>
        <block wx:else>
          <view class='flex-1 text-right red'>{{logistText}}</view>
        </block>
      </view>
      <radio-group class='logistList' wx:if='{{showLogist}}' bindchange="radioChange">
        <label class='listMsg flex' wx:for='{{logistList}}' wx:key='{{item.id}}' data-parid='{{item.parid}}' data-childindex='{{index}}' bindtap='logistMsgClick' >
          <view class='flex-1'>
            <view>{{item.name}}{{item.unloadAddressVO.addressType?'-'+item.unloadAddressVO.addressType:''}}</view>
            <view class='c666 fs12'>{{item.contactNo}}</view>
            <view class='c666 fs12'>{{item.unloadAddressVO.fullAddress}}</view>
            <view class='c999 fs11'>
              距离送货地址
              <text class='yello'>{{item.distance}}km</text> 运输时效:
              <text class='yello'>{{item.estimateTime}}h</text>
            </view>
          </view>
          <view class='flex'>
            <view class='call flex-1 self-center' data-phone='{{item.tel}}' catchtap='callLogist'>
              <icon class='iconfont icon-call'></icon>
            </view>
            <view class='choose flex-1 self-center'>
              <radio value="{{item.id}}" checked='{{item.ischose}}'  color='#00A6F5'/>
            </view>
          </view>
        </label>
      </radio-group>
    </view>
    <view class='logistMod'>
      <view class='msgMod flex' bindtap='sendMsg'>
        <view class='name self-center'>发货人信息</view>
        <view class='flex-1 self-center center'>
          <block wx:if='{{sendp.name}}'>
          {{sendp.name}}{{sendp.tel?"("+sendp.tel+")":""}}
          </block>
          <input wx:else value='{{sendp.name}}{{sendp.tel?"("+sendp.tel+")":""}}' placeholder='请输入发货人信息' placeholder-class='c999' disabled='disabled'></input>
        </view>
        <view>
          <image mode='widthFix' src='/images/order/Right.png'></image>
        </view>
      </view>
      <view class='msgMod flex' bindtap='getMsg'>
        <view class='name self-center'>收货人信息</view>
        <view class='flex-1 self-center center'>
        <block wx:if='{{deliverp.name}}'>
         {{deliverp.name}}{{deliverp.tel?"("+deliverp.tel+")":""}}
          </block>
          <input wx:else value='{{deliverp.name}}{{deliverp.tel?"("+deliverp.tel+")":""}}' placeholder='请输入收货人信息' placeholder-class='c999' disabled='disabled'></input>
        </view>
        <view>
          <image mode='widthFix' src='/images/order/Right.png'></image>
        </view>
      </view>
      <view class='msgMod flex' bindtap='chooseDeliverTime'>
        <view class='name self-center'>预约发货时间</view>
        <!-- <view class='picker-box flex-1 self-center center'>
        <picker mode="date" value="{{date.date}}" start="2015-09-01" end="2020-12-12" bindchange="bindDateChange">
          <view class="picker {{date.color}}">
            {{date.date}}
          </view>
        </picker>
      </view> -->
        <view class='deliveryTime flex-1 self-center text-right'>
          <input value='{{sendTime}}' class='fs12' placeholder='请选择发货时间' placeholder-class='c999 fs14' disabled='disabled'></input>
        </view>
        <view class='self-center'>
          <image mode='widthFix' src='/images/order/Right.png'></image>
        </view>
      </view>
      <view class='msgMod flex'>
        <view class='name self-center'>代付提货费</view>
        <view class='flex-1 self-center'>
          <input class='price' type='digit' value='{{deliveryFee}}' placeholder='请输入提货费' bindblur='priceChange' placeholder-class='c999'></input>
        </view>
      </view>
      <!-- <view class='msgMod flex' bindtap='discountChose'>
      <view class='name self-center'>秒账优惠</view>
      <view class='flex-1 self-center center'>
        <block wx:if="{{1==2}}">
          <text>小李（15051408253）</text>
        </block>
        <block wx:else>
          <text class='c999'>请选择优惠券</text>
        </block>
      </view>
      <view>
        <image mode='widthFix' src='/images/order/Right.png'></image>
      </view>
    </view> -->
      <view class='msgMod flex uploadImg'>
        <view class='imgList'>
          <view class='picBox' wx:for="{{enclosure}}" wx:key="" data-index="{{index}}" bindtap='operPic'>
            <image src='{{item}}'></image>
          </view>
        </view>
        <view class='uploadBtn' bindtap='uploadFile'>
          <icon class='iconfont icon-camera'></icon>
          <view class='fs12'>上传附件</view>
        </view>
      </view>
      <view class='msgMod remark'>
        <input class='textArea' placeholder='备注' value='{{remark}}' bindinput='areaChange'></input>
      </view>
    </view>
  </view>
  <view class='logistBtn flex'>
    <view class='flex-1 self-center'>
      <view class='fs11'>
        <text wx:if='{{deliveryFee>0}}'>实际应付:</text>
        <text wx:else>预估运费:</text>
        <text class='red fs15'>￥{{totalAmt}}</text>
      </view>
    </view>
    <block wx:if='{{agreement}}'>
      <view class='btn subBtn' data-type='submit' bindtap='submitOrder'>提交订单</view>
      <view class='btn paySubBtn' data-type='paysubmit' bindtap='submitOrder'>支付并提交</view>
    </block>
    <block wx:else>
      <view class='btn subBtn disabled'>提交订单</view>
      <view class='btn paySubBtn disabled'>支付并提交</view>
    </block>

  </view>
</scroll-view>
<view class='mask' wx:if="{{showMask}}"></view>
<view class='modMsg goodsMod' animation="{{goodsAnimation}}">
  <form bindsubmit="goodsSubmit" bindreset="goodsReset">
    <view class='goodsText text-center title'>货品信息</view>
    <view class='goodsText flex'>
      <view class='name self-center'>货品名称</view>
      <view class='flex-1 text-right'>
        <input name='goodsname' placeholder='请输入货品名称' value='{{goodsMsg.goodsname}}' data-name='goodsname' bindblur='goodsChange'></input>
      </view>
    </view>
    <!-- <view class='goodsText flex'>
      <view class='name self-center'>货品属性</view>
      <view class='flex-1 text-right property'>
        <text bindtap='chooseProp' data-index='0' class='{{props[0]?"choose":""}}'>重货</text>
        <text bindtap='chooseProp' data-index='1' class='{{props[1]?"choose":""}}'>泡货</text>
      </view>
    </view> -->
    <view class='goodsText flex'>
      <view class='name self-center'>箱数</view>
      <view class='flex-1 text-right'>
        <input name='boxnum' type='digit' placeholder='请输入箱数' value='{{goodsMsg.boxnum}}' data-name='boxnum' bindblur='goodsChange'></input>
      </view>
    </view>
    <view class='goodsText flex'>
      <view class='flex-1 flex weight'>
        <view class='name self-center'>重量</view>
        <view class='flex-1 text-right '>
          <input name='weight' type='digit' placeholder='重量' value='{{goodsMsg.weight}}' data-name='weight' bindblur='goodsChange'></input>
        </view>
        <view class=' self-center'>吨</view>
      </view>
      <view class='flex-1 flex volume'>
        <view class='name self-center'>体积</view>
        <view class='flex-1 text-right'>
          <input name='volume' type='digit' placeholder='体积' value='{{goodsMsg.volume}}' data-name='volume' bindblur='goodsChange'></input>
        </view>
        <view class='self-center'>m³</view>
      </view>
    </view>
    <!-- <view class='goodsText flex remark'>
      <textarea name='remark' placeholder='备注' value='{{goodsMsg.remark}}'></textarea>
    </view> -->
    <view class='ModBtn'>
      <button type='default' form-type='reset'>取消</button>
      <button type='success' form-type='submit'>保存</button>
    </view>
  </form>
</view>
<!-- <view class='modMsg logistDealerMod' animation='{{dealerAnimation}}'>
  <view class='title text-left'>物流商</view>
  <view class='listBox'>
    <scroll-view scroll-y='true' style='max-height:400rpx;'>
      <view wx:for="{{logistAll}}" wx:key='{{item.id}}' data-index='{{index}}' data-id='{{item.id}}' bindtap='chooseDealer' class='{{item.ischos?"choose":""}}'>
        {{item.name}}
      </view>
    </scroll-view>
  </view>
  <view class='ModBtn'>
    <button type='default' bindtap='canlelDealer'>取消</button>
    <button type='success' bindtap='sureDealer'>确定</button>
  </view>
</view> -->
<view class='modMsg sendGoodMod' animation='{{sendAnimation}}'>
  <form bindsubmit='getSendMsg'>
    <view class='title'>发货人信息</view>
    <view class='flex'>
      <view class='name self-center'>发货人</view>
      <view class='flex-1 text-right'>
        <input name='name' value='{{sendp.name}}' placeholder='发货人'></input>
      </view>
      <!-- <view class='self-center defaultMsg'>
        <text>默认</text>
      </view> -->
    </view>
    <view class='flex'>
      <view class='name self-center'>联系电话</view>
      <view class='flex-1 text-right'>
        <input name='tel' value='{{sendp.tel}}' placeholder='联系电话'></input>
      </view>
      <!-- <view class='self-center defaultMsg'>
        <text>默认</text>
      </view> -->
    </view>
    <view class='ModBtn'>
      <button type='default' bindtap='setSendMsg'>取消</button>
      <button type='success' form-type='submit'>确定</button>
    </view>
  </form>
</view>
<view class='modMsg sendGoodMod' animation='{{getAnimation}}'>
  <form bindsubmit='getDeliverMsg'>
    <view class='title'>收货人信息</view>
    <view class='flex'>
      <view class='name self-center'>收货人</view>
      <view class='flex-1 text-right'>
        <input name='name' value='{{deliverp.name}}' placeholder='收货人'></input>
      </view>
    </view>
    <view class='flex'>
      <view class='name self-center'>联系电话</view>
      <view class='flex-1 text-right'>
        <input name='tel' value='{{deliverp.tel}}' placeholder='联系电话'></input>
      </view>
    </view>
    <view class='ModBtn'>
      <button type='default' bindtap='setDeliverMsg'>取消</button>
      <button type='success' form-type='submit'>确定</button>
    </view>
  </form>
</view>
<view class='modMsg discountMod' animation='{{discountAnimation}}'>
  <view class='title'>秒账优惠</view>
  <radio-group class='discountList' bindchange="discountChange">
    <label class='flex' wx:for='{{discountList}}' wx:key='{{item.id}}'>
      <view class='flex-1 self-center'>{{item.msg}}</view>
      <view class='self-center chooseBox'>
        <radio value="{{discountList.id}}" checked="{{discountList.isChos}}" color='#FFAA00' />
      </view>
    </label>
  </radio-group>
  <view class='ModBtn'>
    <button type='default' bindtap='canlelDiscount'>取消</button>
    <button type='success' bindtap='sureDiscount'>确定</button>
  </view>
</view>
<view class='modMsg deliveryTimeMod' animation='{{timeAnimation}}'>
  <view class='title flex'>
    <view class='btn self-centrer' bindtap='cancelDelivery'>取消</view>
    <view class='flex-1'>预约发货时间</view>
    <view class='btn self-centrer' bindtap='sureDelivery'>确认</view>
  </view>
  <view>
    <scroll-view class='myscroll border-box' scroll-x='true' bindscrolltolower='addOtherDays'>
      <block wx:for='{{deliverTime}}' wx:key=''>
        <view class='item {{item.isChoose?"cur":""}}' data-index='{{index}}' data-val='{{item.day}}' wx:if='{{index==0}}' bindtap='chooseDate'>
          <view>今天</view>
          <view>{{item.day}}</view>
        </view>
        <view class='item {{item.isChoose?"cur":""}}' data-index='{{index}}' data-val='{{item.day}}' wx:elif='{{index==1}}' bindtap='chooseDate'>
          <view>明天</view>
          <view>{{item.day}}</view>
        </view>
        <view class='item {{item.isChoose?"cur":""}}' data-index='{{index}}' data-val='{{item.day}}' wx:elif='{{index==2}}' bindtap='chooseDate'>
          <view>后天</view>
          <view>{{item.day}}</view>
        </view>
        <view class='item {{item.isChoose?"cur":""}}' data-index='{{index}}' data-val='{{item.day}}' wx:else bindtap='chooseDate'>
          <view>预约</view>
          <view>{{item.day}}</view>
        </view>
      </block>
    </scroll-view>
    <view class='times'>
      <block wx:for='{{areaTime}}' wx:key=''>

        <block wx:if='{{item.disabled}}'>
          <view class='col'>
            <text class='disabled' data-index='{{index}}' data-start='{{item.start}}' data-end='{{item.end}}'>{{item.val}}</text>
          </view>
        </block>
        <block wx:else>
          <view class='col'>
            <text class='{{item.isChoose?"cur":""}}' data-name='{{item.name}}' data-index='{{index}}' data-start='{{item.start}}' data-end='{{item.end}}' bindtap='chooseAreaDate'>{{item.val}}</text>
          </view>
        </block>

      </block>
    </view>
  </view>
</view>
<view class='aggrement border-box'>
  <checkbox checked='{{agreement}}' color='#00a6f5' bindtap='agreChange'></checkbox>
  我已阅读并同意
  <text class='darkblue' bindtap='agreementMsg'>《物流服务协议》</text>
  <view wx:if='{{deliveryFee>0}}' class='float-right fs12 c666'>预估运费:
    <text class='red'>{{logistCost}}</text>
  </view>
</view>
<view class='logistBtn flex' id="logistBtn">
  <view class='flex-1 self-center'>
    <view class='fs11'>
      <block  wx:if='{{deliveryFee==0}}'>预估运费:</block>
      <block  wx:else>预估费用:</block>
      <text class='red fs15'>￥{{totalAmt}}</text>
    </view>
  </view>
  <view class='btn subBtn' data-type='submit' bindtap='submitOrder'>提交订单</view>
  <view class='btn paySubBtn' data-type='paysubmit' bindtap='submitOrder'>支付并提交</view>
</view>,.container {
  width: 100%;
  overflow: hidden;
}

.logistMod {
  background: #fff;
  margin-top: 24rpx;
}

.logistMod .msgMod {
  padding: 20rpx;
  border-bottom: 1px solid #efeff4;
}

.logistMod .msgMod.logistMsg {
  border-bottom: 0;
}
.logistMod .msgMod > .name{
  white-space: nowrap;
}

.logistOper .operbtn {
  text-align: center;
  padding: 10rpx 0;
  border-left: 1px solid #ddd;
  width: 100rpx;
}

.logistOper .operbtn .iconfont {
  font-size: 40rpx;
}

.logistOper .text {
  padding: 20rpx;
}

.logistOper .text view {
  white-space: nowrap;
  overflow: hidden;
}

.touch-blue {
  color: #fff;
  background: #00a6f5;
}

.touch-gary {
  background: #f1f1f1;
}

.icon-Right, .icon-Down {
  font-size: 28rpx;
  color: #00a6f5;
  line-height: 48rpx;
}
.msgMod picker{
  margin-right:20rpx;
  position: relative;
}
.msgMod picker image{
  position: absolute;
  right:-40rpx;
  top:12rpx;
}
.addrMod .sendAddr {
  border-bottom: 1px solid #f2f2f2;
}

.addrMod .sendAddr, .addrMod .delivAddr {
  padding: 20rpx 20rpx 20rpx 0;
  min-height: 60rpx;
  width: 100%;
}

.left-icon {
  padding: 0 20rpx;
}

.left-icon image {
  width: 30rpx;
}

.icon-box {
  width: 30rpx;
}

.icon-box .line {
  width: 15rpx;
  height: 46rpx;
  margin: 6rpx 0;
  border-right: 1px solid #ddd;
}

.addrMod .status {
  margin-left: 20rpx;
  border-left: 1px solid #ddd;
  padding-left: 20rpx;
  height: 80%;
}

.addrMod .status text {
  display: inline-block;
  width: 70rpx;
  text-align: center;
  line-height: 40rpx;
  font-size: 20rpx;
  border: 1px solid #ddd;
  border-radius: 0.3em;
}

.addrMod .status text.isDefault {
  color: #00a6f5;
  background: #e7f6fe;
  border-color: #00a6f5;
}

.m-l20 {
  margin-left: 20rpx;
}

.m-20 {
  margin: 0 20rpx;
}

.msgMod .center {
  margin: 0 20rpx;
  text-align: right;
}

.listMsg {
  border-top: 1px solid #efeff4;
}

.listMsg > .flex-1 {
  padding: 20rpx;
}

.listMsg .call {
  display: inline-block;
  margin: 0 20rpx;
  padding-right: 20rpx;
  border-right: 1px solid #ddd;
}

.listMsg .call icon {
  font-size: 48rpx;
  color: #00a6f5;
}

.listMsg .choose {
  display: inline-block;
  vertical-align: middle;
  padding-right: 20rpx;
}

.listMsg .yello {
  display: inline-block;
  margin-right: 20rpx;
}

.msgMod .picker-box {
  position: relative;
}

.msgMod image, .addrMod image {
  width: 24rpx;
}

.price {
  text-align: right;
}

/*上传附件*/

.uploadImg {
  padding: 10rpx;
}

.uploadImg .imgList {
  overflow: hidden;
}

.uploadImg .imgList .picBox {
  position: relative;
 float:left;
  width: 120rpx;
  height: 120rpx;
  margin: 10rpx;
}

.uploadImg .imgList image {
  width: 120rpx;
  height: 120rpx;
}

.uploadImg .uploadBtn {
  float: left;
  margin: 10rpx;
  height: 120rpx;
  width: 120rpx;
  text-align: center;
  background: #f2f2f2;
}

.uploadImg icon {
  font-size: 48rpx;
  color: #999;
}

.aggrement {
  position: fixed;
  width: 100%;
  height:60rpx;
  line-height: 60rpx;
  background: #efeff4;
  bottom:100rpx;
  z-index: 5;
  padding:0 20rpx;
  font-size: 24rpx;
}

.logistBtn {
  height: 100rpx;
  position: fixed;
  z-index: 5;
  width: 100%;
  bottom: 0;
  background: #fff;
  box-shadow: -2px -2px 5px rgba(0, 0, 0, 0.1);
  -webkit-box-shadow: -2px -2px 5px rgba(0, 0, 0, 0.1);
}

.logistBtn .flex-1 {
  padding-left: 20rpx;
}

.logistBtn .btn {
  width: 160rpx;
  text-align: center;
  line-height: 100rpx;
  color: #fff;
  font-size: 24rpx;
}

.logistBtn .subBtn {
  background: #35d2c6;
}

.logistBtn .paySubBtn {
  background: #00a6f5;
}
.logistBtn .disabled{
  background: #d5d5d5;
  color:#999;
}

.mask {
  position: fixed;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.4);
  top: 0;
  left: 0;
  z-index: 99;
}

.modMsg {
  position: fixed;
  width: 100%;
  background: #fff;
  bottom: -100%;
  z-index: 100;
}

.modMsg .name, .msgMod .name {
  white-space: nowrap;
}

.msgMod  .deliveryTime {
  padding-right: 20rpx;
}

.goodsMod .title {
  line-height: 60rpx;
}

.goodsMod .goodsText {
  padding: 20rpx;
  border-bottom: 1px solid #f2f2f2;
}

.goodsText .name {
  min-width: 80rpx;
}

.goodsText .weight {
  margin-right: 80rpx;
}

.goodsText .volume {
  margin-left: 80rpx;
}

.goodsText .volume input, .goodsText .weight input {
  padding-right: 20rpx;
}

.goodsMod .property text {
  display: inline-block;
  margin-left: 20rpx;
  padding: 10rpx 30rpx;
  background: #f1f1f1;
  font-size: 24rpx;
}

.goodsMod .property text.choose {
  color: #fff;
  background: #ffbc51;
}

.ModBtn {
  padding: 40rpx 0 20rpx;
  text-align: center;
  vertical-align: middle;
}

.ModBtn button {
  display: inline-block;
  margin: 0 7.5%;
  width: 35%;
  font-size: 30rpx;
}

.logistDealerMod .listBox view {
  text-align: center;
  line-height: 80rpx;
  font-size: 24rpx;
  border-bottom: 1px solid #f2f2f2;
}

.logistDealerMod .listBox  view.choose {
  /* box-shadow: inset 2px 2px 5px rgba(0,0,0,0.2); */
  color:#00a6f5;
}

.logistDealerMod .title {
  line-height: 100rpx;
  text-align: center;
  border-bottom: 1px solid #f2f2f2;
}

.sendGoodMod .title {
  line-height: 100rpx;
  text-align: center;
  border-bottom: 1px solid #ddd;
}

.sendGoodMod .flex {
  padding: 20rpx;
  border-bottom: 1px solid #ddd;
}

.sendGoodMod .defaultMsg {
  margin-left: 20rpx;
  padding-left: 20rpx;
  border-left: 1px solid #ddd;
}

.sendGoodMod .defaultMsg text {
  display: inline-block;
  width: 70rpx;
  text-align: center;
  line-height: 40rpx;
  font-size: 20rpx;
  border: 1px solid #ddd;
  border-radius: 0.3em;
}

.sendGoodMod .defaultMsg text.isDefault {
  color: #00a6f5;
  background: #e7f6fe;
  border-color: #00a6f5;
}

.discountMod .title {
  line-height: 100rpx;
  text-align: center;
  border-bottom: 1px solid #ddd;
}

.discountMod label {
  padding: 20rpx;
  border-bottom: 1px solid #ddd;
}

.discountMod .chooseBox {
  margin-left: 20rpx;
}

.deliveryTimeMod .title {
  background: #00a6f5;
  color: #fff;
  text-align: center;
  padding: 20rpx;
}

.deliveryTimeMod .title .btn {
  padding: 0 20rpx;
  font-size: 24rpx;
}

.deliveryTimeMod .times {
  padding: 0 10rpx 20rpx;
}

.deliveryTimeMod .times .col {
  display: inline-block;
  width: 33.333%;
  padding: 0 10rpx;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  text-align: center;
  margin: 20rpx 0 0;
}

.deliveryTimeMod .times text {
  display: inline-block;
  padding: 20rpx 0;
  width: 100%;
  border: 1px solid #c4c4c4;
  border-radius: 0.3em;
  font-size: 24rpx;
}

.deliveryTimeMod .times text.cur {
  background: #ffbc51;
  border-color: #ffbc51;
  color: #fff;
}

.deliveryTimeMod .times text.disabled {
  color: #999;
}

.deliveryTimeMod .myscroll {
  white-space: nowrap;
  height: 140rpx;
  padding: 0 10rpx;
}

.deliveryTimeMod .myscroll .item {
  display: inline-block;
  margin: 20rpx 10rpx;
  border: 1px solid #c4c4c4;
  border-radius: 0.3em;
  text-align: center;
  padding: 10rpx 30rpx;
  font-size: 24rpx;
}

.deliveryTimeMod .myscroll .item.cur {
  color: #ffbc51;
  border-color: #ffbc51;
}
.remark{
  padding:0 !important;
}
.remark textarea{
  width: 100%;
  height:120rpx;
}
,const util = require('../../../utils/util.js')
const app = getApp()
let downanimate = wx.createAnimation({
  duration: 300,
  timingFunction: 'ease',
})
let goodsanimate = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let sendanimate = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let getanimate = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let discountanimate = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let timeanimate = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let date = new Date();
let hour = date.getHours()
let minute = date.getMinutes()
Page({
  data: {
    options: {},
    showLogist: false,
    choose: [false, false, false],
    downAnimation: {},
    goodsAnimation: {},
    sendAnimation: {},
    getAnimation: {},
    discountAnimation: {},
    timeAnimation: {},
    cloudImg: [],
    logistImg: [],
    sxImg: [],
    cloudShopFileInfoIds: [],
    logisticFileInfoIds: [],
    fileInfoIds:[],
    showMask: false,
    props: [false, false],
    defaultAddr: false,
    updateLog:[],
    logistDetail: {},
    logistDealer: null,
    logistCost: 0.00, //物流费用
    logistAll: [], //物流商List
    logistList: null, //物流商下的路线
    logistMsg: null, //选择的物流路线
    logistText: '物流路线尚未开通，敬请期待',
    logistVOMsg: null, //选择的物流商
    discountList: null,
    /*{msg: '优惠一',isChos: false,id: 1001}, {msg: '优惠二',isChos: false,id: 1002}*/
    deliverTime: [],
    daysPageSize: 10,
    areaTime: [{
      start: hour + ':' + minute,
      end: (hour + 2) + ':' + minute,
      val: '2小时上门',
      name: '2小时',
      isChoose: false,
      disables: false
    }, {
      start: '9:00',
      end: '11:00',
      val: '9:00-11:00',
      isChoose: false,
      disables: false
    }, {
      start: '11:00',
      end: '13:00',
      val: '11:00-13:00',
      isChoose: false,
      disables: false
    }, {
      start: '13:00',
      end: '15:00',
      val: '13:00-15:00',
      isChoose: false,
      disables: false
    }, {
      start: '15:00',
      end: '18:00',
      val: '15:00-18:00',
      isChoose: false,
      disables: false
    }],
    chooseDay: util.getToday('day'),
    timeRange: '',
    startTime: '',
    endTime: '',
    sendTime: '',
    logistID: null,
    goodsMsg: null,
    sendAddr: null,
    deliveryAddr: null,
    sendp: {
      name: '',
      tel: ''
    },
    deliverp: {
      name: '',
      tel: ''
    },
    logistNumber: '',
    deliveryFee: 0.00,
    totalAmt: 0.00,
    agreement: true,
    isLogin: true,
    isShare: false,
    isbindOrder: false,
    orderfrom: '',
    P: {},
    dealerList: [],
    d_index: 0
  },
  onLoad: function(options) {
    console.log(options)
    let that = this
    let {
      id,
      bindOrder,
      orderfrom
    } = options
    let isLogin = true,
      isShare = false,
      isbindOrder = false
    if (id) {
      this.orderId = id
    } else {
      wx.switchTab({
        url: '/pages/index/index',
      })
    }
    if (bindOrder) {
      isShare = true
      if (bindOrder == 'fail') {
        isLogin = false
        isbindOrder = false
      } else if (bindOrder == 'pendding') {
        isLogin = true
        isbindOrder = false
      } else {
        isbindOrder = true
        isLogin = true
      }
    }else{
      isShare = options.isShare
    }
    let ownerId = options.ownerId
    if (ownerId) {
      wx.setStorageSync('owner', ownerId)
    }
    if (options.unRequest){
      if (options.isLogin=='true'){
        isLogin = true
      }else{
        isLogin = false
      }
      
    }
    this.setData({
      options: options,
      isLogin: isLogin,
      isShare: isShare,
      orderfrom: orderfrom ? orderfrom : ''
    }, function() {
      if (isShare && !isbindOrder) {
        that.getShareLogist();
      } else {
        that.getLogistMsg(id)
      }
    })
    app.AcFunc.get$('logistdetail').then(res => {
      this.setData({
        height: app.globalData.SystemInfo.screenHeight - res[0].height - app.globalData.SystemInfo.statusBarHeight-50
      })
    })
    // this.WxValidate = app.WxValidate({
    //   phone: {
    //     required: true,
    //     phone: true,
    //   }
    // }, {
    //   phone: {
    //     required: '电话号码不能为空',
    //   }
    // })
  },
  onReady: function() {
    //this.getOrderNumber('WL')
  },
  onShow: function() {
    let allDays = util.getMyDays(this.data.daysPageSize)
    console.log(allDays)
    this.setData({
      deliverTime: this.setDaysVal(allDays)
    })
    this.setAreaTime()
    //this.getLogistPrice()
  },
  onHide: function() {

  },
  onUnload: function() {
    let query = this.data.options
    let logistDetail = this.data.logistDetail
    if (query.unRequest){
      return false
    }
    if (query.action && query.salesId) {
      query.id = query.salesId
      query.orderNo = query.salesOrderNo
      query.action = 'viewSaleOrder'
      query.bindOrder = null
      app.queryFunc(query)
    }else{
      this.setParentPage(logistDetail)
    }
  },
  onShareAppMessage: function(e) {
    let logistDetail = this.data.logistDetail
    let shareUrl = logistDetail.shareUrl
    shareUrl = shareUrl.substr(shareUrl.indexOf('?'), shareUrl.length)
    return {
      title: '秒账云店物流单\n物流单号：' + logistDetail.orderNo,
      imageUrl: '',
      path: '/pages/index/index' + shareUrl
    }
  },
  onPullDownRefresh: function() {
    let that = this
    let isShare = that.data.isShare
    if (isShare) {
      return
    }
    that.getLogistMsg(this.orderId)
    setTimeout(() => {
      wx.stopPullDownRefresh()
    }, 500)
  },
  cancelOrder: function() {
    let that = this
    let logistDetail=this.data.logistDetail
    let id = logistDetail.id
      wx.showModal({
        title: '提示',
        content: '此次操作将会同步上游卖家, 请确认是否继续操作\n*建议和卖家商量后再进行操作',
        success: (res) => {
          if (res.confirm) {
            if (logistDetail.paymentStatus == "paid"){
              wx.showModal({
                title: '提示',
                content: '该物流单已经支付，确认取消吗？',
                success: (res) => {
                  if (res.confirm) {
                    app.HttpService.logistCancel(id).then((res) => {
                      if (logistDetail.orderStatus == "wait"){
                        wx.navigateBack({})
                      }else{
                        that.getLogistMsg(res.id)
                      }
                    }).catch((error) => {
                      app.AcFunc.myTotal(error, 'none')
                    })
                  }
                }
              })
            }else{
              app.HttpService.logistCancel(id).then((res) => {
                if (logistDetail.orderStatus == "wait") {
                  wx.navigateBack({})
                } else {
                  that.getLogistMsg(res.id)
                }
              }).catch((error) => {
                app.AcFunc.myTotal(error, 'none')
              })
            }
          }
        },
        fail: (error) => {

        }
      })
  },
  getLogistMsg: function(id) {
    let that = this
    app.HttpService.logistDetail(id).then((res) => {
      console.log(res)
      that.data.options.salesId = res.relateOrderId
      that.setLogistDetail(res)
    }).catch((error) => {
      console.log(error)
      app.AcFunc.myTotal(error, 'none')
    })
  },
  getShareLogist: function(id) {
    let that = this
    let options = this.data.options
    if(id){
      options.id=id
    }
    let pamars = {
      ownerId: options.ownerId,
      orderId: options.id,
      username: options.username
    }
    app.HttpService.logistShare(pamars).then((res) => {
      console.log(res)
      that.setLogistDetail(res)
      options.salesId = res.relateOrderId
      options.salesOrderNo = res.relateOrderNo
      that.setData({
        options: options
      })
    }).catch((error) => {
      console.log(error)
      app.AcFunc.myTotal(error, 'none')
    })
  },
  setLogistDetail: function(data) {
    let _data = data
    let that = this
    this.data.shareUrl = data.shareUrl;
    let paymentStatus = _data.paymentStatus //支付状态
    let orderStatus = _data.orderStatus //订单状态
    let detailVO = _data.detailVO
    let isLogin = this.data.isLogin
    let cloudShopFileInfoIds = _data.cloudShopFileInfoIds ? _data.cloudShopFileInfoIds.split(',') : []
    let logisticFileInfoIds = _data.logisticFileInfoIds ? _data.logisticFileInfoIds.split(',') : []
    let fileInfoIds = _data.fileInfoIds ? _data.fileInfoIds.split(',') : []
    let sendAddr = [detailVO.delyAddressVO]
    let deliveryAddr = [detailVO.recvAddressVO]
    let logistVOMsg = _data.enterpriseVO
    let logistList = logistVOMsg.enterpriseSpeciallineVOList[0].enterpriseSpeciallineUnloadVOList
    let dealerList = [_data.enterpriseVO.name]
    let enterpriseSpeciallineId = _data.enterpriseSpeciallineId,
      enterpriseSpeciallineUnloadId = _data.enterpriseSpeciallineUnloadId
    let arriveDate = _data.arriveDate,
      timeRange = detailVO.timeRange == "-1" ? "2小时上门" : detailVO.timeRange
    _data.arriveDate = arriveDate ? arriveDate.substr(0, (arriveDate.length - 3)) : ''
    //detailVO.planArriveDate = detailVO.maxPlanDelyDate.substr(0, 10) + ' ' + timeRange
    let sendp = {
      name: '',
      tel: ''
    }
    let deliverp = {
      name: '',
      tel: ''
    }
    let ownerId = _data.ownerId
    let logistAll = [logistVOMsg]
    for (let i in logistList) {
      logistList[i].parid = logistAll[0].id
      logistList[i].contactNo = logistList[i].contactNo.split(/[\s\,\，\;]+/)[0]
      if (logistList[i].id == enterpriseSpeciallineUnloadId) {
        logistList[i].isChos = true
      } else {
        logistList[i].isChos = false
      }
    }
    let cloudImg = [],
      logistImg = [],
      xsImg=[]
    for (let i in cloudShopFileInfoIds) {
      let url = app.getimg('thumbnail', cloudShopFileInfoIds[i])
      cloudImg.push(url)
    }
    for (let i in logisticFileInfoIds) {
      let url = app.getlogistimg(logisticFileInfoIds[i])
      logistImg.push(url)
    }
    for (let i in fileInfoIds) {
      let url = app.getxsimg('thumbnail', fileInfoIds[i], ownerId)
      xsImg.push(url)
    }
    logistAll[0].enterpriseSpeciallineUnloadVOList = logistList
    
    let maxPlanDelyDate = detailVO.maxPlanDelyDate
    let minPlanDelyDate = detailVO.minPlanDelyDate
    let sendTime = minPlanDelyDate.substr(0, 10) + ' ' + timeRange
    _data = app.AcFunc.changeObjStatus(_data)
    _data.detailVO = app.AcFunc.setGoodsMsg(detailVO)
    _data.balanceAmt = app.AcFunc.money(_data.balanceAmt, 2, false) //差额
    _data.shortAmt = app.AcFunc.money(_data.shortAmt, 2, false)
    sendp.name = _data.detailVO.consignor
    sendp.tel = _data.detailVO.consignorContactNo
    deliverp.name = _data.detailVO.consignee
    deliverp.tel = _data.detailVO.consigneeContactNo
    if (_data.orderStatus == 'reject' || _data.orderStatus == 'cancel'){
      _data.balanceAmt = app.AcFunc.money(_data.shortAmt + _data.proxyAmt, 2, false)
    }
    if(!isLogin){
      _data.isEdit=false
      _data.hasPay = true
    }
    that.setData({
      logistDetail: _data,
      sendAddr: sendAddr,
      deliveryAddr: deliveryAddr,
      logistVOMsg: logistVOMsg,
      logistList: logistList,
      logistAll: logistAll,
      logistMsg: logistList[0],
      goodsMsg: _data.detailVO,
      totalAmt: app.AcFunc.money(_data.totalAmt, 2, false),
      sendp: sendp,
      deliverp: deliverp,
      sendTime: sendTime,
      deliveryFee: app.AcFunc.money(_data.proxyAmt, 2, false),
      logistCost: _data.logisticAmt,
      startTime: _data.detailVO.minPlanDelyDate,
      endTime: _data.detailVO.maxPlanDelyDate,
      timeRange: _data.detailVO.timeRange,
      cloudShopFileInfoIds: cloudShopFileInfoIds,
      logisticFileInfoIds: logisticFileInfoIds,
      fileInfoIds:fileInfoIds,
      cloudImg: cloudImg,
      logistImg: logistImg,
      xsImg: xsImg,
      dealerList: dealerList,
      updateLog: _data.updateLog,
      d_index: 0,
      P: app.P()
    }, function() {
      if (_data.isEdit) {
        that.getLogistLine('first')
      }
    })

  },
  callLogist: function(e) {
    let tel = e.currentTarget.dataset.phone
    if (tel == '') {
      app.AcFunc.myTotal('这个商家真懒，没留下联系方式...', 'none')
      return
    }
    wx.makePhoneCall({
      phoneNumber: tel
    })
  },
  setImgUrl: function(logisticFileInfoIds) {
    let enclosure = []

  },
  radioChange: function(e) {
    console.log(e)
  },
  discountChange: function(e) {

  },
  priceChange: function(e) {
    let val = e.detail.value
    let that = this
    val = app.AcFunc.money(val, 2, false)
    this.setData({
      deliveryFee: val
    }, function() {
      that.getTotaoPrice()
    })
  },
  agreChange: function() {
    let res = this.data.agreement
    if (res) {
      res = false
    } else {
      res = true
    }
    this.setData({
      agreement: res
    })
  },
  uploadFile: function() {
    let enclosure = this.data.enclosure
    let cloudShopFileInfoIds = this.data.cloudShopFileInfoIds
    let cloudImg = this.data.cloudImg
    let that = this
    console.log(app.uploadPath)
    wx.chooseImage({
      count: 1,
      sizeType: ['original', 'compressed'],
      sourceType: ['album', 'camera'],
      success(res) {
        const tempFilePaths = res.tempFilePaths
        wx.uploadFile({
          url: app.getUploadUrl(),
          filePath: tempFilePaths[0],
          name: 'file',
          formData: {},
          success(res) {
            const data = JSON.parse(res.data)
            console.log(data)
            if (data.errorCode == 0) {
              cloudShopFileInfoIds.push(data.data.id)
              cloudImg.push(tempFilePaths[0])
            }
            that.setData({
              cloudShopFileInfoIds: cloudShopFileInfoIds,
              cloudImg: cloudImg
            })
          },
          fail(error) {
            console.log(error)
          }
        })
      }
    })
  },
  operPic: function(e) {
    if (!this.data.logistDetail.isEdit) {
      return false
    }
    let ind = e.currentTarget.dataset.index
    let type = e.currentTarget.dataset.type
    let cloudImg = this.data.cloudImg
    let logistImg = this.data.logistImg
    let xsImg = this.data.xsImg
    let cloudShopFileInfoIds = this.data.cloudShopFileInfoIds
    let logisticFileInfoIds = this.data.logisticFileInfoIds
    let fileInfoIds = this.data.fileInfoIds
    let that = this
    wx.showActionSheet({
      itemList: ['删除', '查看'],
      success(res) {
        let tapIndex = res.tapIndex
        if (tapIndex == 0) {
          if (type == 'cloud') {
            cloudImg.splice(ind, 1)
            cloudShopFileInfoIds.splice(ind, 1)
          } else if (type == 'xs'){
            xsImg.splice(ind, 1)
            fileInfoIds.splice(ind, 1)
          }else {
            logistImg.splice(ind, 1)
            logisticFileInfoIds.splice(ind, 1)
          }
          that.setData({
            logistImg: logistImg,
            logisticFileInfoIds: logisticFileInfoIds,
            cloudImg: cloudImg,
            cloudShopFileInfoIds: cloudShopFileInfoIds
          })
        } else {
          app.AcFunc.imgBig(e)
        }
      },
      fail(res) {
        console.log(res.errMsg)
      }
    })
  },
  fillInGoods: function(e) {
    if (!this.data.logistDetail.isEdit) {
      return false
    }
    goodsanimate.bottom('0').step()
    this.setData({
      goodsAnimation: goodsanimate.export(),
      showMask: true
    })
  },
  goodsSubmit: function(e) {
    let data = e.detail.value
    let goodsMsg = this.data.goodsMsg
    let logistDetail = this.data.logistDetail
    let that = this
    if (data.goodsname == '') {
      app.AcFunc.myTotal('请输入货品名称', 'none')
      return
    } else {
      goodsMsg.goodsName = data.goodsname
    }
    if (data.boxnum == '') {
      app.AcFunc.myTotal('请输入货品箱数', 'none')
      return
    } else {
      goodsMsg.goodsQty = data.boxnum
    }
    if (data.weight == 0 && data.volume == 0) {
      app.AcFunc.myTotal('重量和体积不能都为0', 'none')
      return
    }
    if (data.weight == '' && data.volume == '') {
      app.AcFunc.myTotal('重量和体积不能都为空', 'none')
      return
    } else {
      goodsMsg.goodsWeight = data.weight == '' ? null : data.weight
      goodsMsg.goodsVolume = data.volume == '' ? null : data.volume
    }
    let goodsDesc = data.goodsname + '，' + data.boxnum + '箱' + (data.weight ? '，' + data.weight + '吨' : '') + (data.volume ? '，' + data.volume + 'm³' : '')
    logistDetail.detailVO.goodsMsg = goodsDesc
    this.setData({
      goodsMsg: goodsMsg,
      logistDetail: logistDetail
    }, function() {
      that.goodsReset()
      that.getLogistPrice()
    })

  },
  goodsReset: function(e) {
    goodsanimate.bottom('-100%').step()
    this.setData({
      goodsAnimation: goodsanimate.export(),
    })
    setTimeout(() => {
      this.setData({
        showMask: false
      })
    }, 200)
  },
  addrDefault: function(e) {
    let defaultAddr = this.data.defaultAddr
    if (defaultAddr) {
      defaultAddr = false
    } else {
      defaultAddr = true
    }
    this.setData({
      defaultAddr: defaultAddr
    })
  },
  getLogistLine: function(name = '') {
    let that = this
    let sendAddr = this.data.sendAddr
    let deliveryAddr = this.data.deliveryAddr
    let dealerList = ['请选择物流商']
    let logistVOMsg = this.data.logistVOMsg
    let logistMsg = this.data.logistMsg
    let logistList = this.data.logistList
    let d_index = 0
    if (sendAddr && deliveryAddr) {
      let params = {
        fromAddressVO: {
          id: sendAddr[0].id,
          province: sendAddr[0].province,
          city: sendAddr[0].city,
          district: sendAddr[0].district,
          addressDetail: sendAddr[0].addressDetail
        },
        toAddressVO: {
          id: deliveryAddr[0].id,
          province: deliveryAddr[0].province,
          city: deliveryAddr[0].city,
          district: deliveryAddr[0].district,
          addressDetail: deliveryAddr[0].addressDetail
        },
      }
      app.HttpService.logistMatchLine(params).then((res) => {
        console.log(res)
        let data = res
        let _obj = []
        if (data.length > 0) {
          for (let i in data) {
            let VOLis = data[i].enterpriseSpeciallineUnloadVOList
            dealerList.push(data[i].name)
            if (logistVOMsg.id == data[i].id) {
              d_index = parseInt(i) + 1
              logistList = VOLis
              for (let j in VOLis) {
                let phones = VOLis[j].contactNo.split(/[\s\,\，\;]+/)
                VOLis[j].tel = phones[0]
                VOLis[j].name = data[i].name
                VOLis[j].parid = data[i].id
                if (VOLis[j].id == logistMsg.id) {
                  VOLis[j].isChos = true
                  //logistMsg = VOLis[j]
                } else {
                  VOLis[j].isChos = false
                }
              }
            }else{
              if (data[i].isTop){
                d_index=i
              }
            }

          }
        }

        that.setData({
          dealerList: dealerList,
          d_index: d_index,
          logistAll: data,
          logistList: logistList,
          logistMsg:logistMsg,
          logistCost: 0
        })

      }).catch((error) => {
        console.log(error)
      })

      setTimeout(function() {
        if (name != 'first') {
          that.setbalanceAmt()
        }
      }, 300)
    }
  },
  logistDealer: function() { //dealeranimate
    if (!this.data.logistDetail.isEdit) {
      return false
    }
    let that = this
    let logistVOMsg = this.data.logistVOMsg
    let logistAll = this.data.logistAll
    let d_index = 0
    if (logistAll.length > 0) {
      if (logistVOMsg) {
        for (let i in logistAll) {
          if (logistAll[i].id == logistVOMsg.id) {
            d_index = i
          }
        }
      }
    } else {
      app.AcFunc.myTotal('物流路线暂未开通，敬请期待', 'none')
    }
  },
  chooseDealer: function(e) {
    let that = this
    let ind = parseInt(e.detail.value) - 1
    let logistDetail = this.data.logistDetail
    if (ind < 0) {
      return
    }
    let logistAll = this.data.logistAll
    let logistVOMsg = logistAll[ind]
    let logistList = logistVOMsg.enterpriseSpeciallineUnloadVOList
    for (let i = 0; i < logistList.length; i++) {
      logistList[i].isChos = false
    }
    logistDetail.shortAmtByFormula =0
    this.setData({
      logistVOMsg: logistVOMsg,
      d_index: ind + 1,
      logistList: logistList,
      logistMsg: null,
      logistCost: 0,
      logistDetail: logistDetail
    }, () => {
      that.getTotaoPrice()
    })

  },
  logistMsgClick: function(e) {
    if (!this.data.logistDetail.isEdit) {
      return false
    }
    let that = this
    let id = e.currentTarget.dataset.parid
    let ind = e.currentTarget.dataset.childindex
    let logistAll = this.data.logistAll
    let logistList = this.data.logistList
    let logistMsg = []
    for (let i in logistList) {
      if (i == ind) {
        //logistMsg = logistAll[i].enterpriseSpeciallineUnloadVOList[ind2]
        logistList[i].isChos = true
        logistMsg = logistList[i]
      } else {
        logistList[i].isChos = false
      }
    }
    this.setData({
      logistList: logistList,
      logistMsg: logistMsg
    }, function () {
      that.getLogistPrice()
    })

  },
  showLogist: function() {
    let sendAddr = this.data.sendAddr
    let deliveryAddr = this.data.deliveryAddr
    let showLogist = this.data.showLogist
    let logistList = this.data.logistList
    let res = false
    if (sendAddr && deliveryAddr) {
      let len = logistList.length
      if (len > 0) {
        if (showLogist) {
          downanimate.rotate('0').step()
          res = false
        } else {
          downanimate.rotate('180').step()
          res = true
        }
        this.setData({
          downAnimation: downanimate.export(),
          showLogist: res
        })
      } else {
        app.AcFunc.myTotal('对不起，您所选择的物流路线尚未开通，敬请期待!', 'none', 3000)
      }
    } else {
      // wx.showModal({
      //   title: '提示',
      //   content: '请选择收送货地址',
      // })
      return
    }

  },

  sendMsg: function() {
    if (!this.data.logistDetail.isEdit) {
      return false
    }
    sendanimate.bottom('0').step()
    this.setData({
      sendAnimation: sendanimate.export(),
      showMask: true
    })
  },
  getMsg: function() {
    if (!this.data.logistDetail.isEdit) {
      return false
    }
    getanimate.bottom('0').step()
    this.setData({
      getAnimation: getanimate.export(),
      showMask: true
    })
  },
  setSendMsg: function() {
    sendanimate.bottom('-100%').step()
    this.setData({
      sendAnimation: sendanimate.export(),
    })
    setTimeout(() => {
      this.setData({
        showMask: false
      })
    }, 200)
  },
  setDeliverMsg: function() {
    getanimate.bottom('-100%').step()
    this.setData({
      getAnimation: getanimate.export(),
    })
    setTimeout(() => {
      this.setData({
        showMask: false
      })
    }, 200)
  },
  /**收送货人信息 */
  getSendMsg: function(e) {
    let val = e.detail.value
    if (val.name == '') {
      app.AcFunc.myTotal('请输入发货人姓名', 'none')
      return
    }
    if (val.tel == '') {
      app.AcFunc.myTotal('请输入发货人联系方式', 'none')
      return
    }
    // if (!this.WxValidate.checkObj({
    //     phone: val.tel
    //   })) {
    //   const error = this.WxValidate.errorList[0]
    //   app.AcFunc.myTotal(`${error.param} : ${error.msg}`, 'none')
    //   return false
    // }
    this.setData({
      sendp: val
    })
    this.setSendMsg()
  },
  getDeliverMsg: function(e) {
    let val = e.detail.value
    if (val.name == '') {
      app.AcFunc.myTotal('请输入收货人姓名', 'none')
      return
    }
    if (val.tel == '') {
      app.AcFunc.myTotal('请输入收货人联系方式', 'none')
      return
    }
    // if (!this.WxValidate.checkObj({
    //     phone: val.tel
    //   })) {
    //   const error = this.WxValidate.errorList[0]
    //   app.AcFunc.myTotal(`${error.param} : ${error.msg}`, 'none')
    //   return false
    // }
    this.setData({
      deliverp: val
    })
    this.setDeliverMsg()
  },

  discountChose: function() {
    discountanimate.bottom('0').step()
    this.setData({
      discountAnimation: discountanimate.export(),
      showMask: true
    })
  },
  canlelDiscount: function() {
    discountanimate.bottom('-100%').step()
    this.setData({
      discountAnimation: discountanimate.export(),
    })
    setTimeout(() => {
      this.setData({
        showMask: false
      })
    }, 200)
  },
  chooseDeliverTime: function() {
    if (!this.data.logistDetail.isEdit) {
      return false
    }
    timeanimate.bottom('0').step()
    this.setData({
      timeAnimation: timeanimate.export(),
      showMask: true
    })
  },
  sureDelivery: function() {
    this.sunArriveDate()
    this.cancelDelivery()
  },
  cancelDelivery: function() {
    timeanimate.bottom('-100%').step()
    this.setData({
      timeAnimation: timeanimate.export(),
    })
    setTimeout(() => {
      this.setData({
        showMask: false
      })
    }, 200)
  },
  setDaysVal: function(days) {
    let deliverTime = []
    for (let i in days) {
      let _obj = {
        day: days[i],
        isChoose: false
      }
      if (i == 0) {
        _obj.isChoose = true
      }
      deliverTime.push(_obj)
    }
    return deliverTime;
  },
  addOtherDays: function() {
    wx.showLoading({
      title: '加载中...',
    })
    let daysPageSize = this.data.daysPageSize;
    daysPageSize += 10
    let allDays = util.getMyDays(daysPageSize)
    console.log(allDays)
    this.setData({
      deliverTime: this.setDaysVal(allDays),
      daysPageSize: daysPageSize
    }, () => {
      wx.hideLoading()
    })
  },
  setAreaTime: function() {
    date = new Date();
    hour = date.getHours()
    minute = date.getMinutes()
    let chooseDay = util.getToday('day').replace(/\-/g, "/")

    let areaTime = this.data.areaTime
    for (let i in areaTime) {
      let end = areaTime[i].end
      let start = areaTime[i].start
      if (areaTime[i].name) {
        continue
      } else {
        let n_time = date.getTime()
        let _time = new Date(chooseDay + ' ' + start).getTime()
        if (n_time > _time) {
          areaTime[i].disabled = true
        }
      }
    }
    this.setData({
      areaTime: areaTime
    })
  },
  chooseDate: function(e) {
    let that = this
    date = new Date();
    hour = date.getHours()
    minute = date.getMinutes()
    let day = e.currentTarget.dataset.val
    let _today = util.getToday('day')
    let ind = e.currentTarget.dataset.index
    let deliverTime = this.data.deliverTime
    let areaTime = this.data.areaTime
    let _time = date.getTime
    let _obj = {
      start: hour + ':' + minute,
      end: (hour + 2) + ':' + minute,
      val: '2小时上门',
      name: '2小时',
      isChoose: false,
      disables: false
    }
    if (ind == 0) {
      if (areaTime.length < 5) {
        areaTime.unshift(_obj)
      }
    } else {
      if (areaTime.length > 4) {
        areaTime.splice(0, 1);
      }
    }
    for (let i in areaTime) {
      areaTime[i].isChoose = false
      areaTime[i].disabled = false
    }
    for (let i in deliverTime) {
      deliverTime[i].isChoose = false
      if (i == ind) {
        deliverTime[i].isChoose = true
      }
    }
    this.setData({
      deliverTime: deliverTime,
      areaTime: areaTime,
      chooseDay: day
    }, function() {
      if (_today == day) {
        that.setAreaTime()
      }

    })
    //unshift  shift
  },
  chooseAreaDate: function(e) {
    let that=this
    let ind = e.currentTarget.dataset.index
    let name = e.currentTarget.dataset.name
    let start = e.currentTarget.dataset.start
    let end = e.currentTarget.dataset.end
    let day = this.data.chooseDay.replace(/\-/g, "/")
    let _day = util.getToday('day').replace(/\-/g, "/")
    let oldDay = new Date(_day).getTime()
    let newDay = new Date(day).getTime()
    let areaTime = this.data.areaTime
    let sendTime = ''
    let len = areaTime.length - 1
    for (let i in areaTime) {
      areaTime[i].isChoose = false
      if (i == ind) {
        areaTime[i].isChoose = true
        if (ind == len) {
          app.AcFunc.myTotal('亲，请联系客服今天是否能发货哦！', 'none')
        }
      }
    }
    day = day.replace(/\//g, "-")
    let startTime = day + ' ' + start
    let endTime = day + ' ' + end
    let timeRange = start + '-' + end
    sendTime = day + ' ' + timeRange
    if (name == '2小时') {
      timeRange = '-1'
      sendTime = day + ' 2小时上门'
    }
    this.setData({
      areaTime: areaTime,
      startTime: startTime,
      endTime: endTime,
      sendTime: sendTime,
      timeRange: timeRange
    })
  },
  changeData: function(address, status) {
    if (status == 'send') {
      this.setData({
        sendAddr: address
      })
    } else {
      this.setData({
        deliveryAddr: address
      })
    }
    this.getLogistLine()
  },
  getLogistPrice: function() {
    let that = this
    let goodsMsg = this.data.goodsMsg
    let sendAddr = this.data.sendAddr
    let deliveryAddr = this.data.deliveryAddr
    let logistMsg = this.data.logistMsg
    let logistDetail = this.data.logistDetail
    if (goodsMsg && logistMsg) {
      let params = {
        enterpriseSpeciallineId: logistMsg.enterpriseSpeciallineId,
        //goodsType: goodsMsg.goodsType, //['heavy', 'light']
        goodsQty: goodsMsg.goodsQty,
        goodsWeight: goodsMsg.goodsWeight,
        goodsVolume: goodsMsg.goodsVolume,
        fromAddressVO: sendAddr[0],
        toAddressVO: deliveryAddr[0]
      }
      app.HttpService.logistQuery(params).then((res) => {
        logistDetail.shortAmtByFormula = res.cost
        that.setData({
          logistCost: res.cost,
          logistDetail: logistDetail
        }, () => {
          that.setbalanceAmt()
          that.getTotaoPrice()
        })
      }).catch((error) => {
        console.log(error)
      })

    } else {
      if (!goodsMsg) {
        app.AcFunc.myTotal('请输入货品信息')
        return
      }
      if (!logistMsg) {
        app.AcFunc.myTotal('请选择提货点')
        return
      }
    }
  },
  getParams: function() {
    let _data = this.data
    let logistDetail = _data.logistDetail
    let goodsMsg = _data.goodsMsg
    let sendp = _data.sendp
    let deliverp = _data.deliverp
    let startTime = _data.startTime
    let endTime = _data.endTime
    let sendAddr = _data.sendAddr[0]
    let deliveryAddr = _data.deliveryAddr[0]
    let logistMsg = _data.logistMsg
    let logistVOMsg = _data.logistVOMsg
    let declared = this.data.agreement
    let options = this.data.options
    if (!goodsMsg) {
      app.AcFunc.myTotal('请输入物品信息', 'none')
      return false
    }
    if (!sendAddr) {
      app.AcFunc.myTotal('请选择发货地址', 'none')
      return false
    }
    if (!deliveryAddr) {
      app.AcFunc.myTotal('请选择收货地址', 'none')
      return false
    }
    if (!logistVOMsg) {
      app.AcFunc.myTotal('请选择物流商', 'none')
      return false
    }
    if (!logistMsg) {
      app.AcFunc.myTotal('请选物流路线', 'none')
      return false
    }
    if (!sendp.name) {
      app.AcFunc.myTotal('请输入发货人信息', 'none')
      return false
    }
    if (!deliverp.name) {
      app.AcFunc.myTotal('请输入收货人信息', 'none')
      return false
    }
    if (!startTime) {
      app.AcFunc.myTotal('请选择发货时间', 'none')
      return false
    }
    if (!declared) {
      app.AcFunc.myTotal('请同意物流协议', 'none')
      return false
    }
    let params = {
      id: logistDetail.id,
      ownerId: logistDetail.ownerId,
      orderNo: logistDetail.orderNo, //秒账单号
      enterpriseId: logistVOMsg.id, //物流商id
      enterpriseSpeciallineId: logistMsg.enterpriseSpeciallineId, //专线id
      enterpriseSpeciallineUnloadId: logistMsg.id,
      orderStatus: logistDetail.orderStatus,
      paymentStatus: logistDetail.paymentStatus,
      isWait: logistDetail.isWait,
      detailVO: {
        id: logistDetail.detailVO.id,
        goodsName: goodsMsg.goodsName,
        sysGoodsType: goodsMsg.sysGoodsType,
        goodsQty: goodsMsg.goodsQty,
        goodsWeight: goodsMsg.goodsWeight,
        goodsVolume: goodsMsg.goodsVolume,
        consignor: sendp.name,
        consignorContactNo: sendp.tel,
        consignee: deliverp.name,
        consigneeContactNo: deliverp.tel,
        minPlanDelyDate: this.data.startTime,
        maxPlanDelyDate: this.data.endTime,
        timeRange: this.data.timeRange,
        planArriveDate: logistDetail.detailVO.planArriveDate,
        remark: goodsMsg.remark,
        delyAddressVO: {
          id: sendAddr.id,
          province: sendAddr.province,
          city: sendAddr.city,
          district: sendAddr.district,
          addressDetail: sendAddr.addressDetail
        },
        recvAddressVO: {
          id: deliveryAddr.id,
          province: deliveryAddr.province,
          city: deliveryAddr.city,
          district: deliveryAddr.district,
          addressDetail: deliveryAddr.addressDetail
        },
      },
      proxyAmt: app.AcFunc.money(this.data.deliveryFee, 2, false),
      totalAmt: app.AcFunc.money(this.data.totalAmt, 2, false),
      cloudShopFileInfoIds: this.data.cloudShopFileInfoIds.join(','),
      logisticFileInfoIds: this.data.logisticFileInfoIds.join(','),
      fileInfoIds: this.data.fileInfoIds.join(','),
      declared: declared,
      discountIdList: logistDetail.discountIdList,
      isShare: false
    }
    return params
  },
  updateOrder: function(e) {
    if (!this.data.agreement) {
      return false
    }
    let params = this.getParams()
    let that = this
    let _type = e.currentTarget.dataset.type
    let orderfrom = this.data.orderfrom
   
    let ischange=this.dataFilter(params)
  
    if (!params) {
      return
    }
    if (_type == 'wait') {
      params.isWait = true
    } else {
      params.isWait = false
    }
    if (params) {
      if (ischange) {
        wx.showModal({
          title: '提示',
          content: '此次操作将会同步上游卖家, 请确认是否继续操作\n*建议和卖家商量后再进行操作',
          success: (res) => {
            if (res.confirm) {
              app.HttpService.logistUpdate(params).then((res) => {
                console.log(res)
                // this.data.options.salesId = res.relateOrderId
                if (_type == 'paysubmit') {
                  that.payOrder(res)
                } else {
                  wx.showToast({
                    title: '保存成功！',
                  })
                  setTimeout(() => {
                    that.getLogistMsg(res.id)
                  }, 1500)
                  // setTimeout(() => {
                  //   wx.navigateBack({})
                  // }, 1500)
                }
              }).catch((error) => {
                app.AcFunc.myTotal(error, 'none')
              })
            }
          },
          fail: (error) => {

          }
        })
      } else {
        app.HttpService.logistUpdate(params).then((res) => {
          console.log(res)
          // this.data.options.salesId = res.relateOrderId
          if (_type == 'paysubmit') {
            that.payOrder(res)
          } else {
            wx.showToast({
              title: '保存成功！',
            })
            setTimeout(() => {
              that.getLogistMsg(res.id)
            }, 1500)
            
          }


        }).catch((error) => {
          app.AcFunc.myTotal(error, 'none')
        })
      }


    }
  },
  payOrder: function(detail) {
    let that = this
    let isShare = this.data.isShare
    let isbindOrder = this.data.isbindOrder
    if (!detail.enterpriseVO) {
      detail = this.data.logistDetail
    }
    app.pay({
      ownerId: detail.ownerId,
      logisticOrderId: detail.id,
      logisticCompName: detail.enterpriseVO.name,
      totalAmt: detail.balanceAmt
    }).init().then((res) => {
      // if (isShare && !isbindOrder) {
      //   that.getShareLogist(detail.id);
      // }else{
      //   that.getLogistMsg(detail.id)
      // }
      that.setParentPage(detail)
      wx.navigateBack({})
    }).catch((error) => {
      setTimeout(()=>{
        that.setParentPage(detail)
        wx.navigateBack({})
      },1500)
    })
  },
  getOrderNumber(name, len) {
    let pamars = {
      prefix: name,
      length: len ? len : 4
    }
    app.HttpService.orderNumber(pamars).then((res) => {
      console.log(res)
      this.setData({
        logistNumber: res
      })
    }).catch((error) => {
      console.log(error)
    })
  },
  agreementMsg: function() {
    wx.navigateTo({
      url: '/pages/agreement/logist/index',
    })
  },
  getTotaoPrice: function() {
    let logistCost = parseFloat(this.data.logistCost)
    let deliveryFee = parseFloat(this.data.deliveryFee)
    let logistDetail = this.data.logistDetail
    let balanceAmt = logistDetail.balanceAmt
    let payAmt = logistDetail.payAmt
    let totalPrice = logistDetail.shortAmtByFormula + deliveryFee
    if (payAmt == totalPrice){
      balanceAmt=0
    }else{
      if (payAmt>0){
        balanceAmt = totalPrice - payAmt
      }else{
        balanceAmt = totalPrice
      }
    }
    logistDetail.balanceAmt = app.AcFunc.money(balanceAmt, 2, false)
    this.setData({
      totalAmt: app.AcFunc.money(totalPrice, 2, false),
      logistDetail: logistDetail
    })
  },
  setParentPage: function(data) {
    var pages = getCurrentPages();
    if (pages.length > 1) {
      var prePage = pages[pages.length - 2];
      if (prePage.operData){
        prePage.operData(data)
      }
    }
    //wx.navigateBack({})
  },
  toAddrList: function(e) {
    if (!this.data.logistDetail.isEdit) {
      return false
    }
    let name = e.currentTarget.dataset.name
    let status = name
    let id = null
    let sendAddr = this.data.sendAddr ? this.data.sendAddr : []
    let deliveryAddr = this.data.deliveryAddr ? this.data.deliveryAddr : []
    if (name == "send") {
      id = sendAddr[0].id
    } else {
      id = deliveryAddr[0].id
    }
    wx.navigateTo({
      url: '/pages/order/addressList/index?status=' + name + '&id=' + id,
      success: function(res) {},
      fail: function(res) {},
      complete: function(res) {},
    })
  },
  //**清空差额 */
  setbalanceAmt: function() {
    let logistDetail = this.data.logistDetail
    let logistCost = parseFloat(this.data.logistCost)
    let deliveryFee = parseFloat(this.data.deliveryFee)
    let payAmt = logistDetail.payAmt
    let balanceAmt = logistCost + deliveryFee
    if (balanceAmt == payAmt){
      balanceAmt=0
    }
    logistDetail.balanceAmt = app.AcFunc.money(balanceAmt, 2, false)
    this.setData({
      logistDetail: logistDetail
    })
  },
  loginShop: function() {
    let query = this.data.options
    wx.navigateTo({
      url: '/pages/login/index' + app.AcFunc.objToUrl(query),
    })
  },
  /**更改上个页面 */
  changePage: function() {

  },
  /**创建支付账户 */
  createPayAccount(pamars) {
    let that = this
    app.HttpService.createPayAccount(pamars).then((res) => {
      console.log(res)
      that.createPayOrder(res)
    }).catch((error) => {
      app.AcFunc.myTotal(error, 'none')
    })
  },
  /**生成支付性息 */
  createPayOrder(account) {
    let pamars = {}
    app.HttpService.createPayOrder(pamars).then((res) => {
      console.log(res)
    }).catch((error) => {
      app.AcFunc.myTotal(error, 'none')
    })
  },
  goodsChange: function(e) {
    let val = e.detail.value
    let name = e.currentTarget.dataset.name
    let goodsMsg = this.data.goodsMsg
    if (name != 'goodsName') {
      val = app.AcFunc.money(val, 6,true)
    }
    goodsMsg[name] = val
    this.setData({
      goodsMsg: goodsMsg
    })
  },
  areaChange: function(e) {
    let val = e.detail.value
    let goodsMsg = this.data.goodsMsg
    goodsMsg.remark = val
    this.setData({
      goodsMsg: goodsMsg
    })
  },
  dataFilter:function(newData){
    let logistDetail = this.data.logistDetail
    let res=false
    let oldDate = {
      enterpriseId: logistDetail.enterpriseId, //物流商id
      enterpriseSpeciallineId: logistDetail.enterpriseSpeciallineId, //专线id
      enterpriseSpeciallineUnloadId: logistDetail.enterpriseSpeciallineUnloadId,
      detailVO: {
        goodsName: logistDetail.detailVO.goodsName,
        sysGoodsType: logistDetail.detailVO.sysGoodsType,
        goodsQty: logistDetail.detailVO.goodsQty,
        goodsWeight: logistDetail.detailVO.goodsWeight,
        goodsVolume: logistDetail.detailVO.goodsVolume,
        consignor: logistDetail.detailVO.consignor,
        consignorContactNo: logistDetail.detailVO.consignorContactNo,
        consignee: logistDetail.detailVO.consignee,
        consigneeContactNo: logistDetail.detailVO.consigneeContactNo,
        timeRange: logistDetail.detailVO.timeRange,
        maxPlanDelyDate: logistDetail.detailVO.maxPlanDelyDate.substr(0,10),
        remark: logistDetail.detailVO.remark,
        delyAddressVO: {
          id: logistDetail.detailVO.delyAddressVO.id
        },
        recvAddressVO: {
          id: logistDetail.detailVO.recvAddressVO.id
        },
      },
      proxyAmt: logistDetail.proxyAmt,
      cloudShopFileInfoIds: logistDetail.cloudShopFileInfoIds,
    }
    let o_detail = oldDate.detailVO
    let n_detail = newData.detailVO
    n_detail.maxPlanDelyDate = n_detail.maxPlanDelyDate.substr(0, 10)
    for (let i in oldDate){
      if (i == "detailVO"){
        continue
      }else{
        if (oldDate[i] != newData[i]) {
          res = true
          break
        }
      }
    }
    if(!res){
      for (let j in o_detail) {
        if (j == "delyAddressVO" || j == "recvAddressVO") {
          continue
        } else {
          if (o_detail[j] != n_detail[j]) {
            res = true
            break
          }
        }
      }
    }
    if(!res){
      if (n_detail.delyAddressVO.id != o_detail.delyAddressVO.id || n_detail.recvAddressVO.id != o_detail.recvAddressVO.id) {
        res = true
      }
    }
    return res
  },
  sunArriveDate: function () {
    let endTime = this.data.endTime.replace(/\-/g, "/")
    let logistMsg = this.data.logistMsg
    let logistDetail=this.data.logistDetail
    let _h = parseInt(logistMsg.estimateTime)
    let m1 = _h * 60 * 60 * 1000
    let m2 = new Date(endTime).getTime()
    let _date = util.formatTime(m1 + m2)
    let arriveDate = _date.replace(/\//g, "-")
    logistDetail.detailVO.planArriveDate = arriveDate
    this.setData({
      logistDetail: logistDetail
    })
  }
}),{
  "navigationBarTitleText": "物流信息",
  "enablePullDownRefresh": false
},
  <view class='container {{showMask?"disabledScroll":""}}'>
    <view wx:if='{{isShare&&logistDetail.clientName}}' class='logistMod customer flex'>
      <view class='flex-1'>客户</view>
      <view class='c666'>{{logistDetail.clientName}}</view>
    </view>
    <view class='logistMod logistOper flex'>
      <view class='flex-1 self-center text'>
        <view class='fs10  blue'>①以托运站最终验货后开单价格为准，多退少补</view>
        <view class='fs10  blue'>②如需人工帮助,请致电0579-85059881,85059882</view>
      </view>
      <button open-type='share' class='operbtn self-center'>
        <icon class='iconfont icon-fenxiang'></icon>
        <view class='fs10'>分享订单</view>
      </button>
      <button wx:if='{{logistDetail.isCancel&&!isShared}}' bindtap='cancelOrder' class='operbtn self-center'>
        <icon class='iconfont icon-close'></icon>
        <view class='fs10'>取消订单</view>
      </button>
      <button wx:if='{{logistDetail.orderStatus=="wait"}}' data-type='{{logistDetail.orderStatus}}' bindtap='updateOrder' class='operbtn self-center'>
        <icon class='iconfont icon-wait'></icon>
        <view class='fs10'>存为草稿</view>
      </button>
    </view>
    <view class='logistMod'>
      <view class='msgMod logistStatus flex'>
        <view class='flex-1'>
          <view class='fs13'>物流单号:{{logistDetail.orderNo}}</view>
          <view wx:if='{{logistDetail.idDeff}}' class='fs13'>预估到货时间:{{logistDetail.detailVO.planArriveDate}}</view>
          <view wx:else class='fs13'>到货时间:{{logistDetail.arriveDate}}</view>
          <view wx:if='{{logistDetail.orderStatus=="reject"}}' class='fs12 error'>拒收理由:{{logistDetail.rejectReason }}</view>
        </view>
        <view class='orderState'>
          <!-- <view class='state state_{{logistDetail.orderStatus}}'>
          <icon class="iconfont icon-{{logistDetail.orderStatus}}"></icon>
          <view class="text">
            <text wx:if='{{logistDetail.paymentStatus=="unpaid"&&logistDetail.orderStatus!="wait"}}' class='c666'>未支付</text>
            <text>{{logistDetail.statusDesc}}</text>
          </view>
        </view> -->
          <image wx:if="{{logistDetail.paymentStatus}}" src='/images/order/{{logistDetail.paymentStatus}}{{logistDetail.orderStatus}}.png'></image>
          <view class='unPay' wx:if='{{logistDetail.balanceAmt>0&&logistDetail.paymentStatus=="paid"}}'>
            <image src='/images/order/unpay.png'></image>
          </view>
        </view>
      </view>
      <view class='msgMod flex' bindtap='fillInGoods'>
        <view class='flex-1 self-center'>
          <view class='fs13'>物品信息:{{logistDetail.detailVO.goodsMsg}}</view>
          <!-- <view class='fs13 c999'>{{logistDetail.detailVO.remark}}</view> -->
        </view>
        <view class='self-center' wx:if='{{logistDetail.isEdit}}'>
          <image mode='widthFix' src='/images/order/Right.png'></image>
        </view>
      </view>
      <view class='addrMod flex'>
        <view class='self-center left-icon'>
          <view class='icon-box'>
            <image mode='widthFix' src='/images/order/send2x.png'></image>
            <view class='line'></view>
            <image mode='widthFix' src='/images/order/get2x.png'></image>
          </view>
        </view>
        <view class='flex-1'>
          <view class='flex sendAddr'>
            <view class='flex-1 self-center flex' data-name='send' bindtap='toAddrList'>
              <view class='flex-1'>
                <view class='breakWord'>
                  <text wx:if='{{sendAddr.length>0}}'>{{sendAddr[0].province}}{{sendAddr[0].city}}{{sendAddr[0].district}}{{sendAddr[0].addressDetail}}</text>
                  <input disabled='disabled' wx:else placeholder-class='c999' placeholder='请选择发货地址'></input>
                </view>
              </view>
              <view class='self-center m-20' wx:if='{{logistDetail.isEdit}}'>
                <image mode='widthFix' src='/images/order/Right.png'></image>
              </view>
            </view>
            <!-- <view class='self-center status' wx:if="{{1==1}}" bindtap='addrDefault'>
            <text class='{{defaultAddr?"isDefault":""}}'>默认</text>
          </view> -->
          </view>
          <view class='flex delivAddr' data-name='delivery' bindtap='toAddrList'>
            <view class='flex-1 self-center'>
              <view class='breakWord'>
                <text wx:if='{{deliveryAddr.length>0}}'>{{deliveryAddr[0].province}}{{deliveryAddr[0].city}}{{deliveryAddr[0].district}}{{deliveryAddr[0].addressDetail}}</text>
                <input disabled='disabled' wx:else placeholder-class='c999' placeholder='请选择收货地址'></input>
              </view>
            </view>
            <view class='self-center  m-20' wx:if='{{logistDetail.isEdit}}'>
              <image mode='widthFix' src='/images/order/Right.png'></image>
            </view>
          </view>
        </view>
      </view>

    </view>
    <view class='logistMod'>
      <view class='msgMod flex' bindtap='logistDealer'>
        <view class='name self-center'>物流商</view>
        <view class='flex-1 self-center center'>
          <!-- <input value='{{logistVOMsg.name}}' placeholder='请选择物流商' placeholder-class='c999' disabled='disabled'></input> -->
          <picker bindchange="chooseDealer" disabled='{{(logistAll.length>0)?false:true}}' value="{{d_index}}" range="{{dealerList}}">
            <view class="picker {{dealerList[d_index]=='请选择物流商'?'c999':''}}">
              {{dealerList[d_index]}}
            </view>
            <image wx:if='{{logistDetail.isEdit}}' mode='widthFix' src='/images/order/Right.png'></image>
          </picker>
        </view>
      </view>
      <view class='msgMod logistMsg flex' bindtap='showLogist'>
        <view class='name self-center'>物流信息</view>
        <block wx:if='{{logistList.length>0}}'>
          <view class='flex-1 self-center center'></view>
          <view class='self-center'>
            <image mode='widthFix' src='/images/order/Down.png' animation='{{downAnimation}}'></image>
          </view>
        </block>
        <block wx:else>
          <view class='flex-1 text-right red'>{{logistText}}</view>
        </block>
      </view>
      <radio-group class='logistList' wx:if='{{showLogist}}' bindchange="radioChange">
        <label class='listMsg flex' wx:for='{{logistList}}' wx:key='{{item.id}}' bindtap='logistMsgClick' data-parid='{{item.parid}}' data-childindex='{{index}}'>
          <view class='flex-1'>
            <view>{{logistVOMsg.name}}{{item.unloadAddressVO.addressType?'-'+item.unloadAddressVO.addressType:''}}</view>
            <view class='c666 fs12'>{{item.contactNo}}</view>
            <view class='c666 fs12'>{{item.unloadAddressVO.addressDetail}}</view>
            <view class='c999 fs11'>
              距离送货地址
              <text class='yello'>{{item.distance?item.distance:0}}km</text> 运输时效:
              <text class='yello'>{{item.estimateTime?item.estimateTime:0}}h</text>
            </view>
          </view>
          <view class='flex'>
            <view class='call flex-1 self-center' data-phone='{{item.contactNo}}' catchtap='callLogist'>
              <icon class='iconfont icon-call'></icon>
            </view>
            <view class='choose flex-1 self-center'>
              <block wx:if="{{logistDetail.isEdit}}">
                <radio value="{{item.id}}" checked="{{item.isChos}}" color='#00A6F5' />
              </block>
              <block wx:else>
                <radio value="{{item.id}}" checked="{{item.isChos}}" disabled='disabled' color='#00A6F5' />
              </block>
            </view>
          </view>

        </label>
      </radio-group>
    </view>
    <view class='logistMod'>
      <view class='msgMod flex' bindtap='sendMsg'>
        <view class='name self-center'>发货人信息</view>
        <view class='flex-1 self-center center'>
          {{sendp.name}}{{sendp.tel?"("+sendp.tel+")":""}}
        </view>
        <view wx:if='{{logistDetail.isEdit}}'>
          <image mode='widthFix' src='/images/order/Right.png'></image>
        </view>
      </view>
      <view class='msgMod flex' bindtap='getMsg'>
        <view class='name self-center'>收货人信息</view>
        <view class='flex-1 self-center center breakWord'>
          {{deliverp.name}}{{deliverp.tel?"("+deliverp.tel+")":""}}
          <!-- <input value='{{deliverp.name}}{{deliverp.tel?"("+deliverp.tel+")":""}}' placeholder='请输入收货人信息' placeholder-class='c999' disabled='disabled'></input> -->
        </view>
        <view wx:if='{{logistDetail.isEdit}}'>
          <image mode='widthFix' src='/images/order/Right.png'></image>
        </view>
      </view>
      <view class='msgMod flex' bindtap='chooseDeliverTime'>
        <view class='name self-center'>
        <text wx:if='{{logistDetail.idDeff}}'>预约发货时间</text>
        <text wx:else>发货时间</text>
        </view>
        <view class='deliveryTime flex-1 self-center text-right'>
        <block wx:if='{{logistDetail.idDeff}}'><input value='{{sendTime}}' class='fs12' placeholder='请选择发货时间' placeholder-class='c999 fs14' disabled='disabled'></input></block>
        <block wx:else><input value='{{logistDetail.delyDate }}' class='fs12' placeholder='请选择发货时间' placeholder-class='c999 fs14' disabled='disabled'></input></block>
        </view>
        <view class='self-center' wx:if='{{logistDetail.isEdit}}'>
          <image mode='widthFix' src='/images/order/Right.png'></image>
        </view>
      </view>
      <view class='msgMod flex'>
        <view class='name self-center'>代付提货费</view>
        <view class='flex-1 self-center'>
          <block wx:if="{{logistDetail.isEdit}}">
            <input class='price' type='digit' value='{{deliveryFee}}' placeholder='请输入提货费' bindblur='priceChange' placeholder-class='c999'></input>
          </block>
          <block wx:else>
            <input class='price' value='{{deliveryFee}}' disabled='disabled' placeholder='请输入提货费' placeholder-class='c999'></input>
          </block>

        </view>
      </view>
      <!-- <view class='msgMod flex' bindtap='discountChose'>
        <view class='self-center'>秒账优惠</view>
        <view class='flex-1 self-center center'>
            <block wx:if="{{1==2}}">
                <text>小李（15051408253）</text>
            </block>
            <block wx:else>
                <text class='c999'>请选择优惠券</text>
            </block>
        </view>
        <view>
            <image mode='widthFix' src='/images/order/Right.png'></image>
        </view>
    </view> -->
      <view class='msgMod flex uploadImg'>
        <view class='imgList' wx:if='{{cloudImg.length>0||xsImg.length>0}}'>
          <view class='picBox' wx:for="{{cloudImg}}" wx:key="">
            <image src='{{item}}' data-type='cloud' data-index="{{index}}" bindtap='operPic' data-src='{{item}}'></image>
          </view>
          <view class='picBox' wx:for="{{xsImg}}" wx:key="">
            <image src='{{item}}' data-type='xs' data-index="{{index}}" bindtap='operPic' data-src='{{item}}'></image>
          </view>
          <view class='uploadBtn' bindtap='uploadFile' wx:if='{{logistDetail.isEdit}}'>
          <icon class='iconfont icon-camera'></icon>
          <view class='fs12'>上传附件</view>
        </view>
        </view>
        
      </view>
    </view>
    <view class='logistMod' wx:if='{{logistImg.length>0}}'>
      <view class='msgMod'>
        <view class='title'>物流单回执</view>
        <view class='imgList'>
          <view class='picBox' wx:for="{{logistImg}}" wx:key="" >
            <image src='{{item}}' data-type='logist' data-index="{{index}}" bindtap='operPic' data-src='{{item}}'></image>
          </view>
        </view>
      </view>
    </view>
    <view class='logistMod remark'>
      <block wx:if='{{logistDetail.isEdit}}'>
        <input class='textArea' placeholder='备注' value='{{goodsMsg.remark}}' bindinput='areaChange'></input>
      </block>
      <block wx:else>
        <view class='c666 textArea'>{{goodsMsg.remark}}</view>
      </block>
    </view>
    <view class='logistMod detailMsg' wx:if='{{updateLog.length>0}}'>
      <view class='title'>修改记录</view>
      <view class='message' wx:for='{{updateLog}}' wx:key='{{item.id}}'>
        <view class='fs12'>{{item.changeBrief}}</view>
        <view class='c666 fs12'>修改人：{{item.name}}
          <text>{{item.createDate}}</text>
        </view>
      </view>
    </view>
  </view>
<view class='logistBtn' id='logistdetail'>
  <view wx:if='{{isShare}}' class='sharedtext text-center'>数据已同步到云店，登录云店后可以详细查看内容，可以下物流单</view>
  <view wx:else class='aggrement border-box'>
    <checkbox checked='{{agreement}}' color='#00a6f5' bindtap='agreChange'></checkbox>
    我已阅读并同意
    <text class='darkblue' bindtap='agreementMsg'>《物流服务协议》</text>
    <view class='float-right' wx:if='{{logistDetail.paymentStatus=="paid"&&logistDetail.balanceAmt!=0}}'>已付金额:
      <text class='red'>{{logistDetail.payAmt}}</text> 
      </view>
      <view class='float-right' wx:if='{{logistDetail.paymentStatus=="unpaid"&&deliveryFee>0}}'>预估运费:
      <text class='red'>{{logistDetail.shortAmt}}</text> 
      </view>
  </view>
  <view class='flex'>
    <view class='flex-1 self-center'>
      <view class='fs11' wx:if='{{logistDetail.paymentStatus=="paid"&&logistDetail.balanceAmt!=0}}'>差额:
        <text class='red fs15'>￥{{logistDetail.balanceAmt}}</text>
      </view>
      <view class='fs11' wx:elif='{{logistDetail.paymentStatus=="paid"&&logistDetail.balanceAmt==0}}'>已付金额:
        <text class='red fs15'>￥{{logistDetail.payAmt}}</text>
      </view>
      <view class='fs11' wx:elif='{{logistDetail.paymentStatus=="unpaid"}}'>
         <block wx:if='{{deliveryFee>0}}'>实际应付:</block>
         <block wx:else>预估运费:</block>
        <text class='red fs15'>￥{{logistDetail.balanceAmt}}</text>
      </view>
    </view>
    <block wx:if='{{logistDetail.orderStatus=="wait"&&isLogin}}'> 
      <view class='btn subBtn {{!agreement?"disabled":""}}' bindtap='updateOrder'>提交订单</view>
      <view class='btn paySubBtn {{!agreement?"disabled":""}}' data-type='paysubmit' bindtap='updateOrder'>支付并提交</view>
    </block>
    <block wx:elif='{{logistDetail.isEdit}}'>
      <block wx:if='{{logistDetail.paymentStatus=="paid"&&logistDetail.orderStatus=="undispatch"&&logistDetail.balanceAmt<=0}}'></block>
      <block wx:else>
      <view class='btn subBtn {{!agreement?"disabled":""}}' bindtap='updateOrder'>
        保存
      </view>
      <view class='btn paySubBtn {{!agreement?"disabled":""}}' wx:if='{{logistDetail.hasPay}}' data-type='paysubmit' bindtap='updateOrder'>
        保存并支付
      </view>
      </block>
      
    </block>
    <block wx:elif='{{logistDetail.hasPay}}'>
      <view class='btn payOrder {{!agreement?"disabled":""}}' bindtap='payOrder'>
        支付订单
      </view>
      <block wx:if='{{isShare&&!isLogin}}'>
        <view class='btn paySubBtn loginshop' bindtap='loginShop'>
          进入云店
        </view>
      </block>
      <!-- <block wx:elif='{{logistDetail.balanceAmt>0}}'>
      <view class='btn subBtn' bindtap='payAndSubmit'>
        支付订单
      </view>
    </block> -->
    </block>
  </view>
</view>

<view class='mask' wx:if="{{showMask}}"></view>
<view class='modMsg goodsMod' animation="{{goodsAnimation}}">
  <form bindsubmit="goodsSubmit">
    <view class='goodsText text-center title'>货品信息</view>
    <view class='goodsText flex'>
      <view class='self-center'>货品名称</view>
      <view class='flex-1 text-right'>
        <input name='goodsname' value='{{goodsMsg.goodsName}}' placeholder='请输入货品名称' data-name='goodsName' bindblur='goodsChange'></input>
      </view>
    </view>
    <view class='goodsText flex'>
      <view class='self-center'>箱数</view>
      <view class='flex-1 text-right'>
        <input name='boxnum' type='digit' value='{{goodsMsg.goodsQty}}' placeholder='请输入箱数' data-name='goodsQty' bindblur='goodsChange'></input>
      </view>
    </view>
    <view class='goodsText flex'>
      <view class='flex-1 flex weight'>
        <view class='name  self-center'>重量</view>
        <view class='flex-1 text-right '>
          <input name='weight' type='digit' value='{{goodsMsg.goodsWeight}}' placeholder='重量' data-name='goodsWeight' bindblur='goodsChange'></input>
        </view>
        <view class=' self-center'>吨</view>
      </view>
      <view class='flex-1 flex volume'>
        <view class='name self-center'>体积</view>
        <view class='flex-1 text-right'>
          <input name='volume' type='digit' value='{{goodsMsg.goodsVolume}}' placeholder='体积' data-name='goodsVolume' bindblur='goodsChange'></input>
        </view>
        <view class='self-center'>m3</view>
      </view>
    </view>
    <view class='ModBtn'>
      <button type='default' bindtap='goodsReset'>取消</button>
      <button type='success' form-type='submit'>保存</button>
    </view>
  </form>
</view>
<view class='modMsg logistDealerMod' animation='{{dealerAnimation}}'>
  <view class='title text-left'>物流商</view>
  <view class='listBox'>
    <scroll-view scroll-y='true' style='max-height:400rpx;'>
      <view wx:for="{{logistAll}}" wx:key='{{item.id}}' data-index='{{index}}' data-id='{{item.id}}' bindtap='chooseDealer' class='{{item.ischos?"choose":""}}'>
        {{item.name}}
      </view>
    </scroll-view>
  </view>
  <view class='ModBtn'>
    <button type='default' bindtap='canlelDealer'>取消</button>
    <button type='success' bindtap='sureDealer'>确定</button>
  </view>
</view>
<view class='modMsg sendGoodMod' animation='{{sendAnimation}}'>
  <form bindsubmit='getSendMsg'>
    <view class='title'>发货人信息</view>
    <view class='flex'>
      <view class='name self-center'>发货人</view>
      <view class='flex-1 text-right'>
        <input name='name' value='{{sendp.name}}' placeholder='发货人'></input>
      </view>
      <!-- <view class='self-center defaultMsg'>
                <text>默认</text>
            </view> -->
    </view>
    <view class='flex'>
      <view class='name self-center'>联系电话</view>
      <view class='flex-1 text-right'>
        <input name='tel' value='{{sendp.tel}}' placeholder='联系电话'></input>
      </view>
      <!-- <view class='self-center defaultMsg'>
                <text>默认</text>
            </view> -->
    </view>
    <view class='ModBtn'>
      <button type='default' bindtap='setSendMsg'>取消</button>
      <button type='success' form-type='submit'>确定</button>
    </view>
  </form>
</view>
<view class='modMsg sendGoodMod' animation='{{getAnimation}}'>
  <form bindsubmit='getDeliverMsg'>
    <view class='title'>收货人信息</view>
    <view class='flex'>
      <view class='name self-center'>收货人</view>
      <view class='flex-1 text-right'>
        <input name='name' value='{{deliverp.name}}' placeholder='收货人'></input>
      </view>
    </view>
    <view class='flex'>
      <view class='name self-center'>联系电话</view>
      <view class='flex-1 text-right'>
        <input name='tel' value='{{deliverp.tel}}' placeholder='联系电话'></input>
      </view>
    </view>
    <view class='ModBtn'>
      <button type='default' bindtap='setDeliverMsg'>取消</button>
      <button type='success' form-type='submit'>确定</button>
    </view>
  </form>
</view>
<view class='modMsg discountMod' animation='{{discountAnimation}}'>
  <view class='title'>秒账优惠</view>
  <radio-group class='discountList' bindchange="discountChange">
    <label class='flex' wx:for='{{discountList}}' wx:key='{{item.id}}'>
      <view class='flex-1 self-center'>{{item.msg}}</view>
      <view class='self-center chooseBox'>
        <radio value="{{discountList.id}}" checked="{{discountList.isChos}}" color='#FFAA00' />
      </view>
    </label>
  </radio-group>
  <view class='ModBtn'>
    <button type='default' bindtap='canlelDiscount'>取消</button>
    <button type='success' bindtap='sureDiscount'>确定</button>
  </view>
</view>
<view class='modMsg deliveryTimeMod' animation='{{timeAnimation}}'>
  <view class='title flex'>
    <view class='btn self-centrer' bindtap='cancelDelivery'>取消</view>
    <view class='flex-1'>预约发货时间</view>
    <view class='btn self-centrer' bindtap='sureDelivery'>确认</view>
  </view>
  <view>
    <scroll-view class='myscroll border-box' scroll-x='true' bindscrolltolower='addOtherDays'>
      <block wx:for='{{deliverTime}}' wx:key=''>
        <view class='item {{item.isChoose?"cur":""}}' data-index='{{index}}' data-val='{{item.day}}' wx:if='{{index==0}}' bindtap='chooseDate'>
          <view>今天</view>
          <view>{{item.day}}</view>
        </view>
        <view class='item {{item.isChoose?"cur":""}}' data-index='{{index}}' data-val='{{item.day}}' wx:elif='{{index==1}}' bindtap='chooseDate'>
          <view>明天</view>
          <view>{{item.day}}</view>
        </view>
        <view class='item {{item.isChoose?"cur":""}}' data-index='{{index}}' data-val='{{item.day}}' wx:elif='{{index==2}}' bindtap='chooseDate'>
          <view>后天</view>
          <view>{{item.day}}</view>
        </view>
        <view class='item {{item.isChoose?"cur":""}}' data-index='{{index}}' data-val='{{item.day}}' wx:else bindtap='chooseDate'>
          <view>预约</view>
          <view>{{item.day}}</view>
        </view>
      </block>
    </scroll-view>
    <view class='times'>
      <block wx:for='{{areaTime}}' wx:key=''>
        <block wx:if='{{item.disabled}}'>
          <view class='col'>
            <text class='disabled' data-index='{{index}}' data-start='{{item.start}}' data-end='{{item.end}}'>{{item.val}}</text>
          </view>
        </block>
        <block wx:else>
          <view class='col'>
            <text class='{{item.isChoose?"cur":""}}' data-name='{{item.name}}' data-index='{{index}}' data-start='{{item.start}}' data-end='{{item.end}}' bindtap='chooseAreaDate'>{{item.val}}</text>
          </view>
        </block>
      </block>
    </view>
  </view>
</view>,.container {
  width: 100%;
  padding-bottom:180rpx;
  overflow: hidden;
}
.customer{padding:20rpx;font-size:30rpx;}
.logistMod {
  background: #fff;
  margin-top: 24rpx;
}

.logistMod .msgMod {
  padding: 20rpx;
  border-bottom: 1px solid #efeff4;
}
.msgMod picker{
  margin-right:20rpx;
  position: relative;
}
.msgMod picker image{
  position: absolute;
  right:-40rpx;
  top:12rpx;
}
.logistMod .msgMod.logistMsg {
  border-bottom: 0;
}
.logistMod .msgMod > .name{
  white-space: nowrap;
}

.logistOper .operbtn {
  background: #fff;
  border-radius: 0;
  text-align: center;
  padding: 10rpx 0;
  border-left: 1px solid #ddd;
  line-height: 1.8;
  width: 100rpx;
  outline: none;
  list-style: none;
}

.logistOper .operbtn::after {
  border: none;
}

.logistOper .operbtn .iconfont {
  font-size: 40rpx;
  line-height: 100%;
}

.logistOper .text {
  padding: 20rpx;
}

.logistOper .text view {
  white-space: nowrap;
  overflow: hidden;
}

.touch-blue {
  color: #fff;
  background: #00a6f5;
}

.touch-gary {
  background: #f1f1f1;
}

.icon-Right, .icon-Down {
  font-size: 28rpx;
  color: #00a6f5;
  line-height: 48rpx;
}

.addrMod .sendAddr {
  border-bottom: 1px solid #f2f2f2;
}

.addrMod .sendAddr, .addrMod .delivAddr {
  padding: 20rpx 20rpx 20rpx 0;
  min-height: 60rpx;
}

.left-icon {
  padding: 0 20rpx;
}

.left-icon image {
  width: 30rpx;
}

.icon-box {
  width: 30rpx;
}

.icon-box .line {
  width: 15rpx;
  height: 46rpx;
  margin: 6rpx 0;
  border-right: 1px solid #ddd;
}

.addrMod .status {
  margin-left: 20rpx;
  border-left: 1px solid #ddd;
  padding-left: 20rpx;
  height: 80%;
}

.addrMod .status text {
  display: inline-block;
  width: 70rpx;
  text-align: center;
  line-height: 40rpx;
  font-size: 20rpx;
  border: 1px solid #ddd;
  border-radius: 0.3em;
}

.addrMod .status text.isDefault {
  color: #00a6f5;
  background: #e7f6fe;
  border-color: #00a6f5;
}

.m-l20 {
  margin-left: 20rpx;
}

.msgMod .center {
  margin: 0 20rpx;
  text-align: right;
}

.listMsg {
  border-top: 1px solid #efeff4;
}

.listMsg > .flex-1 {
  padding: 20rpx;
}

.listMsg .call {
  display: inline-block;
  margin: 0 20rpx;
  padding-right: 20rpx;
  border-right: 1px solid #ddd;
}

.listMsg .call icon {
  font-size: 48rpx;
  color: #00a6f5;
}

.listMsg .choose {
  display: inline-block;
  vertical-align: middle;
  padding-right: 20rpx;
}

.listMsg .yello {
  display: inline-block;
  margin-right: 20rpx;
}

.msgMod .picker-box {
  position: relative;
}

.msgMod image, .addrMod image {
  width: 24rpx;
}

.msgMod  .deliveryTime {
  padding-right: 20rpx;
}

.price {
  text-align: right;
  margin-right: 20rpx;
}

/*上传附件*/

.logistMod .uploadImg {
  padding: 0 10rpx;
}

.logistMod .uploadImg .imgList {
  overflow: hidden;
}

.imgList .picBox {
  position: relative;
  float: left;
  width: 120rpx;
  height: 120rpx;
  margin:20rpx 10rpx;
}

.imgList image {
  width: 120rpx;
  height: 120rpx;
}

.uploadImg .uploadBtn {
  float: left;
  margin:20rpx 10rpx;
  height: 120rpx;
  width: 120rpx;
  text-align: center;
  background: #f2f2f2;
}

.uploadImg icon {
  font-size: 48rpx;
  color: #999;
}

.aggrement {
  width: 100%;
  height:60rpx;
  line-height: 60rpx;
  background: #efeff4;
  z-index: 5;
  padding:0 20rpx;
  font-size: 24rpx;
}

.logistBtn {
  position: fixed;
  width: 100%;
  bottom: 0;
  background: #fff;
  box-shadow: -2px -2px 5px rgba(0, 0, 0, 0.1);
  -webkit-box-shadow: -2px -2px 5px rgba(0, 0, 0, 0.1);
  z-index: 10;
}
.logistBtn > .flex{
  min-height:100rpx;
}

.logistBtn .flex-1 {
  padding-left: 20rpx;
}

.logistBtn .btn {
  width: 160rpx;
  text-align: center;
  line-height: 100rpx;
  color: #fff;
  font-size: 24rpx;
}

.logistBtn .subBtn {
  background: #35d2c6;
}

.logistBtn .paySubBtn {
  background: #00a6f5;
}
.logistBtn .payOrder {
  background: #35D2C6;
}
.logistBtn .loginshop{
  padding:0;
}
.logistBtn .disabled{
  background: #d5d5d5;
  color:#999;
}
.mask {
  position: fixed;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.4);
  top: 0;
  left: 0;
}

.modMsg {
  position: fixed;
  width: 100%;
  background: #fff;
  bottom: -100%;
  z-index: 10;
}

.goodsMod .title {
  line-height: 60rpx;
}

.goodsMod .goodsText {
  padding: 20rpx;
  border-bottom: 1px solid #f2f2f2;
}

.goodsText .name {
  min-width: 80rpx;
}

.goodsText .weight {
  margin-right: 80rpx;
}

.goodsText .volume {
  margin-left: 80rpx;
}

.goodsText .volume input, .goodsText .weight input {
  padding-right: 20rpx;
}

.goodsMod .property text {
  display: inline-block;
  margin-left: 20rpx;
  padding: 10rpx 30rpx;
  background: #f1f1f1;
  font-size: 24rpx;
}

.goodsMod .property text.choose {
  color: #fff;
  background: #ffbc51;
}

.ModBtn {
  padding: 40rpx 0 20rpx;
  text-align: center;
  vertical-align: middle;
}

.ModBtn button {
  display: inline-block;
  margin: 0 7.5%;
  width: 35%;
  font-size: 30rpx;
}

.logistDealerMod .listBox view {
  text-align: center;
  line-height: 80rpx;
  font-size: 24rpx;
  border-bottom: 1px solid #f2f2f2;
}

.logistDealerMod .listBox view.choose {
  color: #00a6f5;
}

.logistDealerMod .title {
  line-height: 100rpx;
  text-align: center;
  border-bottom: 1px solid #f2f2f2;
}

.sendGoodMod .title {
  line-height: 100rpx;
  text-align: center;
  border-bottom: 1px solid #ddd;
}

.sendGoodMod .flex {
  padding: 20rpx;
  border-bottom: 1px solid #ddd;
}

.sendGoodMod .defaultMsg {
  margin-left: 20rpx;
  padding-left: 20rpx;
  border-left: 1px solid #ddd;
}

.sendGoodMod .defaultMsg text {
  display: inline-block;
  width: 70rpx;
  text-align: center;
  line-height: 40rpx;
  font-size: 20rpx;
  border: 1px solid #ddd;
  border-radius: 0.3em;
}

.sendGoodMod .defaultMsg text.isDefault {
  color: #00a6f5;
  background: #e7f6fe;
  border-color: #00a6f5;
}

.discountMod .title {
  line-height: 100rpx;
  text-align: center;
  border-bottom: 1px solid #ddd;
}

.discountMod label {
  padding: 20rpx;
  border-bottom: 1px solid #ddd;
}

.discountMod .chooseBox {
  margin-left: 20rpx;
}

.deliveryTimeMod .title {
  background: #00a6f5;
  color: #fff;
  text-align: center;
  padding: 20rpx;
}

.deliveryTimeMod .title .btn {
  padding: 0 20rpx;
  font-size: 24rpx;
}

.deliveryTimeMod .times {
  padding: 0 10rpx 20rpx;
}

.deliveryTimeMod .times .col {
  display: inline-block;
  width: 33.333%;
  padding: 0 10rpx;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  text-align: center;
  margin: 20rpx 0 0;
}

.deliveryTimeMod .times text {
  display: inline-block;
  padding: 20rpx 0;
  width: 100%;
  border: 1px solid #c4c4c4;
  border-radius: 0.3em;
  font-size: 24rpx;
}

.deliveryTimeMod .times text.cur {
  background: #ffbc51;
  border-color: #ffbc51;
  color: #fff;
}

.deliveryTimeMod .times text.disabled {
  color: #999;
}

.deliveryTimeMod .myscroll {
  white-space: nowrap;
  height: 140rpx;
  padding: 0 10rpx;
}

.deliveryTimeMod .myscroll .item {
  display: inline-block;
  margin: 20rpx 10rpx;
  border: 1px solid #c4c4c4;
  border-radius: 0.3em;
  text-align: center;
  padding: 10rpx 30rpx;
  font-size: 24rpx;
}

.deliveryTimeMod .myscroll .item.cur {
  color: #ffbc51;
  border-color: #ffbc51;
}
.sharedtext{
  color:#c8c8c8;
  font-size:24rpx;
  margin:40rpx 0 10rpx;
}
.detailMsg {
  padding: 0;
}

.detailMsg .title {
  padding: 20rpx 20rpx 0;
}

.detailMsg .message {
  padding: 20rpx;
  border-bottom: 1px solid #efeff4;
}

.detailMsg .message text {
  display: inline-block;
  margin-left: 30rpx;
}
,let util = require('../../../utils/util.js')
let app = getApp()
let t_x = 0;
let t_y = 0;
let timeInterval;
let times = 0;

let downanimation = wx.createAnimation({
  duration: 300,
  timingFunction: 'ease',
})
let moreanimation = wx.createAnimation({
  duration: 300,
  timingFunction: 'ease',
})
Page({
  data: {
    options: {},
    orderId: 0,
    detailVO: {},
    showProList: false,
    showMoreLogist: 2,
    proPrice: ['2882.00', '3554.00', '5245.00'],
    p_index: 0,
    delyWay: 'selfLogistic',
    ordernumber: null,
    downAnimate: {},
    moreAnimate: {},
    P: {},
    prodList: [],
    swiperProps: [],
    pagesNum: 1,
    circular: false,
    direction: '',
    cloudStatus: 'shared', //['waitReceive', 'received', 'refused', 'deleted', 'shared']
    headDesc: {
      iconclass: '',
      text: ''
    },
    isShare: false,
    isLogin: false,
    isbindOrder: false,
    isEdit: false,
    showPrice:true,
    orderCount: {
      der: 0,
      under: 0
    },
    editList: null,
    addressIds: null,
    addrList: null,
    logistList: [],
    cloudShopFileInfoIds: [],
    fileInfoIds: [],
    cloudImgList: [],
    xsImgList: [],
    prodNum: 0,
    chosLogistText: '选秒账物流，享运费八折（线下退，最高减100元/单）'
  },
  onLoad: function(options) {
    console.log(options)
    let that = this
    let orderId = options.id ? options.id : 0
    let bindOrder = options.bindOrder
    let _from = options.action
    let isShare = false,
      isLogin = true,
      isEdit = false,
      isbindOrder = false
    if (_from == 'viewCloudShopOrder') {
      isEdit = false
      isShare = true
      isbindOrder = true
      if (bindOrder == 'fail') {
        isLogin = false
      } else {
        isLogin = true
      }
    } else {
      if (bindOrder) {
        isShare = true
        isEdit = false
        if (bindOrder == 'fail') {
          isLogin = false
          isbindOrder = false
        } else if (bindOrder == 'pendding') {
          isLogin = true
          isbindOrder = false
        } else {
          isbindOrder = true
          isLogin = true
        }
      }
    }
    let ownerId = options.ownerId
    if (ownerId){
      wx.setStorageSync('owner', ownerId)
    }
    this.setData({
      options: options,
      orderId: orderId,
      isShare: isShare,
      isLogin: isLogin,
      isEdit: isEdit,
      isbindOrder: isbindOrder
    })
    let setTime = setTimeout(function() {
      let isShare = that.data.isShare
      let isLogin = that.data.isLogin
      if (isShare && !isbindOrder) {
        that.getShareDetail()
      } else if (_from == 'viewCloudShopOrder') {
        that.getCloudOrderShare()
      } else {
        that.getOrderDetail()
      }
    }, 300)
    // app.AcFunc.get$('orderdetail').then(res => {

    //   this.setData({
    //     height: app.globalData.SystemInfo.windowHeight - res[0].height + 60
    //   })
    // })
  },
  onReady: function() {

  },
  onShow: function() {

  },
  onPullDownRefresh: function() {
    let that = this
    let isShare = that.data.isShare
    if (isShare) {
      return
    }
    this.getOrderDetail()
    setTimeout(() => {
      wx.stopPullDownRefresh()
    }, 500)
  },
  onShareAppMessage: function() {
    let detailVO = this.data.detailVO
    let shareUrl = detailVO.shareUrl
    shareUrl = shareUrl.substr(shareUrl.indexOf('?'), shareUrl.length)
    return {
      title: '秒账云店订单\n订单号：' + this.data.detailVO.orderNumber,
      imageUrl: '',
      path: '/pages/index/index' + shareUrl
    }
  },
  onUnload: function() {
    // let isShare = this.data.isShare
    // if (isShare){
    //   wx.switchTab({
    //     url: '/pages/index/index',
    //   })
    // }
  },
  getOrderDetail: function() {
    let id = this.data.orderId
    let that = this
    app.HttpService.orderDetail(id).then((res) => {
      console.log(res)
      that.setOrderDetail(res)
    }).catch((error) => {
      console.log(error)
      app.AcFunc.myTotal(error, 'none')
      //wx.navigateBack({})
    })
  },
  getShareDetail: function() {
    let options = this.data.options
    let that = this
    let pamars = {
      ownerId: options.ownerId,
      orderId: options.id,
      username: options.username,
    }
    app.HttpService.orderShare(pamars).then((res) => {
      console.log(res)
      that.setOrderDetail(res)
    }).catch((error) => {
      console.log(error)
      app.AcFunc.myTotal(error, 'none')
    })
  },
  getCloudOrderShare: function() {
    let options = this.data.options
    let that = this
    let pamars = {
      userCodeId: options.userCodeId,
      orderId: options.id,
      ownerId: options.ownerId
    }
    app.HttpService.cloudOrderShare(pamars).then((res) => {
      console.log(res)
      that.setOrderDetail(res)
    }).catch((error) => {
      console.log(error)
      app.AcFunc.myTotal(error, 'none')
    })
  },
  setOrderDetail: function(data) {
    let that = this
    let isEdit = false
    let logistList = data.salesLogisticOrderList ? data.salesLogisticOrderList : []
    let logisticOrderIds = data.logisticOrderIds
    let cloudStatus = data.cloudStatus
    let details = data.details
    let cloudShopFileInfoIds = data.cloudShopFileInfoIds ? data.cloudShopFileInfoIds.split(',') : []
    let fileInfoIds = data.fileInfoIds ? data.fileInfoIds.split(',') : []
    let addressIds = data.clientAddrIdList
    let editList = data.orderUpdateLog
    let delyWay = data.delyWay
    let headDesc = this.data.headDesc
    let isbindOrder = this.data.isbindOrder
    let cloudImgList = [],
      xsImgList = []
    let paidAmt = data.paidAmt?data.paidAmt:0
    let writeoffPrepaidAmt = data.writeoffPrepaidAmt ? data.writeoffPrepaidAmt:0
    let ownerId = data.ownerCfg.ownerId 
    data.sunPaidAmt = app.AcFunc.money((paidAmt + writeoffPrepaidAmt), 2, false)
    data.unpaidAmt = app.AcFunc.money(data.unpaidAmt, 2, false)
    if (!isbindOrder){
      headDesc.iconclass = 'icon-share'
      headDesc.text = '分享订单'
    }
    if (cloudStatus == 'waitReceive') {
      isEdit = true
      headDesc.iconclass = 'icon-shijian'
      headDesc.text = '待接单'
    } else if (cloudStatus == 'shared') {
      headDesc.iconclass = 'icon-share'
      headDesc.text = '分享订单'
    } else if (cloudStatus == 'received') {
      headDesc.iconclass = 'icon-trues'
      headDesc.text = '已完成'
    } else if (cloudStatus == 'refused') {
      headDesc.iconclass = 'icon-close'
      headDesc.text = '已拒绝'
    } else if (cloudStatus == 'deleted') {
      headDesc.iconclass = 'icon-close'
      headDesc.text = '卖家删除'
    }
    if (logistList.length > 0) {
      for (let i in logistList) {
        logistList[i] = app.AcFunc.changeObjStatus(logistList[i])
      }
    } else {
      data.delyWay == "selfLogistic"
    }
    for (let i in details) {
      let colorPhotoId = details[i].prodDimUnitVO.prodDimAttrVO.colorPhotoId
      let prodPhotoId = details[i].prodDimUnitVO.prodDimAttrVO.prodPhotoId
      let photoId = colorPhotoId ? colorPhotoId : (prodPhotoId ? prodPhotoId : 0)
      let photoUrl = photoId ? app.getxsimg('thumbnail', photoId, ownerId) : '/images/buy/defaultpro.png' //that.setImgUrl(photoId,'string')thumbnail
      details[i].unitPrice = app.AcFunc.money(details[i].unitPrice, 6, true)
      details[i].photoUrl = photoUrl
      details[i].photoId = photoId
      details[i].left = 0
    }

    for (let i in fileInfoIds) {
      let url = fileInfoIds[i] ? app.getxsimg('thumbnail', fileInfoIds[i],ownerId) : '/images/buy/defaultpro.png'
      xsImgList.push(url)
    }
    for (let i in cloudShopFileInfoIds) {
      let url = cloudShopFileInfoIds[i] ? app.getimg('thumbnail', cloudShopFileInfoIds[i]) : '/images/buy/defaultpro.png'
      cloudImgList.push(url)
    }
    let P = app.P(data)
    let showPrice=true
    if (P.morePriceFlag){
      if (P.viewProductSalesPriceOne || P.viewProductSalesPriceTwo || P.viewProductSalesPriceThree || P.viewProductSalesPriceThree){
        showPrice=true
      }else{
        showPrice=false
      }
    }else{
      if (P.viewProductSalesPriceOne){
        showPrice=true
      }else{
        showPrice=false
      }
    }
    let _cheapAmt = app.AcFunc.money((data.taxAmt+data.totalAmt - data.contractAmt),2, false)
    data.contractAmt = app.AcFunc.money(data.contractAmt, 2, false)
    data.cheapAmt = app.AcFunc.money(data.cheapAmt, 2, false)
    data.taxAmt = app.AcFunc.money(data.taxAmt, 2, false)
    data.orderDate = data.orderDate.substr(0, 10)
    data.allCheapAmt = _cheapAmt
    that.setData({
      detailVO: data,
      headDesc: headDesc,
      isEdit: isEdit,
      prodList: details,
      fileInfoIds: fileInfoIds,
      cloudShopFileInfoIds: cloudShopFileInfoIds,
      cloudImgList: cloudImgList,
      xsImgList: xsImgList,
      logistList: logistList,
      delyWay: delyWay,
      addressIds: addressIds,
      P: P,
      editList: editList
    })
    setTimeout(() => {
      that.countOrder(details)
      that.setAddress()
      that.sunProd()
      //that.setScrollView()
    }, 300)
  },
  countOrder: function(details) {
    let detailVO = this.data.detailVO
    let der = 0
    let under = 0
    let boxFlag = this.data.P.boxFlag
    if (details.length > 0) {
      for (let i in details) {
        //let display = boxFlag ? details[i].displayDeldCartons : details[i].displayDeldQty
        let display = details[i].displayDeldQty * details[i].unitRate
       // let cartons = details[i].cartons ? details[i].cartons : 0
        let displayQty = details[i].displayQty ? details[i].displayQty* details[i].unitRate : 0
        //let undisplay = boxFlag ? (cartons - display) : (displayQty - display)
        let undisplay = displayQty - display
        if (undisplay<0){
          undisplay=0
        }
        der += display
        under += undisplay
      }
      this.setData({
        orderCount: {
          der: app.AcFunc.money(der, 6, true),
          under: app.AcFunc.money(under, 6, true)
        }
      })
    }

  },
  setImgUrl: function(fileInfoIds) {
    let url = app.__config.basePath + '/sys/common/file/thumbnail/' + fileInfoIds + '/' + wx.getStorageSync('owner').ownerId + '/get?access_token=' + wx.getStorageSync("access_token")
    return url
  },
  showProList: function() {
    let showProList = this.data.showProList
    let prodList = this.data.prodList
    let isEdit = this.data.isEdit
    if (prodList.length == 0) {
      return
    }
    if (showProList) {
      showProList = false
      downanimation.rotate('0').step()
    } else {
      showProList = true
      downanimation.rotate('180').step()
    }
    this.setData({
      downAnimate: downanimation.export(),
      showProList: showProList
    })
    // let metaArray=[];
    // for (let i = 0; i < 2000; i++) {
    //   metaArray.push({})
    // }
    if (showProList) {
      //this.setScrollView()
    }
  },
  setScrollView: function() {
    let prodList = this.data.prodList
    this.sv = this.selectComponent("#scroll-view");
    if (!this.sv) {
      return
    }
    let base = 200
    let scrollHeight = base
    if (prodList.length <= 3) {
      scrollHeight = base * prodList.length
    } else {
      scrollHeight = 600
    }
    this.sv.init({
      height: base,
      metaArray: prodList,
      showLength: 4,
      scrollHeight: scrollHeight
    })
  },
  touchminus: function(e) {
    let that = this
    let ind = e.currentTarget.dataset.index
    let proList = this.data.prodList
    let proListVO = proList[ind]
    let originalPrice = proListVO.originalPrice
    let oldPrice = app.AcFunc.countTotalPrice(proListVO.amountFormula, proListVO)
    let n = proListVO.displayQty
    if (n > 1) {
      n--;
      proList[ind].displayQty = app.AcFunc.filterNumber(n)
      this.setData({
        prodList: proList
      })
      setTimeout(function() {
        //that.sv.reload()
        that.priceSum(ind)
      }, 300)
    }
  },
  touchplus: function(e) {
    let that = this
    let ind = e.currentTarget.dataset.index
    let prodList = this.data.prodList
    let proListVO = prodList[ind]
    let originalPrice = proListVO.originalPrice
    let n = proListVO.displayQty
    let oldPrice = app.AcFunc.countTotalPrice(proListVO.amountFormula, proListVO)
    n++;
    prodList[ind].displayQty = app.AcFunc.filterNumber(n)
    this.setData({
      prodList: prodList
    }, () => {
      that.priceSum(ind)
    })

  },
  textChange: function(e) {
    let val = e.detail.value
    let detailVO = this.data.detailVO
    detailVO.remark = val
    this.setData({
      detailVO: detailVO
    })
  },
  uploadFile: function() {
    let that = this
    let enclosure = this.data.cloudImgList
    let cloudShopFileInfoIds = this.data.cloudShopFileInfoIds
    wx.chooseImage({
      count: 1,
      sizeType: ['original'],
      sourceType: ['album', 'camera'],
      success(res) {
        let tempFilePaths = res.tempFilePaths
        wx.uploadFile({
          url: app.getUploadUrl(),
          filePath: tempFilePaths[0],
          name: 'file',
          formData: {},
          success(res) {
            let data = JSON.parse(res.data)
            console.log(data)
            if (data.errorCode == 0) {
              cloudShopFileInfoIds.push(data.data.id)
              enclosure.push(tempFilePaths[0])
            }
            that.setData({
              cloudShopFileInfoIds: cloudShopFileInfoIds,
              cloudImgList: enclosure
            })
            console.error(that.data.fileInfoIds)
          },
          fail(error) {
            console.log(error)
          }
        })
      }
    })
  },
  operPic: function(e) {
    let ind = e.currentTarget.dataset.index
    let type = e.currentTarget.dataset.type
    let fileInfoIds = this.data.fileInfoIds
    let cloudShopFileInfoIds = this.data.cloudShopFileInfoIds
    let cloudImgList = this.data.cloudImgList
    let xsImgList = this.data.xsImgList
    let that = this
    wx.showActionSheet({
      itemList: ['删除', '查看'],
      success(res) {
        let tapIndex = res.tapIndex
        if (tapIndex == 0) {
          if (type == 'xs') {
            fileInfoIds.splice(ind, 1)
            xsImgList.splice(ind, 1)
          } else {
            cloudShopFileInfoIds.splice(ind, 1)
            cloudImgList.splice(ind, 1)
          }
          that.setData({
            xsImgList: xsImgList,
            cloudImgList: cloudImgList,
            fileInfoIds: fileInfoIds,
            cloudShopFileInfoIds: cloudShopFileInfoIds
          })
        }else{
          app.AcFunc.imgBig(e)
        }
      },
      fail(res) {
        console.log(res.errMsg)
      }
    })
  },
  showMoreLogist: function() {
    let showMoreLogist = this.data.showMoreLogist
    let logistList = this.data.logistList
    let num = 0
    if (showMoreLogist > 2) {
      num = 2
      moreanimation.rotate('0').step()
    } else {
      num = logistList.length
      moreanimation.rotate('180').step()
    }
    this.setData({
      moreAnimate: moreanimation.export(),
      showMoreLogist: num
    })
  },
  getPamars: function() {
    let _data = this.data
    let detailVO = _data.detailVO
    let pamars = detailVO
    return pamars
  },
  deleteOrder: function() {
    let detailVO = this.data.detailVO
    wx.showModal({
      title: '提示',
      content: '确定删除该云单吗？',
      success(res) {
        if (res.confirm) {
          app.HttpService.orderDelete(detailVO.id).then((res) => {
            console.log(res)
            wx.showToast({
              title: '删除成功',
              success: () => {
                wx.switchTab({
                  url: '/pages/order/order',
                })
              }
            })
          }).catch((error) => {
            console.log(error)
          })
        } else if (res.cancel) {

        }
      }
    })

  },
  saveOrder: function() {
    let that = this
    let logistList = this.data.logistList
    let detailVO = this.data.detailVO
    let details = this.data.prodList
    let ownerCfg = detailVO.ownerCfg
    let salesLogisticOrderList = []
    if (ownerCfg){
      delete ownerCfg.cloudShopVO
    }
    let fileInfoIds = this.data.fileInfoIds.join(',')
    let cloudShopFileInfoIds = this.data.cloudShopFileInfoIds.join(',')
    for (let i in details) {
      delete details[i].photoUrl
      delete details[i].photoId
      delete details[i].left
      details[i].qty = details[i].displayQty
    }
    if (logistList.length > 0) {
      for (let i = 0; i < logistList.length; i++) {
        let _obj = {}
        _obj.id = logistList[i].id
        _obj.orderNo = logistList[i].orderNo
        salesLogisticOrderList.push(_obj)
      }
    }
    let pamars = {
      id: detailVO.id,
      delyWay: detailVO.delyWay,
      cloudStatus: detailVO.cloudStatus,
      orderNumber: detailVO.orderNumber,
      orderDate: detailVO.orderDate,
      remark: detailVO.remark,
      cloudShopFileInfoIds: cloudShopFileInfoIds, //附件id
      fileInfoIds: fileInfoIds,
      details: details,
      clientAddrIdList: detailVO.clientAddrIdList,
      clientId: detailVO.client.id,
      salesLogisticOrderList: salesLogisticOrderList,
      ownerCfg: ownerCfg,
      //xsShopId: cloudShop.id,
      contractAmt: detailVO.contractAmt,
      orderStatus: detailVO.orderStatus,
      orderPaidStatus: detailVO.orderPaidStatus,
      cloudStatus: detailVO.cloudStatus
    }
    app.HttpService.orderUpdate(pamars).then((res) => {
      console.log(res)
      that.setOrderDetail(res)
      app.AcFunc.myTotal('修改云单成功', 'success')
      // setTimeout(() => {
      //   wx.navigateBack({})
      // }, 1500)
    }).catch((error) => {
      app.AcFunc.myTotal(error, 'none')
    })
  },
  creatOrder: function() {
    let that = this
    let details = this.data.detailVO.details
    let cartPamars = []
    for (let i in details) {
      let _obj = {}
      _obj.prodId = details[i].prodId
      _obj.name = details[i].prodDimUnitVO.prodDimAttrVO.prodName
      _obj.photo = details[i].prodDimUnitVO.prodDimAttrVO.prodPhotoId
      _obj.remark = details[i].remark
      _obj.specId = details[i].prodDimUnitVO.prodDimAttrVO.specId
      _obj.specName = details[i].prodDimUnitVO.prodDimAttrVO.specName
      _obj.colorId = details[i].prodDimUnitVO.prodDimAttrVO.colorId
      _obj.colorName = details[i].prodDimUnitVO.prodDimAttrVO.colorName
      _obj.unitId = details[i].prodDimUnitVO.unitId
      _obj.unitName = details[i].prodDimUnitVO.unitName
      _obj.unitPrice = details[i].unitPrice
      _obj.amountFormula = details[i].amountFormula
      _obj.cartons = details[i].cartons ? details[i].cartons : 0
      _obj.eachCarton = details[i].eachCarton ? details[i].eachCarton : 0
      _obj.qty = details[i].displayQty
      cartPamars.push(_obj)
    }
    app.HttpService.cartCreate(cartPamars).then((res) => {
      if (res) {
        wx.setStorageSync('againOrder', res);
        setTimeout(function() {
          console.error('switchTab   cart')
          wx.switchTab({
            url: '/pages/cart/cart',
          })
        }, 300)
      }
    }).catch((error) => {
      app.AcFunc.myTotal(error, 'none')
    })
  },
  loginShop: function() {
    // if (this.data.isLogin) {
    //   wx.switchTab({
    //     url: '/pages/index/index',
    //   })
    // } else {
    wx.reLaunch({
      url: '/pages/login/index' + app.AcFunc.objToUrl(this.data.options),
    })
    //}
  },
  // reloadPage: () => {
  //   if (getCurrentPages().length != 0) {
  //     getCurrentPages()[getCurrentPages().length - 1].onLoad()
  //   }
  // },
  setAddress: function() {
    let addressIds = this.data.addressIds
    let address = null
    let client = this.data.detailVO.client
    address = client.addressVOs
    let _addr = []
    for (let i in address) {
      for (let j in addressIds) {
        if (address[i].id == addressIds[j]) {
          _addr.push(address[i])
        }
      }
    }
    this.setData({
      addrList: _addr
    })
  },
  changePrice: function(e) {
    console.log(e)
    let that = this
    let price = e
    let val = app.AcFunc.money(e.detail.value, 6, true)
    if (val == 0 || val == '') {
      val = 1
    }
    let ind = e.currentTarget.dataset.index
    let prodList = this.data.prodList
    let prodListVO = prodList[ind]
    let _qty = prodListVO.displayQty
    let originalPrice = prodListVO.originalPrice
    let oldPrice = app.AcFunc.countTotalPrice(prodListVO.amountFormula, prodListVO)
    prodList[ind].displayQty = app.AcFunc.filterNumber(val)
    this.setData({
      prodList: prodList
    }, () => {
      //that.sv.reload()
      that.priceSum(ind, oldPrice)
    })
  },
  priceSum: function(ind) {
    let that = this
    let prodList = this.data.prodList
    let detailVO = this.data.detailVO
    let totalAmt = 0
    for (let i = 0; i < prodList.length; i++) {
      let newprice = app.AcFunc.countTotalPrice(prodList[i].amountFormula, prodList[i])
      totalAmt += newprice
    }
    detailVO.totalAmt = app.AcFunc.money(totalAmt, 2, false)
    detailVO.contractAmt = detailVO.totalAmt
    this.setData({
      detailVO: detailVO
    }, () => {
      that.sunProd()
    })
  },
  operData: function(logistData) {
    let logistList = this.data.logistList
    let detailVO = this.data.detailVO
    let unloadDescr = []
    let reset=false
    let isShare=this.data.isShare
    let lineVOList = logistData.enterpriseVO.enterpriseSpeciallineVOList
    if (logistList.length > 0) {
      for (let i = 0; i < logistList.length; i++) {
        if (logistList[i].id == logistData.id) {
          reset = true
          break
        }
      }
    }
    if (reset){
      if (!isShare){
        this.getOrderDetail()
      }
      return
    }
    if (lineVOList.length > 0) {
      for (let i = 0; i < lineVOList.length; i++) {
        let unloadVOList = lineVOList[i].enterpriseSpeciallineUnloadVOList
        for (let j = 0; j < unloadVOList.length; j++) {
          let addresDetail = unloadVOList[j].unloadAddressVO ? unloadVOList[j].unloadAddressVO.fullAddress : ''
          unloadDescr.push(addresDetail)
        }
      }
    }
    logistData.enterpriseSpeciallineUnloadDescr = unloadDescr.join(',')
    logistData.enterpriseName = logistData.enterpriseVO.name
    ///logistData.orderNumber = logistData.orderNo
    logistData.unloadContactNo = logistData.enterpriseVO.contactNo
    logistData.planArriveDate = logistData.detailVO.planArriveDate
    logistData.arriveDate = logistData.arriveDate
    logistList.push(logistData)
    logistData = app.AcFunc.changeObjStatus(logistData)
    detailVO.delyWay = 'ydcfoLogistic'
    console.log(logistList)
    this.setData({
      logistList: logistList,
      detailVO: detailVO
    })
  },
  chooseLogist: function() {
    if (!this.data.isEdit) {
      return
    }
    let that = this
    let logistList = this.data.logistList
    let addrList = this.data.addrList
    if (addrList) {
      addrList = JSON.stringify(addrList)
    }
    wx.showActionSheet({
      itemList: ['自行配送', '秒账物流'],
      success: (res) => {
        console.log(res.tapIndex)
        let sheetInd = res.tapIndex
        if (sheetInd == 0) {
          if (logistList.length > 0) {
            return
          }
        } else {
          wx.navigateTo({
            url: '/pages/order/logistEdit/index?address=' + addrList,
          })
        }
      },
      fail: (res) => {
        console.log(res.errMsg)
      }
    })
  },
  logistDetail: function(e) {
    let id = e.currentTarget.id
    let logistList = this.data.logistList
    let isShare = this.data.isShare
    let options = this.data.options
    let isLogin = this.data.isLogin
    if (isShare){
      options.bindOrder='fail'
      options.action ='viewLogisticsOrder'
      options.id = id
      options.unRequest='salesToLogist'
      options.isLogin = isLogin
      wx.navigateTo({
        url: '/pages/order/logistDetail/logistDetail' + app.AcFunc.objToUrl(options),
      })
    }else{
      wx.navigateTo({
        url: '/pages/order/logistDetail/logistDetail?id=' + id + '&orderfrom=orderDetail',
      })
    }
    
  },
  /**计算产品总数 */
  sunProd: function() {
    let prodList = this.data.prodList
    let sum = 0
    for (let i = 0; i < prodList.length; i++) {
      let displayQty = prodList[i].displayQty ? prodList[i].displayQty:1
      let unitRate = prodList[i].unitRate ? prodList[i].unitRate:1
      let sunQty = displayQty * unitRate
      sum += sunQty
    }
    this.setData({
      prodNum: app.AcFunc.money(sum, 6, true)
    })
  },
  updataProd: function() {
    let prodList = this.data.prodList
  },
  touchstart: function(e) {
    if (!this.data.isEdit) {
      return
    }
    t_x = e.touches[0].pageX;
    t_y = e.touches[0].pageY; // 获取触摸时的原点
    // timeInterval = setInterval(function() {
    //   times++;
    // }, 50);
  },
  touchend: function(e) {
    if (!this.data.isEdit) {
      return
    }
    let index = e.currentTarget.dataset.index;
    let touchMoveX = e.changedTouches[0].pageX;
    let touchMoveY = e.changedTouches[0].pageY;
    let prodList = this.data.prodList
    let tmX = touchMoveX - t_x;
    let tmY = touchMoveY - t_y;
    let absX = Math.abs(tmX);
    let absY = Math.abs(tmY);
    if (absX > 2 * absY && absX > 5) {
      if (tmX < 0) {
        console.log("左滑=====")
        prodList[index].left = -160
      } else {
        console.log("右滑=====")
        prodList[index].left = 0
      }
    }

    this.setData({
      prodList: prodList
    })
    t_y = 0
    t_x = 0
    times = 0
  },
  prodDetail: function(e) {
    let index = e.currentTarget.dataset.index;
    let _detailVO = this.data.detailVO
    let prodList = this.data.prodList
    let imgUrl = prodList[index].photoUrl
    if (!this.data.isEdit){
      return
    }
    delete prodList[index].photoUrl
    delete _detailVO.shareUrl
    _detailVO.details = [prodList[index]]
    _detailVO.fromType = 'order'
    let detailVO = JSON.stringify(_detailVO)
    wx.navigateTo({
      url: '/pages/productdetail/productdetail?detailVO=' + detailVO,
    })
  },
  delProd: function(e) {
    let index = e.currentTarget.dataset.index;
    let that = this
    let prodList = this.data.prodList
    if (prodList.length == 1) {
      app.AcFunc.myTotal('亲，云单至少要保留一个产品哦！', 'none', 2000)
      prodList[0].left = 0
      that.setData({
        prodList: prodList
      })
      return
    }
    wx.showModal({
      title: '提示',
      content: '点击保存后，才能删除哦',
      success: (res) => {
        if (res.confirm) {
          prodList.splice(index, 1)
          this.setData({
            prodList: prodList
          }, () => {
            that.sunProd()
            that.priceSum()
          })
        }
      }
    })

  },
  changeDetailVO: function(detail) {
    let prodList = this.data.prodList
    let _data = this.data.detailVO
    let that = this
    let ind = 0
    let detailVO = detail[0]
    for (let i = 0; i < prodList.length; i++) {
      if (prodList[i].id == detailVO.id) {
        ind = i 
        break
      }
    }
    prodList[ind].prodDimUnitVO.prodDimAttrVO.specName = detailVO.specName
    prodList[ind].prodDimUnitVO.prodDimAttrVO.specId = detailVO.specId
    prodList[ind].prodDimUnitVO.prodDimAttrVO.colorName = detailVO.colorName
    prodList[ind].prodDimUnitVO.prodDimAttrVO.colorId = detailVO.colorId
    prodList[ind].prodDimUnitVO.unitName = detailVO.unitName
    prodList[ind].prodDimUnitVO.unitId = detailVO.unitId
    prodList[ind].colorId = detailVO.colorId
    prodList[ind].unitId = detailVO.unitId
    prodList[ind].displayQty = detailVO.qty
    prodList[ind].qty = detailVO.qty
    prodList[ind].unitPrice = detailVO.unitPrice
    prodList[ind].specId = detailVO.specId
    prodList[ind].unitRate = detailVO.unitRate?detailVO.unitRate:1
    prodList[ind].cartons = detailVO.cartons
    prodList[ind].eachCarton = detailVO.eachCarton
    prodList[ind].photoUrl = detailVO.photo ? app.getxsimg('thumbnail', detailVO.photo) : '/images/buy/defaultpro.png'
    _data.details = prodList
    this.setData({
      prodList: prodList,
      detailVO: _data
    }, () => {
      that.sunProd()
      that.priceSum()
    })
  },
  showimgBig:function(event){
    let src = event.currentTarget.dataset.src
    if (src.indexOf('defaultpro')>0){
       app.AcFunc.myTotal('暂无产品图片','none')
    }else{
      app.AcFunc.imgBig(event)
    }
  }
}),{
  "navigationBarTitleText": "订单详情",
  "usingComponents": {
    "lazyRoll": "/assets/components/lazyRoll/index"
  },
  "enablePullDownRefresh": false
},<view class='orderStatus border-box'>
  <icon class='iconfont {{headDesc.iconclass}}'></icon>
  <text>{{headDesc.text}}</text>
  <view class='fs12 overpoint' wx:if='{{detailVO.refuseReason}}'> {{detailVO.refuseReason}}</view>
</view>
<view class='container'>
  <view class='detailMod addressMod flex'>
    <view class='self-top'>
      <icon class='iconfont icon-address'></icon>
    </view>
    <view class='flex-1 overflow'>
      <view class='fs16'>
        <text>{{detailVO.client.userInfoVO.name}}</text>
        <text>{{detailVO.client.userInfoVO.telephone}}</text>
      </view>
      <view class='c666 fs12 border-box' wx:for='{{addrList}}' wx:key='{{item.id}}'>
        {{item.province}}{{item.city}}{{item.district}}{{item.addressDetail}}
      </view>
    </view>
    <view class='morLink self-center'>
      <!-- <icon class='iconfont icon-Right'></icon> -->
    </view>
  </view>
  <view class='detailMod prodMod'>
    <view class='prodMsg flex prodhead'>
      <view class='flex-1'>产品列表({{prodList.length}})
        <!-- <image bindtap='addProduct' src='/images/buy/bluebtn.png'></image> -->
      </view>
      <view class='showList fs12' bindtap='showProList'>
        总数:{{prodNum}}
        <icon class='iconfont icon-Down' animation="{{downAnimate}}"></icon>
      </view>
    </view>
    <view class='proList item-center' wx:if="{{showProList}}">
      <!-- <lazyRoll id="scroll-view" style="top:{{item._top}}rpx;"> -->
      <view class='proDetail flex' wx:for="{{prodList}}" wx:key='item.id'>
        <view class="goodbox flex" data-index='{{index}}' bindscroll="getleft" bindtap='' style="left:{{item.left}}rpx" bindtouchstart='touchstart' bindtouchend='touchend'>
          <view class='self-center'>
            <block wx:if='{{isbindOrder}}'>
              <image wx:if='{{P.imgFlag&&P.viewProductPhoto}}' lazy-load='true' src='{{item.photoUrl}}' mode='aspectFit'></image>
            </block>
            <block wx:else>
              <image wx:if='{{P.imgFlag}}' lazy-load='true' src='{{item.photoUrl}}' mode='aspectFit' catchtap='showimgBig' data-src='{{item.photoUrl}}'></image>
            </block>
          </view>
          <view class='flex-1 self-center' data-index='{{index}}' catchtap='prodDetail'>
            <view class='overpoint'>{{item.prodDimUnitVO.prodDimAttrVO.prodName}}{{item.prodDimUnitVO.prodDimAttrVO.specName?'-'+item.prodDimUnitVO.prodDimAttrVO.specName:''}}{{item.prodDimUnitVO.prodDimAttrVO.colorName?'-'+item.prodDimUnitVO.prodDimAttrVO.colorName:''}}</view>
            <view class='overpoint fs11 c666' wx:if='{{item.remark&&detailVO.ownerCfg.ownerMZServiceVO.mzLogisticsFlag}}'>备注:{{item.remark}}</view>
            <view class='flex price'>
              <view class='red flex-1 self-center' wx:if='showPrice'>￥{{item.unitPrice}}
                <text wx:if='{{P.unitFlag&&P.viewProductUnit}}'>{{item.prodDimUnitVO.unitName?'/'+item.prodDimUnitVO.unitName:''}}</text>
              </view>
              <view class='operInput clearfix' wx:if='{{isEdit}}'>
                <view class='iconfont icon-minus float-left' data-index='{{index}}' hover-class='touch' hover-stay-time='100' catchtap='touchminus' data-name='allBox'></view>
                <input value='{{item.displayQty}}' type='digit' data-index='{{index}}' bindblur='changePrice' bindchange='changePrice' catchtap='catchchange'></input>
                <view class='iconfont icon-plus float-right' data-index='{{index}}' hover-class='touch' hover-stay-time='100' catchtap='touchplus' data-name='allBox'></view>
              </view>
              <view class='operInput clearfix' wx:else>
                <view class='iconfont icon-minus float-left' data-index='{{index}}' hover-class='none' hover-stay-time='100' data-name='allBox'></view>
                <input value='{{item.displayQty}}' catchtap='catchchange' data-index='{{index}}' disabled='disabled'></input>
                <view class='iconfont icon-plus float-right' data-index='{{index}}' hover-class='none' hover-stay-time='100' data-name='allBox'></view>
              </view>
            </view>
          </view>
        </view>
        <view class="goodOper self-center" data-index='{{index}}' data-id='{{item.id}}' bindtap='delProd'>删除
        </view>
      </view>
      <!-- </lazyRoll> -->
    </view>
  </view>
  <view class='detailMod numList fs12'>
    <view class='flex'>
      <view class='flex-1'>金额</view>
      <view class='red'>￥{{detailVO.contractAmt}}
        <text>{{detailVO.allCheapAmt&&detailVO.allCheapAmt!=0?'(优惠:¥'+detailVO.allCheapAmt+')':''}}</text>
        <text>{{detailVO.taxAmt>0?'(税额:¥'+detailVO.taxAmt+')':''}}</text>
      </view>
    </view>
    <view class='flex'>
      <view class='flex-1'>已付款</view>
      <view class=''>￥{{detailVO.sunPaidAmt}}</view>
    </view>
    <view class='flex'>
      <view class='flex-1'>未付款</view>
      <view class=''>￥{{detailVO.unpaidAmt?detailVO.unpaidAmt:0.00}}{{detailVO.partnerExpensesAmt>0?'(费用垫付：'+detailVO.partnerExpensesAmt+')':''}}</view>
    </view>
    <view class='flex'>
      <view class='flex-1'>已收货数量</view>
      <view class=''>{{orderCount.der}}</view>
    </view>
    <view class='flex'>
      <view class='flex-1'>未收货数量</view>
      <view class=''>{{orderCount.under}}</view>
    </view>
  </view>
  <view class='detailMod delivery' wx:if='{{detailVO.ownerCfg.ownerMZServiceVO.mzLogisticsFlag}}'>
    <view class='chooseLog flex' bindtap='chooseLogist'>
      <view class='flex-1'>
        <view>送货方式</view>
        <text wx:if='{{detailVO.delyWay=="selfLogistic"}}' class='tips'>{{chosLogistText}}</text>
      </view>
      <view class='self-top clearfix'>
        <text class='float-left c666 fs13'>{{detailVO.delyWay=="selfLogistic"?'自行配送':'秒账物流'}}</text>
        <icon wx:if='{{isEdit}}' class='iconfont icon-Right'></icon>
      </view>
    </view>
    <view class='logistMod' wx:if='{{detailVO.delyWay=="ydcfoLogistic"}}'>
      <view class='logistList' wx:for='{{logistList}}' id='{{item.id}}' wx:key='{{item.id}}' wx:if="{{index<showMoreLogist}}" bindtap='logistDetail'>
        <view class='flex'>
          <view class='flex-1 fs12 c666 self-center breakWord'>{{item.enterpriseName}}, 物流单号:{{item.orderNo}}</view>
          <view class='orderState'>
            <image src='/images/order/{{item.paymentStatus}}{{item.orderStatus}}.png'></image>
            <!-- <view class='state state_{{item.orderStatus}}'>
              <icon class="iconfont icon-{{item.orderStatus}}"></icon>
              <view class="text">
                <text wx:if='{{item.paymentStatus=="unpaid"&&item.orderStatus!="wait"}}' class='c666'>未支付</text>
                <text>{{item.statusDesc}}</text>
              </view>
            </view> -->
          </view>
        </view>
        <view class='fs12 c666'>卸货网点:{{item.enterpriseSpeciallineUnloadDescr}}</view>
        <view class='fs12 c666'>电话:{{item.unloadContactNo}}，
          <block wx:if='{{item.orderStatus!="cancel"&&item.orderStatus!="reject"}}'></block>
          <text wx:if='{isEsti}}' class='fs12'>预估到货时间:{{item.planArriveDate}}</text>
          <text wx:else class='fs12'>到货时间:{{item.arriveDate}}</text>
        </view>
      </view>
      <view class='logistMore' bindtap='showMoreLogist' wx:if='{{logistList.length>2}}'>
        <icon class='iconfont icon-open' animation="{{moreAnimate}}"></icon>
        <text class='fs12'>展开</text>
      </view>
    </view>
  </view>
  <view class='detailMod uploadImg clearfix'>
    <view class='imgList'>
      <view class='picBox' wx:for="{{xsImgList}}" wx:key="">
        <image src='{{item}}' data-type='xs' data-src='{{item}}' data-index="{{index}}" bindtap='operPic'></image>
      </view>
      <view class='picBox' wx:for="{{cloudImgList}}" wx:key="">
        <image src='{{item}}' data-type='cloud' data-src='{{item}}' data-index="{{index}}" bindtap='operPic'></image>
      </view>
      <view class='uploadBtn' bindtap='uploadFile' wx:if='{{isEdit}}'>
        <icon class='iconfont icon-camera'></icon>
        <view class='fs12'>上传附件</view>
      </view>
    </view>
  </view>
  <view class='detailMod remark' wx:if='{{detailVO.ownerCfg.ownerItemVO.remarkFlag}}'>
    <block wx:if='{{isEdit}}'>
      <input class='textArea' placeholder='备注' value='{{detailVO.remark}}' bindinput='textChange'></input>
    </block>
    <block wx:else>
      <view class='c666 textArea'>{{detailVO.remark}}</view>
    </block>
  </view>
  <view class='detailMod'>
    <view>订单信息</view>
    <view class='c666 fs12'>订单时间: {{detailVO.orderDate}}</view>
    <view class='c666 fs12'>订单编号: {{detailVO.xsOrderNo?detailVO.xsOrderNo:detailVO.orderNumber}}</view>
  </view>
  <view class='detailMod detailMsg' wx:if='{{editList.length>0}}'>
    <view class='title'>修改记录</view>
    <view class='message' wx:for='{{editList}}' wx:key='{{item.id}}'>
      <view class='fs12'>{{item.changeBrief}}</view>
      <view class='c666 fs12'>修改人：{{item.name}}
        <text>{{item.createDate}}</text>
      </view>
    </view>
  </view>
  <view wx:if='{{isShare}}' class='sharedtext text-center'>数据已同步到云店，登录云店后可以详细查看内容，可以下物流单</view>
</view>
<view class='detailbottom flex' id='orderdetail'>
  <block wx:if='{{!isLogin}}'>
    <button class='buyAgain flex-1' type='success' bindtap='loginShop'>进入云店</button>
  </block>
  <block wx:else>
    <block wx:if='{{isEdit}}'>
      <view class='delete self-center' bindtap='deleteOrder'>
        <icon class='iconfont icon-delete'></icon>
        <view>删除</view>
      </view>
      <view class='save self-center' bindtap='saveOrder'>
        <icon class='iconfont icon-save'></icon>
        <view>保存</view>
      </view>
    </block>
    <button class='shareBtn flex-1' open-type='share'>分享</button>
    <button class='buyAgain flex-1' bindtap='creatOrder'>再次下单</button>
  </block>
</view>,.orderStatus {
  position: fixed;
  top: 0;
  width: 100%;
  background: #00a6f5;
  color: #fff;
  padding: 0 20rpx 10rpx;
  line-height: 36rpx;
  font-size: 36rpx;
  z-index: 5;
}

.orderStatus icon {
  margin-right: 10rpx;
  font-size: 40rpx;
}

.orderStatus icon:before {
  float: left;
  line-height: 40rpx;
}

.container {
  padding: 86rpx 0 110rpx;
}

.detailMod {
  background: #fff;
  margin-bottom: 24rpx;
  padding: 20rpx;
}

.addressMod .icon-address {
  margin-right: 20rpx;
  font-size: 32rpx;
  line-height: 100%;
  position: relative;
  width: 32rpx;
  height: 32rpx;
}

.addressMod .icon-address:before {
  line-height: 100%;
  position: absolute;
  top: 10rpx;
}

.addressMod text {
  display: inline-block;
  margin-right: 40rpx;
}

.addressMod .morLink {
  padding-left: 20rpx;
}

.addressMod .morLink .icon-Right {
  font-size: 28rpx;
}

.prodMod {
  padding: 0;
}

.prodMsg {
  padding: 20rpx;
}
.prodhead{
  padding:0 20rpx;
  line-height: 100rpx;
  height:100rpx;
}
.prodMsg image{
  width: 60rpx;
  height:60rpx;
  margin-left:30rpx;
}
.showList {
  position: relative;
  padding-right: 40rpx;
}

.prodMsg .icon-Down {
  position: absolute;
  right: 0;
  top: 0;
  font-size: 24rpx;
}
.proDetail {
  position: relative;
  overflow: hidden;
  height:200rpx;
  border-bottom: 1px dashed #efeff4;
}

.proDetail .goodbox {
  position: absolute;
  background: #fff;
  z-index: 2;
  width: 100%;
  height:200rpx;
  left: 0;
  top: 0;
  padding: 20rpx;
  box-sizing: border-box;
  transition: left 0.2s ease; 
}
.proDetail .goodOper{
  position: absolute;
  top:0;
  right:0;
  height:200rpx;
  line-height: 200rpx;
  background: #f5222d;
  color:#fff;
  text-align: center;
  width: 160rpx;
}

.proDetail .price {
  margin-top: 20rpx;
}

.proDetail .price .text {
  margin-right: 20rpx;
}

.proDetail .flex-1 {
  overflow: hidden;
}

.proSwiper {
  height: 612rpx;
}

.prodScroll {
  height: 612rpx;
}

.proList {
  border-top: 1px solid #efeff4;
}

.proList image {
  display: inline-block;
  height: 130rpx;
  width: 130rpx;
  margin-right: 20rpx;
}

.operInput input {
  width: 92rpx;
}

.numList {
  padding: 10rpx 20rpx;
}

.numList .flex {
  margin: 10rpx 0;
}

/**/

.delivery {
  padding: 0;
}

.delivery .chooseLog {
  padding: 20rpx;
}

.delivery .chooseLog icon {
  float: right;
  font-size: 24rpx;
  height: 48rpx;
  width: 48rpx;
  position: relative;
}

.delivery .chooseLog icon:before {
  position: absolute;
  right: 0;
  top: 4rpx;
}

.logistMod .logistList {
  padding: 20rpx;
  border-top: 1px solid #efeff4;
}

.logistMod .logistMore {
  text-align: center;
  border-top: 1px solid #efeff4;
  color: #999;
  line-height: 60rpx;
}

.logistMod .logistMore icon {
  vertical-align: middle;
}

/*上传附件*/

.uploadImg {
  padding:0;
  overflow: hidden;
}

.uploadImg .imgList {
  float: left;
}

.uploadImg .imgList .picBox {
  position: relative;
  float:left;
  width: 120rpx;
  height: 120rpx;
  margin:20rpx 0 0 20rpx;
}

.uploadImg .imgList image {
  width: 120rpx;
  height: 120rpx;
}

.uploadImg .uploadBtn {
  float:left;
  margin: 20rpx 0 20rpx 20rpx;
  height: 120rpx;
  width: 120rpx;
  text-align: center;
  background: #f2f2f2;
}

.uploadImg icon {
  font-size: 48rpx;
  color: #999;
}

.remark {
  padding: 0;
}

.detailMsg {
  padding: 0;
}

.detailMsg .title {
  padding: 20rpx 20rpx 0;
}

.detailMsg .message {
  padding: 20rpx;
  border-bottom: 1px solid #efeff4;
}

.detailMsg .message text {
  display: inline-block;
  margin-left: 30rpx;
}

.sharedtext {
  color: #c8c8c8;
  font-size: 24rpx;
  margin: 40rpx 0 10rpx;
}

.detailbottom {
  height: 100rpx;
  position: fixed;
  width: 100%;
  bottom: 0;
  left: 0;
  background: #fff;
  border-top: 1px solid #f2f2f2;
  z-index: 999999;
  text-align: center;
}

.detailbottom .delete, .detailbottom .save {
  font-size: 24rpx;
  color: #666;
  width: 160rpx;
}

.detailbottom .iconfont {
  font-size: 40rpx;
  line-height: 100%;
}

.detailbottom .delete {
  border-right: 1px solid #f2f2f2;
}

.detailbottom .flex-1 {
  width: 200rpx;
}

.detailbottom .shareBtn {
  color: #fff;
  background: #35d2c6;
  line-height: 100rpx;
}

.detailbottom .buyAgain {
  color: #fff;
  background: #00a6f5;
  line-height: 100rpx;
}

.detailbottom button {
  border-radius: 0;
  -webkit-border-radius: 0;
  border: 0;
  outline: none;
  list-style: none;
}

.detailbottom button::after {
  border: 0;
  border-radius: 0;
  -webkit-border-radius: 0;
}

.lazyRoll {
  height: 336px !important;
}
,const app = getApp();
let streamanimation = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
let selleranimation = wx.createAnimation({
  duration: 400,
  timingFunction: 'ease',
})
Page({
  data: {
    upStream: [],
    filterList: [{
        name: '单据状态',
        list: [{
          name: '待接单',
          check: false,
          cloudStatuses: 'waitReceive'
        }, {
          name: '已完成',
          check: false,
          cloudStatuses: 'received'
        }, {
          name: '已拒绝',
          check: false,
          cloudStatuses: 'refused'
        }, {
          name: '卖家删除',
          check: false,
          cloudStatuses: 'deleted'
        }, {
          name: '分享订单',
          check: false,
          cloudStatuses: 'shared'
        }]
      },
      {
        name: '付款状态',
        list: [{
          name: '草稿',
          check: false,
          orderPaidStatuses: 'waitSalesPaid'
        }, {
          name: '未付款',
          check: false,
          orderPaidStatuses: 'noSalesPaid'
        }, {
          name: '部分付款',
          check: false,
          orderPaidStatuses: 'someSalesPaid'
        }, {
          name: '全部付款',
          check: false,
          orderPaidStatuses: 'allSalesPaid'
        }, {
          name: '超付款',
          check: false,
          orderPaidStatuses: 'overchargeSalesPaid'
        }]
      },
      {
        name: '收货状态',
        list: [{
          name: '草稿',
          check: false,
          orderStatuses: 'wait'
        }, {
          name: '未收货',
          check: false,
          orderStatuses: 'unDelivered'
        }, {
          name: '部分收货',
          check: false,
          orderStatuses: 'partialDelivered'
        }, {
          name: '全部收货',
          check: false,
          orderStatuses: 'allDelivered'
        }, {
          name: '拒收',
          check: false,
          orderStatuses: 'stop'
        }]
      },
    ],
    seller: [{
      name: '未支付未发货',
      check: false,
      logisstate: 'unpaid|undelivery'
    }, {
      name: '未支付已取消',
      check: false,
      logisstate: 'unpaid|cancel'
    }, {
      name: '未支付已拒收',
      check: false,
      logisstate: 'unpaid|reject'
    }, {
      name: '未支付运输中',
      check: false,
      logisstate: 'unpaid|delivering'
    }, {
      name: '未支付待派单',
      check: false,
      logisstate: 'unpaid|undispatch'
    }, {
      name: '已支付待派单',
      check: false,
      logisstate: 'paid|undispatch'
    }, {
      name: '已支付待派单\n(差额未付)',
      check: false,
      logisstate: 'paid|undispatch|differ'
    }, {
      name: '已支付未发货',
      check: false,
      logisstate: 'paid|undelivery'
    }, {
      name: '已支付未发货\n(差额未付)',
      check: false,
      logisstate: 'paid|undelivery|differ'
    }, {
      name: '已支付已取消',
      check: false,
      logisstate: 'paid|cancel'
    }, {
      name: '已退款已取消',
      check: false,
      logisstate: 'refund|cancel'
    }, {
      name: '已支付已拒收',
      check: false,
      logisstate: 'paid|reject'
    }, {
      name: '已退款已拒收',
      check: false,
      logisstate: 'refund|reject'
    }, {
      name: '已支付运输中',
      check: false,
      logisstate: 'paid|delivering'
    }, {
      name: '已支付运输中\n(差额未付)',
      check: false,
      logisstate: 'paid|delivering|differ'
    }, {
      name: '已支付正常签收',
      check: false,
      logisstate: 'paid|normalSign'
    }, {
      name: '已支付正常签收\n(差额未付)',
      check: false,
      logisstate: 'paid|normalSign|differ'
    }, {
      name: '已支付异常签收',
      check: false,
      logisstate: 'paid|abnormalSign'
    }, {
      name: '已支付异常签收\n(差额未付)',
      check: false,
      logisstate: 'paid|abnormalSign|differ'
    }, {
      name: '草稿',
      check: false,
      logisstate: 'unpaid|wait'
    }, {
      name: '分享订单',
      check: false,
      logisstate: 'isShare'
    }],
    startdate: {
      data: '开始时间',
      color: 'c999'
    },
    enddate: {
      data: '结束时间',
      color: 'c999'
    },
    streamAnimation: {},
    sellerAnimation: {},
    streamLen: 6,
    sellerLen: 6,
    showorder: true
  },
  onLoad: function(options) {
    let that = this;
    let filter = JSON.parse(options.filter);
    let search = JSON.parse(options.search);
    console.log(search)
    if (filter) {//云单筛选页面
      let beginDate = this.data.startdate;
      let endDate = this.data.enddate;
      let filterList = this.data.filterList
      if (search.beginDate) { //开始时间
        beginDate.data = search.beginDate.substring(0, 10)
        this.setData({
          startdate: beginDate
        })
      }
      if (search.endDate) { //结束时间
        endDate.data = search.endDate.substring(0, 10)
        this.setData({
          enddate: endDate
        })
      }
      this.setState(filterList, search.cloudStatuses, 0, 'cloudStatuses') //单据状态
      this.setState(filterList, search.orderPaidStatuses, 1, 'orderPaidStatuses') //付款状态
      this.setState(filterList, search.orderStatuses, 2, 'orderStatuses') //收货状态
      app.HttpService.browseshop().then(res => {
        let upStream = that.data.upStream;
        for (let a = 0; a < res.length; a++) {
          let obj = {};
          if (search.cloudShopIds && search.cloudShopIds.length > 0) {
            if (search.cloudShopIds.indexOf(res[a].id) > -1) {
              obj.check = true;
            } else {
              obj.check = false;
            }
          } else {
            obj.check = false;
          }
          obj.name = res[a].name;
          obj.id = res[a].id;
          upStream.push(obj);
        }
        this.setData({
          upStream: upStream,
          showorder: filter,
          filterList: filterList
        })
      })
    }else{//物流单筛选页面
      let seller = this.data.seller
      if (search.paymentStatusAndOrderStatus && search.paymentStatusAndOrderStatus.length > 0){
        for (let b = 0; b < seller.length; b++) {
          if (search.paymentStatusAndOrderStatus.indexOf(seller[b].logisstate) > -1) {
            seller[b].check = true;
          } else {
            seller[b].check = false;
          }
        }
      }
      if (search.isShare) {
        seller[seller.length - 1].check = true
      }
      this.setData({
        showorder: filter,
        seller: seller
      })
    }
  },
  //当有筛选条件时，再次进入筛选页面需选中
  setState(filterList, search, num, cloudStatuses) {
    if (search && search.length > 0) {
      for (let b = 0; b < filterList[0].list.length; b++) {
        if (search.indexOf(filterList[num].list[b][cloudStatuses]) > -1) {
          filterList[num].list[b].check = true;
        } else {
          filterList[num].list[b].check = false;
        }
      }
    }
  },
  onReady: function() {

  },
  onShow: function() {},
  onHide: function() {

  },
  onUnload: function() {
  },
  chooseFilter: function(e) {
    let pind = e.currentTarget.dataset.pindex
    let ind = e.currentTarget.dataset.index
    let filterList = this.data.filterList
    let list = filterList[pind].list
    let check = list[ind].check
    if (check) {
      list[ind].check = false
    } else {
      list[ind].check = true
    }
    this.setData({
      filterList: filterList
    })
  },
  filterStream: function(e) {
    let ind = e.currentTarget.dataset.index
    let upStream = this.data.upStream
    let check = upStream[ind].check
    if (check) {
      upStream[ind].check = false
    } else {
      upStream[ind].check = true
    }
    this.setData({
      upStream: upStream
    })
    console.log(upStream)
    console.log(this.data.upStream)
  },
  filterSeller: function(e) {
    let ind = e.currentTarget.dataset.index
    let seller = this.data.seller
    let check = seller[ind].check
    if (check) {
      seller[ind].check = false
    } else {
      seller[ind].check = true
    }
    this.setData({
      seller: seller
    })
  },
  resetChoose: function() {
    let filterList = this.data.filterList
    let upStream = this.data.upStream
    let seller = this.data.seller
    for (let i in filterList) {
      for (let j in filterList[i].list) {
        filterList[i].list[j].check = false
      }
    }
    for (let i in upStream) {
      upStream[i].check = false
    }
    for (let i in seller) {
      seller[i].check = false
    }
    this.setData({
      filterList: filterList,
      seller: seller,
      upStream: upStream,
      startdate: {
        data: '开始时间',
        color: 'c999'
      },
      enddate: {
        data: '结束时间',
        color: 'c999'
      }
    })
  },
  sureChoose() {
    let searchobj = {
      'pageNum': 0,
      'pageSize': 10,
    }
    if (this.data.startdate.data !== '开始时间') {
      searchobj.beginDate = this.data.startdate.data + ' 00:00:00'
    }
    if (this.data.enddate.data !== '结束时间') {
      searchobj.endDate = this.data.enddate.data + ' 23:59:59'
    }
    if (this.data.showorder) { //云单搜索参数
      let cloudStatuses = []
      let orderPaidStatuses = []
      let orderStatuses = []
      let cloudShopIds = []
      let filterList = this.data.filterList
      let upStream = this.data.upStream
      for (let i in filterList[0].list) {
        if (filterList[0].list[i].check) {
          cloudStatuses.push(filterList[0].list[i].cloudStatuses)
        }
      }
      for (let i in filterList[1].list) {
        if (filterList[1].list[i].check) {
          orderPaidStatuses.push(filterList[1].list[i].orderPaidStatuses)
        }
      }

      for (let i in filterList[2].list) {
        if (filterList[2].list[i].check) {
          orderStatuses.push(filterList[2].list[i].orderStatuses)
        }
      }
      for (let i in upStream) {
        if (upStream[i].check) {
          cloudShopIds.push(upStream[i].id)
        }
      }
      searchobj.cloudStatuses = cloudStatuses;
      searchobj.orderPaidStatuses = orderPaidStatuses;
      searchobj.orderStatuses = orderStatuses;
      searchobj.cloudShopIds = cloudShopIds;
    } else { //物流单搜索参数
      let seller = this.data.seller
      let paymentStatusAndOrderStatus = [];
      for (let i in seller) {
        if (seller[i].logisstate == 'isShare') {
          if (seller[i].check) {
            searchobj.isShare = true
          } else {
            searchobj.isShare = false
          }
        } else {
          if (seller[i].check) {
            paymentStatusAndOrderStatus.push(seller[i].logisstate)
          }
        }
      }
      searchobj.paymentStatusAndOrderStatus = paymentStatusAndOrderStatus
    }
    let pages = getCurrentPages(); // 获取页面栈
    let prevPage = pages[pages.length - 2]; // 上一个页面
    if (this.data.showorder) {
      prevPage.setData({
        cloudSearchobj: searchobj,
        cloudlist: [],
        cloudrefresh: true,
        cloudtotal: 0,
        filtersure: true
      })
    } else {
      prevPage.setData({
        logistSearchobj: searchobj,
        logistlist: [],
        logistrefresh: true,
        logisttotal: 0,
        filtersure: true
      })
    }
    wx.navigateBack({
      delta: 1
    })
  },
  startTimeChange: function(e) {
    if (this.data.enddate.data !== '结束时间' && (e.detail.value > this.data.enddate.data)) {
      wx.showToast({
        title: '开始时间要小于结束时间哦',
        icon: 'none',
      })
      return
    }
    this.setData({
      startdate: {
        data: e.detail.value,
        color: 'c333'
      }
    })
  },
  endTimeChange: function(e) {
    if (this.data.startdate.data !== '开始时间' && (e.detail.value < this.data.startdate.data)) {
      wx.showToast({
        title: '结束时间要大于开始时间哦',
        icon: 'none',
      })
      return
    }
    this.setData({
      enddate: {
        data: e.detail.value,
        color: 'c333'
      }
    })
  },
  showmoreStream: function() {
    let upStream = this.data.upStream
    let streamLen = this.data.streamLen
    if (streamLen == 6) {
      streamLen = upStream.length
      streamanimation.rotate('180').step()
    } else {
      streamLen = 6
      streamanimation.rotate('0').step()
    }

    this.setData({
      streamAnimation: streamanimation.export(),
      streamLen: streamLen
    })
  },
  showmoreSeller: function() {
    let seller = this.data.seller
    let sellerLen = this.data.sellerLen
    if (sellerLen == 6) {
      sellerLen = seller.length
      selleranimation.rotate('180').step()
    } else {
      sellerLen = 6
      selleranimation.rotate('0').step()
    }

    this.setData({
      sellerAnimation: selleranimation.export(),
      sellerLen: sellerLen
    })
  }
}),{"navigationBarTitleText": "订单筛选"},<view class='container'>
  <view wx:if="{{showorder}}">
    <view class='filterMod'>
      <view class='title flex'>
        <view class='flex-1'>上游商家</view>
        <view class='self-center' wx:if="{{upStream.length>6}}" bindtap='showmoreStream'>
          <image animation='{{streamAnimation}}' src='/images/order/Down.png' mode='widthFix'></image>
        </view>
      </view>
      <view class='list'>
        <view wx:for="{{upStream}}" wx:key="" wx:if='{{index<streamLen}}' class='{{item.check?"choose textEllipsis":"textEllipsis"}}' data-shopid='{{item.id}}' data-index='{{index}}' bindtap='filterStream'>{{item.name}}</view>
      </view>
    </view>
    <view class='filterMod'>
      <view class='title'>时间筛选</view>
      <view class='list timeBox clearfix'>
        <picker mode="date" value="{{startdate.data}}" start="2018-10-01" end="2020-12-12" bindchange="startTimeChange">
          <view class="picker {{startdate.color}}">
            {{startdate.data}}
          </view>
        </picker>
        <view class='line'></view>
        <picker mode="date" value="{{enddate.data}}" start="2018-10-01" end="2020-12-12" bindchange="endTimeChange">
          <view class="picker.data {{startdate.color}}">
            {{enddate.data}}
          </view>
        </picker>
      </view>
    </view>
    <view class='filterMod' wx:for="{{filterList}}" wx:key="" wx:for-index="ind" wx:for-item="listVo">
      <view class='title'>{{listVo.name}}</view>
      <view class='list'>
        <view wx:for="{{listVo.list}}" wx:key="" class='{{item.check?"choose":""}}' data-pindex='{{ind}}' data-index="{{index}}" bindtap='chooseFilter'>{{item.name}}</view>
      </view>
    </view>
  </view>
  <view class='filterMod' wx:if="{{!showorder}}">
    <view class='title flex'>
      <view class='flex-1'>状态</view>
      <view class='self-center' wx:if="{{seller.length>6}}" bindtap='showmoreSeller'>
        <image animation='{{sellerAnimation}}' src='/images/order/Down.png' mode='widthFix'></image>
      </view>
    </view>
    <view class='sellerList flex f-wrap'>
      <view wx:for="{{seller}}" wx:key="" wx:if='{{index<sellerLen}}' class='flex {{item.check?"choose":""}}' data-index="{{index}}" bindtap='filterSeller'>
        <view class='flex-1 self-center'>
          <text>{{item.name}}</text>
        </view>
      </view>
    </view>
  </view>
</view>
<view class='footBtn flex'>
  <button class='bg_navy' hover-class='none' bindtap='resetChoose'>重置</button>
  <button class='bg_blue' hover-class='none' bindtap='sureChoose'>确定</button>
</view>,.container{
  padding-bottom:100rpx;
}
.filterMod{
  background: #fff;
  border-bottom: 1px solid #EFEFF4;
  font-size:24rpx;
}
.filterMod .title{
  color:#666;
  margin-top:24rpx;
  font-size:28rpx;
  padding:20rpx 20rpx 10rpx;
}
.list{
  padding:0 16rpx 20rpx 16rpx;
}
.list > view{
  display: inline-block;
  width: 30%;
  border:1px solid #c4c4c4;
  height:72rpx;
  line-height: 72rpx;
  text-align: center;
  font-size:22rpx;
  border-radius:0.3em;
  margin:12rpx 1.3333%;
}
.sellerList{
  padding:0 16rpx 20rpx 16rpx;
}
.sellerList > view{
  border:1px solid #c4c4c4;
  height:72rpx;
  width: 30%;
  text-align: center;
  line-height: 1.2;
  font-size:22rpx;
  border-radius:0.3em;
  margin:12rpx 1.3333%;
}
.filterMod image{
  width: 30rpx;
  
}
.timeBox{
  padding:0 20rpx 16rpx;
}
.timeBox picker{
  float:left;
}
.timeBox .picker{
  display: inline-block;
  border:1px solid #c4c4c4;
  height:72rpx;
  line-height: 72rpx;
  text-align: center;
  font-size:22rpx;
  width:196rpx;
  border-radius:0.3em;
  margin:12rpx 1.3333%;

} 
.timeBox .line{
  float:left;
  height:36rpx;
  border-radius: 0;
  border:0;
  border-bottom:1px solid #979797;
  width: 80rpx;
  margin: 16rpx 10rpx;
}
.list view.choose,.sellerList > view.choose{
  color:#FFBC51;
  border-color:#FFBC51;
}
.footBtn{
  position: fixed;
  width: 100%;
  bottom:0;
  height:100rpx;
  z-index: 50;
}
.footBtn button{
  border:0;
  width: 50%;
  height:100%;
  line-height: 100rpx;
  border-radius: 0;
  color:#fff;
  font-size:30rpx;
},Page({
  data: {
    tel:'',
    orderId:0
  },
  onLoad: function (options) {
    let id = options.id
    let owner=wx.getStorageSync('owner')
    if (id){
      //orderData = JSON.parse(orderData)
      this.setData({
        tel: owner.cloudShopVO.contactNo,
        orderId: id
      })
    }
     
  },
  onReady: function () {

  },
  onShow: function () {
   
  },
  onUnload:function(){
    //  wx.switchTab({
    //    url: '/pages/index/index',
    //  })
  },
  orderDetail:function(){
    wx.navigateTo({
      url: '/pages/order/orderDetail/orderDetail?id=' + this.data.orderId+'&from=creatOrder',
    })

  },
  contactSeller:function(){
    let tel = this.data.tel 
    if (!tel){
      getApp().AcFunc().myTotal('商家没有留下联系方式')
    }else{
      wx.makePhoneCall({
        phoneNumber: tel
      })
    }
    
  },
  keepChoose:function(){
    wx.switchTab({
      url: '/pages/index/index',
    })
  }
})
,{
  "navigationBarTitleText": "下单成功"
},<view class='container flex f-col'>
  <view class='flex-1 text-center'>
    <view class='iconBox'>
      <icon class='iconfont icon-success'></icon>
    </view>
    <view class='text1'>下单成功</view>
    <view class='text2 c666 fs13'>等待接单...</view>
    <view class='btn'>
      <button type='success' bindtap='orderDetail'>查看单据</button>
    </view>
    <view class='btn'>
      <button bindtap='contactSeller' >联系卖家</button>
    </view>
  </view>
  <view class='btnBox' bindtap='keepChoose'>返回选购</view>
</view>,page{
  height:100%;
  background: #fff;
}
.container{
  height:100%;
}
.container .iconBox{
  overflow: hidden;
  padding:60rpx 0 40rpx;
}
.container .iconfont{
  color:#09BB07;
  font-size:180rpx;
  line-height: 100%;
}
.container .iconfon:before{
    line-height: 100%;
}
.container .text1{
  font-size:36rpx;
}
.container .text2{
  margin-top:30rpx;
}
.container button{
  font-size:30rpx;
  margin:40rpx 20rpx;
}
.btnBox{
  height:100rpx;
  line-height: 100rpx;
  text-align: center;
  color:#00A6F5;
  font-size:30rpx;
  border-top:1px solid #F2F2F2;
},// pages/productdetail/fineCode/index.js
Page({

  /**
   * 页面的初始数据
   */
  data: {

  },

  /**
   * 生命周期函数--监听页面加载
   */
  onLoad: function (options) {

  },

  /**
   * 生命周期函数--监听页面初次渲染完成
   */
  onReady: function () {

  },

  /**
   * 生命周期函数--监听页面显示
   */
  onShow: function () {

  },

  /**
   * 生命周期函数--监听页面隐藏
   */
  onHide: function () {

  },

  /**
   * 生命周期函数--监听页面卸载
   */
  onUnload: function () {

  },

  /**
   * 页面相关事件处理函数--监听用户下拉动作
   */
  onPullDownRefresh: function () {

  },

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom: function () {

  },

  /**
   * 用户点击右上角分享
   */
  onShareAppMessage: function () {

  }
}),{},<!--pages/productdetail/fineCode/index.wxml-->
<text>pages/productdetail/fineCode/index.wxml</text>
,/* pages/productdetail/fineCode/index.wxss */,import WxResource from './core/WxResource'

export default WxResource,import WxRequest from './core/WxRequest'

export default WxRequest,/**
 * 注册拦截器
 */
class InterceptorManager {
    constructor() {
        this.__init()
    }

    __init() {
        this.handlers = []
    }

    /**
     * 添加一个拦截器
     */
    use(obj) {
        this.handlers.push({
            request: obj.request,
            requestError: obj.requestError,
            response: obj.response,
            responseError: obj.responseError,
        })
        return this.handlers.length - 1
    }

    /**
     * 移除一个拦截器
     */
    eject(id) {
        if (this.handlers[id]) {
            this.handlers[id] = null
        }
    }

    /**
     * 遍历所有已注册的拦截器
     */
    forEach(fn) {
        this.handlers.forEach(h => {
            if (h !== null) {
                fn(h)
            }
        })
    }
}

export default InterceptorManager,import Utils from '../helpers/Utils'

/**
 * 注册路由
 * 
 * @param {String} template url 路径
 * @param {Object} defaults 参数对象
 * 
 */
class RouteManager {
    constructor(template = '', defaults = {}) {
        Object.assign(this, {
            template,
            defaults,
        })
        this.__init()
    }

    __init() {
        this.urlParams = {}
    }

    setUrlParams(config, params, actionUrl) {
        const PROTOCOL_AND_DOMAIN_REGEX = /^https?:\/\/[^\/]*/
        let url = actionUrl || this.template,
            val, encodedVal,
            protocolAndDomain = '',
            urlParams = this.urlParams

        Utils.each(url.split(/\W/), (param, key) => {
            if (param === 'hasOwnProperty') {
                throw `hasOwnProperty is not a valid parameter name.`
            }
            if (!(new RegExp('^\\d+$').test(param)) && param && (new RegExp('(^|[^\\\\]):' + param + '(\\W|$)').test(url))) {
                urlParams[param] = {
                    isQueryParamValue: (new RegExp('\\?.*=:' + param + '(?:\\W|$)')).test(url)
                }
            }
        })

        url = url.replace(/\\:/g, ':')
        url = url.replace(PROTOCOL_AND_DOMAIN_REGEX, function(match) {
            protocolAndDomain = match
            return ''
        })

        params = params || {}

        Utils.each(this.urlParams, (paramInfo, urlParam) => {
            val = params.hasOwnProperty(urlParam) ? params[urlParam] : this.defaults[urlParam]
            if (Utils.isDefined(val) && val !== null) {
                if (paramInfo.isQueryParamValue) {
                    encodedVal = Utils.encodeUriQuery(val, true)
                } else {
                    encodedVal = Utils.encodeUriSegment(val)
                }
                url = url.replace(new RegExp(':' + urlParam + '(\\W|$)', 'g'), function(match, p1) {
                    return encodedVal + p1
                })
            } else {
                url = url.replace(new RegExp('(/?):' + urlParam + '(\\W|$)', 'g'), function(match, leadingSlashes, tail) {
                    if (tail.charAt(0) === '/') {
                        return tail
                    } else {
                        return leadingSlashes + tail
                    }
                })
            }
        })

        // strip trailing slashes and set the url (unless this behavior is specifically disabled)
        if (this.defaults.stripTrailingSlashes) {
            url = url.replace(/\/+$/, '') || '/'
        }

        // then replace collapse `/.` if found in the last URL path segment before the query
        // E.g. `http://url.com/id./format?q=x` becomes `http://url.com/id.format?q=x`
        url = url.replace(/\/\.(?=\w+($|\?))/, '.')

        // replace escaped `/\.` with `/.`
        config.url = protocolAndDomain + url.replace(/\/\\\./, '/.')

        // set params - delegate param encoding to $http
        Utils.each(params, (value, key) => {
            if (!this.urlParams[key]) {
                config.data = config.data || {}
                config.data[key] = value
            }
        })
    }
}

export default RouteManager,import InterceptorManager from './InterceptorManager'
import RouteManager from './RouteManager'

/**
 * Promise 封装 wx.request 请求方法
 * 
 * @param {String} url 设置一个含有参数的 URL 模板
 * @param {Object} paramDefaults 设置 URL 参数的默认值
 * @param {Object} actions 设置资源方法
 * @param {Object} options 设置默认参数
 * 
 */
class WxResource {
    constructor(url = '', paramDefaults = {}, actions = {}, options = {}) {
        Object.assign(this, {
            url,
            paramDefaults,
            actions,
            options,
        })
        this.__init()
    }

    /**
     * 初始化
     */
    __init() {
        this.__initInterceptor()
        this.__initDefaults()
        this.__initMethods()
    }

    /**
     * 初始化默认拦截器
     */
    __initInterceptor() {
        this.interceptors = new InterceptorManager
        this.interceptors.use({
            request(request) {
                request.requestTimestamp = new Date().getTime()
                return request
            },
            requestError(requestError) {
                return Promise.reject(requestError)
            },
            response(response) {
                response.responseTimestamp = new Date().getTime()
                return response
            },
            responseError(responseError) {
                return Promise.reject(responseError)
            },
        })
    }

    /**
     * 初始化默认参数
     */
    __initDefaults() {
        this.defaults = {
            // URL 是否以‘/‘结尾
            stripTrailingSlashes: true,

            // 方法名后缀字符串
            suffix: 'Async',

            // 默认方法
            actions: {
                'get': { method: 'GET' },
                'save': { method: 'POST' },
                'update': { method: 'PUT' },
                'query': { method: 'GET' },
                'remove': { method: 'DELETE' },
                'delete': { method: 'DELETE' },
            }
        }
    }

    /**
     * __initRoute         
     */
    __initRoute(template, defaults) {
        return new RouteManager(template, Object.assign({}, this.defaults, defaults))
    }

    /**
     * 遍历对象构造方法，方法名以小写字母+后缀名
     */
    __initMethods() {
        const route = this.__initRoute(this.url, this.options)
        const actions = Object.assign({}, this.defaults.actions, this.actions)

        for (let name in actions) {
            this[name + route.defaults.suffix] = (...args) => {
                const httpConfig = this.__setHttpConfig(route, actions[name], ...args)
                return this.__defaultRequest(httpConfig)
            }
        }
    }

    /**
     * 设置 httpConfig
     * 
     * @param {object} route 路由对象
     * @param {string} action 请求方法
     * @param {arrary} args 参数数组 [params, data]
     */
    __setHttpConfig(route, action, ...args) {
        const MEMBER_NAME_REGEX = /^(\.[a-zA-Z_$@][0-9a-zA-Z_$@]*)+$/

        // 判断是否为有效的路径
        const isValidDottedPath = (path) => {
            return (path != null && path !== '' && path !== 'hasOwnProperty' && MEMBER_NAME_REGEX.test('.' + path))
        }

        // 查找路径
        const lookupDottedPath = (obj, path) => {
            if (!isValidDottedPath(path)) {
                throw `badmember, Dotted member path ${path} is invalid.`
            }
            let keys = path.split('.')
            for (let i = 0, ii = keys.length; i < ii && typeof obj !== 'undefined'; i++) {
                let key = keys[i]
                obj = (obj !== null) ? obj[key] : undefined
            }
            return obj
        }

        // 提取参数
        const extractParams = (data, actionParams) => {
            let ids = {}
            actionParams = Object.assign({}, this.paramDefaults, actionParams)
            for (let key in actionParams) {
                let value = actionParams[key]
                if (typeof value === 'function') {
                    value = value(data)
                }
                ids[key] = value && value.charAt && value.charAt(0) === '@' ? lookupDottedPath(data, value.substr(1)) : value
            }
            return ids
        }

        let params = {},
            data = {},
            httpConfig = {},
            hasBody = /^(POST|PUT|PATCH)$/i.test(action.method)

        // 判断参数个数
        switch (args.length) {
            case 2:
                params = args[0]
                data = args[1]
                break
            case 1:
                if (hasBody) data = args[0]
                else params = args[0]
                break
            case 0:
                break
            default:
                throw `Expected up to 2 arguments [params, data], got ${args.length} arguments`
        }

        // 设置 httpConfig
        for (let key in action) {
            switch (key) {
                case 'params':
                case 'isArray':
                case 'interceptor':
                case 'cancellable':
                    break
                default:
                    httpConfig[key] = action[key]
                    break
            }
        }

        // 判断是否为 (POST|PUT|PATCH) 请求，设置请求 data
        if (hasBody) {
            httpConfig.data = data
        }

        // 解析 URL
        route.setUrlParams(httpConfig, Object.assign({}, extractParams(data, action.params || {}), params), action.url)

        return httpConfig
    }

    /**
     * 以 wx.request 作为底层方法
     * @param {Object} httpConfig 请求参数配置
     */
    __defaultRequest(httpConfig) {
        // 注入拦截器
        const chainInterceptors = (promise, interceptors) => {
            for (let i = 0, ii = interceptors.length; i < ii;) {
                let thenFn = interceptors[i++]
                let rejectFn = interceptors[i++]
                promise = promise.then(thenFn, rejectFn)
            }
            return promise
        }

        let requestInterceptors = []
        let responseInterceptors = []
        let promise = Promise.resolve(httpConfig)

        // 缓存拦截器
        this.interceptors.forEach(n => {
            if (n.request || n.requestError) {
                requestInterceptors.push(n.request, n.requestError)
            }
            if (n.response || n.responseError) {
                responseInterceptors.unshift(n.response, n.responseError)
            }
        })

        // 注入请求拦截器
        promise = chainInterceptors(promise, requestInterceptors)

        // 发起HTTPS请求
        promise = promise.then(this.__http)

        // 注入响应拦截器
        promise = chainInterceptors(promise, responseInterceptors)

        // 接口调用成功，res = {data: '开发者服务器返回的内容'}
        promise = promise.then(res => res, err => err)

        return promise
    }

    /**
     * __http - wx.request
     */
    __http(obj) {
        return new Promise((resolve, reject) => {
            obj.success = (res) => resolve(res)
            obj.fail = (res) => reject(res)
            wx.request(obj)
        })
    }
}

export default WxResource,export default {
    isArray(value) {
        return Array.isArray(value)
    },
    isFunction(value) {
        return typeof value === 'function'
    },
    isDefined(value) {
        return typeof value !== 'undefined'
    },
    isObject(value) {
        return value !== null && typeof value === 'object'
    },
    each(obj, iterator) {
        let i, key
        if (obj && typeof obj.length === 'number') {
            for (i = 0; i < obj.length; i++) {
                iterator.call(obj[i], obj[i], i)
            }
        } else if (this.isObject(obj)) {
            for (key in obj) {
                if (obj.hasOwnProperty(key)) {
                    iterator.call(obj[key], obj[key], key)
                }
            }
        }
        return obj
    },
    encodeUriSegment(val) {
        return this.encodeUriQuery(val, true).
        replace(/%26/gi, '&').
        replace(/%3D/gi, '=').
        replace(/%2B/gi, '+')
    },
    encodeUriQuery(val, pctEncodeSpaces) {
        return encodeURIComponent(val).
        replace(/%40/gi, '@').
        replace(/%3A/gi, ':').
        replace(/%24/g, '$').
        replace(/%2C/gi, ',').
        replace(/%20/g, (pctEncodeSpaces ? '%20' : '+'))
    },
},/**
 * 注册拦截器
 */
class InterceptorManager {
    constructor(blackList) {
        this.blackList=blackList;
        this.__init()
    }

    __init() {
        this.handlers = []
    }

    /**
     * 添加一个拦截器
     */
    use(obj) {
        let that = this
        this.handlers.push({
            request: function(req){
              return obj.request(req, that.blackList)
            },
            requestError: obj.requestError,
            response: obj.response,
            responseError: obj.responseError,
        })
        return this.handlers.length - 1
    }

    /**
     * 移除一个拦截器
     */
    eject(id) {
        if (this.handlers[id]) {
            this.handlers[id] = null
        }
    }

    /**
     * 遍历所有已注册的拦截器
     */
    forEach(fn) {
        this.handlers.forEach((h) => {
            if (h !== null) {
                fn(h)
            }
        })
    }
}

export default InterceptorManager,import InterceptorManager from './InterceptorManager'
import Utils from './../helpers/Utils'

/**
 * Promise 封装 wx.request 请求方法
 * 
 * @param {Object} defaults 配置项
 * @param {String} defaults.suffix 方法名后缀字符串，默认值 Request
 * @param {String} defaults.baseURL 基础请求路径
 * @param {Object} defaults.header 请求头
 * @param {Array} defaults.transformRequest 转换请求数据
 * @param {Array} defaults.transformResponse 转换响应数据
 * @param {Function} defaults.validateStatus 基于响应状态返回成功或失败
 * 
 */
class WxRequest {
  constructor(defaults) {
    Object.assign(this, {
      defaults,
    })
    this.__init()
  }

  /**
   * 初始化
   */
  __init() {
    this.__initInterceptor()
    this.__initDefaults()
    this.__initMethods()
  }

  /**
   * 初始化默认拦截器
   */
  __initInterceptor() {
    this.interceptors = new InterceptorManager
    this.interceptors.use({
      request(request) {
        request.requestTimestamp = new Date().getTime()
        return request
      },
      requestError(requestError) {
        return Promise.reject(requestError)
      },
      response(response) {
        // response.responseTimestamp = new Date().getTime()
        return response
      },
      responseError(responseError) {
        return Promise.reject(responseError)
      },
    })
  }

  /**
   * 初始化默认参数
   */
  __initDefaults() {
    const defaults = {
      // 方法名后缀字符串，默认值 Request
      suffix: 'Request',
      // 基础请求路径
      baseURL: '',
      // 请求头
      header: {
        // 'Accept': 'application/json, text/plain, */*',
        // 'Content-Type': 'application/x-www-form-urlencoded',
        // 'Accept': 'application/json, text/javascript',
        'Content-Type': 'application/json; charset=UTF-8',
      },
      // 转换请求数据
      transformRequest: [
        (data, header) => {
          return data
        },
      ],
      // 转换响应数据
      transformResponse: [
        (data, header) => {
          if (typeof data === 'string') {
            try {
              data = JSON.parse(data)
            } catch (e) { /* Ignore */ }
          }
          return data
        },
      ],
      // 基于响应状态返回成功或失败，
      validateStatus: status => status >= 200 && status < 300,
    }

    // 合并参数
    this.defaults = Object.assign({}, defaults, this.defaults)
  }

  /**
   * 遍历对象构造方法，方法名以小写字母+后缀名
   */
  __initMethods() {
    // 方法名后缀字符串
    const suffix = this.defaults.suffix

    // 发起请求所支持的方法
    const instanceSource = {
      method: [
        // 'OPTIONS',
        'GET',
        // 'HEAD',
        'POST',
        // 'PUT',
        'DELETE',
        // 'TRACE',
        // 'CONNECT',
      ],
    }

    // 遍历对象构造方法
    for (let key in instanceSource) {
      instanceSource[key].forEach((method, index) => {
        this[method.toLowerCase() + suffix] = (url, config) => {
          return this.__defaultRequest(Object.assign({}, config, {
            method,
            url,
          }))
        }
      })
    }

    // request - 基础请求方法
    this.request = (...args) => this.__defaultRequest(...args)

    // Promise.all - 合并处理请求
    this.all = promises => Promise.all(promises)
  }

  /**
   * 以 wx.request 作为底层方法
   * @param {Object|String} config 配置项|接口地址
   * @param {String} config.method 请求方法
   * @param {String} config.url    接口地址
   * @param {Object} config.data 请求参数
   * @param {Object} config.header 设置请求的 header
   * @param {String} config.dataType 请求的数据类型
   */
  __defaultRequest(config) {

    // 判断参数类型，如果第一个参数为字符串则赋值于 url，第二个参数为 config 配置
    if (typeof config === 'string') {
      config = Object.assign({}, {
        url: arguments[1]
      }, arguments[2])
    }

    // 合并参数
    const defaults = Object.assign({
      method: 'GET',
      dataType: 'json',
    }, this.defaults, config)

    const {
      baseURL,
      header,
      validateStatus
    } = defaults

    // 配置请求参数
    const $$config = {
      url: defaults.url,
      data: defaults.data,
      header: defaults.header,
      method: defaults.method,
      dataType: defaults.dataType,
    }

    // 配置请求路径 prefix
    if (this.$$prefix && !Utils.isAbsoluteURL($$config.url)) {
      $$config.url = Utils.combineURLs(this.$$prefix, $$config.url)
    }

    // 配置请求路径 baseURL
    if (baseURL && !Utils.isAbsoluteURL($$config.url)) {
      $$config.url = Utils.combineURLs(baseURL, $$config.url)
    }

    // 注入拦截器
    const chainInterceptors = (promise, interceptors) => {
      for (let i = 0, ii = interceptors.length; i < ii;) {
        let thenFn = interceptors[i++]
        let rejectFn = interceptors[i++]
        promise = promise.then(thenFn, rejectFn)
      }
      return promise
    }

    // 转换数据
    const transformData = (data, header, status, fns) => {
      fns.forEach(fn => {
        data = fn(data, header, status)
      })
      return data
    }

    // 转换响应数据
    const transformResponse = res => {
      const __res = Object.assign({}, res, {
        data: transformData(res.data, res.header, res.statusCode, defaults.transformResponse),
      })
      return validateStatus(res.statusCode) ? __res : Promise.reject(__res)
    }

    // 发起HTTPS请求
    const serverRequest = config => {
      const __config = Object.assign({}, config, {
        data: transformData($$config.data, $$config.header, undefined, defaults.transformRequest),
      })
      return this.__http(__config).then(transformResponse, transformResponse)
    }

    let requestInterceptors = []
    let responseInterceptors = []
    let promise = Promise.resolve($$config)

    // 缓存拦截器
    this.interceptors.forEach(n => {
      if (n.request || n.requestError) {
        requestInterceptors.push(n.request, n.requestError)
      }
      if (n.response || n.responseError) {
        responseInterceptors.unshift(n.response, n.responseError)
      }
    })

    // 注入请求拦截器
    promise = chainInterceptors(promise, requestInterceptors)

    // 发起HTTPS请求
    promise = promise.then(serverRequest)

    // 注入响应拦截器
    promise = chainInterceptors(promise, responseInterceptors)

    return promise
  }

  /**
   * __http - wx.request
   */
  __http(obj) {
    var t=this;
    return new Promise((resolve, reject) => {
      obj.success = (res) => {
        let app = getApp()
        // if (app.visitor){
        //   if (/action=/.test(obj.url)) {
        //     resolve(res);
        //   }
        //  console.log(t)
        //  return ; 
        // }
        if (res.statusCode == '440') {          
          if (!app.isNotAction){
            res.data.data = '允许游客登录';
            resolve(res);
          }else{
            // res.data.errorMsg = '缓存失效，请重新登录';
            // res.data.errorCode = '440';
            reject(res);
          }
        } else if (res.statusCode == '401') {
          let clearToken=false;
          if (/access_token=[a-zA-Z0-9\-]+$/.test(obj.url)){
            clearToken=true;
          }
          app.reconnectToken({ clearToken: clearToken}).then((access_token) => {
            obj.url = obj.url.replace(/access_token=[a-zA-Z0-9\-]*$/, 'access_token=' + access_token)
            app.WxService.request(obj).then((res2) => {
              resolve(res2)
            }).catch(e=>{
              console.error('http方法wx.request res2错误',e)
              reject(e)
            })
          }).catch(e => {
            console.error('http方法app.reconnectToken 错误', e)
            reject(e)
          })
        } else {
          resolve(res)
        }
      }
      obj.fail = (res) => reject(res)
      wx.request(obj)
    })
  }
}

export default WxRequest,/**
 * 合并路径
 * @param {string} baseURL 基础路径
 * @param {string} relativeURL 相对路径
 * @returns {string} 合并后的路径
 */
const combineURLs = (baseURL, relativeURL) => {
	return relativeURL ? baseURL.replace(/\/+$/, '') + '/' + relativeURL.replace(/^\/+/, '') : baseURL
}

/**
 * 判断是否绝对路径
 * @param {string} url 路径
 * @returns {boolean} 返回真值表示绝对路径，假值表示非绝对路径
 */
const isAbsoluteURL = url => {
	return /^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(url)
}

export default {
	combineURLs,
	isAbsoluteURL,
}